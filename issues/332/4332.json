{
	"id": 51281981,
	"number": 4332,
	"state": "open",
	"title": "cmd/compile: racewalk generates too many runtime.racewrite() calls",
	"body": "\u003cpre\u003eFor the following code\n        t := []byte(\u0026quot;hello world\u0026quot;)\nit generates 11 runtime.racewrite. Seemingly for each char in the string. I think we\nneed to do better.\n\n\nfunc Encode() ([]byte, error) {\n        t := []byte(\u0026quot;hello world\u0026quot;)\n  400c25:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400c2c:       00 \n  400c2d:       48 89 1c 24             mov    %rbx,(%rsp)\n  400c31:       e8 2a cc 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400c36:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400c3d:       00 \n  400c3e:       48 ff c3                inc    %rbx\n  400c41:       48 89 1c 24             mov    %rbx,(%rsp)\n  400c45:       e8 16 cc 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400c4a:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400c51:       00 \n  400c52:       48 83 c3 02             add    $0x2,%rbx\n  400c56:       48 89 1c 24             mov    %rbx,(%rsp)\n  400c5a:       e8 01 cc 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400c5f:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400c66:       00 \n  400c67:       48 83 c3 03             add    $0x3,%rbx\n  400c6b:       48 89 1c 24             mov    %rbx,(%rsp)\n  400c6f:       e8 ec cb 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400c74:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400c7b:       00 \n  400c7c:       48 83 c3 04             add    $0x4,%rbx\n  400c80:       48 89 1c 24             mov    %rbx,(%rsp)\n  400c84:       e8 d7 cb 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400c89:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400c90:       00 \n  400c91:       48 83 c3 05             add    $0x5,%rbx\n  400c95:       48 89 1c 24             mov    %rbx,(%rsp)\n  400c99:       e8 c2 cb 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400c9e:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400ca5:       00 \n  400ca6:       48 83 c3 06             add    $0x6,%rbx\n  400caa:       48 89 1c 24             mov    %rbx,(%rsp)\n  400cae:       e8 ad cb 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400cb3:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400cba:       00 \n  400cbb:       48 83 c3 07             add    $0x7,%rbx\n  400cbf:       48 89 1c 24             mov    %rbx,(%rsp)\n  400cc3:       e8 98 cb 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400cc8:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400ccf:       00 \n  400cd0:       48 83 c3 08             add    $0x8,%rbx\n  400cd4:       48 89 1c 24             mov    %rbx,(%rsp)\n  400cd8:       e8 83 cb 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400cdd:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400ce4:       00 \n  400ce5:       48 83 c3 09             add    $0x9,%rbx\n  400ce9:       48 89 1c 24             mov    %rbx,(%rsp)\n  400ced:       e8 6e cb 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400cf2:       48 8d 1c 25 58 14 43    lea    0x431458,%rbx\n  400cf9:       00 \n  400cfa:       48 83 c3 0a             add    $0xa,%rbx\n  400cfe:       48 89 1c 24             mov    %rbx,(%rsp)\n  400d02:       e8 59 cb 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400d07:       48 c7 04 24 88 76 42    movq   $0x427688,(%rsp)\n  400d0e:       00 \n  400d0f:       e8 5c 1d 01 00          callq  412a70 \u0026lt;runtime.new\u0026gt;\n  400d14:       48 8b 5c 24 08          mov    0x8(%rsp),%rbx\n  400d19:       48 89 5c 24 28          mov    %rbx,0x28(%rsp)\n  400d1e:       48 8b 5c 24 28          mov    0x28(%rsp),%rbx\n  400d23:       48 89 1c 24             mov    %rbx,(%rsp)\n  400d27:       e8 34 cb 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400d2c:       48 8b 7c 24 28          mov    0x28(%rsp),%rdi\n  400d31:       48 8d 34 25 58 14 43    lea    0x431458,%rsi\n  400d38:       00 \n  400d39:       48 a5                   movsq  %ds:(%rsi),%es:(%rdi)\n  400d3b:       a4                      movsb  %ds:(%rsi),%es:(%rdi)\n  400d3c:       a4                      movsb  %ds:(%rsi),%es:(%rdi)\n  400d3d:       a4                      movsb  %ds:(%rsi),%es:(%rdi)\n  400d3e:       48 8d 5c 24 10          lea    0x10(%rsp),%rbx\n  400d43:       48 89 1c 24             mov    %rbx,(%rsp)\n  400d47:       e8 14 cb 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400d4c:       48 c7 44 24 18 0b 00    movq   $0xb,0x18(%rsp)\n  400d53:       00 00 \n  400d55:       48 c7 44 24 20 0b 00    movq   $0xb,0x20(%rsp)\n  400d5c:       00 00 \n  400d5e:       48 8b 5c 24 28          mov    0x28(%rsp),%rbx\n  400d63:       48 89 5c 24 10          mov    %rbx,0x10(%rsp)\n/tmp/test.go:5\n        return t, nil\n  400d68:       48 8d 5c 24 38          lea    0x38(%rsp),%rbx\n  400d6d:       48 89 1c 24             mov    %rbx,(%rsp)\n  400d71:       e8 ea ca 00 00          callq  40d860 \u0026lt;runtime.racewrite\u0026gt;\n  400d76:       48 8d 5c 24 10          lea    0x10(%rsp),%rbx\n  400d7b:       48 89 1c 24             mov    %rbx,(%rsp)\n  400d7f:       e8 6c cb 00 00          callq  40d8f0 \u0026lt;runtime.raceread\u0026gt;\n  400d84:       48 8b 5c 24 10          mov    0x10(%rsp),%rbx\n  400d89:       48 89 5c 24 38          mov    %rbx,0x38(%rsp)\n  400d8e:       48 8b 5c 24 18          mov    0x18(%rsp),%rbx\n  400d93:       48 89 5c 24 40          mov    %rbx,0x40(%rsp)\n  400d98:       48 8b 5c 24 20          mov    0x20(%rsp),%rbx\n  400d9d:       48 89 5c 24 48          mov    %rbx,0x48(%rsp)\n  400da2:       48 c7 44 24 50 00 00    movq   $0x0,0x50(%rsp)\n  400da9:       00 00 \n  400dab:       48 c7 44 24 58 00 00    movq   $0x0,0x58(%rsp)\n  400db2:       00 00 \n  400db4:       e8 57 cc 00 00          callq  40da10 \u0026lt;runtime.racefuncexit\u0026gt;\n/tmp/test.go:6\n}\n  400db9:       48 83 c4 30             add    $0x30,%rsp\n  400dbd:       c3                      retq\u003c/pre\u003e",
	"user": {
		"login": "dvyukov",
		"id": 1095328,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "Performance"
		},
		{
			"name": "RaceDetector"
		}
	],
	"comments": 7,
	"created_at": "2012-11-02T06:28:57Z",
	"updated_at": "2015-06-08T06:23:43Z",
	"milestone": {
		"id": 1055141,
		"number": 6,
		"title": "Unplanned"
	}
}
