{
	"id": 127796691,
	"number": 14046,
	"state": "closed",
	"title": "runtime/pprof: panic during preempt: runtime error: index out of range",
	"body": "Steps to reproduce:\r\n* Setup net/http to serve with TLS on :8081 that serves broken script that causes request loop through page on localhost:8081/bar\r\n* Load the broken script that freezes a browser through https://localhost:8081/bar\r\n* While the browser is frozen in request loop, fire up https://localhost:8081/debug/pprof/goroutine?debug=1, which will cause the server to crash.\r\n\r\n(port and hostname is obviously unimportant, but TLS is required)\r\n\r\nEnvironment:\r\n* OS: OS X El Capitan\r\n* Revision: 36f959cc11809b5627ba5e0813dad3ba9a299fd4\r\n\r\nServer that reproduces the issue (requires a cert.pem and key.pem file):\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"fmt\"\r\n\t\"log\"\r\n\t\"net/http\"\r\n\t_ \"net/http/pprof\"\r\n)\r\n\r\nfunc main() {\r\n\thttp.HandleFunc(\"/payload\", func(w http.ResponseWriter, r *http.Request) {\r\n\t\tfmt.Fprint(w, \"1234\")\r\n\t})\r\n\thttp.HandleFunc(\"/script\", func(w http.ResponseWriter, r *http.Request) {\r\n\t\tfmt.Fprint(w, \"while (true) { var x = new XMLHttpRequest(); x.open('get', '/payload'); x.send();}\")\r\n\t})\r\n\thttp.HandleFunc(\"/bar\", func(w http.ResponseWriter, r *http.Request) {\r\n\t\tfmt.Fprint(w, \"\u003chtml\u003e\u003chead\u003e\u003cscript src='/script'\u003e\u003c/script\u003e\u003c/head\u003e\u003cbody\u003e\u003c/body\u003e\u003c/html\u003e\")\r\n\t})\r\n\r\n\tlog.Fatal(http.ListenAndServeTLS(\":8081\", \"cert.pem\", \"key.pem\", nil))\r\n}\r\n```\r\n\r\nTrace:\r\n```\r\npanic: runtime error: index out of range\r\npreempt off reason: profile\r\nfatal error: panic during preemptoff\r\n\r\ngoroutine 48 [running]:\r\nruntime.throw(0x478f20, 0x17)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/panic.go:530 +0x90 fp=0xc82022b6f8 sp=0xc82022b6e0\r\nruntime.gopanic(0x3adb60, 0xc82000a0b0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/panic.go:382 +0x2c2 fp=0xc82022b778 sp=0xc82022b6f8\r\nruntime.panicindex()\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/panic.go:15 +0x49 fp=0xc82022b7a0 sp=0xc82022b778\r\nruntime.GoroutineProfile(0xc820213000, 0xf, 0xf, 0x5, 0x1)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/mprof.go:545 +0x28e fp=0xc82022b850 sp=0xc82022b7a0\r\nruntime/pprof.writeRuntimeProfile(0xfc1ab8, 0xc820116008, 0x1, 0x437dd0, 0x9, 0x4ddc08, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/pprof/pprof.go:545 +0xb8 fp=0xc82022b8d0 sp=0xc82022b850\r\nruntime/pprof.writeGoroutine(0xfc1ab8, 0xc820116008, 0x1, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/pprof/pprof.go:507 +0x93 fp=0xc82022b918 sp=0xc82022b8d0\r\nruntime/pprof.(*Profile).WriteTo(0x62a520, 0xfc1ab8, 0xc820116008, 0x1, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/pprof/pprof.go:236 +0xd4 fp=0xc82022ba38 sp=0xc82022b918\r\nnet/http/pprof.handler.ServeHTTP(0xc82011802d, 0x9, 0xfc1a58, 0xc820116008, 0xc82010a1c0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/pprof/pprof.go:210 +0x37e fp=0xc82022bb00 sp=0xc82022ba38\r\nnet/http/pprof.Index(0xfc1a58, 0xc820116008, 0xc82010a1c0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/pprof/pprof.go:222 +0x200 fp=0xc82022bc58 sp=0xc82022bb00\r\nnet/http.HandlerFunc.ServeHTTP(0x4ddaf0, 0xfc1a58, 0xc820116008, 0xc82010a1c0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/server.go:1616 +0x3a fp=0xc82022bc78 sp=0xc82022bc58\r\nnet/http.(*ServeMux).ServeHTTP(0xc820014ae0, 0xfc1a58, 0xc820116008, 0xc82010a1c0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/server.go:1908 +0x17d fp=0xc82022bcd0 sp=0xc82022bc78\r\nnet/http.serverHandler.ServeHTTP(0xc82006e180, 0xfc1a58, 0xc820116008, 0xc82010a1c0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/server.go:2079 +0x19e fp=0xc82022bd30 sp=0xc82022bcd0\r\nnet/http.initNPNRequest.ServeHTTP(0xc820174300, 0xc82006e180, 0xfc1a58, 0xc820116008, 0xc82010a1c0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/server.go:2485 +0x221 fp=0xc82022bec0 sp=0xc82022bd30\r\nnet/http.(*initNPNRequest).ServeHTTP(0xc82000b1f0, 0xfc1a58, 0xc820116008, 0xc82010a1c0)\r\n\t\u003cautogenerated\u003e:253 +0xb6 fp=0xc82022bef8 sp=0xc82022bec0\r\nnet/http.(Handler).ServeHTTP-fm(0xfc1a58, 0xc820116008, 0xc82010a1c0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/h2_bundle.go:3628 +0x50 fp=0xc82022bf30 sp=0xc82022bef8\r\nnet/http.(*http2serverConn).runHandler(0xc820088280, 0xc820116008, 0xc82010a1c0, 0xc820118040)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/h2_bundle.go:3841 +0x9f fp=0xc82022bf80 sp=0xc82022bf30\r\nruntime.goexit()\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/asm_amd64.s:1998 +0x1 fp=0xc82022bf88 sp=0xc82022bf80\r\ncreated by net/http.(*http2serverConn).processHeaderBlockFragment\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/h2_bundle.go:3634 +0x55e\r\n\r\ngoroutine 1 [IO wait]:\r\nnet.runtime_pollWait(0xf457f8, 0x72, 0xf40050)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/netpoll.go:160 +0x60\r\nnet.(*pollDesc).Wait(0xc8201326f0, 0x72, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/fd_poll_runtime.go:73 +0x3a\r\nnet.(*pollDesc).WaitRead(0xc8201326f0, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/fd_poll_runtime.go:78 +0x36\r\nnet.(*netFD).accept(0xc820132690, 0x0, 0xf45928, 0xc82017a0e0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/fd_unix.go:426 +0x27c\r\nnet.(*TCPListener).AcceptTCP(0xc82002e060, 0x12442, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/tcpsock_posix.go:254 +0x4d\r\nnet/http.tcpKeepAliveListener.Accept(0xc82002e060, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/server.go:2423 +0x41\r\ncrypto/tls.(*listener).Accept(0xc82013f180, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/crypto/tls/tls.go:52 +0x60\r\nnet/http.(*Server).Serve(0xc82006e180, 0xf458f0, 0xc82013f180, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/server.go:2115 +0x129\r\nnet/http.(*Server).ListenAndServeTLS(0xc82006e180, 0x42fcf0, 0xf, 0x42fd00, 0xe, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/server.go:2274 +0x38e\r\nnet/http.ListenAndServeTLS(0x426270, 0x5, 0x42fcf0, 0xf, 0x42fd00, 0xe, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/server.go:2226 +0xcd\r\nmain.main()\r\n\t/Users/kenny/dev/golang/src/github.com/joushou/test/main.go:21 +0xdd\r\n\r\ngoroutine 17 [syscall, locked to thread]:\r\nruntime.goexit()\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/asm_amd64.s:1998 +0x1\r\n\r\ngoroutine 19 [select]:\r\nnet/http.(*http2serverConn).serve(0xc820088280)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/h2_bundle.go:2944 +0xedc\r\nnet/http.(*http2Server).handleConn(0xc8200ba880, 0xc82006e180, 0xf459b0, 0xc820174300, 0xf84328, 0xc82000b1f0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/h2_bundle.go:2530 +0x986\r\nnet/http.http2ConfigureServer.func1(0xc82006e180, 0xc820174300, 0xf84328, 0xc82000b1f0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/h2_bundle.go:2467 +0x97\r\nnet/http.(*conn).serve(0xc820176180)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/server.go:1412 +0x777\r\ncreated by net/http.(*Server).Serve\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/server.go:2135 +0x44e\r\n\r\ngoroutine 10 [IO wait]:\r\nnet.runtime_pollWait(0xf45678, 0x72, 0xc82017e800)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/runtime/netpoll.go:160 +0x60\r\nnet.(*pollDesc).Wait(0xc82016e0d0, 0x72, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/fd_poll_runtime.go:73 +0x3a\r\nnet.(*pollDesc).WaitRead(0xc82016e0d0, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/fd_poll_runtime.go:78 +0x36\r\nnet.(*netFD).Read(0xc82016e070, 0xc82017e800, 0x400, 0x400, 0x0, 0xf40050, 0xc82000a058)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/fd_unix.go:250 +0x23a\r\nnet.(*conn).Read(0xc820172008, 0xc82017e800, 0x400, 0x400, 0x0, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/net.go:172 +0xe4\r\ncrypto/tls.(*block).readFromUntil(0xc820170180, 0xf45a60, 0xc820172008, 0x5, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/crypto/tls/conn.go:460 +0xcc\r\ncrypto/tls.(*Conn).readRecord(0xc820174300, 0x4ddf17, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/crypto/tls/conn.go:562 +0x2d1\r\ncrypto/tls.(*Conn).Read(0xc820174300, 0xc8200bf008, 0x9, 0x9, 0x0, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/crypto/tls/conn.go:939 +0x167\r\nio.ReadAtLeast(0xf843c8, 0xc820174300, 0xc8200bf008, 0x9, 0x9, 0x9, 0x0, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/io/io.go:297 +0xe6\r\nio.ReadFull(0xf843c8, 0xc820174300, 0xc8200bf008, 0x9, 0x9, 0xc8204b5f00, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/io/io.go:315 +0x62\r\nnet/http.http2readFrameHeader(0xc8200bf008, 0x9, 0x9, 0xf843c8, 0xc820174300, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/h2_bundle.go:715 +0xa5\r\nnet/http.(*http2Framer).ReadFrame(0xc8200befd0, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/h2_bundle.go:906 +0xe9\r\nnet/http.(*http2serverConn).readFrames(0xc820088280)\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/h2_bundle.go:2848 +0x5a\r\ncreated by net/http.(*http2serverConn).serve\r\n\t/usr/local/Cellar/go/HEAD/libexec/src/net/http/h2_bundle.go:2938 +0x720\r\n```",
	"user": {
		"login": "joushou",
		"id": 176245,
		"type": "User",
		"site_admin": false
	},
	"assignee": {
		"login": "rsc",
		"id": 104030,
		"type": "User",
		"site_admin": false
	},
	"comments": 3,
	"closed_at": "2016-01-27T04:56:17Z",
	"created_at": "2016-01-20T22:13:40Z",
	"updated_at": "2016-01-27T04:56:17Z",
	"milestone": {
		"id": 1425772,
		"number": 34,
		"title": "Go1.6Maybe"
	}
}
