{
	"id": 234265235,
	"body": "This is tighten's fault; it is moving the sqrt calculation closer to use.\r\n\r\nSimpler code:\r\n\r\n```go\r\npackage main\r\n\r\nimport \"math\"\r\n\r\nvar x uint32\r\n\r\nfunc main() {\r\n\tend := uint32(math.Sqrt(float64(x)))\r\n\tfor j := uint32(3); j \u003c= end; j += 2 {\r\n\t}\r\n}\r\n```\r\n\r\nWith `-ssa=0`:\r\n\r\n```\r\n\"\".main t=1 size=41 args=0x0 locals=0x0\r\n\t0x0000 00000 (sqrt.go:11)\tTEXT\t\"\".main(SB), $0-0\r\n\t0x0000 00000 (sqrt.go:12)\tMOVLQZX\t\"\".x(SB), BX\r\n\t0x0006 00006 (sqrt.go:12)\tCVTSQ2SD\tBX, X0\r\n\t0x000b 00011 (sqrt.go:12)\tSQRTSD\tX0, X0\r\n\t0x000f 00015 (sqrt.go:12)\tCVTTSD2SQ\tX0, BX\r\n\t0x0014 00020 (sqrt.go:12)\tMOVQL\tBX, BX\r\n\t0x0016 00022 (sqrt.go:12)\tMOVL\tBX, CX\r\n\t0x0018 00024 (sqrt.go:13)\tMOVL\t$3, AX\r\n\t0x001d 00029 (sqrt.go:13)\tCMPL\tAX, CX\r\n\t0x001f 00031 (sqrt.go:13)\tJHI\t$0, 40\r\n\t0x0021 00033 (sqrt.go:13)\tADDL\t$2, AX\r\n\t0x0024 00036 (sqrt.go:13)\tCMPL\tAX, CX\r\n\t0x0026 00038 (sqrt.go:13)\tJLS\t$0, 33\r\n\t0x0028 00040 (sqrt.go:18)\tRET\r\n```\r\n\r\nWith regular SSA:\r\n\r\n```\r\n\"\".main t=1 size=35 args=0x0 locals=0x0\r\n\t0x0000 00000 (sqrt.go:11)\tTEXT\t\"\".main(SB), $0-0\r\n\t0x0000 00000 (sqrt.go:12)\tMOVL\t\"\".x(SB), AX\r\n\t0x0006 00006 (sqrt.go:13)\tMOVL\t$3, CX\r\n\t0x000b 00011 (sqrt.go:12)\tCVTSQ2SD\tAX, X0\r\n\t0x0010 00016 (sqrt.go:12)\tSQRTSD\tX0, X0\r\n\t0x0014 00020 (sqrt.go:12)\tCVTTSD2SQ\tX0, DX\r\n\t0x0019 00025 (sqrt.go:13)\tCMPL\tCX, DX\r\n\t0x001b 00027 (sqrt.go:13)\tJHI\t$0, 34\r\n\t0x001d 00029 (sqrt.go:13)\tADDL\t$2, CX\r\n\t0x0020 00032 (sqrt.go:12)\tJMP\t11\r\n\t0x0022 00034 (sqrt.go:18)\tRET\r\n```\r\n\r\nWith SSA with the tighten pass disabled:\r\n\r\n```\r\n\"\".main t=1 size=37 args=0x0 locals=0x0\r\n\t0x0000 00000 (sqrt.go:11)\tTEXT\t\"\".main(SB), $0-0\r\n\t0x0000 00000 (sqrt.go:12)\tMOVL\t\"\".x(SB), AX\r\n\t0x0006 00006 (sqrt.go:12)\tCVTSQ2SD\tAX, X0\r\n\t0x000b 00011 (sqrt.go:12)\tSQRTSD\tX0, X0\r\n\t0x000f 00015 (sqrt.go:12)\tCVTTSD2SQ\tX0, AX\r\n\t0x0014 00020 (sqrt.go:13)\tMOVL\t$3, CX\r\n\t0x0019 00025 (sqrt.go:13)\tCMPL\tCX, AX\r\n\t0x001b 00027 (sqrt.go:13)\tJHI\t$0, 36\r\n\t0x001d 00029 (sqrt.go:13)\tADDL\t$2, CX\r\n\t0x0020 00032 (sqrt.go:13)\tCMPL\tCX, AX\r\n\t0x0022 00034 (sqrt.go:13)\tJLS\t$0, 29\r\n\t0x0024 00036 (sqrt.go:18)\tRET\r\n```\r\n\r\nObserve that with tighten disabled, we do have to generate an extra CMPL, so in some sense, tighten is doing its job...it just has no idea that the value calculation it moved is so expensive that it's worth keeping out of the loop. Not sure what the right approach is here.\r\n",
	"user": {
		"login": "josharian",
		"id": 67496,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2016-07-21T14:10:45Z",
	"updated_at": "2016-07-21T14:10:45Z"
}
