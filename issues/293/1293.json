{
	"id": 51277607,
	"number": 1293,
	"state": "closed",
	"title": "cmd/cgo: problem with forward-declared enum",
	"body": "by **aotto1968zwei**:\n\n\u003cpre\u003eBefore filing a bug, please check whether it has been fixed since\nthe latest release: run \u0026quot;hg pull -u\u0026quot; and retry what you did to\nreproduce the problem.  Thanks.\n\nhg pull -u -\u0026gt; done, same error\n\n\u0026gt; make\nCGOPKGPATH= cgo -- -I . -I ./../../libmsgque -DMQ_IGNORE_EXTERN MqS.go MqSException.go\nMqBufferS.go MqBinary.go send.go read.go link.go config.go service.go\nunrecognized Go type \u0026amp;{- 0x2aadded25af0 false}\nunrecognized Go type \u0026amp;{- 0x2aadded25af0 false}\nunrecognized Go type \u0026amp;{- 0x2aadded25af0 false}\nunrecognized Go type \u0026amp;{- 0x2aadded25af0 false}\nunrecognized Go type \u0026amp;{- 0x2aadded25af0 false}\nunrecognized Go type \u0026amp;{- 0x2aadded25af0 false}\nunrecognized Go type \u0026amp;{- 0x2aadded25af0 false}\nunrecognized Go type \u0026amp;{- 0x2aadded25af0 false}\nunrecognized Go type \u0026amp;{- 0x2aadded25af0 false}\nunrecognized Go type \u0026amp;{- 0x2aadded25af0 false}\n6g -o _go_.6  MqS.cgo1.go MqSException.cgo1.go MqBufferS.cgo1.go MqBinary.cgo1.go\nsend.cgo1.go read.cgo1.go link.cgo1.go config.cgo1.go service.cgo1.go _cgo_gotypes.go\n6c -FVw -I\u0026quot;/home/dev1usr/src/go/src/pkg/runtime\u0026quot; _cgo_defun.c\nrm -f _obj/gomsgque.a\ngopack grc _obj/gomsgque.a _go_.6  _cgo_defun.6\ncp _obj/gomsgque.a \u0026quot;/home/dev1usr/src/go/pkg/linux_amd64/gomsgque.a\u0026quot;\ngcc -m64 -fPIC -O2 -o MqS.cgo2.o -c -I . -I ./../../libmsgque -DMQ_IGNORE_EXTERN\nMqS.cgo2.c\ngcc -m64 -fPIC -O2 -o MqSException.cgo2.o -c -I . -I ./../../libmsgque\n-DMQ_IGNORE_EXTERN MqSException.cgo2.c\ngcc -m64 -fPIC -O2 -o MqBufferS.cgo2.o -c -I . -I ./../../libmsgque -DMQ_IGNORE_EXTERN\nMqBufferS.cgo2.c\ngcc -m64 -fPIC -O2 -o MqBinary.cgo2.o -c -I . -I ./../../libmsgque -DMQ_IGNORE_EXTERN\nMqBinary.cgo2.c\ngcc -m64 -fPIC -O2 -o send.cgo2.o -c -I . -I ./../../libmsgque -DMQ_IGNORE_EXTERN\nsend.cgo2.c\ngcc -m64 -fPIC -O2 -o read.cgo2.o -c -I . -I ./../../libmsgque -DMQ_IGNORE_EXTERN\nread.cgo2.c\ngcc -m64 -fPIC -O2 -o link.cgo2.o -c -I . -I ./../../libmsgque -DMQ_IGNORE_EXTERN\nlink.cgo2.c\ngcc -m64 -fPIC -O2 -o config.cgo2.o -c -I . -I ./../../libmsgque -DMQ_IGNORE_EXTERN\nconfig.cgo2.c\ngcc -m64 -fPIC -O2 -o service.cgo2.o -c -I . -I ./../../libmsgque -DMQ_IGNORE_EXTERN\nservice.cgo2.c\nservice.cgo2.c: In function '_cgo_Cfunc_MqServiceGetFilter':\nservice.cgo2.c:31:3: error: expected specifier-qualifier-list before '*' token\nservice.cgo2.c:36:3: error: 'struct \u0026lt;anonymous\u0026gt;' has no member named 'r'\nservice.cgo2.c:36:43: error: 'struct \u0026lt;anonymous\u0026gt;' has no member named 'p2'\nmake: *** [service.cgo2.o] Fehler 1\n\n\nWhat steps will reproduce the problem?\ncompile a file with cgo:\nmsgque.h\nMQ_EXTERN enum MqErrorE MQ_DECL MqServiceGetFilter (\n  struct MqS  * const ctx,\n  MQ_SIZE const id,\n  struct MqS ** const filter\n) __attribute__((nonnull(1)));\n\nservice.go:\nfunc (this *MqS) ServiceGetFilter(i int32) *MqS {\n  var ret *_Ctype_struct_MqS\n  this.iErrorMqToGoWithCheck(C.MqServiceGetFilter((*_Ctype_struct_MqS)(this), C.MQ_SIZE(i), \u0026amp;ret))\n  return (*MqS)(ret)\n}\n\nWhat is the expected output?\nservice.cgo2.c:\nvoid\n_cgo_Cfunc_MqServiceGetFilter(void *v)\n{\n        struct {\n                struct MqS* p0;\n                MQ_SIZE p1;\n                char __pad12[4];\n                struct MqS** p2;\n                enum MqErrorE r;\n                char __pad28[4];\n        }\n *a = v;\n        a-\u0026gt;r = MqServiceGetFilter(a-\u0026gt;p0, a-\u0026gt;p1, a-\u0026gt;p2);\n}\n\n\n\nWhat do you see instead?\nservice.cgo2.c:\nvoid\n_cgo_Cfunc_MqServiceGetFilter(void *v)\n{\n        struct {\n                struct MqS* p0;\n                MQ_SIZE p1;\n                char __pad12[4];\n                * p2;\n                enum MqErrorE r;\n                char __pad28[4];\n        }\n *a = v;\n        a-\u0026gt;r = MqServiceGetFilter(a-\u0026gt;p0, a-\u0026gt;p1, a-\u0026gt;p2);\n}\nRESULT:\ngcc -m64 -fPIC -O2 -o service.cgo2.o -c -I . -I ./../../libmsgque -DMQ_IGNORE_EXTERN\nservice.cgo2.c\nservice.cgo2.c: In function '_cgo_Cfunc_MqServiceGetFilter':\nservice.cgo2.c:31:3: error: expected specifier-qualifier-list before '*' token\nservice.cgo2.c:36:3: error: 'struct \u0026lt;anonymous\u0026gt;' has no member named 'r'\nservice.cgo2.c:36:43: error: 'struct \u0026lt;anonymous\u0026gt;' has no member named 'p2'\n\n\n\nWhich compiler are you using (5g, 6g, 8g, gccgo)?\ncgo\n\n\nWhich operating system are you using?\nlinux\u0026gt; uname -a\nLinux linux-w0uy 2.6.34.7-0.5-desktop #1 SMP PREEMPT 2010-10-25 08:40:12 +0200 x86_64\nx86_64 x86_64 GNU/Linux\n\n\nWhich revision are you using?  (hg identify)\n\u0026gt; hg identify\nf85e929d53c7 tip\n\nPlease provide any additional information below.\ncompiling my file service.go with cgo create wrong wrapper code\n\nsteps to solve\n\n1: delete \u0026quot;const\u0026quot; from \u0026quot;struct MqS ** const filter\u0026quot; \n-\u0026gt; error still available\n2. change service.cgo2.c by hand from \u0026quot;* p2\u0026quot; to \u0026quot;struct MqS** p2\u0026quot; \n-\u0026gt; compile ok -\u0026gt; test ok -\u0026gt; works\n\n\nmfg, Andreas Otto\u003c/pre\u003e",
	"user": {
		"login": "gopherbot",
		"id": 8566911,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 20,
	"closed_at": "2014-12-08T10:07:41Z",
	"created_at": "2010-11-22T17:12:16Z",
	"updated_at": "2016-06-24T19:22:31Z"
}
