{
	"id": 51288158,
	"number": 8414,
	"state": "closed",
	"title": "http.TimeoutHandler breaks with GOMAXPROCS n \u003e 1",
	"body": "by **steinar@plainvanillagames.com**:\n\n\u003cpre\u003e*What does 'go version' print?*\n\ngo version go1.3 darwin/amd64\n\n*What steps reproduce the problem?*\n\nRunning the following code (also attached) with 2 or more processes:\n\u003ca href=\"http://play.golang.org/p/eDtbVWdoMw\"\u003ehttp://play.golang.org/p/eDtbVWdoMw\u003c/a\u003e\nSince play.golang.org allows only one process per execution, the error cannot be\nreproduced there.\n\n1. Create a TimeoutHandler\n2. Make it timeout while handler is writing to the ResponseWriter buffer\n\nWhat happened?\n\nPanic.\n\n1. Handler starts writing to the ResponseWriter\n2. Timeout occurs and ServeHTTP returns.  Meanwhile the original handler is still\nrunning in a  go routine.\n3. Bufio panics because buffer is dereferenced \n\nWhat should have happened instead?\n\nEither of the following would have been expected:\n\n* ResponseWriter is locked while being written to\n  * Timeout trigger should have waited for the ongoing Write to complete\n* Timeout should not occur if write has started\n\nPlease provide any additional information below.\n\nThe following is a stack trace of *timeout.go* running on a Macbook Pro.\n\n{{{\n2014/07/23 11:13:57 http: multiple response.WriteHeader calls\npanic: runtime error: slice bounds out of range\n\ngoroutine 8692 [running]:\nruntime.panic(0x269820, 0x40666f)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/runtime/panic.c:279 +0xf5\nbufio.(*Writer).flush(0xc208038080, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/bufio/bufio.go:530 +0x256\nbufio.(*Writer).Write(0xc208038080, 0xc20810e700, 0x1770, 0x1b00, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/bufio/bufio.go:566 +0x203\nnet/http.(*chunkWriter).Write(0xc2081dc7a0, 0xc20810e700, 0x1770, 0x1b00, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:261 +0x2a0\nbufio.(*Writer).Write(0xc208038100, 0xc20810e700, 0x1770, 0x1b00, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/bufio/bufio.go:562 +0xd9\nnet/http.(*response).write(0xc2081dc780, 0x1770, 0xc20810e700, 0x1770, 0x1b00, 0x2983d0,\n0x0, 0x100000000, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:987 +0x1de\nnet/http.(*response).Write(0xc2081dc780, 0xc20810e700, 0x1770, 0x1b00, 0x3ff408, 0x0,\n0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:959 +0x7b\nnet/http.(*timeoutWriter).Write(0xc2080c12c0, 0xc20810e700, 0x1770, 0x1b00, 0x0, 0x0,\n0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:1924 +0xf5\nmain.handlerFn(0x4afad0, 0xc2080c12c0, 0xc20809f860)\n\t/Users/steinar/projects/quizup/quizup-presence/src/examples/timeout.go:36 +0x289\nnet/http.HandlerFunc.ServeHTTP(0x31b6d0, 0x4afad0, 0xc2080c12c0, 0xc20809f860)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:1235 +0x40\nnet/http.func·014()\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:1888 +0xa4\ncreated by net/http.(*timeoutHandler).ServeHTTP\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:1890 +0x142\n\ngoroutine 16 [chan receive]:\nmain.main()\n\t/Users/steinar/projects/quizup/quizup-presence/src/examples/timeout.go:62 +0x12a\n\ngoroutine 19 [finalizer wait]:\nruntime.park(0x147d0, 0x40a200, 0x408d09)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/runtime/proc.c:1369 +0x89\nruntime.parkunlock(0x40a200, 0x408d09)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/runtime/proc.c:1385 +0x3b\nrunfinq()\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/runtime/mgc0.c:2644 +0xcf\nruntime.goexit()\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/runtime/proc.c:1445\n\ngoroutine 20 [IO wait]:\nnet.runtime_pollWait(0x4af730, 0x72, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/runtime/netpoll.goc:146 +0x66\nnet.(*pollDesc).Wait(0xc20802a140, 0x72, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/fd_poll_runtime.go:84 +0x46\nnet.(*pollDesc).WaitRead(0xc20802a140, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/fd_poll_runtime.go:89 +0x42\nnet.(*netFD).accept(0xc20802a0e0, 0x31b7e8, 0x0, 0x4ae290, 0x23)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/fd_unix.go:409 +0x343\nnet.(*TCPListener).AcceptTCP(0xc20803a028, 0x3bf18, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/tcpsock_posix.go:234 +0x5d\nnet.(*TCPListener).Accept(0xc20803a028, 0x0, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/tcpsock_posix.go:244 +0x4b\nnet/http/httptest.(*historyListener).Accept(0xc208022a80, 0x0, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/httptest/server.go:48 +0x7e\nnet/http.(*Server).Serve(0xc2080041e0, 0x4af7e0, 0xc208022a80, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:1698 +0x91\ncreated by net/http/httptest.(*Server).Start\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/httptest/server.go:109 +0x2a3\n\ngoroutine 21 [select]:\nnet/http.(*persistConn).roundTrip(0xc20821e420, 0xc208000fa0, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/transport.go:1015 +0x6db\nnet/http.(*Transport).RoundTrip(0xc208046100, 0xc20809f790, 0xc20818dd10, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/transport.go:208 +0x49a\nnet/http.send(0xc20809f790, 0x4ae5c0, 0xc208046100, 0xc2081acaa4, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/client.go:195 +0x43d\nnet/http.(*Client).send(0x40b4a0, 0xc20809f790, 0x23, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/client.go:118 +0x15b\nnet/http.(*Client).doFollowingRedirects(0x40b4a0, 0xc20809f790, 0x31b858, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/client.go:343 +0x97f\nnet/http.(*Client).Do(0x40b4a0, 0xc20809f790, 0xc20818dd10, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/client.go:150 +0xa3\nmain.func·001()\n\t/Users/steinar/projects/quizup/quizup-presence/src/examples/timeout.go:50 +0xf0\ncreated by main.main\n\t/Users/steinar/projects/quizup/quizup-presence/src/examples/timeout.go:59 +0xf2\n\ngoroutine 8671 [select]:\nnet/http.(*persistConn).writeLoop(0xc20821e420)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/transport.go:885 +0x38f\ncreated by net/http.(*Transport).dialConn\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/transport.go:601 +0x957\n\ngoroutine 8691 [runnable]:\nnet.(*pollDesc).PrepareWrite(0xc2081bc6f0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/fd_poll_runtime.go:79\nnet.(*netFD).Write(0xc2081bc690, 0xc208096000, 0x93, 0x1000, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/fd_unix.go:312 +0x108\nnet.(*conn).Write(0xc208093ee8, 0xc208096000, 0x93, 0x1000, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/net.go:130 +0xe7\nbufio.(*Writer).flush(0xc208038080, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/bufio/bufio.go:530 +0xe2\nbufio.(*Writer).Flush(0xc208038080, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/bufio/bufio.go:519 +0x39\nnet/http.(*response).finishRequest(0xc2081dc780)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:1003 +0xa0\nnet/http.(*conn).serve(0xc2080e0400)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:1178 +0xab9\ncreated by net/http.(*Server).Serve\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/server.go:1721 +0x313\n\ngoroutine 8670 [IO wait]:\nnet.runtime_pollWait(0x4af680, 0x72, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/runtime/netpoll.goc:146 +0x66\nnet.(*pollDesc).Wait(0xc2081bc530, 0x72, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/fd_poll_runtime.go:84 +0x46\nnet.(*pollDesc).WaitRead(0xc2081bc530, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/fd_poll_runtime.go:89 +0x42\nnet.(*netFD).Read(0xc2081bc4d0, 0xc20809b000, 0x1000, 0x1000, 0x0, 0x4ae290, 0x23)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/fd_unix.go:232 +0x34c\nnet.(*conn).Read(0xc20803bb68, 0xc20809b000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/net.go:122 +0xe7\nnet/http.noteEOFReader.Read(0x4af8a0, 0xc20803bb68, 0xc20821e478, 0xc20809b000, 0x1000,\n0x1000, 0x31d001, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/transport.go:1203 +0x72\nnet/http.(*noteEOFReader).Read(0xc2080f9e00, 0xc20809b000, 0x1000, 0x1000, 0x40, 0x0,\n0x0)\n\t\u0026lt;autogenerated\u0026gt;:124 +0xca\nbufio.(*Reader).fill(0xc2080a8b40)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/bufio/bufio.go:97 +0x1b3\nbufio.(*Reader).Peek(0xc2080a8b40, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/bufio/bufio.go:132 +0x101\nnet/http.(*persistConn).readLoop(0xc20821e420)\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/transport.go:782 +0x95\ncreated by net/http.(*Transport).dialConn\n\t/usr/local/Cellar/go/1.3/libexec/src/pkg/net/http/transport.go:600 +0x93f\nexit status 2\n}}}\u003c/pre\u003e\n\n\n\n\n\nAttachments:\n\n1. \u003ca href=\"https://storage.googleapis.com/go-attachment/8414/0/timeout.go\"\u003etimeout.go\u003c/a\u003e (1491 bytes)\n1. \u003ca href=\"https://storage.googleapis.com/go-attachment/8414/0/output.txt\"\u003eoutput.txt\u003c/a\u003e (23179 bytes)",
	"user": {
		"login": "gopherbot",
		"id": 8566911,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"assignee": {
		"login": "bradfitz",
		"id": 2621,
		"type": "User",
		"site_admin": false
	},
	"comments": 5,
	"closed_at": "2014-12-08T10:46:45Z",
	"created_at": "2014-07-23T11:18:16Z",
	"updated_at": "2016-06-25T01:38:30Z",
	"milestone": {
		"id": 1067218,
		"number": 21,
		"title": "Go1.4"
	}
}
