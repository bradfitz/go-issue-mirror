{
	"id": 72070916,
	"number": 10628,
	"state": "closed",
	"title": "reflect: Call through autogenerated method corrupts memory on ppc64le",
	"body": "I'm very sorry about the quality of this issue report, I've yet to be able to resolve it to a smaller reproduction.\r\n\r\nThe background is we have an API server which instruments types and exposes their methods over an RPC interface. This stack trace is from the sever side, attempting to dispatch to `agent.(*AgentAPIV1).StateServingInfo`\r\n```\r\nunexpected fault address 0xf8010260f8010260\r\nfatal error: fault\r\n[signal 0xb code=0x1 addr=0xf8010260f8010260 pc=0x1e56c]\r\n\r\ngoroutine 229 [running]:\r\nruntime.throw(0xf45d00, 0x5)\r\n        /home/ubuntu/go/src/runtime/panic.go:543 +0x8c fp=0xc2083ff688 sp=0xc2083ff670\r\nruntime.sigpanic()\r\n        /home/ubuntu/go/src/runtime/sigpanic_unix.go:27 +0x2f0 fp=0xc2083ff6d8 sp=0xc2083ff688\r\nruntime.convI2E(0xf8010260f8010258, 0x7c030378e8410070, 0x0, 0x0)\r\n        /home/ubuntu/go/src/runtime/iface.go:256 +0x74 fp=0xc2083ff708 sp=0xc2083ff6e0\r\ngithub.com/juju/juju/apiserver/agent.(*AgentAPIV0).StateServingInfo(0x31f5c8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n        /home/ubuntu/src/github.com/juju/juju/apiserver/agent/agent_v0.go:93 +0xa0 fp=0xc2083ff830 sp=0xc2083ff708\r\ngithub.com/juju/juju/apiserver/agent.(*AgentAPIV1).StateServingInfo(0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n        \u003cautogenerated\u003e:22 +0x40 fp=0xc2083ff838 sp=0xc2083ff830\r\nruntime.call128(0xc208205bd0, 0xe85098, 0xc208398380)\r\n        /home/ubuntu/go/src/runtime/asm_ppc64x.s:413 +0x88 fp=0xc2083ff8c0 sp=0xc2083ff838\r\nreflect.Value.call(0xe84f40, 0xc20802c5f0, 0x913, 0xf30060, 0x4, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n        /home/ubuntu/go/src/reflect/value.go:432 +0xe30 fp=0xc2083ffc00 sp=0xc2083ff8c0\r\nreflect.Value.Call(0xe84f40, 0xc20802c5f0, 0x913, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n        /home/ubuntu/go/src/reflect/value.go:300 +0x94 fp=0xc2083ffc60 sp=0xc2083ffc00\r\ngithub.com/juju/juju/rpc/rpcreflect.newMethod.func6(0xe84f40, 0xc20802c5f0, 0x16, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n        /home/ubuntu/src/github.com/juju/juju/rpc/rpcreflect/type.go:326 +0x1a0 fp=0xc2083ffd60 sp=0xc2083ffc60\r\ngithub.com/juju/juju/apiserver.(*srvCaller).Call(0xc208581500, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n        /home/ubuntu/src/github.com/juju/juju/apiserver/root.go:131 +0xf0 fp=0xc2083ffde8 sp=0xc2083ffd60\r\ngithub.com/juju/juju/rpc.(*Conn).runRequest(0xc208472be0, 0x3fff7fc0ee38, 0xc208581500, 0x1286728, 0x3, 0xc2080a8460, 0x5, 0x1, 0x0, 0x0, ...)\r\n        /home/ubuntu/src/github.com/juju/juju/rpc/server.go:552 +0x114 fp=0xc2083fff28 sp=0xc2083ffde8\r\nruntime.goexit()\r\n        /home/ubuntu/go/src/runtime/asm_ppc64x.s:1132 +0x4 fp=0xc2083fff28 sp=0xc2083fff28\r\ncreated by github.com/juju/juju/rpc.(*Conn).handleRequest\r\n        /home/ubuntu/src/github.com/juju/juju/rpc/server.go:481 +0x5f4\r\n```\r\nhowever `AgentAPIV1` is defined as\r\n```\r\n// AgentAPIV1 implements the version 1 of the API provided to an agent.\r\ntype AgentAPIV1 struct {\r\n        *AgentAPIV0\r\n}\r\n```\r\nSo the compiler has autogenerated `AgentAPIV1.StateServingInfo` and forwarded it to `AgentAPIV0.StateServingInfo`\r\n```\r\ngithub.com/juju/juju/apiserver/agent.(*AgentAPIV0).StateServingInfo(0x31f5c8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n        /home/ubuntu/src/github.com/juju/juju/apiserver/agent/agent_v0.go:93 +0xa0 fp=0xc2083ff830 sp=0xc2083ff708\r\ngithub.com/juju/juju/apiserver/agent.(*AgentAPIV1).StateServingInfo(0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n        \u003cautogenerated\u003e:22 +0x40 fp=0xc2083ff838 sp=0xc2083ff830\r\n```\r\nHowever, looking at the receiver value for `agent.(*AgentAPIV1).StateServingInfo` it is `0x00`, but in the next frame the receiver is `0x31f5c8`, this may be related to the problem.\r\n\r\nThe faulting line,  /home/ubuntu/src/github.com/juju/juju/apiserver/agent/agent_v0.go:93, is\r\n\r\n```\r\nfunc (api *AgentAPIV0) StateServingInfo() (result state.StateServingInfo, err error) {\r\n        auth := api.auth\r\n        fmt.Printf(\"%#v\\n\", auth) // line 93\r\n```\r\nand at this point the value of `auth` is garbage, its interface type and value are random junk, `runtime.convI2E(0xf8010260f8010258, 0x7c030378e8410070, 0x0, 0x0)`\r\n\r\nSo far I have been able to determine that manually adding the forwarding method\r\n```\r\nfunc (api *AgentAPIV1) StateServingInfo() (result state.StateServingInfo, err error) {\r\n        return api.AgentAPIV0.StateServingInfo()\r\n}\r\n```\r\nStops the panic, but I have not yet been able to construct a stand alone reproduction.\r\n\r\nSadly this only happens on our ppc64le system, which is not accessible to others.\r\n\r\n/cc @randall77 @minux @aclements \r\n\r\n",
	"user": {
		"login": "davecheney",
		"id": 7171,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "OS-Linux"
		}
	],
	"comments": 10,
	"closed_at": "2015-08-11T05:36:48Z",
	"created_at": "2015-04-30T05:55:54Z",
	"updated_at": "2015-08-11T05:36:48Z",
	"milestone": {
		"id": 1096159,
		"number": 24,
		"title": "Go1.6"
	}
}
