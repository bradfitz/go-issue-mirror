{
	"id": 108083246,
	"number": 12733,
	"state": "closed",
	"title": "x/net/http2: serverConn.readFrames goroutine leak",
	"body": "Originally from @dvyukov at https://github.com/bradfitz/http2/issues/58, @dvyukov wrote:\r\n\r\n-----\r\n\r\nThe following test leaks serverConn.readFrames goroutines:\r\n```go\r\npackage http2\r\n\r\nimport (\r\n\t\"io\"\r\n\t\"net\"\r\n\t\"net/http\"\r\n\t\"testing\"\r\n\t\"time\"\r\n)\r\n\r\nvar data = \"PRI * HTTP/2.0\\r\\n\\r\\nSM\" +\r\n\t\"\\r\\n\\r\\n\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x96\\x01\\x00nf\" +\r\n\t\"i\\r\\n\\x00\\x00\\x00\\t\\ai\\n\\r\\x01#-9---\\n\\x00\" +\r\n\t\"G\\x01#?M\\x0f\\n\\r\\n\\x00\\x00\\x00\\t\\x0f\\n\\n\\r\\x01#-\" +\r\n\t\"9---\\n\\x00G\\x01#?M\\x0f\\n\\x00G\\x01#?M\\x0f\" +\r\n\t\"\\n\\r\\n\\x00\\x00\\x00\\t\\x0f\\n\\n\\r\\x01#-9---\\n\\x00\" +\r\n\t\"G\\x01#?\\n\\x00\\x00\\x00\\x04\\x00M\\x0f\\n\\r\\n\\x00\\x00\\x01#-\" +\r\n\t\"----[\\x00\\x00\\r\\n\\x00\\x00\\x01#-----[\\x00\" +\r\n\t\"\\x00\\x01\\xff\\xffM\\r\\n\\r\\n\\x00\\x00\\x01#-----\\n\\x00\" +\r\n\t\"\\x00\\r\\n\\x00\\x00\\x19\\t\\ai\\n\\r\\n\\x00\\x00\\x00\\t\\ai\\n\\r\" +\r\n\t\"\\n\\x00\"\r\n\r\nfunc TestFuzz(t *testing.T) {\r\n\tfor i := 0; i \u003c 10; i++ {\r\n\t\ts := \u0026http.Server{}\r\n\t\ts2 := \u0026Server{MaxReadFrameSize: 1 \u003c\u003c 16, PermitProhibitedCipherSuites: true}\r\n\t\tc := \u0026MyConn{[]byte(data), false, false}\r\n\t\ts2.handleConn(s, c, http.HandlerFunc(handler))\r\n\t\tif !c.closed {\r\n\t\t\tpanic(\"connection is not closed\")\r\n\t\t}\r\n\t}\r\n\ttime.Sleep(time.Second)\r\n\tpanic(\"кeady or not, here I come\")\r\n}\r\n\r\nfunc handler(w http.ResponseWriter, req *http.Request) {\r\n\tw.Write([]byte(\"hello\"))\r\n}\r\n\r\ntype MyConn struct {\r\n\tdata    []byte\r\n\tclosed  bool\r\n\twritten bool\r\n}\r\n\r\nfunc (c *MyConn) Read(b []byte) (n int, err error) {\r\n\tif len(c.data) == 0 {\r\n\t\treturn 0, io.EOF\r\n\t}\r\n\tn = copy(b, c.data)\r\n\tc.data = c.data[n:]\r\n\treturn\r\n}\r\n\r\nfunc (c *MyConn) Write(b []byte) (n int, err error) {\r\n\tc.written = true\r\n\treturn len(b), nil\r\n}\r\n\r\nfunc (c *MyConn) Close() error {\r\n\tc.closed = true\r\n\treturn nil\r\n}\r\n\r\nfunc (c *MyConn) LocalAddr() net.Addr {\r\n\treturn \u0026net.TCPAddr{net.IP{127, 0, 0, 1}, 49706, \"\"}\r\n}\r\n\r\nfunc (c *MyConn) RemoteAddr() net.Addr {\r\n\treturn \u0026net.TCPAddr{net.IP{127, 0, 0, 1}, 49706, \"\"}\r\n}\r\n\r\nfunc (c *MyConn) SetDeadline(t time.Time) error {\r\n\treturn nil\r\n}\r\n\r\nfunc (c *MyConn) SetReadDeadline(t time.Time) error {\r\n\treturn nil\r\n}\r\n\r\nfunc (c *MyConn) SetWriteDeadline(t time.Time) error {\r\n\treturn nil\r\n}\r\n```\r\n```\r\npanic: кeady or not, here I come\r\n\r\ngoroutine 5 [running]:\r\ntesting.tRunner.func1(0xc20801a1b0)\r\n\tsrc/testing/testing.go:446 +0x174\r\ngithub.com/bradfitz/http2.TestFuzz(0xc20801a1b0)\r\n\tsrc/github.com/bradfitz/http2/fuzz_test.go:34 +0x2ab\r\ntesting.tRunner(0xc20801a1b0, 0xa4c040)\r\n\tsrc/testing/testing.go:452 +0x9b\r\ncreated by testing.RunTests\r\n\tsrc/testing/testing.go:560 +0xa2a\r\n\r\ngoroutine 1 [chan receive]:\r\ntesting.RunTests(0x90c700, 0xa4be60, 0x61, 0x61, 0xa4e601)\r\n\tsrc/testing/testing.go:561 +0xa6a\r\ntesting.(*M).Run(0xc20804ff38, 0x7f53aa89b368)\r\n\tsrc/testing/testing.go:490 +0x73\r\nmain.main()\r\n\tgithub.com/bradfitz/http2/_test/_testmain.go:250 +0x119\r\n\r\ngoroutine 9 [chan send]:\r\ngithub.com/bradfitz/http2.(*serverConn).readFrames(0xc20808c280)\r\n\tsrc/github.com/bradfitz/http2/server.go:544 +0x117\r\ncreated by github.com/bradfitz/http2.(*serverConn).serve\r\n\tsrc/github.com/bradfitz/http2/server.go:626 +0x69c\r\n\r\ngoroutine 14 [chan send]:\r\ngithub.com/bradfitz/http2.(*serverConn).readFrames(0xc20808c500)\r\n\tsrc/github.com/bradfitz/http2/server.go:544 +0x117\r\ncreated by github.com/bradfitz/http2.(*serverConn).serve\r\n\tsrc/github.com/bradfitz/http2/server.go:626 +0x69c\r\n\r\ngoroutine 18 [chan send]:\r\ngithub.com/bradfitz/http2.(*serverConn).readFrames(0xc20808c780)\r\n\tsrc/github.com/bradfitz/http2/server.go:544 +0x117\r\ncreated by github.com/bradfitz/http2.(*serverConn).serve\r\n\tsrc/github.com/bradfitz/http2/server.go:626 +0x69c\r\n\r\ngoroutine 21 [chan send]:\r\ngithub.com/bradfitz/http2.(*serverConn).readFrames(0xc20808ca00)\r\n\tsrc/github.com/bradfitz/http2/server.go:544 +0x117\r\ncreated by github.com/bradfitz/http2.(*serverConn).serve\r\n\tsrc/github.com/bradfitz/http2/server.go:626 +0x69c\r\n\r\ngoroutine 24 [chan send]:\r\ngithub.com/bradfitz/http2.(*serverConn).readFrames(0xc20808cc80)\r\n\tsrc/github.com/bradfitz/http2/server.go:544 +0x117\r\ncreated by github.com/bradfitz/http2.(*serverConn).serve\r\n\tsrc/github.com/bradfitz/http2/server.go:626 +0x69c\r\n\r\ngoroutine 27 [chan send]:\r\ngithub.com/bradfitz/http2.(*serverConn).readFrames(0xc20808cf00)\r\n\tsrc/github.com/bradfitz/http2/server.go:544 +0x117\r\ncreated by github.com/bradfitz/http2.(*serverConn).serve\r\n\tsrc/github.com/bradfitz/http2/server.go:626 +0x69c\r\n\r\ngoroutine 30 [chan send]:\r\ngithub.com/bradfitz/http2.(*serverConn).readFrames(0xc20808d180)\r\n\tsrc/github.com/bradfitz/http2/server.go:544 +0x117\r\ncreated by github.com/bradfitz/http2.(*serverConn).serve\r\n\tsrc/github.com/bradfitz/http2/server.go:626 +0x69c\r\n\r\ngoroutine 33 [chan send]:\r\ngithub.com/bradfitz/http2.(*serverConn).readFrames(0xc20808d400)\r\n\tsrc/github.com/bradfitz/http2/server.go:544 +0x117\r\ncreated by github.com/bradfitz/http2.(*serverConn).serve\r\n\tsrc/github.com/bradfitz/http2/server.go:626 +0x69c\r\n\r\ngoroutine 36 [chan send]:\r\ngithub.com/bradfitz/http2.(*serverConn).readFrames(0xc20808d680)\r\n\tsrc/github.com/bradfitz/http2/server.go:544 +0x117\r\ncreated by github.com/bradfitz/http2.(*serverConn).serve\r\n\tsrc/github.com/bradfitz/http2/server.go:626 +0x69c\r\n\r\ngoroutine 39 [chan send]:\r\ngithub.com/bradfitz/http2.(*serverConn).readFrames(0xc20808d900)\r\n\tsrc/github.com/bradfitz/http2/server.go:544 +0x117\r\ncreated by github.com/bradfitz/http2.(*serverConn).serve\r\n\tsrc/github.com/bradfitz/http2/server.go:626 +0x69c\r\n```\r\non commit b6255645465a25b25f804acb9b3a54009e80c2a4",
	"user": {
		"login": "bradfitz",
		"id": 2621,
		"type": "User",
		"site_admin": false
	},
	"assignee": {
		"login": "bradfitz",
		"id": 2621,
		"type": "User",
		"site_admin": false
	},
	"comments": 1,
	"closed_at": "2015-10-13T15:22:09Z",
	"created_at": "2015-09-24T08:25:01Z",
	"updated_at": "2015-10-13T15:22:09Z",
	"milestone": {
		"id": 1096159,
		"number": 24,
		"title": "Go1.6"
	}
}
