{
	"id": 59250416,
	"number": 10026,
	"state": "closed",
	"title": "runtime: Invalid heap pointer error in init() on Windows only using Go 1.4.2",
	"body": "We are seeing this error on Windows 2008r2 64-bit when running our tests:\r\n\r\n```\r\nruntime: garbage collector found invalid heap pointer *(0xd74360+0x4a8)=0x9 s=nil\r\nfatal error: invalid heap pointer\r\n\r\nruntime stack:\r\nruntime.throw(0xd66643)\r\n  c:/go/src/runtime/panic.go:491 +0xad fp=0x6fb90 sp=0x6fb60\r\nscanblock(0xd74360, 0xe3e0, 0x22c4f8)\r\n  c:/go/src/runtime/mgc0.c:381 +0x558 fp=0x6fcd0 sp=0x6fb90\r\nmarkroot(0xc0820020e0, 0x1)\r\n  c:/go/src/runtime/mgc0.c:499 +0x170 fp=0x6fd30 sp=0x6fcd0\r\nruntime.parfordo(0xc0820020e0)\r\n  c:/go/src/runtime/parfor.c:76 +0xb9 fp=0x6fdb0 sp=0x6fd30\r\ngc(0x6fee8)\r\n  c:/go/src/runtime/mgc0.c:1442 +0x26c fp=0x6fec8 sp=0x6fdb0\r\nruntime.gc_m()\r\n  c:/go/src/runtime/mgc0.c:1371 +0x103 fp=0x6ff00 sp=0x6fec8\r\nruntime.onM(0xd76e90)\r\n  c:/go/src/runtime/asm_amd64.s:257 +0x6d fp=0x6ff08 sp=0x6ff00\r\nruntime.mstart()\r\n  c:/go/src/runtime/proc.c:818 fp=0x6ff10 sp=0x6ff08\r\n\r\ngoroutine 1 [garbage collection, locked to thread]:\r\nruntime.switchtoM()\r\n  c:/go/src/runtime/asm_amd64.s:198 fp=0xc0820676d8 sp=0xc0820676d0\r\nruntime.gogc(0x0)\r\n  c:/go/src/runtime/malloc.go:469 +0x1d6 fp=0xc082067710 sp=0xc0820676d8\r\nruntime.mallocgc(0xa0, 0x9f0bc0, 0xc000000000, 0x220000)\r\n  c:/go/src/runtime/malloc.go:341 +0x398 fp=0xc0820677c0 sp=0xc082067710\r\nruntime.newarray(0x9f0bc0, 0x4, 0x60000c081fffb4f)\r\n  c:/go/src/runtime/malloc.go:365 +0xc8 fp=0xc0820677f8 sp=0xc0820677c0\r\nruntime.growslice(0x8c8700, 0xc08200c3c0, 0x2, 0x2, 0x1, 0x0, 0x0, 0x0)\r\n  c:/go/src/runtime/slice.go:87 +0x2c2 fp=0xc082067858 sp=0xc0820677f8\r\nregexp/syntax.(*compiler).rune(0xc082044078, 0xc08200e950, 0x4, 0x4, 0xc0000000d4, 0x0)\r\n  c:/go/src/regexp/syntax/compile.go:267 +0x102 fp=0xc082067920 sp=0xc082067858\r\nregexp/syntax.(*compiler).compile(0xc082044078, 0xc082002310, 0x0)\r\n  c:/go/src/regexp/syntax/compile.go:119 +0x2e6 fp=0xc082067a00 sp=0xc082067920\r\nregexp/syntax.(*compiler).compile(0xc082044078, 0xc082002380, 0x0)\r\n  c:/go/src/regexp/syntax/compile.go:142 +0x6be fp=0xc082067ae0 sp=0xc082067a00\r\nregexp/syntax.(*compiler).compile(0xc082044078, 0xc082002460, 0x0)\r\n  c:/go/src/regexp/syntax/compile.go:156 +0x9a4 fp=0xc082067bc0 sp=0xc082067ae0\r\nregexp/syntax.Compile(0xc082002460, 0xc082002460, 0x0, 0x0)\r\n  c:/go/src/regexp/syntax/compile.go:83 +0x7f fp=0xc082067c88 sp=0xc082067bc0\r\nregexp.compile(0xa96a90, 0x9, 0xc0820000d4, 0xc08206fb60, 0x0, 0x0)\r\n  c:/go/src/regexp/regexp.go:161 +0x119 fp=0xc082067d30 sp=0xc082067c88\r\nregexp.Compile(0xa96a90, 0x9, 0x1, 0x0, 0x0)\r\n  c:/go/src/regexp/regexp.go:118 +0x57 fp=0xc082067d68 sp=0xc082067d30\r\nregexp.MustCompile(0xa96a90, 0x9, 0x22dc40)\r\n  c:/go/src/regexp/regexp.go:219 +0x47 fp=0xc082067e00 sp=0xc082067d68\r\ngithub.com/tolsen/slogger/v2.init()\r\n  c:/Users/Administrator/Documents/GitHub/mms-automation/go_planner/src/github.com/tolsen/slogger/v2/context.go:59 +0x93 fp=0xc082067e20 sp=0xc082067e00\r\ngithub.com/tolsen/slogger/v2/rolling_file_appender.init()\r\n  c:/Users/Administrator/Documents/GitHub/mms-automation/go_planner/src/github.com/tolsen/slogger/v2/rolling_file_appender/rolling_file_appender.go:460 +0x6a fp=0xc082067e40 sp=0xc082067e20\r\ncom.tengen/cm/util.init()\r\n  c:/Users/Administrator/Documents/GitHub/mms-automation/go_planner/src/com.tengen/cm/util/uri.go:9 +0x89 fp=0xc082067f30 sp=0xc082067e40\r\ncom.tengen/cm/auth/authtest.init()\r\n  c:/Users/Administrator/Documents/GitHub/mms-automation/go_planner/src/com.tengen/cm/auth/authtest/testharness.go:261 +0x53 fp=0xc082067f38 sp=0xc082067f30\r\ncom.tengen/cm/action.init()\r\n  c:/Users/Administrator/Documents/GitHub/mms-automation/go_planner/src/com.tengen/cm/action/updateshards_test.go:195 +0x5b fp=0xc082067f80 sp=0xc082067f38\r\nmain.init()\r\n  com.tengen/cm/action/_test/_testmain.go:54 +0x51 fp=0xc082067f98 sp=0xc082067f80\r\nruntime.main()\r\n  c:/go/src/runtime/proc.go:58 +0xeb fp=0xc082067fe0 sp=0xc082067f98\r\nruntime.goexit()\r\n  c:/go/src/runtime/asm_amd64.s:2232 +0x1 fp=0xc082067fe8 sp=0xc082067fe0\r\n\r\ngoroutine 2 [runnable]:\r\nruntime.forcegchelper()\r\n  c:/go/src/runtime/proc.go:90 fp=0xc08201ffe0 sp=0xc08201ffd8\r\nruntime.goexit()\r\n  c:/go/src/runtime/asm_amd64.s:2232 +0x1 fp=0xc08201ffe8 sp=0xc08201ffe0\r\ncreated by runtime.init�~T��~U~V4\r\n  c:/go/src/runtime/proc.go:87 +0x2c\r\n\r\ngoroutine 3 [runnable]:\r\nruntime.bgsweep()\r\n  c:/go/src/runtime/mgc0.go:82 fp=0xc08201dfe0 sp=0xc08201dfd8\r\nruntime.goexit()\r\n  c:/go/src/runtime/asm_amd64.s:2232 +0x1 fp=0xc08201dfe8 sp=0xc08201dfe0\r\ncreated by gc\r\n  c:/go/src/runtime/mgc0.c:1386\r\n\r\ngoroutine 4 [runnable]:\r\nruntime.runfinq()\r\n  c:/go/src/runtime/malloc.go:712 fp=0xc08204dfe0 sp=0xc08204dfd8\r\nruntime.goexit()\r\n  c:/go/src/runtime/asm_amd64.s:2232 +0x1 fp=0xc08204dfe8 sp=0xc08204dfe0\r\ncreated by runtime.createfing\r\n  c:/go/src/runtime/malloc.go:707 +0x65\r\nexit status 2\r\nFAIL  com.tengen/cm/action  0.035s\r\n```\r\n\r\nThe error points to a regexp in a 3rd-party dep, but AFAICT that's a red-herring. I'm able to reproduce the same error with a small number of files found here: https://github.com/leothekim/Invalid-Heap-Pointer-Go-1.4.2-Windows-amd64. The same code does not error on Mac OS X. Setting `GODEBUG=invalidptr=0` gets rid of the error on Windows.\r\n\r\nCuriously, none of the files depends on each other - they just live in the same package. Even more curiously, the error disappears if I removing one of them and run `go test` or the built executable. This suggests something to do with importing the 3rd-party deps impacting how init() methods are evaluating, likely with allocating more memory for somethingorotherhandwave.\r\n\r\nThis also seems related to a number of issues I've seen here with a similar error, though I'm a complete golang n00b, and even less of a Windows person, so I'm not quite sure how to proceed. Still, I hope providing some code that reproduces this is helpful in getting to the bottom of this.",
	"user": {
		"login": "leothekim",
		"id": 487820,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 9,
	"closed_at": "2015-03-03T22:57:43Z",
	"created_at": "2015-02-27T15:27:49Z",
	"updated_at": "2016-06-25T02:02:13Z"
}
