{
	"id": 66063045,
	"body": "\u003ca id=\"c4\"\u003e\u003c/a\u003eComment 4:\n\n\u003cpre\u003eA brand new thread is at the beginning of thr_new and receives a SIGCHLD.  The TLS array\nhas not been set up yet, so sigtramp faults trying to read from g, causing another\nsigtramp, which also faults, but this time SIGSEGV is masked, so the program dies with a\ncore dump.\n\nQuestions for the FreeBSD experts:\n\n1. The thr_new system call sets up TLS using the tls_base and tls_size parameters.  Why\ndo we do it again in thr_start?\n\n2. Why not fill in m-\u003etls[0] = m, m-\u003etls[1] = g in newosproc before thr_new, so that the\nTLS variables are always correct?\n\n3. Should we be disabling signals on the new thread until it has had time to call\nsigaltstack?  This may not be required, since the new thread is running on a sizable\nstack at first.\n\n\n$ acid go_boot*\ngo_bootstrap: freebsd amd64 executable\ncore PC=0x43b9a4 SP=0xf840241668\ncore PC=0x43b85e SP=0xf840092e98\ncore PC=0x4d22f6 SP=0x8006bd498\ncore PC=0x4d22f6 SP=0x8006bc498\ngo_bootstrap.core: freebsd amd64 core dump\n/usr/local/plan9/acid/port\n/usr/local/plan9/acid/amd64\n/usr/rsc/lib/acid\nacid; pid\n100207\nacid; pid\\X\n0x0001876f\nacid; *PC\n0x000000000043b9a4\nacid; *PC\\a\nruntime.sigtramp+0x1b\nacid; *DI  // signal\n0x000000000000000b\nacid; freebsd_amd64_siginfo(*SI)\n\tsigno\t0x0000000b\n\terrno\t00000000\n\tcode\t0x00000001\n\tpid\t00000000\n\tuid\t00000000\n\tstatus\t00000000\n\taddr\t0x0000000000000048\n\tsigval\t0000000000000000\nacid; freebsd_amd64_ucontext(*DX)\n\tsigmask0\t0x00080000\n\tsigmask1\t0xffffffff\n\tsigmask2\t0xffffffff\n\tsigmask3\t0x00439f2e\n\tonstack\t0000000000000000\n\trdi\t0x0000000000000014\n\trsi\t0x000000f840241ed0\n\trdx\t0x000000f840241b60\n\trcx\t0000000000000000\n\tr8\t0x0000000000000002\n\tr9\t0000000000000000\n\trax\t0x00000000000001c7\n\trbx\t0000000000000000\n\trbp\t0000000000000000\n\tr10\t0x000000000001876f\n\tr11\t0x000000f84010fe18\n\tr12\t0x000000000058add0\n\tr13\t0x0000000000000001\n\tr14\t0000000000000000\n\tr15\t0000000000000000\n\ttrapno\t0x0000000c\n\tfs\t0x0013\n\tgs\t0x001b\n\taddr\t0x0000000000000048\n\tflags\t0x00000001\n\tes\t0x003b\n\tds\t0x003b\n\terr\t0x0000000000000004\n\trip\t0x000000000043b9a4\n\tcs\t0x0000000000000043\n\trflags\t0x0000000000010202\n\trsp\t0x000000f840241b08\n\tss\t0x000000000000003b\n\tlen\t0x0000000000000320\n\tfpformat\t0x0000000000010002\n\townedfp\t0x0000000000020002\n\tfpstate0\t0x000000000000037f\n\tfsbase\t0x000000f8402aa050\n\tgsbase\t0000000000000000\nacid; mem(0xf8402aa050-2*8, \"2Y\")  // fsbase (TLS)\n0x000000000001876f 0000000000000000 \nacid; freebsd_amd64_siginfo(0xf840241ed0)  // rsi\n\tsigno\t0x00000014\n\terrno\t00000000\n\tcode\t0x00000001\n\tpid\t0x0000639e\n\tuid\t0x000003e9\n\tstatus\t00000000\n\taddr\t0000000000000000\n\tsigval\t0000000000000000\nacid; freebsd_amd64_ucontext(0xf840241b60)  // rdx\n\tsigmask0\t00000000\n\tsigmask1\t00000000\n\tsigmask2\t00000000\n\tsigmask3\t00000000\n\tonstack\t0000000000000000\n\trdi\t0x000000f8402aa000\n\trsi\t0x0000000000000068\n\trdx\t0x000000f8402aa000\n\trcx\t0x000000f840158340\n\tr8\t0x0000000000000002\n\tr9\t0000000000000000\n\trax\t0x00000000000001c7\n\trbx\t0000000000000000\n\trbp\t0000000000000000\n\tr10\t0x000000f840158340\n\tr11\t0x000000f84010fe18\n\tr12\t0x000000000058add0\n\tr13\t0x0000000000000001\n\tr14\t0000000000000000\n\tr15\t0000000000000000\n\ttrapno\t0x0000000c\n\tfs\t0x0013\n\tgs\t0x001b\n\taddr\t0x000000f83ffdbff8\n\tflags\t0x00000001\n\tes\t0x003b\n\tds\t0x003b\n\terr\t0x0000000000000002\n\trip\t0x000000000043b871\n\tcs\t0x0000000000000043\n\trflags\t0x0000000000000206\n\trsp\t0x000000f840241fa8\n\tss\t0x000000000000003b\n\tlen\t0x0000000000000320\n\tfpformat\t0x0000000000010002\n\townedfp\t0x0000000000020002\n\tfpstate0\t0x000000000000037f\n\tfsbase\t0x000000f8402aa050\n\tgsbase\t0000000000000000\nacid; 0x43b871\\a  // rip\nruntime.thr_start\nacid;\u003c/pre\u003e",
	"user": {
		"login": "rsc",
		"id": 104030,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2012-02-20T00:40:02Z",
	"updated_at": "2014-12-08T10:15:43Z"
}
