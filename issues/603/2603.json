{
	"id": 51279446,
	"number": 2603,
	"state": "closed",
	"title": "cmd/cgo: Mac OS X 10.6 can leak fds to child processes",
	"body": "\u003cpre\u003eFrom rsc@:\r\n\r\n\r\nThe gobuilder binary imports net/http which imports\r\ncrypto/tls, which uses cgo to look up the TLS certificates.\r\nI don't know why the builder would have done that,\r\nbut it does appear to create a Unix domain socket.\r\nIn fact it looks like all kinds of interesting stuff leaks\r\non Snow Leopard:\r\n\r\npackage main\r\n\r\nimport (\r\n       _ \u0026quot;crypto/tls\u0026quot;\r\n       \u0026quot;fmt\u0026quot;\r\n       \u0026quot;net/http\u0026quot;\r\n       \u0026quot;os\u0026quot;\r\n       \u0026quot;os/exec\u0026quot;\r\n)\r\n\r\nfunc main() {\r\n       if len(os.Args) \u0026lt;= 1 {\r\n               http.Get(\u0026quot;\u003ca href=\"https://www.google.com/\"\u003ehttps://www.google.com/\u003c/a\u003e\u0026quot;)\r\n       }\r\n       x, y := exec.Command(\u0026quot;lsof\u0026quot;, \u0026quot;-p\u0026quot;, fmt.Sprint(os.Getpid())).CombinedOutput()\r\n       fmt.Printf(\u0026quot;%s\\n%v\\n\u0026quot;, x, y)\r\n       if len(os.Args) \u0026lt;= 1 {\r\n               x, y = exec.Command(os.Args[0], \u0026quot;child\u0026quot;).CombinedOutput()\r\n               fmt.Printf(\u0026quot;%s\\n%v\\n\u0026quot;, x, y)\r\n       }\r\n}\r\n\r\n$ go run x.go\r\nCOMMAND   PID USER   FD     TYPE             DEVICE  SIZE/OFF     NODE NAME\r\na.out   31270  rsc  cwd      DIR               14,2      5678 515126\r\n/Users/rsc\r\na.out   31270  rsc  txt      REG               14,2   3478748 10616124\r\n/private/var/folders/++/++-J9E++6+0++4RjPqRgNE++JGo/-Tmp-/go-build193370353/_/x/_obj/a.out\r\na.out   31270  rsc  txt      REG               14,2     51288 10616126\r\n/private/var/folders/++/++-J9E++6+0++4RjPqRgNE++JGo/-Caches-/mds/mdsDirectory.db\r\na.out   31270  rsc  txt      REG               14,2     32768 10250465\r\n/private/var/db/mds/messages/se_SecurityMessages\r\na.out   31270  rsc  txt      REG               14,2     58804  1306892\r\n/Library/Keychains/System.keychain\r\na.out   31270  rsc  txt      REG               14,2    412424  2318973\r\n/System/Library/Keychains/SystemRootCertificates.keychain\r\na.out   31270  rsc  txt      REG               14,2   1054960   463241\r\n/usr/lib/dyld\r\na.out   31270  rsc  txt      REG               14,2 234414080 10250368\r\n/private/var/db/dyld/dyld_shared_cache_x86_64\r\na.out   31270  rsc    0r     CHR                3,2       0t0      299 /dev/null\r\na.out   31270  rsc    1u     CHR                4,8  0t777746      323\r\n/dev/ttyp8\r\na.out   31270  rsc    2u     CHR                4,8  0t777746      323\r\n/dev/ttyp8\r\na.out   31270  rsc    3r     CHR                3,2       0t0      299 /dev/null\r\na.out   31270  rsc    4u    IPv4 0xffffff8024b4da08       0t0      TCP\r\nhelix.cam.corp.google.com:53403-\u0026gt;74.125.226.112:https (ESTABLISHED)\r\na.out   31270  rsc    5u    unix 0xffffff8029897940       0t0\r\n-\u0026gt;0xffffff802435b840\r\na.out   31270  rsc    6     PIPE 0xffffff80290d5940     16384\r\n-\u0026gt;0xffffff801dd7b440\r\na.out   31270  rsc    7     PIPE 0xffffff801dd7b440     16384\r\n-\u0026gt;0xffffff80290d5940\r\na.out   31270  rsc    8u  KQUEUE\r\ncount=0, state=0x2\r\na.out   31270  rsc    9u  KQUEUE\r\ncount=0, state=0x2\r\na.out   31270  rsc   10r     CHR                9,1    0t4096      574\r\n/dev/urandom\r\na.out   31270  rsc   12     PIPE 0xffffff801dd794a0     16384\r\n-\u0026gt;0xffffff80290d6650\r\n\r\n\u0026lt;nil\u0026gt;\r\nCOMMAND   PID USER   FD   TYPE             DEVICE  SIZE/OFF     NODE NAME\r\na.out   31273  rsc  cwd    DIR               14,2      5678 515126 /Users/rsc\r\na.out   31273  rsc  txt    REG               14,2   3478748 10616124\r\n/private/var/folders/++/++-J9E++6+0++4RjPqRgNE++JGo/-Tmp-/go-build193370353/_/x/_obj/a.out\r\na.out   31273  rsc  txt    REG               14,2   1054960   463241\r\n/usr/lib/dyld\r\na.out   31273  rsc  txt    REG               14,2 234414080 10250368\r\n/private/var/db/dyld/dyld_shared_cache_x86_64\r\na.out   31273  rsc    0r   CHR                3,2       0t0      299 /dev/null\r\na.out   31273  rsc    1   PIPE 0xffffff80290d6650     16384\r\n-\u0026gt;0xffffff801dd794a0\r\na.out   31273  rsc    2   PIPE 0xffffff80290d6650     16384\r\n-\u0026gt;0xffffff801dd794a0\r\na.out   31273  rsc    3r   CHR                3,2       0t0      299 /dev/null\r\na.out   31273  rsc    5u  unix 0xffffff8029897940       0t0\r\n-\u0026gt;0xffffff802435b840\r\na.out   31273  rsc    6   PIPE 0xffffff801dd7b390     16384\r\n-\u0026gt;0xffffff802458d230\r\na.out   31273  rsc   10r   CHR                9,1    0t4096      574\r\n/dev/urandom\r\na.out   31273  rsc   11r   CHR                3,2       0t0      299 /dev/null\r\n\r\n\u0026lt;nil\u0026gt;\r\n\r\nAnd on Lion:\r\n\r\n\r\nCOMMAND  PID USER   FD     TYPE             DEVICE  SIZE/OFF    NODE NAME\r\na.out   1884  rsc  cwd      DIR               14,5     15878  411317 /Users/rsc\r\na.out   1884  rsc  txt      REG               14,5   3486932 3929759\r\n/private/var/folders/mw/qfnx8hhd1_s9mm9wtbng0hw80000gn/T/go-build202841463/_/x/_obj/a.out\r\na.out   1884  rsc  txt      REG               14,5     51288 3929761\r\n/private/var/folders/mw/qfnx8hhd1_s9mm9wtbng0hw80000gn/C/mds/mdsDirectory.db\r\na.out   1884  rsc  txt      REG               14,5     32768 2273792\r\n/private/var/db/mds/messages/se_SecurityMessages\r\na.out   1884  rsc  txt      REG               14,5    599232 1143044\r\n/usr/lib/dyld\r\na.out   1884  rsc  txt      REG               14,5 293486592 1247338\r\n/private/var/db/dyld/dyld_shared_cache_x86_64\r\na.out   1884  rsc    0r     CHR                3,2       0t0     308 /dev/null\r\na.out   1884  rsc    1u     CHR                4,0 0t1342794     318 /dev/ttyp0\r\na.out   1884  rsc    2u     CHR                4,0 0t1342794     318 /dev/ttyp0\r\na.out   1884  rsc    3u   systm                          0t0\r\na.out   1884  rsc    4u    unix 0xffffff801047b900       0t0\r\n-\u0026gt;0xffffff8015222190\r\na.out   1884  rsc    5u    IPv4 0xffffff800e3a26c0       0t0     TCP\r\n192.168.147.131:55231-\u0026gt;lax04s08-in-f18.1e100.net:https (ESTABLISHED)\r\na.out   1884  rsc    6     PIPE 0xffffff800c0b3bd0     16384\r\n-\u0026gt;0xffffff800c0b3910\r\na.out   1884  rsc    7     PIPE 0xffffff800c0b3910     16384\r\n-\u0026gt;0xffffff800c0b3bd0\r\na.out   1884  rsc    8u  KQUEUE\r\ncount=0, state=0x2\r\na.out   1884  rsc    9u  KQUEUE\r\ncount=0, state=0x2\r\na.out   1884  rsc   10r     CHR               11,1    0t4096     585\r\n/dev/urandom\r\na.out   1884  rsc   12     PIPE 0xffffff8010f277e0     16384\r\n-\u0026gt;0xffffff800dc50b00\r\n\r\n\u0026lt;nil\u0026gt;\r\nCOMMAND  PID USER   FD    TYPE             DEVICE  SIZE/OFF    NODE NAME\r\na.out   1888  rsc  cwd     DIR               14,5     15878 411317 /Users/rsc\r\na.out   1888  rsc  txt     REG               14,5   3486932 3929759\r\n/private/var/folders/mw/qfnx8hhd1_s9mm9wtbng0hw80000gn/T/go-build202841463/_/x/_obj/a.out\r\na.out   1888  rsc  txt     REG               14,5    599232 1143044\r\n/usr/lib/dyld\r\na.out   1888  rsc  txt     REG               14,5 293486592 1247338\r\n/private/var/db/dyld/dyld_shared_cache_x86_64\r\na.out   1888  rsc    0r    CHR                3,2       0t0     308 /dev/null\r\na.out   1888  rsc    1    PIPE 0xffffff800dc50b00     16384\r\n-\u0026gt;0xffffff8010f277e0\r\na.out   1888  rsc    2    PIPE 0xffffff800dc50b00     16384\r\n-\u0026gt;0xffffff8010f277e0\r\na.out   1888  rsc    3u  systm                          0t0\r\na.out   1888  rsc    4u   unix 0xffffff801047b900       0t0\r\n-\u0026gt;0xffffff8015222190\r\na.out   1888  rsc    6    PIPE 0xffffff800ffb8d60     16384\r\n-\u0026gt;0xffffff800bdadb80\r\n\r\n\u0026lt;nil\u0026gt;\u003c/pre\u003e",
	"user": {
		"login": "bradfitz",
		"id": 2621,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "Unfortunate"
		}
	],
	"assignee": {
		"login": "rsc",
		"id": 104030,
		"type": "User",
		"site_admin": false
	},
	"comments": 35,
	"closed_at": "2015-04-28T22:58:53Z",
	"created_at": "2011-12-21T23:37:17Z",
	"updated_at": "2015-10-05T01:41:01Z",
	"milestone": {
		"id": 1055141,
		"number": 6,
		"title": "Unplanned"
	}
}
