{
	"id": 51283635,
	"number": 5443,
	"state": "closed",
	"title": "runtime: PreciseGC causing app to crash during longevity tests ",
	"body": "\u003cpre\u003eMy longevity test crashes after handling a few thousand requests. By turning off\nPreciseGC, the crashes stopped.\n\nI have run my application under different linux kernels\n- 3.5.0-26-generic\n- 3.5.0-28-generic\n\nI have used different versions of go1.1:\n- 1.1rc1\n- some older randomly picked version\n- tip\n\nI didn't notice this issue before because I ran my app with ab -n 2000 -c 16\n\u003ca href=\"http://localhost:8001/\"\u003ehttp://localhost:8001/\u003c/a\u003e...\n\nHowever, once I increased it to let it run for hours (e.g. set n to 2000000), it starts\ncrashing after handling a few thousand requests e.g. after 4957, 16688, 1721, 7820,\n8406, 13981 requests. \n\nI've looked through my code over the last 2 days to see if there is something I'm doing,\nand have seen nothing to suggest my code may be the culprit. As expected, I make\njudicious use of sync.Mutex, sync.Cond and channels in my codebase, and I don't copy\nsync.Mutex or sync.Cond anywhere.\n\nHowever, when I switched turned off PreciseGC (by setting IgnorePreciseGC=1 in mgc0.c\nand rebuilding), the crashes stopped, and my load test continued forever (till my HDD /\npartition filled up - I just posted a message on the golang-devs about that). \n\nI use ulimit to prevent an issue in my code from locking up my whole machine (it\nhappened many times during development). So I run my app using sh run.sh, where run.sh\ncontains:\n  ulimit -v 2000000 \u0026amp;\u0026amp; ulimit -c unlimited \u0026amp;\u0026amp; GOTRACEBACK=crash GOMAXPROCS=8 ./myapp\n\nWhen I use gdb to look at the crash, I get that the crash typically happens around the\nsame point, but that point typically changes each time I reboot my machine. The points I\nhave found are:\n\n---------------------------------------\n(gdb) bt\n#0  runtime.raise (sig=void) at /opt/go-tip/src/pkg/runtime/sys_linux_amd64.s:85\n#1  0x000000000041aa1f in runtime.crash ()\n#2  0x0000000000413bd7 in runtime.dopanic (unused=void) at\n/opt/go-tip/src/pkg/runtime/panic.c:434\n#3  0x0000000000413d17 in runtime.throw (s=void) at\n/opt/go-tip/src/pkg/runtime/panic.c:472\n#4  0x0000000000412cc7 in runtime.sigpanic () at\n/opt/go-tip/src/pkg/runtime/os_linux.c:239\n#5  0x000000000041b2eb in runtime.copy (to=void, fm=void, width=void, ret=void)\n    at /opt/go-tip/src/pkg/runtime/slice.c:257\n#6  0x000000000059cdcc in bufio.(*Reader).Read (b=0xc20021f720, p=..., n=1, err=...)\n    at /opt/go-tip/src/pkg/bufio/bufio.go:156\n#7  0x000000000043f327 in io.ReadAtLeast (r=..., buf=..., min=1, n=0, err=...) at\n/opt/go-tip/src/pkg/io/io.go:284\n#8  0x000000000043f47f in io.ReadFull (r=..., buf=..., n=4305628, err=...) at\n/opt/go-tip/src/pkg/io/io.go:302\n#9  0x000000000050fbcd in ugorji.net/ndb.(*client).readD (c=0xc200219870, numToRead=1,\nexpecting=0 '\\000', bs=..., \n    cat=...) at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:141\n#10 0x000000000050ff6d in ugorji.net/ndb.(*client).readTag (c=0xc200219870, v=0 '\\000')\n    at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:156\n#11 0x0000000000511b52 in ugorji.net/ndb.(*Db).SvrQuery (l=0xc2001b0240, ctxId=...,\npkey=0xc2005e6a10, kind=..., \n    opts=0x0, filters=..., qs=..., err=void) at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:421\n#12 0x00000000005222cf in ugorji.net/ndb.func·001 (k3=..., cursor3=..., err3=...)\n    at /home/ugorji/depot/repo/src/ugorji.net/ndb/low_level_driver.go:195\n#13 0x00000000004232e0 in ?? () at /opt/go-tip/src/pkg/runtime/asm_amd64.s:278\n#14 0x0000000000000000 in ?? ()\n(gdb) q\n\n------------------------------------\n(gdb) bt\n#0  runtime.raise (sig=void) at /opt/go-tip/src/pkg/runtime/sys_linux_amd64.s:85\n#1  0x000000000041aa1f in runtime.crash ()\n#2  0x0000000000413bd7 in runtime.dopanic (unused=void) at\n/opt/go-tip/src/pkg/runtime/panic.c:434\n#3  0x0000000000413d17 in runtime.throw (s=void) at\n/opt/go-tip/src/pkg/runtime/panic.c:472\n#4  0x0000000000412cc7 in runtime.sigpanic () at\n/opt/go-tip/src/pkg/runtime/os_linux.c:239\n#5  0x0000000000423c75 in runtime.memmove (to=void, fr=void, n=void)\n    at /opt/go-tip/src/pkg/runtime/memmove_amd64.s:48\n#6  0x000000000041b2dc in runtime.copy (to=void, fm=void, width=void, ret=void)\n    at /opt/go-tip/src/pkg/runtime/slice.c:259\n#7  0x000000000059ce3c in bufio.(*Reader).Read (b=0xc2003044e0, p=..., n=2, err=...)\n    at /opt/go-tip/src/pkg/bufio/bufio.go:156\n#8  0x000000000043f357 in io.ReadAtLeast (r=..., buf=..., min=2, n=0, err=...) at\n/opt/go-tip/src/pkg/io/io.go:284\n#9  0x000000000043f4af in io.ReadFull (r=..., buf=..., n=833226801153, err=...) at\n/opt/go-tip/src/pkg/io/io.go:302\n#10 0x000000000050fbfd in ugorji.net/ndb.(*client).readD (c=0xc20035bd20, numToRead=2,\nexpecting=0 '\\000', bs=..., \n    cat=...) at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:141\n#11 0x000000000051009f in ugorji.net/ndb.(*client).readNumNoTag (c=0xc20035bd20, v=0)\n    at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:184\n#12 0x00000000005106d0 in ugorji.net/ndb.(*client).readSliceNoTag (c=0xc20035bd20, v=...)\n    at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:226\n#13 0x000000000051216b in ugorji.net/ndb.(*Db).SvrQuery (l=0xc2001ae240, ctxId=...,\npkey=0xc2006e2c10, kind=..., \n    opts=0x0, filters=..., qs=..., err=void) at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:439\n#14 0x00000000005222ff in ugorji.net/ndb.func·001 (k3=..., cursor3=..., err3=...)\n    at /home/ugorji/depot/repo/src/ugorji.net/ndb/low_level_driver.go:195\n#15 0x0000000000423310 in ?? () at /opt/go-tip/src/pkg/runtime/asm_amd64.s:278\n#16 0x0000000000000000 in ?? ()\n\n------------------------------------\n\n(gdb) bt\n#0  runtime.raise (sig=void) at /opt/go-tip/src/pkg/runtime/sys_linux_amd64.s:85\n#1  0x000000000041aa1f in runtime.crash ()\n#2  0x0000000000413bd7 in runtime.dopanic (unused=void) at\n/opt/go-tip/src/pkg/runtime/panic.c:434\n#3  0x0000000000413d17 in runtime.throw (s=void) at\n/opt/go-tip/src/pkg/runtime/panic.c:472\n#4  0x0000000000412cc7 in runtime.sigpanic () at\n/opt/go-tip/src/pkg/runtime/os_linux.c:239\n#5  0x00000000007e2881 in string.* ()\n#6  0x000000000059c8cc in bufio.(*Reader).fill (b=0xc2002d7e40) at\n/opt/go-tip/src/pkg/bufio/bufio.go:79\n#7  0x000000000059ccd0 in bufio.(*Reader).Read (b=0xc2002d7e40, p=..., n=1, err=...)\n    at /opt/go-tip/src/pkg/bufio/bufio.go:147\n#8  0x000000000043f327 in io.ReadAtLeast (r=..., buf=..., min=1, n=0, err=...) at\n/opt/go-tip/src/pkg/io/io.go:284\n#9  0x000000000043f47f in io.ReadFull (r=..., buf=..., n=4305628, err=...) at\n/opt/go-tip/src/pkg/io/io.go:302\n#10 0x000000000050fbcd in ugorji.net/ndb.(*client).readD (c=0xc200254640, numToRead=1,\nexpecting=0 '\\000', bs=..., \n    cat=...) at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:141\n#11 0x000000000050ff6d in ugorji.net/ndb.(*client).readTag (c=0xc200254640, v=0 '\\000')\n    at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:156\n#12 0x0000000000511b52 in ugorji.net/ndb.(*Db).SvrQuery (l=0xc2001af240, ctxId=...,\npkey=0xc20055b830, kind=..., \n    opts=0x0, filters=..., qs=..., err=void) at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:421\n#13 0x00000000005222cf in ugorji.net/ndb.func·001 (k3=..., cursor3=..., err3=...)\n    at /home/ugorji/depot/repo/src/ugorji.net/ndb/low_level_driver.go:195\n#14 0x00000000004232e0 in ?? () at /opt/go-tip/src/pkg/runtime/asm_amd64.s:278\n#15 0x0000000000000000 in ?? ()\n(gdb) \n\n-------------------------------------\n\n(gdb) bt\n#0  runtime.raise (sig=void) at /opt/go-tip/src/pkg/runtime/sys_linux_amd64.s:85\n#1  0x000000000041aa1f in runtime.crash ()\n#2  0x0000000000413bd7 in runtime.dopanic (unused=void) at\n/opt/go-tip/src/pkg/runtime/panic.c:434\n#3  0x0000000000413d17 in runtime.throw (s=void) at\n/opt/go-tip/src/pkg/runtime/panic.c:472\n#4  0x0000000000412cc7 in runtime.sigpanic () at\n/opt/go-tip/src/pkg/runtime/os_linux.c:239\n#5  0x00000000004232e0 in ?? () at /opt/go-tip/src/pkg/runtime/asm_amd64.s:278\n#6  0x00007f704c166100 in ?? ()\n#7  0x00007f704c166fb8 in ?? ()\n#8  0x00007f704c1660f8 in ?? ()\n#9  0x000000000040b4c7 in runtime.MCentral_AllocList (c=void, n=void, pfirst=void)\n    at /opt/go-tip/src/pkg/runtime/mcentral.c:62\n#10 0x00007f705e3a7000 in ?? ()\n#11 0x00007f705e3f7000 in ?? ()\n#12 0x00007f704c1db000 in ?? ()\n#13 0x00007f704c1e3000 in ?? ()\n#14 0x00007f704c192000 in ?? ()\n#15 0x00007f704c173000 in ?? ()\n#16 0x00007f704c1c9000 in ?? ()\n#17 0x00007f704c0b6000 in ?? ()\n#18 0x00007f704c0d2000 in ?? ()\n#19 0x0000000000000006 in ?? ()\n#20 0x0000000000000280 in ?? ()\n#21 0x000000000041ae99 in runtime.appendstr (t=void, x=void, y=void, ret=void)\n    at /opt/go-tip/src/pkg/runtime/slice.c:147\n#22 0x2010000000000076 in ?? ()\n#23 0x0000000000000001 in ?? ()\n#24 0x0000000000000003 in ?? ()\n#25 0x0000000000410503 in runtime.markallocated (v=void, n=void, noptr=void)\n    at /opt/go-tip/src/pkg/runtime/mgc0.c:2213\n#26 0x000000000041e103 in runtime.mallocgc (size=void, flag=void, dogc=void, zeroed=void)\n    at /opt/go-tip/src/pkg/runtime/malloc.goc:88\n#27 0x000000000041e103 in runtime.mallocgc (size=void, flag=void, dogc=void, zeroed=void)\n    at /opt/go-tip/src/pkg/runtime/malloc.goc:88\n#28 0x0000000000421d5b in gostringsize (ret=void, l=void) at\n/opt/go-tip/src/pkg/runtime/string.goc:48\n#29 0x0000000000422411 in runtime.slicebytetostring (b=void, s=void) at\n/opt/go-tip/src/pkg/runtime/string.goc:274\n#30 0x000000000046533e in strconv.quoteWith (s=640, quote=43 '+', ASCIIonly=false,\n~anon3=...)\n    at /opt/go-tip/src/pkg/strconv/quote.go:82\n#31 0x00000000004660c9 in strconv.Quote (s=..., ~anon1=...) at\n/opt/go-tip/src/pkg/strconv/quote.go:91\n#32 0x000000000042a6ca in fmt.(*fmt).fmt_q (f=0x2010000000017902, s=...) at\n/opt/go-tip/src/pkg/fmt/format.go:325\n---Type \u0026lt;return\u0026gt; to continue, or q \u0026lt;return\u0026gt; to quit---\n#33 0x000000c2004de468 in ?? ()\n#34 0x2010000000017902 in ?? ()\n#35 0x000000000000000a in ?? ()\n#36 0x0000000000000000 in ?? ()\n(gdb) \n\n-----------------------------\n\n(gdb) bt\n#0  runtime.raise (sig=void) at /opt/go-tip/src/pkg/runtime/sys_linux_amd64.s:85\n#1  0x000000000041aa1f in runtime.crash ()\n#2  0x0000000000413bd7 in runtime.dopanic (unused=void) at\n/opt/go-tip/src/pkg/runtime/panic.c:434\n#3  0x0000000000413d17 in runtime.throw (s=void) at\n/opt/go-tip/src/pkg/runtime/panic.c:472\n#4  0x0000000000412ca7 in runtime.sigpanic () at\n/opt/go-tip/src/pkg/runtime/os_linux.c:239\n#5  0x000000000040a8e7 in runtime.efacethash (e1=void, ret=void) at\n/opt/go-tip/src/pkg/runtime/iface.c:670\n#6  0x000000000042f042 in fmt.(*pp).printField (p=0xc200130d00, field=..., verb=118,\nplus=false, goSyntax=false, \n    depth=0, wasString=false) at /opt/go-tip/src/pkg/fmt/print.go:765\n#7  0x00000000004348c6 in fmt.(*pp).doPrintf (p=..., format=..., a=...) at\n/opt/go-tip/src/pkg/fmt/print.go:1111\n#8  0x000000000042bfa5 in fmt.Sprintf (format=..., a=..., ~anon2=...) at\n/opt/go-tip/src/pkg/fmt/print.go:229\n#9  0x0000000000534d4a in ugorji.net/logging.logR (calldepth=2 '\\002', ctx=...,\nlevel=1000, message=..., \n    params=..., err=void) at /home/ugorji/depot/repo/src/ugorji.net/logging/logging.go:264\n#10 0x0000000000535053 in ugorji.net/logging.Trace (ctx=..., message=..., params=...,\n~anon3=...)\n    at /home/ugorji/depot/repo/src/ugorji.net/logging/logging.go:284\n#11 0x0000000000511b9a in ugorji.net/ndb.(*Db).SvrQuery (l=0xc2001b0240, ctxId=...,\npkey=0xc200968630, kind=..., \n    opts=0x0, filters=..., qs=..., err=void) at /home/ugorji/depot/repo/src/ugorji.net/ndb/client.go:422\n#12 0x000000000052235f in ugorji.net/ndb.func·001 (k3=..., cursor3=..., err3=...)\n    at /home/ugorji/depot/repo/src/ugorji.net/ndb/low_level_driver.go:195\n#13 0x00000000004232e0 in ?? () at /opt/go-tip/src/pkg/runtime/asm_amd64.s:278\n#14 0x0000000000000000 in ?? ()\n\n------------------------------------\n\nWhich compiler are you using (5g, 6g, 8g, gccgo)?\n6g\n\nWhich operating system are you using?\nLinux 3.5.0-28-generic #42-Ubuntu SMP Fri Mar 8 23:18:20 UTC 2013 x86_64 x86_64 x86_64\nGNU/Linux\n\n\nWhich version are you using?  (run 'go version')\ngo version devel +30c566874b83 Wed May 08 16:06:25 2013 -0700 linux/amd64\n\nPlease provide any additional information below.\u003c/pre\u003e",
	"user": {
		"login": "ugorji",
		"id": 1222082,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 19,
	"closed_at": "2014-12-08T10:29:28Z",
	"created_at": "2013-05-11T17:25:26Z",
	"updated_at": "2016-06-24T22:39:47Z",
	"milestone": {
		"id": 1067200,
		"number": 12,
		"title": "Go1.1.1"
	}
}
