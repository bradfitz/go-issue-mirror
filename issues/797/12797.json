{
	"id": 109134966,
	"number": 12797,
	"state": "closed",
	"title": "runtime: Channel blocks with odd len",
	"body": "I am pushing few messages via channel from C library (code is here https://bitbucket.org/svidyuk/lbmgo)\r\n\r\nAfter processing 1-100 messages(tried with GOGC=off as well) I see that incoming channel(https://bitbucket.org/svidyuk/lbmgo/src/a9618e6ee1cd94a5237b12d2a1043408562c8f32/lbm.go?at=master\u0026fileviewer=file-view-default#lbm.go-28) length jumps to very large number 859531108376.\r\n\r\nAt his stage all following pushes of messages block indefinitely and no new incoming data is processed.\r\n\r\nThis is the case for both 1.4.2 and 1.5.0\r\n\r\nAddress of the incoming channel is always  the same.\r\n\r\nSimple program that I use:\r\n```\r\nvar bboChan chan *lbm.Message\r\nvar receiver *lbm.WildcardReceiver\r\n\r\nfunc listenBBO() {\r\n  for {\r\n    msg := \u003c-bboChan\r\n    if msg.MsgType == lbm.MSG_DATA {\r\n      glog.Infoln(\"message\", msg)\r\n    }\r\n  }\r\n\r\n}\r\nfunc subscribeBBO() {\r\n  glog.Infoln(\"Configuring LBM component\")\r\n  err := lbm.Config(\"test.xml\")\r\n  if err != nil {\r\n    glog.Infoln(\"Failed to configure subscription. Using defaults\", err)\r\n  }\r\n  glog.Infoln(\"Setting up new context\")\r\n  ctx, err := lbm.NewContext()\r\n  if err != nil {\r\n    glog.Infoln(\"Failed to create context\", err)\r\n    return\r\n  }\r\n  bboChan = make(chan *lbm.Message, 1000)\r\n  receiver, err = ctx.NewWildcardReceiver(\"/test/.*\", bboChan)\r\n  if err != nil {\r\n    glog.Infoln(\"Failed to subscribe to bbo\")\r\n    return\r\n  }\r\n  go listenBBO()\r\n}\r\n\r\n```\r\n\r\nStack trace once len(incoming) is very large looks like:\r\n```\r\npanic: test\r\n\r\ngoroutine 17 [running, locked to thread]:\r\nbitbucket.org/svidyuk/lbmgo.lbm_receiver_callback(0x0, 0x7f61fc0d9270, 0xc8200be028, 0x0)\r\n        /home/sergey/go/src/bitbucket.org/svidyuk/lbmgo/lbm.go:39 +0x3b6\r\n\r\ngoroutine 1 [IO wait]:\r\nnet.runtime_pollWait(0x7f621aba5d78, 0x72, 0xc820014190)\r\n        /usr/lib/golang/src/runtime/netpoll.go:157 +0x60\r\nnet.(*pollDesc).Wait(0xc8201da450, 0x72, 0x0, 0x0)\r\n        /usr/lib/golang/src/net/fd_poll_runtime.go:73 +0x3a\r\nnet.(*pollDesc).WaitRead(0xc8201da450, 0x0, 0x0)\r\n        /usr/lib/golang/src/net/fd_poll_runtime.go:78 +0x36\r\nnet.(*netFD).accept(0xc8201da3f0, 0x0, 0x7f6218112430, 0xc8200bb240)\r\n        /usr/lib/golang/src/net/fd_unix.go:408 +0x27c\r\nnet.(*TCPListener).AcceptTCP(0xc8200be078, 0xc8200e5bd8, 0x0, 0x0)\r\n        /usr/lib/golang/src/net/tcpsock_posix.go:254 +0x4d\r\nnet/http.tcpKeepAliveListener.Accept(0xc8200be078, 0x0, 0x0, 0x0, 0x0)\r\n        /usr/lib/golang/src/net/http/server.go:2135 +0x41\r\nnet/http.(*Server).Serve(0xc8200b82a0, 0x7f62181123f8, 0xc8200be078, 0x0, 0x0)\r\n        /usr/lib/golang/src/net/http/server.go:1887 +0xb3\r\nnet/http.(*Server).ListenAndServe(0xc8200b82a0, 0x0, 0x0)\r\n        /usr/lib/golang/src/net/http/server.go:1877 +0x136\r\nnet/http.ListenAndServe(0xc820104670, 0x6, 0x0, 0x0, 0x0, 0x0)\r\n        /usr/lib/golang/src/net/http/server.go:1967 +0x8f\r\nmain.main()\r\n        /home/sergey/go/src/posmanager/posmanager.go:358 +0x9e7\r\n\r\ngoroutine 5 [chan receive]:\r\ngithub.com/golang/glog.(*loggingT).flushDaemon(0xc945a0)\r\n        /home/sergey/go/src/github.com/golang/glog/glog.go:879 +0x67\r\ncreated by github.com/golang/glog.init.1\r\n        /home/sergey/go/src/github.com/golang/glog/glog.go:410 +0x297\r\n\r\ngoroutine 6 [syscall]:\r\nos/signal.loop()\r\n        /usr/lib/golang/src/os/signal/signal_unix.go:22 +0x18\r\ncreated by os/signal.init.1\r\n        /usr/lib/golang/src/os/signal/signal_unix.go:28 +0x37\r\n\r\ngoroutine 9 [chan receive]:\r\ndatabase/sql.(*DB).connectionOpener(0xc820017360)\r\n        /usr/lib/golang/src/database/sql/sql.go:634 +0x45\r\ncreated by database/sql.Open\r\n        /usr/lib/golang/src/database/sql/sql.go:481 +0x336\r\n\r\ngoroutine 11 [IO wait]:\r\nnet.runtime_pollWait(0x7f621aba5ef8, 0x72, 0xc820014190)\r\n        /usr/lib/golang/src/runtime/netpoll.go:157 +0x60\r\nnet.(*pollDesc).Wait(0xc820102e60, 0x72, 0x0, 0x0)\r\n        /usr/lib/golang/src/net/fd_poll_runtime.go:73 +0x3a\r\nnet.(*pollDesc).WaitRead(0xc820102e60, 0x0, 0x0)\r\n        /usr/lib/golang/src/net/fd_poll_runtime.go:78 +0x36\r\nnet.(*netFD).Read(0xc820102e00, 0xc820178000, 0x1000, 0x1000, 0x0, 0x7f621aba0050, 0xc820014190)\r\n        /usr/lib/golang/src/net/fd_unix.go:232 +0x23a\r\nnet.(*conn).Read(0xc8200580b0, 0xc820178000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n        /usr/lib/golang/src/net/net.go:172 +0xe4\r\nbufio.(*Reader).fill(0xc820022840)\r\n        /usr/lib/golang/src/bufio/bufio.go:97 +0x1e9\r\nbufio.(*Reader).Read(0xc820022840, 0xc8201d8bf0, 0x8, 0x8, 0x75bd20, 0x0, 0x0)\r\n        /usr/lib/golang/src/bufio/bufio.go:207 +0x260\r\nio.ReadAtLeast(0x7f621814e080, 0xc820022840, 0xc8201d8bf0, 0x8, 0x8, 0x8, 0x0, 0x0, 0x0)\r\n        /usr/lib/golang/src/io/io.go:298 +0xe6\r\nio.ReadFull(0x7f621814e080, 0xc820022840, 0xc8201d8bf0, 0x8, 0x8, 0x8, 0x0, 0x0)\r\n        /usr/lib/golang/src/io/io.go:316 +0x62\r\nencoding/binary.Read(0x7f621814e080, 0xc820022840, 0x7f621814e028, 0xcb96b0, 0x7e1120, 0xc8201d8b90, 0x0, 0x0)\r\n        /usr/lib/golang/src/encoding/binary/binary.go:216 +0x1336\r\nbitbucket.org/svidyuk/kdbgo.Decode(0xc820022840, 0x0, 0xc8201bdc18, 0x0, 0x0)\r\n        /home/sergey/go/src/bitbucket.org/svidyuk/kdbgo/decode.go:128 +0x131\r\nbitbucket.org/svidyuk/kdbgo.(*KDBConn).ReadMessage(0xc82000b140, 0x2, 0x2, 0x0, 0x0)\r\n        /home/sergey/go/src/bitbucket.org/svidyuk/kdbgo/kdb.go:100 +0x33\r\nmain.connectKDB.func1(0xc82000b140, 0xc820017360)\r\n        /home/sergey/go/src/posmanager/posmanager.go:109 +0xb66\r\ncreated by main.connectKDB\r\n        /home/sergey/go/src/posmanager/posmanager.go:138 +0x329\r\n\r\ngoroutine 19 [chan receive]:\r\nmain.listenBBO()\r\n        /home/sergey/go/src/posmanager/lbm.go:19 +0x1e3\r\ncreated by main.subscribeBBO\r\n        /home/sergey/go/src/posmanager/lbm.go:58 +0x6b4\r\n\r\ngoroutine 34 [syscall, locked to thread]:\r\nruntime.goexit()\r\n        /usr/lib/golang/src/runtime/asm_amd64.s:1696 +0x1\r\n\r\n```\r\n\r\n",
	"user": {
		"login": "sv",
		"id": 14086,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 16,
	"closed_at": "2015-10-14T16:47:01Z",
	"created_at": "2015-09-30T16:54:39Z",
	"updated_at": "2016-10-17T08:03:07Z",
	"milestone": {
		"id": 1096159,
		"number": 24,
		"title": "Go1.6"
	}
}
