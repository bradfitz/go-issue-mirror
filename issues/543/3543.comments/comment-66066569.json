{
	"id": 66066569,
	"body": "\u003ca id=\"c3\"\u003e\u003c/a\u003eComment 3:\n\n\u003cpre\u003eIt looks like windows programs compiled with cgo do not set exception handler. Only\nfirst thread has exception handler set, but not others. See simplified version of your\ntest (thank you) attached. It is an oversight. We will have to fix it.\n\nOn unrelated note, I can see that you are using odbc on Windows. You should not need cgo\nfor that, just call appropriate dlls directly. See \u003ca href=\"http://code.google.com/p/gowingui/\"\u003ehttp://code.google.com/p/gowingui/\u003c/a\u003e\nfor an example of how to. I, personally, avoid cgo when possible, because you have to\nuse another extra set of tools (gcc + gcc runtime) and that makes things more\ncomplicated. Also cgo and gcc, as you discovered, are behind comparing to unix platforms.\n\n@rsc:\n\nException handlers implementations are very different on amd64 and 386.\n\nOn 386 all thread exception handlers are linked into a linked list, and we install ours\nby creating appropriate list elements (SEH) on the stack and removing them once we are\ndone. First thread creates its SEH in _rt0_386_windows (I think it is too early, our\nexception handler is not ready to do anything so early). All other non-cgo threads\ninstall and remove its SEH in tstart. Cgo threads do not call tstart, therefore they do\nnot install SEH.\n\nOn amd64 our pe header points to exception handler. The only other thing we need to do\nto make exception handler working is to call setstacklimits. This is done in settls\n(probably too early too) for first thread, and in tstart_stdcall for other non-cgo\nthreads. Again cgo threads do not call neither settls nor tstart_stdcall, so no\nexception handler for them.\n\nI think correct fix for amd64 is to call setstacklimits from minit instead. 386 fix is\nbit more complicated, since SEH is installed and then removed on stack. I can, probably,\ncreate heap storage for SEH data, but, still, it needs to be *removed* after we are done\nwith our thread so SEH chain remains correct. So single minit is not enough, I need mend\nor something for 386.\n\nI do not want to start major renovations, but ... What do you think?\n\nThank you.\n\nAlex\u003c/pre\u003e\n\n_Labels changed: added **os-windows**, **cgo**._\n\n_Owner changed to @alexbrainman._\n\n_Status changed to **Accepted**._\n\n\nAttachments:\n\n1. \u003ca href=\"https://storage.googleapis.com/go-attachment/3543/3/main.go\"\u003emain.go\u003c/a\u003e (559 bytes)\n1. \u003ca href=\"https://storage.googleapis.com/go-attachment/3543/3/mgodbc.go\"\u003emgodbc.go\u003c/a\u003e (27 bytes)",
	"user": {
		"login": "alexbrainman",
		"id": 9796621,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2012-04-19T07:18:49Z",
	"updated_at": "2014-12-08T10:18:37Z"
}
