{
	"id": 51288325,
	"number": 8524,
	"state": "closed",
	"title": "cmd/dist: goc2c ignores GOROOT_FINAL",
	"body": "by **henning@schmiedehausen.org**:\n\n\u003cpre\u003eWhen building golang, the environment variable GOROOT_FINAL can be set to indicate a\ndifferent installation location from the build location. This works fine, except that\nthe goc2c build step embeds line numbers in the resulting c source files that refer to\nthe build location, no the install location:\n\n// auto generated by go tool dist\n// goos=linux goarch=amd64\n\n\n#include \u0026quot;runtime.h\u0026quot;\n#include \u0026quot;type.h\u0026quot;\n#include \u0026quot;../../cmd/ld/textflag.h\u0026quot;\n#define M0 (sizeof(uintptr)==4 ? 2860486313UL : 33054211828000289ULL)\n#define M1 (sizeof(uintptr)==4 ? 3267000013UL : 23344194077549503ULL)\n\n#line 13 \u0026quot;/home/hschmiedehausen/rpmbuild/BUILD/go/src/pkg/runtime/alg.goc\u0026quot;\n\nThis is the start of zalg_linux_amd64.c The path\n\u0026quot;/home/hschmiedehausen/rpmbuild/BUILD/go\u0026quot; is the build location of the tree,\nnot the install location.\n\nThis would not be a big deal, except that in turn the linker uses the location of\nruntime/string.goc to embed the gdb script in the resulting binary:\n\nreadelf -p41  ~/code/docker/bundles/1.1.3-dev/dynbinary/docker\n\nString dump of section '.debug_gdb_scripts':\n  [     1]  /home/hschmiedehausen/rpmbuild/BUILD/go/src/pkg/runtime/runtime-gdb.py\n\nand as a net result, the debugger now complains that the script is outside its load path\n(it has the install location configured).\n\nWith the attached patch and GOROOT_FINAL set to the install location, the generated\nsources look like this:\n\n// auto generated by go tool dist\n// goos=linux goarch=amd64\n\n\n#include \u0026quot;runtime.h\u0026quot;\n#include \u0026quot;type.h\u0026quot;\n#include \u0026quot;../../cmd/ld/textflag.h\u0026quot;\n#define M0 (sizeof(uintptr)==4 ? 2860486313UL : 33054211828000289ULL)\n#define M1 (sizeof(uintptr)==4 ? 3267000013UL : 23344194077549503ULL)\n\n#line 13 \u0026quot;/usr/lib/golang/src/pkg/runtime/alg.goc\u0026quot;\n...\n\nSo the #line references use the correct installation path.\n\nAnd the resulting binaries contain the correct script:\n\nreadelf -p41  ~/code/docker/bundles/1.1.3-dev/dynbinary/docker\n\nString dump of section '.debug_gdb_scripts':\n  [     1]  /usr/lib/golang/src/pkg/runtime/runtime-gdb.py\n\nand the debugger is happy.\n\nRun \u0026quot;go version\u0026quot; and compare against\n\u003ca href=\"http://golang.org/doc/devel/release.html\"\u003ehttp://golang.org/doc/devel/release.html\u003c/a\u003e  If a newer version of Go exists,\ninstall it and retry what you did to reproduce the problem.\n\nWhat does 'go version' print?\ngo version go1.3 linux/amd64\n\nWhat steps reproduce the problem?\nIf possible, include a link to a program on play.golang.org.\n\n1. Build the golang from source with a different install location from the build\nlocation (GOROOT != GOROOT_FINAL)\n2. look at the output of e.g. go/src/pkg/zalg_*.c\n3. verify that the #line statements contain the build, not the install location. \n\nWhat happened?\n\nBuild a binary (I used docker). Use the readelf program (on linux) to dump the\n.debug_gdb_scripts section. It contains the build location for the script, not the\ninstall location.\n\nWhat should have happened instead?\n\nThe generated source files should contain the install location. The resulting\n.debug_gdb_scripts section should contain the install location.\n\n\nPlease provide any additional information below.\n\nRepeat the steps with the attached path. Now the information is correct. And I can debug\nwith my RPM installed golang on Fedora. ;-)\u003c/pre\u003e\n\n\n\n\n\nAttachments:\n\n1. \u003ca href=\"https://storage.googleapis.com/go-attachment/8524/0/go-1.3-goc2c.patch\"\u003ego-1.3-goc2c.patch\u003c/a\u003e (2126 bytes)",
	"user": {
		"login": "gopherbot",
		"id": 8566911,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 5,
	"closed_at": "2014-12-08T10:47:22Z",
	"created_at": "2014-08-13T19:05:46Z",
	"updated_at": "2016-06-25T01:39:33Z",
	"milestone": {
		"id": 1067218,
		"number": 21,
		"title": "Go1.4"
	}
}
