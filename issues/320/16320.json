{
	"id": 164854597,
	"number": 16320,
	"state": "closed",
	"title": "OSX crash writing C-side data from c-shared library",
	"body": "Please answer these questions before submitting your issue. Thanks!\r\n\r\n*  What version of Go are you using (`go version`)?\r\n\r\ngo1.6.2 darwin/amd64, 1.7 beta 2 and 1.7 RC1.  There appears to be no problem on Ubuntu.\r\n\r\nSystem compiler\r\n\r\n```\r\n$ gcc --version\r\nConfigured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.11.sdk/usr/include/c++/4.2.1\r\nApple LLVM version 7.3.0 (clang-703.0.31)\r\nTarget: x86_64-apple-darwin15.5.0\r\nThread model: posix\r\nInstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin\r\n```\r\n\r\n*  What operating system and processor architecture are you using (`go env`)?\r\n\r\nEl Capitan 10.11.5 (15F34)\r\n2.8 Ghz Intel Core Duo\r\n\r\n* What did you do?\r\nAfter building shared library with:\r\ngo build -o libsample.dylib -buildmode=c-shared sample.go\r\n\r\nof the following program,\r\n```\r\npackage main\r\n\r\n/*\r\n#include \u003cstring.h\u003e\r\n*/\r\nimport \"C\"\r\n\r\n//export sample\r\nfunc sample(buf *C.char) int {\r\n\ts := \"sample\"\r\n\tcs := C.CString(s)\r\n\tC.strcpy(buf, cs)\r\n\treturn len(s)\r\n}\r\n\r\nfunc main() { }\r\n\r\n```\r\n*  I expected to see the copied bytes from \"sample\" in the buffer passed by the exported sample function.\r\n\r\n* Instead I saw following output results upon trying to execute the code from Python or Racket\r\n```\r\n[signal 0xb code=0x1 addr=0x263aab0 pc=0x7fff9bdd4245]\r\n\r\nruntime stack:\r\nruntime.throw(0x1027e54c0, 0x2a)\r\n\t/usr/local/go/src/runtime/panic.go:547 +0x90\r\nruntime.sigpanic()\r\n\t/usr/local/go/src/runtime/sigpanic_unix.go:12 +0x5a\r\n\r\ngoroutine 17 [syscall, locked to thread]:\r\nruntime.cgocall(0x1027ab960, 0xc820034e98, 0x0)\r\n\t/usr/local/go/src/runtime/cgocall.go:123 +0x11b fp=0xc820034e60 sp=0xc820034e30\r\nmain._Cfunc_strcpy(0x263aab0, 0x100737760, 0x0)\r\n\tcommand-line-arguments/_obj/_cgo_gotypes.go:53 +0x42 fp=0xc820034e98 sp=0xc820034e60\r\nmain.sample(0x263aab0, 0x10279dbc0)\r\n\t/Users/john/GOWORK/src/jcgsrq/gozulu/zululink/sample.go:12 +0x51 fp=0xc820034ec8 sp=0xc820034e98\r\nmain._cgoexpwrap_811a8bc3212f_sample(0x263aab0, 0x7fff5bffd500)\r\n\tcommand-line-arguments/_obj/_cgo_gotypes.go:71 +0x21 fp=0xc820034ee0 sp=0xc820034ec8\r\nruntime.call32(0x0, 0x7fff5bffd438, 0x7fff5bffd4c8, 0x10)\r\n\t/usr/local/go/src/runtime/asm_amd64.s:472 +0x3e fp=0xc820034f08 sp=0xc820034ee0\r\nruntime.cgocallbackg1()\r\n\t/usr/local/go/src/runtime/cgocall.go:267 +0x10c fp=0xc820034f40 sp=0xc820034f08\r\nruntime.cgocallbackg()\r\n\t/usr/local/go/src/runtime/cgocall.go:180 +0xd7 fp=0xc820034fa0 sp=0xc820034f40\r\nruntime.cgocallback_gofunc(0x0, 0x0, 0x0)\r\n\t/usr/local/go/src/runtime/asm_amd64.s:716 +0x60 fp=0xc820034fb0 sp=0xc820034fa0\r\nruntime.goexit()\r\n\t/usr/local/go/src/runtime/asm_amd64.s:1998 +0x1 fp=0xc820034fb8 sp=0xc820034fb0\r\n\r\ngoroutine 18 [syscall, locked to thread]:\r\nruntime.goexit()\r\n\t/usr/local/go/src/runtime/asm_amd64.s:1998 +0x1\r\n```\r\nSample Python driver sequence.  The same results happen in Racket.\r\n\r\n```\r\n\r\nfrom ctypes import c_void_p, CDLL\r\n\r\nlib = CDLL('/Users/john/GOWORK/src/jcgsrq/gozulu/zululink/libsample.dylib')\r\n\r\nlib.sample.argtype = (c_void_p,)\r\nimport array\r\nbs = array.array('b',[0 for x in range(10) ])\r\nbuf,sz = bs.buffer_info()\r\nlib.sample(buf)\r\n```\r\n\r\n\r\n\r\n",
	"user": {
		"login": "JohnCGriffin",
		"id": 3608009,
		"type": "User",
		"site_admin": false
	},
	"comments": 3,
	"closed_at": "2016-07-11T21:31:31Z",
	"created_at": "2016-07-11T14:43:51Z",
	"updated_at": "2016-07-11T21:31:31Z"
}
