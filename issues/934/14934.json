{
	"id": 143070162,
	"number": 14934,
	"state": "open",
	"title": "cmd/compile: \"go test\" taking ~38x longer on Go tip than on Go 1.4",
	"body": "1. What version of Go are you using (`go version`)?\r\n\r\nFor Go tip\r\n\r\n```\r\n[~]$ go version\r\ngo version devel +0659cf6 Wed Mar 23 19:22:53 2016 +0000 linux/amd64\r\n```\r\n\r\nand for Go 1.4\r\n\r\n```\r\n[~]$ go version\r\ngo version go1.4.3 linux/amd64\r\n```\r\n\r\n2. What operating system and processor architecture are you using (`go env`)?\r\n\r\nFor Go tip\r\n\r\n```\r\n[/tmp/gotip/src/github.com/mewmew/uc/uc/gocc/lexer]$ go env\r\nGOARCH=\"amd64\"\r\nGOBIN=\"\"\r\nGOEXE=\"\"\r\nGOHOSTARCH=\"amd64\"\r\nGOHOSTOS=\"linux\"\r\nGOOS=\"linux\"\r\nGOPATH=\"/tmp/gotip\"\r\nGORACE=\"\"\r\nGOROOT=\"/home/u/go\"\r\nGOTOOLDIR=\"/home/u/go/pkg/tool/linux_amd64\"\r\nCC=\"gcc\"\r\nGOGCCFLAGS=\"-fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build981577852=/tmp/go-build -gno-record-gcc-switches\"\r\nCXX=\"g++\"\r\nCGO_ENABLED=\"1\"\r\n```\r\n\r\nand for Go 1.4\r\n\r\n```\r\n[/tmp/go14/src/github.com/mewmew/uc/uc/gocc/lexer]$ go env\r\nGOARCH=\"amd64\"\r\nGOBIN=\"\"\r\nGOCHAR=\"6\"\r\nGOEXE=\"\"\r\nGOHOSTARCH=\"amd64\"\r\nGOHOSTOS=\"linux\"\r\nGOOS=\"linux\"\r\nGOPATH=\"/tmp/go14\"\r\nGORACE=\"\"\r\nGOROOT=\"/home/u/go1.4\"\r\nGOTOOLDIR=\"/home/u/go1.4/pkg/tool/linux_amd64\"\r\nCC=\"gcc\"\r\nGOGCCFLAGS=\"-fPIC -m64 -pthread -fmessage-length=0\"\r\nCXX=\"g++\"\r\nCGO_ENABLED=\"1\"\r\n```\r\n\r\n3. What did you do?\r\nIf possible, provide a recipe for reproducing the error.\r\nA complete runnable program is good.\r\nA link on play.golang.org is best.\r\n\r\nFor Go tip\r\n\r\n```\r\n[~]$ export GOPATH=/tmp/gotip\r\n[~]$ go get github.com/mewmew/uc\r\n[~]$ go get github.com/goccmack/gocc\r\n[~]$ export PATH=${GOPATH}/bin:${PATH}\r\n[~]$ cd ${GOPATH}/src/github.com/mewmew/uc\r\n[/tmp/gotip/src/github.com/mewmew/uc]$ git checkout 9557c0010cde8953d0719ab5df170b8cfbdc3a3f\r\n[/tmp/gotip/src/github.com/mewmew/uc]$ cd uc/gocc\r\n[/tmp/gotip/src/github.com/mewmew/uc/uc/gocc]$ make gen\r\n[/tmp/gotip/src/github.com/mewmew/uc/uc/gocc]$ cd lexer\r\n[/tmp/gotip/src/github.com/mewmew/uc/uc/gocc/lexer]$ time go test\r\n2016/03/23 21:05:38 path: ../../testdata/incorrect/lexer/bad.c\r\n2016/03/23 21:05:38 path: ../../testdata/incorrect/lexer/good.c\r\n2016/03/23 21:05:38 path: ../../testdata/incorrect/lexer/long-char.c\r\n2016/03/23 21:05:38 path: ../../testdata/incorrect/lexer/ugly.c\r\n2016/03/23 21:05:38 path: ../../testdata/quiet/lexer/l01.c\r\n2016/03/23 21:05:38 path: ../../testdata/quiet/lexer/l02.c\r\n2016/03/23 21:05:38 path: ../../testdata/quiet/lexer/l03.c\r\n2016/03/23 21:05:38 path: ../../testdata/quiet/lexer/l04.c\r\n2016/03/23 21:05:38 path: ../../testdata/quiet/lexer/l05.c\r\n2016/03/23 21:05:38 path: ../../testdata/quiet/lexer/l06.c\r\nPASS\r\nok  \tgithub.com/mewmew/uc/uc/gocc/lexer\t0.002s\r\n\r\nreal\t0m20.810s\r\nuser\t0m33.817s\r\nsys\t0m0.977s\r\n[/tmp/gotip/src/github.com/mewmew/uc/uc/gocc/lexer]$ time go install\r\n\r\nreal\t0m0.120s\r\nuser\t0m0.113s\r\nsys\t0m0.023s\r\n[/tmp/gotip/src/github.com/mewmew/uc/uc/gocc/lexer]$ time go test\r\n2016/03/23 21:06:18 path: ../../testdata/incorrect/lexer/bad.c\r\n2016/03/23 21:06:18 path: ../../testdata/incorrect/lexer/good.c\r\n2016/03/23 21:06:18 path: ../../testdata/incorrect/lexer/long-char.c\r\n2016/03/23 21:06:18 path: ../../testdata/incorrect/lexer/ugly.c\r\n2016/03/23 21:06:18 path: ../../testdata/quiet/lexer/l01.c\r\n2016/03/23 21:06:18 path: ../../testdata/quiet/lexer/l02.c\r\n2016/03/23 21:06:18 path: ../../testdata/quiet/lexer/l03.c\r\n2016/03/23 21:06:18 path: ../../testdata/quiet/lexer/l04.c\r\n2016/03/23 21:06:18 path: ../../testdata/quiet/lexer/l05.c\r\n2016/03/23 21:06:18 path: ../../testdata/quiet/lexer/l06.c\r\nPASS\r\nok  \tgithub.com/mewmew/uc/uc/gocc/lexer\t0.001s\r\n\r\nreal\t0m20.752s\r\nuser\t0m34.110s\r\nsys\t0m0.953s\r\n[/tmp/gotip/src/github.com/mewmew/uc/uc/gocc/lexer]$ time go test -i\r\n\r\nreal\t0m0.057s\r\nuser\t0m0.030s\r\nsys\t0m0.020s\r\n[/tmp/gotip/src/github.com/mewmew/uc/uc/gocc/lexer]$ time go test\r\n2016/03/23 21:07:15 path: ../../testdata/incorrect/lexer/bad.c\r\n2016/03/23 21:07:15 path: ../../testdata/incorrect/lexer/good.c\r\n2016/03/23 21:07:15 path: ../../testdata/incorrect/lexer/long-char.c\r\n2016/03/23 21:07:15 path: ../../testdata/incorrect/lexer/ugly.c\r\n2016/03/23 21:07:15 path: ../../testdata/quiet/lexer/l01.c\r\n2016/03/23 21:07:15 path: ../../testdata/quiet/lexer/l02.c\r\n2016/03/23 21:07:15 path: ../../testdata/quiet/lexer/l03.c\r\n2016/03/23 21:07:15 path: ../../testdata/quiet/lexer/l04.c\r\n2016/03/23 21:07:15 path: ../../testdata/quiet/lexer/l05.c\r\n2016/03/23 21:07:15 path: ../../testdata/quiet/lexer/l06.c\r\nPASS\r\nok  \tgithub.com/mewmew/uc/uc/gocc/lexer\t0.002s\r\n\r\nreal\t0m20.751s\r\nuser\t0m33.750s\r\nsys\t0m1.007s\r\n```\r\n\r\nand for Go 1.4\r\n\r\n```\r\n[~]$ export GOPATH=/tmp/go14\r\n[~]$ go get github.com/mewmew/uc\r\n[~]$ go get github.com/goccmack/gocc\r\n[~]$ export PATH=${GOPATH}/bin:${PATH}\r\n[~]$ cd ${GOPATH}/src/github.com/mewmew/uc\r\n[/tmp/go14/src/github.com/mewmew/uc]$ git checkout 9557c0010cde8953d0719ab5df170b8cfbdc3a3f\r\n[/tmp/go14/src/github.com/mewmew/uc]$ cd uc/gocc\r\n[/tmp/go14/src/github.com/mewmew/uc/uc/gocc]$ make gen\r\n[/tmp/go14/src/github.com/mewmew/uc/uc/gocc]$ cd lexer\r\n[/tmp/go14/src/github.com/mewmew/uc/uc/gocc/lexer]$ time go test\r\n2016/03/23 21:05:42 path: ../../testdata/incorrect/lexer/bad.c\r\n2016/03/23 21:05:42 path: ../../testdata/incorrect/lexer/good.c\r\n2016/03/23 21:05:42 path: ../../testdata/incorrect/lexer/long-char.c\r\n2016/03/23 21:05:42 path: ../../testdata/incorrect/lexer/ugly.c\r\n2016/03/23 21:05:42 path: ../../testdata/quiet/lexer/l01.c\r\n2016/03/23 21:05:42 path: ../../testdata/quiet/lexer/l02.c\r\n2016/03/23 21:05:42 path: ../../testdata/quiet/lexer/l03.c\r\n2016/03/23 21:05:42 path: ../../testdata/quiet/lexer/l04.c\r\n2016/03/23 21:05:42 path: ../../testdata/quiet/lexer/l05.c\r\n2016/03/23 21:05:42 path: ../../testdata/quiet/lexer/l06.c\r\nPASS\r\nok  \tgithub.com/mewmew/uc/uc/gocc/lexer\t0.002s\r\n\r\nreal\t0m0.588s\r\nuser\t0m0.503s\r\nsys\t0m0.053s\r\n[/tmp/go14/src/github.com/mewmew/uc/uc/gocc/lexer]$ time go install\r\n\r\nreal\t0m0.053s\r\nuser\t0m0.040s\r\nsys\t0m0.007s\r\n[/tmp/go14/src/github.com/mewmew/uc/uc/gocc/lexer]$ time go test\r\n2016/03/23 21:06:43 path: ../../testdata/incorrect/lexer/bad.c\r\n2016/03/23 21:06:43 path: ../../testdata/incorrect/lexer/good.c\r\n2016/03/23 21:06:43 path: ../../testdata/incorrect/lexer/long-char.c\r\n2016/03/23 21:06:43 path: ../../testdata/incorrect/lexer/ugly.c\r\n2016/03/23 21:06:43 path: ../../testdata/quiet/lexer/l01.c\r\n2016/03/23 21:06:43 path: ../../testdata/quiet/lexer/l02.c\r\n2016/03/23 21:06:43 path: ../../testdata/quiet/lexer/l03.c\r\n2016/03/23 21:06:43 path: ../../testdata/quiet/lexer/l04.c\r\n2016/03/23 21:06:43 path: ../../testdata/quiet/lexer/l05.c\r\n2016/03/23 21:06:43 path: ../../testdata/quiet/lexer/l06.c\r\nPASS\r\nok  \tgithub.com/mewmew/uc/uc/gocc/lexer\t0.002s\r\n\r\nreal\t0m0.547s\r\nuser\t0m0.483s\r\nsys\t0m0.057s\r\n[/tmp/go14/src/github.com/mewmew/uc/uc/gocc/lexer]$ time go test -i\r\n\r\nreal\t0m0.034s\r\nuser\t0m0.033s\r\nsys\t0m0.000s\r\n[/tmp/go14/src/github.com/mewmew/uc/uc/gocc/lexer]$ time go test\r\n2016/03/23 21:06:52 path: ../../testdata/incorrect/lexer/bad.c\r\n2016/03/23 21:06:52 path: ../../testdata/incorrect/lexer/good.c\r\n2016/03/23 21:06:52 path: ../../testdata/incorrect/lexer/long-char.c\r\n2016/03/23 21:06:52 path: ../../testdata/incorrect/lexer/ugly.c\r\n2016/03/23 21:06:52 path: ../../testdata/quiet/lexer/l01.c\r\n2016/03/23 21:06:52 path: ../../testdata/quiet/lexer/l02.c\r\n2016/03/23 21:06:52 path: ../../testdata/quiet/lexer/l03.c\r\n2016/03/23 21:06:52 path: ../../testdata/quiet/lexer/l04.c\r\n2016/03/23 21:06:52 path: ../../testdata/quiet/lexer/l05.c\r\n2016/03/23 21:06:52 path: ../../testdata/quiet/lexer/l06.c\r\nPASS\r\nok  \tgithub.com/mewmew/uc/uc/gocc/lexer\t0.002s\r\n\r\nreal\t0m0.545s\r\nuser\t0m0.503s\r\nsys\t0m0.037s\r\n```\r\n\r\n4. What did you expect to see?\r\n\r\nThe time take by `go test github.com/mewmew/uc/uc/gocc/lexer` taking roughly the same amount of time to run when using Go tip and Go 1.4.\r\n\r\n5. What did you see instead?\r\n\r\n\"go test\" took roughly 20 seconds on Go tip and 0.5 seconds on Go 1.4.\r\n\r\nAlso note that the `compile` command used between 25% to 60% of the CPU, during the 20 second duration.\r\n\r\n![CPU usage](https://i.imgur.com/cvCMtN3.png)",
	"user": {
		"login": "mewmew",
		"id": 1414531,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "NeedsDecision"
		},
		{
			"name": "ToolSpeed"
		}
	],
	"assignee": {
		"login": "dr2chase",
		"id": 1928999,
		"type": "User",
		"site_admin": false
	},
	"comments": 36,
	"created_at": "2016-03-23T20:24:11Z",
	"updated_at": "2016-05-26T22:46:11Z",
	"milestone": {
		"id": 1709364,
		"number": 39,
		"title": "Go1.8Early"
	}
}
