{
	"id": 221197120,
	"body": "Does the error occur if you remove nginx from the scenario ?\n\nOn Tue, May 24, 2016 at 6:06 PM, 项超 \u003cnotifications@github.com\u003e wrote:\n\n\u003e I can provide program now.\n\u003e\n\u003e The client code\n\u003e\n\u003e package main\n\u003e\n\u003e import (\n\u003e         \"bytes\"\n\u003e         \"encoding/json\"\n\u003e         \"fmt\"\n\u003e         \"net/http\"\n\u003e )\n\u003e\n\u003e func main() {\n\u003e         for {\n\u003e                 req()\n\u003e         }\n\u003e }\n\u003e\n\u003e func ret() string {\n\u003e         s := \"k\"\n\u003e         for i := 0; i \u003c 12; i++ {\n\u003e                 s = s + s\n\u003e         }\n\u003e         return s\n\u003e }\n\u003e\n\u003e func req() {\n\u003e         fmt.Println(\"start req\")\n\u003e         val := struct {\n\u003e                 Data string `json:\"data\"`\n\u003e         }{Data: ret()}\n\u003e         data, _ := json.Marshal(val)\n\u003e         r, err := http.Post(\"http://127.0.0.1:9989\", \"application/json\", bytes.NewBuffer(data))\n\u003e         if err != nil {\n\u003e                 fmt.Println(err)\n\u003e         } else {\n\u003e                 fmt.Println(\"Status Code: \", r.Status)\n\u003e         }\n\u003e         r.Body.Close()\n\u003e }\n\u003e\n\u003e The server code\n\u003e\n\u003e package main\n\u003e\n\u003e import (\n\u003e         \"compress/gzip\"\n\u003e         \"encoding/json\"\n\u003e         \"io\"\n\u003e         \"io/ioutil\"\n\u003e         \"net/http\"\n\u003e )\n\u003e\n\u003e func main() {\n\u003e         mux := http.NewServeMux()\n\u003e         mux.HandleFunc(\"/\", HelloHandler)\n\u003e         server := \u0026http.Server{Addr: \":8998\", Handler: mux}\n\u003e         server.ListenAndServe()\n\u003e }\n\u003e\n\u003e func HelloHandler(w http.ResponseWriter, r *http.Request) {\n\u003e         reader, err := gzip.NewReader(r.Body) // I make this mistake Purposely.\n\u003e         if err == nil {\n\u003e                 io.Copy(ioutil.Discard, reader)\n\u003e         }\n\u003e         w.Header().Set(\"Content-Type\", \"application/json\")\n\u003e         w.WriteHeader(http.StatusOK)\n\u003e         val := struct {\n\u003e                 Message string `json:\"message\"`\n\u003e         }{\n\u003e                 Message: \"Hello World!\",\n\u003e         }\n\u003e         body, _ := json.Marshal(val)\n\u003e         w.Write(body)\n\u003e }\n\u003e\n\u003e The nginx config\n\u003e\n\u003e worker_processes  1;\n\u003e\n\u003e events {\n\u003e     worker_connections  111024;\n\u003e }\n\u003e\n\u003e http {\n\u003e     include       mime.types;\n\u003e     default_type  application/octet-stream;\n\u003e     sendfile        on;\n\u003e\n\u003e     upstream myapp {\n\u003e         server 127.0.0.1:8998;\n\u003e     }\n\u003e\n\u003e     server {\n\u003e         listen       9989;\n\u003e         server_name  localhost;\n\u003e\n\u003e         location / {\n\u003e             proxy_pass http://myapp;\n\u003e         }\n\u003e\n\u003e         error_page   500 502 503 504  /50x.html;\n\u003e         location = /50x.html {\n\u003e             root   html;\n\u003e         }\n\u003e     }\n\u003e }\n\u003e\n\u003e The nginx error log\n\u003e\n\u003e 2016/05/24 15:50:53 [error] 53509#0: *394941 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\n\u003e 2016/05/24 15:50:53 [error] 53509#0: *394955 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\n\u003e 2016/05/24 15:50:53 [error] 53509#0: *395009 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\n\u003e 2016/05/24 15:50:53 [error] 53509#0: *395029 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\n\u003e 2016/05/24 15:50:53 [error] 53509#0: *395049 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\n\u003e 2016/05/24 15:50:53 [error] 53509#0: *395069 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\n\u003e 2016/05/24 15:50:53 [error] 53509#0: *395077 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\n\u003e 2016/05/24 15:50:53 [error] 53509#0: *395129 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\n\u003e 2016/05/24 15:50:53 [error] 53509#0: *395169 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\n\u003e 2016/05/24 15:50:53 [error] 53509#0: *395319 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\n\u003e\n\u003e when I build server code with go1.3.3 version, there is no \"reset by peer\"\n\u003e error in nginx error log,\n\u003e but I build server code with go1.6.2 version, the \"reset by peer\" error\n\u003e appear in nginx error log.\n\u003e\n\u003e In the server code, I use gzip reader to read body, I know this will\n\u003e return error, I just want to make this case.\n\u003e\n\u003e @ianlancetaylor \u003chttps://github.com/ianlancetaylor\u003e\n\u003e\n\u003e —\n\u003e You are receiving this because you are subscribed to this thread.\n\u003e Reply to this email directly or view it on GitHub\n\u003e \u003chttps://github.com/golang/go/issues/15789#issuecomment-221195841\u003e\n\u003e\n",
	"user": {
		"login": "davecheney",
		"id": 7171,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2016-05-24T08:12:48Z",
	"updated_at": "2016-05-24T08:12:48Z"
}
