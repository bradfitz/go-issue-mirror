{
	"id": 51283120,
	"number": 5103,
	"state": "closed",
	"title": "runtime: epoll hangs in net/http tests",
	"body": "\u003cpre\u003eI think we might have an netpoll bug still.\n\nOn Linux-amd64, at hg revision a78557354dc0 with 7799047 (#4) patched in, I get\noccasional net/http test runs (in full, not -short mode).\n\nThe test that hangs tends to always the same one, but it passes fine on its own.  It\nonly hangs if some tests before it run.\n\nIf I SIGQUIT it, I see the following stacks:\n\n$ go test -v net/http\n....\n....\n--- PASS: TestTransportNoHost (0.00 seconds)\n=== RUN TestTransportSocketLateBinding\n^\\SIGQUIT: quit\nPC=0x4245a3\n\n\ngoroutine 1 [chan receive]:\ntesting.RunTests(0x788468, 0x8ed880, 0x96, 0x96, 0xc2000e0d00, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/testing/testing.go:427 +0x88e\ntesting.Main(0x788468, 0x8ed880, 0x96, 0x96, 0x8e6600, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/testing/testing.go:358 +0x8a\nmain.main()\n        net/http/_test/_testmain.go:365 +0x9a\n\ngoroutine 2 [syscall]:\n\ngoroutine 254 [finalizer wait]:\n\ngoroutine 52252 [select]:\nnet/http.(*persistConn).roundTrip(0xc200504200, 0xc200bae780, 0xc200504200, 0x0, 0x0,\n...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/transport.go:846 +0x6c7\nnet/http.(*Transport).RoundTrip(0xc200504280, 0xc20052ed00, 0xc201ecf1fa, 0x0, 0x0, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/transport.go:186 +0x396\nnet/http.send(0xc20052ed00, 0xc2000e0000, 0xc200504280, 0x0, 0x0, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/client.go:166 +0x3a1\nnet/http.(*Client).send(0xc201a409f0, 0xc20052ed00, 0x1a, 0x100000000, 0xc200000000, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/client.go:100 +0xcd\nnet/http.(*Client).doFollowingRedirects(0xc201a409f0, 0xc20052ed00, 0x788728, 0x0, 0x0,\n...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/client.go:282 +0x5ff\nnet/http.(*Client).Get(0xc201a409f0, 0xc201d397c0, 0x1a, 0x7058a0, 0x0, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/client.go:236 +0xb0\nnet/http_test.TestTransportSocketLateBinding(0xc200552ab0)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/transport_test.go:1360 +0x362\ntesting.tRunner(0xc200552ab0, 0x8ee648)\n        /usr/local/google/home/bradfitz/go/src/pkg/testing/testing.go:346 +0x8a\ncreated by testing.RunTests\n        /usr/local/google/home/bradfitz/go/src/pkg/testing/testing.go:426 +0x86b\n\ngoroutine 52256 [select]:\nnet/http.(*persistConn).writeLoop(0xc200504200)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/transport.go:763 +0x26f\ncreated by net/http.(*Transport).dialConn\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/transport.go:512 +0x58b\n\ngoroutine 52253 [IO wait]:\nnet.runtime_pollWait(0x7fd9ea4d2dc0, 0x72, 0x0)\n        /usr/local/google/home/bradfitz/go/src/pkg/runtime/znetpoll_linux_amd64.c:118 +0x82\nnet.(*pollDesc).WaitRead(0xc200552aa0, 0xb, 0xc2000e0ea0)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/fd_poll_runtime.go:75 +0x31\nnet.(*netFD).accept(0xc200552a20, 0x788580, 0x0, 0xc2000e0ea0, 0xb, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/fd_unix.go:382 +0x2c1\nnet.(*TCPListener).AcceptTCP(0xc201e5a680, 0x4185c8, 0x0, 0x0)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/tcpsock_posix.go:232 +0x57\nnet.(*TCPListener).Accept(0xc201e5a680, 0x0, 0x0, 0x0, 0x0, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/tcpsock_posix.go:242 +0x49\nnet/http/httptest.(*historyListener).Accept(0xc201a409c0, 0x0, 0x0, 0x0, 0x0, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/httptest/server.go:48 +0x54\nnet/http.(*Server).Serve(0xc2000fd960, 0xc200129fc0, 0xc201a409c0, 0x0, 0x0, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/server.go:1408 +0x85\ncreated by net/http/httptest.(*Server).Start\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/httptest/server.go:109 +0x21a\n\ngoroutine 52257 [chan receive]:\nnet/http_test.funcÂ·128(0xc2000d0640, 0xc2000fd910, 0xc20052ea90)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/transport_test.go:1338 +0xbd\nnet/http.HandlerFunc.ServeHTTP(0xc200bae6c0, 0xc2000d0640, 0xc2000fd910, 0xc20052ea90)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/server.go:1015 +0x3e\nnet/http.(*ServeMux).ServeHTTP(0xc201a40870, 0xc2000d0640, 0xc2000fd910, 0xc20052ea90)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/server.go:1282 +0x11d\nnet/http/httptest.(*waitGroupHandler).ServeHTTP(0xc201d39760, 0xc2000d0640,\n0xc2000fd910, 0xc20052ea90)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/httptest/server.go:200 +0x8f\nnet/http.serverHandler.ServeHTTP(0xc2000fd960, 0xc2000d0640, 0xc2000fd910, 0xc20052ea90)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/server.go:1383 +0x16c\nnet/http.(*conn).serve(0xc2019532d0)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/server.go:962 +0x758\ncreated by net/http.(*Server).Serve\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/server.go:1430 +0x266\n\ngoroutine 52255 [IO wait]:\nnet.runtime_pollWait(0x7fd9ea4d2d20, 0x72, 0x0)\n        /usr/local/google/home/bradfitz/go/src/pkg/runtime/znetpoll_linux_amd64.c:118 +0x82\nnet.(*pollDesc).WaitRead(0xc200650590, 0xb, 0xc2000e0ea0)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/fd_poll_runtime.go:75 +0x31\nnet.(*netFD).Read(0xc200650510, 0xc2013ea000, 0x1000, 0x1000, 0x0, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/fd_unix.go:192 +0x2b3\nnet.(*conn).Read(0xc201e5a710, 0xc2013ea000, 0x1000, 0x1000, 0x8, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/net.go:123 +0xc3\nbufio.(*Reader).fill(0xc201db9ea0)\n        /usr/local/google/home/bradfitz/go/src/pkg/bufio/bufio.go:79 +0x10c\nbufio.(*Reader).Peek(0xc201db9ea0, 0x1, 0x0, 0xc2000c1000, 0xc2000ba040, ...)\n        /usr/local/google/home/bradfitz/go/src/pkg/bufio/bufio.go:107 +0xc9\nnet/http.(*persistConn).readLoop(0xc200504200)\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/transport.go:670 +0xc4\ncreated by net/http.(*Transport).dialConn\n        /usr/local/google/home/bradfitz/go/src/pkg/net/http/transport.go:511 +0x574\nrax     0xfffffffffffffffc\nrbx     0xdf8475800\nrcx     0xffffffffffffffff\nrdx     0x0\nrdi     0x7fd9fcff6f60\nrsi     0x0\nrbp     0x7fd9ec868000\nrsp     0x7fd9fcff6e98\nr8      0x0\nr9      0x0\nr10     0x7fd9fcff6ed8\nr11     0x287\nr12     0x6c9ba0\nr13     0xb\nr14     0x0\nr15     0x2\nrip     0x4245a3\nrflags  0x287\ncs      0x33\nfs      0x0\ngs      0x0\nexit status 2\nFAIL    net/http        181.056s\u003c/pre\u003e",
	"user": {
		"login": "bradfitz",
		"id": 2621,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 1,
	"closed_at": "2014-12-08T10:27:16Z",
	"created_at": "2013-03-21T22:55:02Z",
	"updated_at": "2016-06-24T22:36:10Z"
}
