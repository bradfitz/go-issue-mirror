{
	"id": 109124339,
	"number": 12796,
	"state": "closed",
	"title": "net/http: race using same long/infinite Request.Body after first is cut off by server",
	"body": "This program:\r\n    http://play.golang.org/p/M1-UWKD33p\r\nhas the race condition below.\r\n\r\nThe reason is probably because the exit of the http.persistConn.writeLoop\r\ngoroutine is not waited for by the http request.\r\n\r\nFWIW some of our current infrastructure relies heavily on being able\r\nto make two successive requests using the same reader\r\n(it seeks to the start before making the second request).\r\n\r\nReproduced with Go 1.4.3 and 1.5.1.\r\n\r\n    WARNING: DATA RACE\r\n    Read by goroutine 20:\r\n      main.(*reader).Read()\r\n          /home/alesstimec/Downloads/main.go:15 +0x44\r\n      io/ioutil.(*nopCloser).Read()\r\n          \u003cautogenerated\u003e:4 +0xa0\r\n      io.ReadAtLeast()\r\n          /usr/local/go/src/io/io.go:298 +0x118\r\n      io.ReadFull()\r\n          /usr/local/go/src/io/io.go:316 +0x76\r\n      net/http.newTransferWriter()\r\n          /usr/local/go/src/net/http/transfer.go:71 +0x11ce\r\n      net/http.(*Request).write()\r\n          /usr/local/go/src/net/http/request.go:435 +0xc8b\r\n      net/http.(*persistConn).writeLoop()\r\n          /usr/local/go/src/net/http/transport.go:1015 +0x316\r\n    \r\n    Previous write by goroutine 11:\r\n      main.(*reader).Read()\r\n          /home/alesstimec/Downloads/main.go:15 +0x5a\r\n      io/ioutil.(*nopCloser).Read()\r\n          \u003cautogenerated\u003e:4 +0xa0\r\n      io.(*multiReader).Read()\r\n          /usr/local/go/src/io/multi.go:13 +0x10c\r\n      io.copyBuffer()\r\n          /usr/local/go/src/io/io.go:381 +0x281\r\n      io.Copy()\r\n          /usr/local/go/src/io/io.go:351 +0x78\r\n      net/http.(*transferWriter).WriteBody()\r\n          /usr/local/go/src/net/http/transfer.go:218 +0x39f\r\n      net/http.(*Request).write()\r\n          /usr/local/go/src/net/http/request.go:462 +0xed7\r\n      net/http.(*persistConn).writeLoop()\r\n          /usr/local/go/src/net/http/transport.go:1015 +0x316\r\n    \r\n    Goroutine 20 (running) created at:\r\n      net/http.(*Transport).dialConn()\r\n          /usr/local/go/src/net/http/transport.go:686 +0x11e4\r\n      net/http.(*Transport).getConn.func4()\r\n          /usr/local/go/src/net/http/transport.go:549 +0x73\r\n    \r\n    Goroutine 11 (finished) created at:\r\n      net/http.(*Transport).dialConn()\r\n          /usr/local/go/src/net/http/transport.go:686 +0x11e4\r\n      net/http.(*Transport).getConn.func4()\r\n          /usr/local/go/src/net/http/transport.go:549 +0x73\r\n    ==================\r\n",
	"user": {
		"login": "rogpeppe",
		"id": 66491,
		"type": "User",
		"site_admin": false
	},
	"assignee": {
		"login": "bradfitz",
		"id": 2621,
		"type": "User",
		"site_admin": false
	},
	"comments": 5,
	"closed_at": "2015-12-09T17:36:01Z",
	"created_at": "2015-09-30T15:58:48Z",
	"updated_at": "2016-05-03T08:26:40Z",
	"milestone": {
		"id": 1096159,
		"number": 24,
		"title": "Go1.6"
	}
}
