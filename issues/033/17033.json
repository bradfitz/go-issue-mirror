{
	"id": 175888275,
	"number": 17033,
	"state": "open",
	"title": "os/exec, syscall, runtime: hung system call starting process on OS X 10.8",
	"body": "I just noticed an OS X 10.8 builder hung.\r\n\r\nThe root cause was the builder was stuck in a system call trying to start a child process.\r\n\r\nLook at goroutine 511, which is what's blocking the other one:\r\n\r\n```\r\ngoroutine 511 [syscall, 387 minutes]:\r\nsyscall.Syscall(0x3, 0x8, 0x42166db50, 0x8, 0x0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/syscall/asm_darwin_amd64.s:16 +0x5\r\nsyscall.readlen(0x8, 0x42166db50, 0x8, 0x2, 0x421796000, 0x18)\r\n\t/home/bradfitz/go/src/syscall/zsyscall_darwin_amd64.go:1393 +0x56\r\nsyscall.forkExec(0x420838010, 0xd, 0x420838000, 0x1, 0x1, 0x42166dce0, 0x1ffffffffffffff, 0x2ff875, 0x42179a680)\r\n\t/home/bradfitz/go/src/syscall/exec_unix.go:202 +0x33e\r\nsyscall.StartProcess(0x420838010, 0xd, 0x420838000, 0x1, 0x1, 0x42166dce0, 0x2, 0x4, 0x5c620, 0x4204e04c0)\r\n\t/home/bradfitz/go/src/syscall/exec_unix.go:240 +0x64\r\nos.startProcess(0x420838010, 0xd, 0x420838000, 0x1, 0x1, 0x42166de88, 0x42171a000, 0x17, 0x17)\r\n\t/home/bradfitz/go/src/os/exec_posix.go:45 +0x1a3\r\nos.StartProcess(0x420838010, 0xd, 0x420838000, 0x1, 0x1, 0x42166de88, 0x0, 0x0, 0x42166de28)\r\n\t/home/bradfitz/go/src/os/exec.go:94 +0x64\r\nos/exec.(*Cmd).Start(0x4204dc420, 0x420838001, 0x4205421e0)\r\n\t/home/bradfitz/go/src/os/exec/exec.go:358 +0x3ce\r\nos/exec.(*Cmd).Run(0x4204dc420, 0x4205421e0, 0x0)\r\n\t/home/bradfitz/go/src/os/exec/exec.go:276 +0x2b\r\ngolang.org/x/build/pargzip.(*writeChunk).compress(0x42054a000, 0x0, 0x0)\r\n\t/home/bradfitz/src/golang.org/x/build/pargzip/pargzip.go:81 +0x1c5\r\ncreated by golang.org/x/build/pargzip.(*Writer).startChunk\r\n\t/home/bradfitz/src/golang.org/x/build/pargzip/pargzip.go:141 +0x16b\r\n```\r\n\r\nWhere `asm_darwin_amd64.s:16` is in the call to `runtime·entersyscall`:\r\n\r\n```\r\n//                                                                                                                             \r\n// System call support for AMD64, Darwin                                                                                       \r\n//                                                                                                                             \r\n\r\n// Trap # in AX, args in DI SI DX, return in AX DX                                                                             \r\n\r\n// func Syscall(trap, a1, a2, a3 uintptr) (r1, r2 uintptr, err Errno);                                                         \r\nTEXT    ·Syscall(SB),NOSPLIT,$0-56\r\n        CALL    runtime·entersyscall(SB)  // \u003c==================== LINE 16                                                                           \r\n        MOVQ    a1+8(FP), DI\r\n        MOVQ    a2+16(FP), SI\r\n        MOVQ    a3+24(FP), DX\r\n        MOVQ    $0, R10\r\n        MOVQ    $0, R8\r\n        MOVQ    $0, R9\r\n        MOVQ    trap+0(FP), AX  // syscall entry                                                                               \r\n        ADDQ    $0x2000000, AX\r\n        SYSCALL\r\n        JCC     ok\r\n        MOVQ    $-1, r1+32(FP)\r\n        MOVQ    $0, r2+40(FP)\r\n        MOVQ    AX, err+48(FP)\r\n        CALL    runtime·exitsyscall(SB)\r\n        RET\r\nok:\r\n        MOVQ    AX, r1+32(FP)\r\n        MOVQ    DX, r2+40(FP)\r\n        MOVQ    $0, err+48(FP)\r\n        CALL    runtime·exitsyscall(SB)\r\n        RET\r\n```\r\n\r\nAnd the system call it's doing is from:\r\n\r\n```go\r\n        // Read child error status from pipe.                                                                                  \r\n        Close(p[1])\r\n        n, err = readlen(p[0], (*byte)(unsafe.Pointer(\u0026err1)), int(unsafe.Sizeof(err1)))\r\n        Close(p[0])\r\n```\r\n\r\nWhich is:\r\n\r\n```go\r\nfunc readlen(fd int, p *byte, np int) (n int, err error) {\r\n        r0, _, e1 := Syscall(SYS_READ, uintptr(fd), uintptr(unsafe.Pointer(p)), uintptr(np))\r\n        n = int(r0)\r\n        if e1 != 0 {\r\n                err = errnoErr(e1)\r\n        }\r\n        return\r\n}       \r\n```\r\n\r\nFull SIGQUIT output:\r\n\r\n```\r\nkmr0000gn/T/workdir/go/src\r\n2016/09/08 09:34:01 [0x420539600] Run = ok, after 1m14.526362819s\r\n2016/09/08 09:34:01 Removing go/doc/gopher\r\n2016/09/08 09:34:01 Removing go/pkg/bootstrap\r\n^\\SIGQUIT: quit\r\nPC=0x65c6b m=0\r\n\r\ngoroutine 0 [idle]:\r\nruntime.mach_semaphore_wait(0x207, 0x580000000e, 0x0, 0x0, 0x16ae97, 0x456100, 0x7fff5fbff9e8, 0x5c4b3, 0xffffffffffffffff, 0x0, ...)\r\n\t/home/bradfitz/go/src/runtime/sys_darwin_amd64.s:418 +0xb\r\nruntime.semasleep1(0xffffffffffffffff, 0x0)\r\n\t/home/bradfitz/go/src/runtime/os_darwin.go:435 +0x4b\r\nruntime.semasleep.func1()\r\n\t/home/bradfitz/go/src/runtime/os_darwin.go:451 +0x33\r\nruntime.systemstack(0x7fff5fbffa10)\r\n\t/home/bradfitz/go/src/runtime/asm_amd64.s:314 +0xab\r\nruntime.semasleep(0xffffffffffffffff, 0x0)\r\n\t/home/bradfitz/go/src/runtime/os_darwin.go:452 +0x44\r\nruntime.notesleep(0x456830)\r\n\t/home/bradfitz/go/src/runtime/lock_sema.go:166 +0x81\r\nruntime.stopm()\r\n\t/home/bradfitz/go/src/runtime/proc.go:1594 +0xad\r\nruntime.findrunnable(0x4204e4000, 0x0)\r\n\t/home/bradfitz/go/src/runtime/proc.go:2021 +0x296\r\nruntime.schedule()\r\n\t/home/bradfitz/go/src/runtime/proc.go:2120 +0x14c\r\nruntime.goexit0(0x42091fa00)\r\n\t/home/bradfitz/go/src/runtime/proc.go:2257 +0x18c\r\nruntime.mcall(0x7fff5fbffbf0)\r\n\t/home/bradfitz/go/src/runtime/asm_amd64.s:240 +0x5b\r\n\r\ngoroutine 1 [chan receive, 379 minutes]:\r\ngolang.org/x/build/revdial.(*Listener).Accept(0x42053d880, 0x311d68, 0x420548080, 0x439b80, 0x4204e2090)\r\n\t/home/bradfitz/src/golang.org/x/build/revdial/revdial.go:451 +0x5e\r\nnet/http.(*Server).Serve(0x4205e4a00, 0x4392c0, 0x42053d880, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/net/http/server.go:2273 +0x1ce\r\nmain.dialCoordinator(0x2fe30d, 0x3)\r\n\t/home/bradfitz/src/golang.org/x/build/cmd/buildlet/reverse.go:140 +0xd7f\r\nmain.main()\r\n\t/home/bradfitz/src/golang.org/x/build/cmd/buildlet/buildlet.go:175 +0x63b\r\n\r\ngoroutine 35 [select, 387 minutes]:\r\ngolang.org/x/build/pargzip.(*Writer).startChunk(0x42175af50, 0x420672000, 0x100000, 0x100000)\r\n\t/home/bradfitz/src/golang.org/x/build/pargzip/pargzip.go:142 +0x23e\r\ngolang.org/x/build/pargzip.newChunkWriter.Write(0x42175af50, 0x420672000, 0x100000, 0x0, 0x3, 0x13, 0x4216c0000)\r\n\t/home/bradfitz/src/golang.org/x/build/pargzip/pargzip.go:214 +0xa0\r\nbufio.(*Writer).flush(0x42053c900, 0x4216c0000, 0x1a00)\r\n\t/home/bradfitz/go/src/bufio/bufio.go:563 +0x75\r\nbufio.(*Writer).Write(0x42053c900, 0x4216c0000, 0x6cde, 0x8000, 0x6cde, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/bufio/bufio.go:599 +0xd2\r\ngolang.org/x/build/pargzip.(*Writer).Write(0x42175af50, 0x4216c0000, 0x6cde, 0x8000, 0x6cde, 0x0, 0x0)\r\n\t/home/bradfitz/src/golang.org/x/build/pargzip/pargzip.go:172 +0x56\r\narchive/tar.(*Writer).Write(0x421764000, 0x4216c0000, 0x6cde, 0x8000, 0x6cde, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/archive/tar/writer.go:372 +0x83\r\nio.copyBuffer(0x434600, 0x421764000, 0x4355c0, 0x4204f2350, 0x4216c0000, 0x8000, 0x8000, 0xe99e, 0x42092f5f0, 0x42092f600)\r\n\t/home/bradfitz/go/src/io/io.go:392 +0x260\r\nio.Copy(0x434600, 0x421764000, 0x4355c0, 0x4204f2350, 0x0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/io/io.go:360 +0x68\r\nmain.handleGetTGZ.func1(0x4205ec420, 0x55, 0x43ae20, 0x4217972b0, 0x0, 0x0, 0x0, 0x0)\r\n\t/home/bradfitz/src/golang.org/x/build/cmd/buildlet/buildlet.go:433 +0x342\r\npath/filepath.walk(0x4205ec420, 0x55, 0x43ae20, 0x4217972b0, 0x4205e0cc0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/path/filepath/path.go:351 +0x81\r\npath/filepath.walk(0x420880dc0, 0x4d, 0x43ae20, 0x421797110, 0x4205e0cc0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/path/filepath/path.go:376 +0x344\r\npath/filepath.walk(0x420880c80, 0x48, 0x43ae20, 0x421796a90, 0x4205e0cc0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/path/filepath/path.go:376 +0x344\r\npath/filepath.walk(0x4204e0940, 0x3f, 0x43ae20, 0x4205fe410, 0x4205e0cc0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/path/filepath/path.go:376 +0x344\r\npath/filepath.walk(0x42053c840, 0x3b, 0x43ae20, 0x42171d6c0, 0x4205e0cc0, 0x0, 0x20)\r\n\t/home/bradfitz/go/src/path/filepath/path.go:376 +0x344\r\npath/filepath.Walk(0x42053c840, 0x3b, 0x4205e0cc0, 0x42053c840, 0x3b)\r\n\t/home/bradfitz/go/src/path/filepath/path.go:398 +0x14c\r\nmain.handleGetTGZ(0x439540, 0x42171d5f0, 0x420598b40)\r\n\t/home/bradfitz/src/golang.org/x/build/cmd/buildlet/buildlet.go:438 +0x3e5\r\nnet/http.HandlerFunc.ServeHTTP(0x311b50, 0x439540, 0x42171d5f0, 0x420598b40)\r\n\t/home/bradfitz/go/src/net/http/server.go:1726 +0x44\r\nmain.requirePasswordHandler.ServeHTTP(0x436440, 0x311b50, 0x0, 0x0, 0x439540, 0x42171d5f0, 0x420598b40)\r\n\t/home/bradfitz/src/golang.org/x/build/cmd/buildlet/buildlet.go:1126 +0xe0\r\nmain.(*requirePasswordHandler).ServeHTTP(0x4204de980, 0x439540, 0x42171d5f0, 0x420598b40)\r\n\t\u003cautogenerated\u003e:25 +0x8b\r\nnet/http.(*ServeMux).ServeHTTP(0x455740, 0x439540, 0x42171d5f0, 0x420598b40)\r\n\t/home/bradfitz/go/src/net/http/server.go:2022 +0x7f\r\nnet/http.serverHandler.ServeHTTP(0x4205e4a00, 0x439540, 0x42171d5f0, 0x420598b40)\r\n\t/home/bradfitz/go/src/net/http/server.go:2202 +0x7d\r\nnet/http.(*conn).serve(0x4205e4400, 0x439ac0, 0x42053c340)\r\n\t/home/bradfitz/go/src/net/http/server.go:1579 +0x4b7\r\ncreated by net/http.(*Server).Serve\r\n\t/home/bradfitz/go/src/net/http/server.go:2293 +0x44d\r\n\r\ngoroutine 37 [chan receive, 387 minutes]:\r\ngolang.org/x/build/pargzip.(*Writer).writeCompressedChunk(0x42175af50, 0x42054a000, 0x0, 0x0)\r\n\t/home/bradfitz/src/golang.org/x/build/pargzip/pargzip.go:160 +0x97\r\ngolang.org/x/build/pargzip.(*Writer).init.func1(0x42175af50)\r\n\t/home/bradfitz/src/golang.org/x/build/pargzip/pargzip.go:126 +0xaf\r\ncreated by golang.org/x/build/pargzip.(*Writer).init\r\n\t/home/bradfitz/src/golang.org/x/build/pargzip/pargzip.go:131 +0x109\r\n\r\ngoroutine 16 [IO wait]:\r\nnet.runtime_pollWait(0x84206d2dd0, 0x72, 0x3)\r\n\t/home/bradfitz/go/src/runtime/netpoll.go:160 +0x59\r\nnet.(*pollDesc).wait(0x420516220, 0x72, 0x436f00, 0x4205240b0)\r\n\t/home/bradfitz/go/src/net/fd_poll_runtime.go:75 +0x38\r\nnet.(*pollDesc).waitRead(0x420516220, 0x420670000, 0x2000)\r\n\t/home/bradfitz/go/src/net/fd_poll_runtime.go:80 +0x34\r\nnet.(*netFD).Read(0x4205161c0, 0x420670000, 0x2000, 0x2000, 0x0, 0x436f00, 0x4205240b0)\r\n\t/home/bradfitz/go/src/net/fd_unix.go:243 +0x181\r\nnet.(*conn).Read(0x4204f2000, 0x420670000, 0x2000, 0x2000, 0x0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/net/net.go:173 +0x70\r\ncrypto/tls.(*block).readFromUntil(0x4208ffb90, 0x842053d368, 0x4204f2000, 0x5, 0x4204f2000, 0x0)\r\n\t/home/bradfitz/go/src/crypto/tls/conn.go:472 +0x91\r\ncrypto/tls.(*Conn).readRecord(0x4208fc000, 0x312317, 0x4208fc100, 0x420524020)\r\n\t/home/bradfitz/go/src/crypto/tls/conn.go:574 +0xc4\r\ncrypto/tls.(*Conn).Read(0x4208fc000, 0x420871000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/crypto/tls/conn.go:1109 +0x116\r\nbufio.(*Reader).fill(0x42091cde0)\r\n\t/home/bradfitz/go/src/bufio/bufio.go:97 +0x10b\r\nbufio.(*Reader).Read(0x42091cde0, 0x420839fe0, 0x7, 0x7, 0x70, 0x42175a000, 0x42054a750)\r\n\t/home/bradfitz/go/src/bufio/bufio.go:209 +0x1bc\r\nio.ReadAtLeast(0x434640, 0x42091cde0, 0x420839fe0, 0x7, 0x7, 0x7, 0x0, 0x42054a730, 0x4204de180)\r\n\t/home/bradfitz/go/src/io/io.go:307 +0xa4\r\nio.ReadFull(0x434640, 0x42091cde0, 0x420839fe0, 0x7, 0x7, 0x0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/io/io.go:325 +0x58\r\ngolang.org/x/build/revdial.readFrames(0x42091cde0, 0x434b80, 0x42053d880, 0x16ae3f, 0x420540200)\r\n\t/home/bradfitz/src/golang.org/x/build/revdial/revdial.go:373 +0xb4\r\ngolang.org/x/build/revdial.NewListener.func1(0x420839fb0, 0x42053d880)\r\n\t/home/bradfitz/src/golang.org/x/build/revdial/revdial.go:417 +0x5c\r\ncreated by golang.org/x/build/revdial.NewListener\r\n\t/home/bradfitz/src/golang.org/x/build/revdial/revdial.go:431 +0x119\r\n\r\ngoroutine 511 [syscall, 387 minutes]:\r\nsyscall.Syscall(0x3, 0x8, 0x42166db50, 0x8, 0x0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/syscall/asm_darwin_amd64.s:16 +0x5\r\nsyscall.readlen(0x8, 0x42166db50, 0x8, 0x2, 0x421796000, 0x18)\r\n\t/home/bradfitz/go/src/syscall/zsyscall_darwin_amd64.go:1393 +0x56\r\nsyscall.forkExec(0x420838010, 0xd, 0x420838000, 0x1, 0x1, 0x42166dce0, 0x1ffffffffffffff, 0x2ff875, 0x42179a680)\r\n\t/home/bradfitz/go/src/syscall/exec_unix.go:202 +0x33e\r\nsyscall.StartProcess(0x420838010, 0xd, 0x420838000, 0x1, 0x1, 0x42166dce0, 0x2, 0x4, 0x5c620, 0x4204e04c0)\r\n\t/home/bradfitz/go/src/syscall/exec_unix.go:240 +0x64\r\nos.startProcess(0x420838010, 0xd, 0x420838000, 0x1, 0x1, 0x42166de88, 0x42171a000, 0x17, 0x17)\r\n\t/home/bradfitz/go/src/os/exec_posix.go:45 +0x1a3\r\nos.StartProcess(0x420838010, 0xd, 0x420838000, 0x1, 0x1, 0x42166de88, 0x0, 0x0, 0x42166de28)\r\n\t/home/bradfitz/go/src/os/exec.go:94 +0x64\r\nos/exec.(*Cmd).Start(0x4204dc420, 0x420838001, 0x4205421e0)\r\n\t/home/bradfitz/go/src/os/exec/exec.go:358 +0x3ce\r\nos/exec.(*Cmd).Run(0x4204dc420, 0x4205421e0, 0x0)\r\n\t/home/bradfitz/go/src/os/exec/exec.go:276 +0x2b\r\ngolang.org/x/build/pargzip.(*writeChunk).compress(0x42054a000, 0x0, 0x0)\r\n\t/home/bradfitz/src/golang.org/x/build/pargzip/pargzip.go:81 +0x1c5\r\ncreated by golang.org/x/build/pargzip.(*Writer).startChunk\r\n\t/home/bradfitz/src/golang.org/x/build/pargzip/pargzip.go:141 +0x16b\r\n\r\ngoroutine 535 [semacquire]:\r\nsync.runtime_notifyListWait(0x42053c6d0, 0x8d9)\r\n\t/home/bradfitz/go/src/runtime/sema.go:267 +0x121\r\nsync.(*Cond).Wait(0x42053c6c0)\r\n\t/home/bradfitz/go/src/sync/cond.go:57 +0x80\r\ngolang.org/x/build/revdial.(*conn).Read(0x42054a730, 0x42095f000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/bradfitz/src/golang.org/x/build/revdial/revdial.go:296 +0xe5\r\nnet/http.(*connReader).Read(0x4204de120, 0x42095f000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/net/http/server.go:586 +0x144\r\nbufio.(*Reader).fill(0x420522240)\r\n\t/home/bradfitz/go/src/bufio/bufio.go:97 +0x10b\r\nbufio.(*Reader).ReadSlice(0x420522240, 0x42050ba0a, 0x84a6b, 0x4208fc1b0, 0x4205ae810, 0xac, 0x8000)\r\n\t/home/bradfitz/go/src/bufio/bufio.go:330 +0xb5\r\nbufio.(*Reader).ReadLine(0x420522240, 0x4217620f0, 0xf0, 0xf0, 0x2f5040, 0x4208fc310, 0x1ee7b2)\r\n\t/home/bradfitz/go/src/bufio/bufio.go:359 +0x37\r\nnet/textproto.(*Reader).readLineSlice(0x4208fe7b0, 0x42050baa8, 0x42050baa8, 0x1e518, 0xf0, 0x2f5040)\r\n\t/home/bradfitz/go/src/net/textproto/reader.go:55 +0x5e\r\nnet/textproto.(*Reader).ReadLine(0x4208fe7b0, 0x4217620f0, 0x1000, 0x8f, 0x0)\r\n\t/home/bradfitz/go/src/net/textproto/reader.go:36 +0x2f\r\nnet/http.readRequest(0x420522240, 0x0, 0x4217620f0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/net/http/request.go:793 +0xa5\r\nnet/http.(*conn).readRequest(0x420548080, 0x439ac0, 0x42053c780, 0x0, 0x0, 0x0)\r\n\t/home/bradfitz/go/src/net/http/server.go:765 +0x10d\r\nnet/http.(*conn).serve(0x420548080, 0x439ac0, 0x42053c780)\r\n\t/home/bradfitz/go/src/net/http/server.go:1532 +0x3d3\r\ncreated by net/http.(*Server).Serve\r\n\t/home/bradfitz/go/src/net/http/server.go:2293 +0x44d\r\n\r\nrax    0xe\r\nrbx    0x456720\r\nrcx    0x7fff5fbff988\r\nrdx    0x7fff5fbffa10\r\nrdi    0x207\r\nrsi    0xd3\r\nrbp    0x7fff5fbff9c0\r\nrsp    0x7fff5fbff988\r\nr8     0x42091fa00\r\nr9     0x3\r\nr10    0x0\r\nr11    0x246\r\nr12    0x0\r\nr13    0x42091fa00\r\nr14    0x4b140\r\nr15    0x377130\r\nrip    0x65c6b\r\nrflags 0x246\r\ncs     0x7\r\nfs     0x0\r\ngs     0x0\r\n```\r\n\r\n/cc @ianlancetaylor @aclements @cherrymui @josharian \r\n",
	"user": {
		"login": "bradfitz",
		"id": 2621,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "NeedsInvestigation"
		},
		{
			"name": "OS-Darwin"
		}
	],
	"comments": 0,
	"created_at": "2016-09-08T23:15:15Z",
	"updated_at": "2016-10-18T05:26:55Z",
	"milestone": {
		"id": 1709363,
		"number": 38,
		"title": "Go1.8"
	}
}
