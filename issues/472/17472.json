{
	"id": 183297506,
	"number": 17472,
	"state": "open",
	"title": "all: various failures when all tests are run without -short",
	"body": "I saw some bugs with go test in cmd/go, so I decided to run everything without -short. Need to run go test without -short once in a while on the whole tree. I tried it today and there were some disappointments.\r\n\r\nI'll let someone else decide if they want to break out individual bugs for the failures, but the point made in the first paragraph still stands: Before release, test everything.\r\n\r\n### What version of Go are you using (`go version`)?\r\n\r\ngo version devel +7a60a96 Sat Apr 30 05:59:54 2016 +0000 darwin/amd64\r\n\r\n\r\n### What operating system and processor architecture are you using (`go env`)?\r\n\r\nwally=% go env\r\nGOARCH=\"amd64\"\r\nGOBIN=\"/Users/r/bin\"\r\nGOEXE=\"\"\r\nGOHOSTARCH=\"amd64\"\r\nGOHOSTOS=\"darwin\"\r\nGOOS=\"darwin\"\r\nGOPATH=\"/Users/r\"\r\nGORACE=\"\"\r\nGOROOT=\"/Users/r/go\"\r\nGOTOOLDIR=\"/Users/r/go/pkg/tool/darwin_amd64\"\r\nCC=\"clang\"\r\nGOGCCFLAGS=\"-fPIC -m64 -pthread -fno-caret-diagnostics -Qunused-arguments -fmessage-length=0 -fdebug-prefix-map=/var/folders/r3/cryt3b891yj6rzqr8vzcn2xc0000gn/T/go-build408997659=/tmp/go-build -gno-record-gcc-switches -fno-common\"\r\nCXX=\"clang++\"\r\nCGO_ENABLED=\"1\"\r\nwally=% \r\n\r\n### What did you do?\r\n\r\ncd $GOROOT/src; go test ./...\r\n\r\n\r\n### What did you expect to see?\r\n\r\nEverything passes.\r\n\r\n### What did you see instead?\r\n\r\nMost do well, but some crash and some (math/big for example) are just crazy slow and time out\r\n\r\n```\r\nwally=% go test ./...\r\nok  \tarchive/tar\t0.049s\r\nok  \tarchive/zip\t45.824s\r\nok  \tbufio\t0.095s\r\n?   \tbuiltin\t[no test files]\r\nok  \tbytes\t1.378s\r\nok  \tcmd/addr2line\t0.915s\r\nok  \tcmd/api\t0.017s\r\n?   \tcmd/asm\t[no test files]\r\n?   \tcmd/asm/internal/arch\t[no test files]\r\nok  \tcmd/asm/internal/asm\t0.214s\r\n?   \tcmd/asm/internal/flags\t[no test files]\r\nok  \tcmd/asm/internal/lex\t0.013s\r\n?   \tcmd/cgo\t[no test files]\r\nok  \tcmd/compile\t6.745s\r\n?   \tcmd/compile/internal/amd64\t[no test files]\r\n?   \tcmd/compile/internal/arm\t[no test files]\r\n?   \tcmd/compile/internal/arm64\t[no test files]\r\nSIGQUIT: quit\r\nPC=0x5222b m=0\r\n\r\ngoroutine 0 [idle]:\r\nruntime.mach_semaphore_wait(0x7fff00000803, 0x0, 0x14, 0x0, 0x100437600, 0x358900, 0x7fff5fbff6e8, 0x4c803, 0xffffffffffffffff, 0x4300000000, ...)\r\n\t/Users/r/go/src/runtime/sys_darwin_amd64.s:414 +0xb\r\nruntime.semasleep1(0xffffffffffffffff, 0x4300000000)\r\n\t/Users/r/go/src/runtime/os_darwin.go:413 +0x4b\r\nruntime.semasleep.func1()\r\n\t/Users/r/go/src/runtime/os_darwin.go:429 +0x33\r\nruntime.systemstack(0x7fff5fbff710)\r\n\t/Users/r/go/src/runtime/asm_amd64.s:314 +0xab\r\nruntime.semasleep(0xffffffffffffffff, 0x0)\r\n\t/Users/r/go/src/runtime/os_darwin.go:430 +0x44\r\nruntime.notesleep(0x358d70)\r\n\t/Users/r/go/src/runtime/lock_sema.go:166 +0xb2\r\nruntime.stopm()\r\n\t/Users/r/go/src/runtime/proc.go:1598 +0xad\r\nruntime.findrunnable(0xc42001c600, 0x0)\r\n\t/Users/r/go/src/runtime/proc.go:2030 +0x241\r\nruntime.schedule()\r\n\t/Users/r/go/src/runtime/proc.go:2129 +0x14c\r\nruntime.park_m(0xc420057380)\r\n\t/Users/r/go/src/runtime/proc.go:2192 +0xa0\r\nruntime.mcall(0x7fff5fbff8e0)\r\n\t/Users/r/go/src/runtime/asm_amd64.s:240 +0x5b\r\n\r\ngoroutine 1 [chan receive, 3 minutes]:\r\ntesting.(*T).Run(0xc420264000, 0x23d6d7, 0x17, 0x24bf90, 0x51f01)\r\n\t/Users/r/go/src/testing/testing.go:658 +0x2e6\r\ntesting.RunTests.func1(0xc420264000)\r\n\t/Users/r/go/src/testing/testing.go:804 +0x67\r\ntesting.tRunner(0xc420264000, 0xc420040e30)\r\n\t/Users/r/go/src/testing/testing.go:621 +0x81\r\ntesting.RunTests(0x24ca88, 0x355360, 0x94, 0x94, 0xc420423800)\r\n\t/Users/r/go/src/testing/testing.go:810 +0x2bb\r\ntesting.(*M).Run(0xc420040ef8, 0xc42006c230)\r\n\t/Users/r/go/src/testing/testing.go:754 +0x85\r\nmain.main()\r\n\tcmd/compile/internal/big/_test/_testmain.go:452 +0xc6\r\n\r\ngoroutine 194 [runnable]:\r\ncmd/compile/internal/big.nat.trailingZeroBits(0xc42050e000, 0x30d5, 0x511f, 0xc4204d4140)\r\n\t/Users/r/go/src/cmd/compile/internal/big/nat.go:691 +0x91\r\ncmd/compile/internal/big.(*Int).binaryGCD(0xc4204d4140, 0xc42021c080, 0xc42021c0a0, 0x333148)\r\n\t/Users/r/go/src/cmd/compile/internal/big/int.go:540 +0x411\r\ncmd/compile/internal/big.(*Rat).norm(0xc42021c080, 0x0)\r\n\t/Users/r/go/src/cmd/compile/internal/big/rat.go:425 +0x122\r\ncmd/compile/internal/big.(*Rat).Sub(0xc42021c080, 0xc42021c300, 0xc4200cdb38, 0xc42021c040)\r\n\t/Users/r/go/src/cmd/compile/internal/big/rat.go:488 +0x15a\r\ncmd/compile/internal/big.delta(0xc42021c300, 0xb6a0000000000000, 0xc42021c040)\r\n\t/Users/r/go/src/cmd/compile/internal/big/rat_test.go:517 +0x95\r\ncmd/compile/internal/big.checkIsBestApprox32(0xc420264300, 0x80000000, 0xc42021c300, 0x8000000000000000)\r\n\t/Users/r/go/src/cmd/compile/internal/big/rat_test.go:537 +0x140\r\ncmd/compile/internal/big.TestFloat32SpecialCases(0xc420264300)\r\n\t/Users/r/go/src/cmd/compile/internal/big/ratconv_test.go:386 +0x220\r\ntesting.tRunner(0xc420264300, 0x24bf90)\r\n\t/Users/r/go/src/testing/testing.go:621 +0x81\r\ncreated by testing.(*T).Run\r\n\t/Users/r/go/src/testing/testing.go:657 +0x2bc\r\n\r\nrax    0xe\r\nrbx    0x358c60\r\nrcx    0x7fff5fbff688\r\nrdx    0x7fff5fbff710\r\nrdi    0x803\r\nrsi    0x401\r\nrbp    0x7fff5fbff6c0\r\nrsp    0x7fff5fbff688\r\nr8     0x7fff5fbff668\r\nr9     0x0\r\nr10    0x0\r\nr11    0x286\r\nr12    0x0\r\nr13    0xc420000ea0\r\nr14    0x38c40\r\nr15    0x2a18d0\r\nrip    0x5222b\r\nrflags 0x286\r\ncs     0x7\r\nfs     0x0\r\ngs     0x0\r\n*** Test killed with quit: ran too long (10m0s).\r\nFAIL\tcmd/compile/internal/big\t600.017s\r\nok  \tcmd/compile/internal/gc\t171.985s\r\n?   \tcmd/compile/internal/mips64\t[no test files]\r\n?   \tcmd/compile/internal/ppc64\t[no test files]\r\n?   \tcmd/compile/internal/s390x\t[no test files]\r\nok  \tcmd/compile/internal/ssa\t0.253s\r\nok  \tcmd/compile/internal/syntax\t4.552s\r\nok  \tcmd/compile/internal/test\t0.013s\r\n?   \tcmd/compile/internal/x86\t[no test files]\r\nok  \tcmd/cover\t1.919s\r\n?   \tcmd/dist\t[no test files]\r\nok  \tcmd/doc\t0.265s\r\nok  \tcmd/fix\t0.025s\r\n--- FAIL: TestRepoRootForImportPath (1.02s)\r\n\tvcs_test.go:164: RepoRootForImport(\"git.openstack.org/openstack/swift.git\") = VCS(Git) Repo(https://git.openstack.org/openstack/swift.git), want VCS(Git) Repo(https://git.openstack.org/openstack/swift)\r\n--- FAIL: TestCoverageRuns (4.20s)\r\n\tgo_test.go:244: running testgo [test -short -coverpkg=strings strings regexp]\r\n\tgo_test.go:259: standard output:\r\n\tgo_test.go:260: --- FAIL: TestIndexRune (0.00s)\r\n\t\t\tstrings_test.go:272: expected no allocations, got 1.000000\r\n\t\tFAIL\r\n\t\tcoverage: 97.2% of statements in strings\r\n\t\tFAIL\tstrings\t0.168s\r\n\t\tok  \tregexp\t0.188s\tcoverage: 15.5% of statements in strings\r\n\t\t\r\n\tgo_test.go:273: go [test -short -coverpkg=strings strings regexp] failed unexpectedly: exit status 1\r\n--- FAIL: TestGoGetUpdateInsecure (0.03s)\r\n\tgo_test.go:2449: cloning github.com/golang/example repo: exit status 128\r\n\t\tfatal: transport 'http' not allowed\r\n--- FAIL: TestGoGetInsecureCustomDomain (3.17s)\r\n\tgo_test.go:244: running testgo [get -d wh3rd.net/repo]\r\n\tgo_test.go:263: standard error:\r\n\tgo_test.go:264: package wh3rd.net/repo: cannot download, http://wh3rd.net/git uses insecure protocol\r\n\t\t\r\n\tgo_test.go:283: testgo failed as expected: exit status 1\r\n\tgo_test.go:244: running testgo [get -d -insecure wh3rd.net/repo]\r\n\tgo_test.go:263: standard error:\r\n\tgo_test.go:264: # cd .; git clone http://wh3rd.net/git /var/folders/r3/cryt3b891yj6rzqr8vzcn2xc0000gn/T/gotest969981157/src/wh3rd.net/repo\r\n\t\tCloning into '/var/folders/r3/cryt3b891yj6rzqr8vzcn2xc0000gn/T/gotest969981157/src/wh3rd.net/repo'...\r\n\t\tfatal: transport 'http' not allowed\r\n\t\tpackage wh3rd.net/repo: exit status 128\r\n\t\t\r\n\tgo_test.go:273: go [get -d -insecure wh3rd.net/repo] failed unexpectedly: exit status 1\r\nFAIL\r\nFAIL\tcmd/go\t363.020s\r\nok  \tcmd/gofmt\t43.335s\r\n?   \tcmd/internal/bio\t[no test files]\r\n?   \tcmd/internal/browser\t[no test files]\r\n?   \tcmd/internal/dwarf\t[no test files]\r\n?   \tcmd/internal/gcprog\t[no test files]\r\nok  \tcmd/internal/goobj\t0.013s\r\nok  \tcmd/internal/obj\t0.014s\r\n?   \tcmd/internal/obj/arm\t[no test files]\r\n?   \tcmd/internal/obj/arm64\t[no test files]\r\n?   \tcmd/internal/obj/mips\t[no test files]\r\n?   \tcmd/internal/obj/ppc64\t[no test files]\r\n?   \tcmd/internal/obj/s390x\t[no test files]\r\nok  \tcmd/internal/obj/x86\t0.118s\r\n?   \tcmd/internal/objfile\t[no test files]\r\n?   \tcmd/internal/pprof/commands\t[no test files]\r\n?   \tcmd/internal/pprof/driver\t[no test files]\r\n?   \tcmd/internal/pprof/fetch\t[no test files]\r\n?   \tcmd/internal/pprof/plugin\t[no test files]\r\nok  \tcmd/internal/pprof/profile\t0.014s\r\n?   \tcmd/internal/pprof/report\t[no test files]\r\n?   \tcmd/internal/pprof/svg\t[no test files]\r\n?   \tcmd/internal/pprof/symbolizer\t[no test files]\r\n?   \tcmd/internal/pprof/symbolz\t[no test files]\r\n?   \tcmd/internal/pprof/tempfile\t[no test files]\r\n?   \tcmd/internal/sys\t[no test files]\r\nok  \tcmd/link\t0.014s\r\n?   \tcmd/link/internal/amd64\t[no test files]\r\n?   \tcmd/link/internal/arm\t[no test files]\r\n?   \tcmd/link/internal/arm64\t[no test files]\r\n?   \tcmd/link/internal/ld\t[no test files]\r\n?   \tcmd/link/internal/mips64\t[no test files]\r\nok  \tcmd/link/internal/pe\t0.025s\r\n?   \tcmd/link/internal/ppc64\t[no test files]\r\n?   \tcmd/link/internal/s390x\t[no test files]\r\n?   \tcmd/link/internal/x86\t[no test files]\r\nok  \tcmd/nm\t14.478s\r\nok  \tcmd/objdump\t39.243s\r\nok  \tcmd/pack\t9.990s\r\n?   \tcmd/pprof\t[no test files]\r\nok  \tcmd/trace\t0.032s\r\nok  \tcmd/vendor/golang.org/x/arch/arm/armasm\t0.020s\r\nok  \tcmd/vendor/golang.org/x/arch/ppc64/ppc64asm\t0.017s\r\nok  \tcmd/vendor/golang.org/x/arch/x86/x86asm\t0.453s\r\nok  \tcmd/vet\t15.959s\r\nok  \tcmd/vet/internal/cfg\t0.015s\r\n?   \tcmd/vet/internal/whitelist\t[no test files]\r\nok  \tcompress/bzip2\t0.080s\r\nok  \tcompress/flate\t40.458s\r\nok  \tcompress/gzip\t0.141s\r\nok  \tcompress/lzw\t0.087s\r\nok  \tcompress/zlib\t2.196s\r\nok  \tcontainer/heap\t0.016s\r\nok  \tcontainer/list\t0.015s\r\nok  \tcontainer/ring\t0.029s\r\nok  \tcontext\t2.509s\r\n?   \tcrypto\t[no test files]\r\nok  \tcrypto/aes\t0.111s\r\nok  \tcrypto/cipher\t2.687s\r\nok  \tcrypto/des\t0.029s\r\nok  \tcrypto/dsa\t40.585s\r\nok  \tcrypto/ecdsa\t7.006s\r\nok  \tcrypto/elliptic\t0.753s\r\nok  \tcrypto/hmac\t0.016s\r\nok  \tcrypto/md5\t0.016s\r\nok  \tcrypto/rand\t1.083s\r\nok  \tcrypto/rc4\t0.142s\r\nok  \tcrypto/rsa\t1.186s\r\nok  \tcrypto/sha1\t0.055s\r\nok  \tcrypto/sha256\t0.018s\r\nok  \tcrypto/sha512\t0.018s\r\nok  \tcrypto/subtle\t0.022s\r\nok  \tcrypto/tls\t305.765s\r\nok  \tcrypto/x509\t8.573s\r\n?   \tcrypto/x509/pkix\t[no test files]\r\nok  \tdatabase/sql\t0.537s\r\nok  \tdatabase/sql/driver\t0.014s\r\nok  \tdebug/dwarf\t0.029s\r\nok  \tdebug/elf\t0.038s\r\nok  \tdebug/gosym\t0.318s\r\nok  \tdebug/macho\t0.011s\r\nok  \tdebug/pe\t0.019s\r\nok  \tdebug/plan9obj\t0.011s\r\n?   \tencoding\t[no test files]\r\nok  \tencoding/ascii85\t0.010s\r\nok  \tencoding/asn1\t0.018s\r\nok  \tencoding/base32\t0.011s\r\nok  \tencoding/base64\t0.011s\r\nok  \tencoding/binary\t0.010s\r\nok  \tencoding/csv\t0.009s\r\nok  \tencoding/gob\t3.912s\r\nok  \tencoding/hex\t0.013s\r\nok  \tencoding/json\t3.027s\r\nok  \tencoding/pem\t0.020s\r\nok  \tencoding/xml\t0.016s\r\nok  \terrors\t0.009s\r\nok  \texpvar\t0.015s\r\nok  \tflag\t0.010s\r\nok  \tfmt\t0.150s\r\nok  \tgo/ast\t0.017s\r\nok  \tgo/build\t0.265s\r\nok  \tgo/constant\t0.015s\r\nok  \tgo/doc\t0.062s\r\nok  \tgo/format\t0.021s\r\n?   \tgo/importer\t[no test files]\r\nok  \tgo/internal/gccgoimporter\t0.016s\r\nok  \tgo/internal/gcimporter\t1.312s\r\nok  \tgo/parser\t0.051s\r\nok  \tgo/printer\t0.351s\r\nok  \tgo/scanner\t0.015s\r\nok  \tgo/token\t0.026s\r\nok  \tgo/types\t12.281s\r\n?   \thash\t[no test files]\r\nok  \thash/adler32\t0.018s\r\nok  \thash/crc32\t0.019s\r\nok  \thash/crc64\t0.011s\r\nok  \thash/fnv\t0.015s\r\nok  \thtml\t0.014s\r\nok  \thtml/template\t0.054s\r\nok  \timage\t0.619s\r\nok  \timage/color\t0.100s\r\n?   \timage/color/palette\t[no test files]\r\nok  \timage/draw\t0.089s\r\nok  \timage/gif\t0.072s\r\n?   \timage/internal/imageutil\t[no test files]\r\nok  \timage/jpeg\t0.191s\r\nok  \timage/png\t0.142s\r\nok  \tindex/suffixarray\t0.022s\r\n?   \tinternal/nettrace\t[no test files]\r\n?   \tinternal/race\t[no test files]\r\nok  \tinternal/singleflight\t0.025s\r\n?   \tinternal/syscall/windows\t[no test files]\r\n?   \tinternal/syscall/windows/registry\t[no test files]\r\n?   \tinternal/syscall/windows/sysdll\t[no test files]\r\n?   \tinternal/testenv\t[no test files]\r\nok  \tinternal/trace\t0.043s\r\nok  \tio\t0.030s\r\nok  \tio/ioutil\t0.015s\r\nok  \tlog\t0.016s\r\nok  \tlog/syslog\t2.082s\r\nok  \tmath\t0.016s\r\nok  \tmath/big\t2.500s\r\nok  \tmath/cmplx\t0.015s\r\nok  \tmath/rand\t1.170s\r\nok  \tmime\t0.021s\r\nok  \tmime/multipart\t0.483s\r\nok  \tmime/quotedprintable\t0.169s\r\nok  \tnet\t71.162s\r\nok  \tnet/http\t36.075s\r\nok  \tnet/http/cgi\t0.588s\r\nok  \tnet/http/cookiejar\t0.017s\r\nok  \tnet/http/fcgi\t0.014s\r\nok  \tnet/http/httptest\t0.124s\r\nok  \tnet/http/httptrace\t0.012s\r\nok  \tnet/http/httputil\t0.067s\r\nok  \tnet/http/internal\t0.014s\r\n?   \tnet/http/pprof\t[no test files]\r\nok  \tnet/internal/socktest\t0.967s\r\nok  \tnet/mail\t0.011s\r\nok  \tnet/rpc\t0.025s\r\nok  \tnet/rpc/jsonrpc\t0.017s\r\nok  \tnet/smtp\t0.019s\r\nok  \tnet/textproto\t0.012s\r\nok  \tnet/url\t0.015s\r\nok  \tos\t1.380s\r\nok  \tos/exec\t0.506s\r\nok  \tos/signal\t7.216s\r\nok  \tos/user\t0.013s\r\nok  \tpath\t0.010s\r\nok  \tpath/filepath\t0.038s\r\n?   \tplugin\t[no test files]\r\nok  \treflect\t0.872s\r\nok  \tregexp\t33.375s\r\nok  \tregexp/syntax\t0.477s\r\nok  \truntime\t217.252s\r\n?   \truntime/cgo\t[no test files]\r\nok  \truntime/debug\t0.018s\r\nok  \truntime/internal/atomic\t0.286s\r\nok  \truntime/internal/sys\t0.013s\r\nok  \truntime/pprof\t25.184s\r\n?   \truntime/race\t[no test files]\r\nok  \truntime/trace\t1.678s\r\nok  \tsort\t1.099s\r\nok  \tstrconv\t2.417s\r\nok  \tstrings\t0.548s\r\n--- FAIL: TestWaitGroupMisuse2 (1.49s)\r\n\twaitgroup_test.go:114: Should panic\r\n\twaitgroup_test.go:84: Unexpected panic: \u003cnil\u003e\r\nFAIL\r\nFAIL\tsync\t1.972s\r\nok  \tsync/atomic\t2.872s\r\nok  \tsyscall\t0.081s\r\nok  \ttesting\t3.199s\r\n?   \ttesting/iotest\t[no test files]\r\nok  \ttesting/quick\t0.052s\r\nok  \ttext/scanner\t0.012s\r\nok  \ttext/tabwriter\t0.011s\r\nok  \ttext/template\t0.454s\r\nok  \ttext/template/parse\t0.016s\r\nok  \ttime\t7.398s\r\nok  \tunicode\t0.012s\r\nok  \tunicode/utf16\t0.012s\r\nok  \tunicode/utf8\t0.013s\r\n?   \tunsafe\t[no test files]\r\nok  \tvendor/golang_org/x/crypto/curve25519\t0.033s\r\nok  \tvendor/golang_org/x/net/http2/hpack\t0.060s\r\nok  \tvendor/golang_org/x/net/idna\t0.014s\r\nok  \tvendor/golang_org/x/net/lex/httplex\t0.013s\r\nok  \tvendor/golang_org/x/net/route\t0.057s\r\n?   \tvendor/golang_org/x/text/transform\t[no test files]\r\n?   \tvendor/golang_org/x/text/unicode/norm\t[no test files]\r\n?   \tvendor/golang_org/x/text/width\t[no test files]\r\nwally=% \r\n```\r\n",
	"user": {
		"login": "robpike",
		"id": 4324516,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "Builders"
		},
		{
			"name": "NeedsInvestigation"
		}
	],
	"comments": 1,
	"created_at": "2016-10-16T22:51:05Z",
	"updated_at": "2016-10-17T22:28:58Z",
	"milestone": {
		"id": 1709363,
		"number": 38,
		"title": "Go1.8"
	}
}
