{
	"id": 51279210,
	"number": 2436,
	"state": "closed",
	"title": "build: fix version.bash info (+fix)",
	"body": "\u003cpre\u003eI'm not sure why this wasn't happening earlier, as I almost always have local\nmodifications.  It's possible that something else about my setup caused this.  I synced\nforward, then to a non-tagged non-tip version, then sync'd back before I noticed this\nissue.\n\nJust in case this is the issue:\n$ awk --version\nGNU Awk 3.1.6\n\nThere is no VERSION file:\n$ rm VERSION ../VERSION\nrm: cannot remove `VERSION': No such file or directory\nrm: cannot remove `../VERSION': No such file or directory\n\nMercurial reports the correct tag:\n$ hg id\nd7322ae4d055+ weekly.2011-09-21\n\n./version.bash doesn't:\n$ ./version.bash\nweekly.2011-11-09 9839+\n\nHere's what hg tags says: (used by version.bash)\n$ hg tags | grep weekly | sed 's/:.*//'\nweekly.2011-11-09              10370\nweekly                         10370\nweekly.2011-11-08              10363\nweekly.2011-11-02              10272\nweekly.2011-11-01              10249\nweekly.2011-10-26              10183\nweekly.2011-10-25              10163\nweekly.2011-10-18              10125\nweekly.2011-10-06               9969\nweekly.2011-09-21               9839\nweekly.2011-09-16               9776\nweekly.2011-09-07               9681\nweekly.2011-09-01               9631\nweekly.2011-08-17               9454\nweekly.2011-08-10               9366\nweekly.2011-07-29               9301\nweekly.2011-07-19               9178\nweekly.2011-07-07               9017\nweekly.2011-06-23               8875\nweekly.2011-06-16               8787\nweekly.2011-06-09               8703\nweekly.2011-06-02               8623\nweekly.2011-05-22               8483\nweekly.2011-04-27               8257\nweekly.2011-04-13               8085\nweekly.2011-04-04               7978\nweekly.2011-03-28               7901\nweekly.2011-03-15               7778\nweekly.2011-03-07.1             7666\nweekly.2011-03-07               7659\nweekly.2011-02-24               7569\nweekly.2011-02-15               7463\nweekly.2011-02-01.1             7324\nweekly.2011-02-01               7321\nweekly.2011-01-20               7188\nweekly.2011-01-19               7181\nweekly.2011-01-12               7105\nweekly.2011-01-06               7053\nweekly.2010-12-22               7008\nweekly.2010-12-15.1             6980\nweekly.2010-12-15               6976\nweekly.2010-12-08               6870\nweekly.2010-12-02               6821\nweekly.2010-11-23               6786\nweekly.2010-11-10               6745\nweekly.2010-11-02               6696\nweekly.2010-10-27               6645\nweekly.2010-10-20               6580\nweekly.2010-10-13.1             6528\nweekly.2010-10-13               6519\nweekly.2010-09-29               6432\nweekly.2010-09-22               6348\nweekly.2010-09-15               6288\nweekly.2010-09-06               6178\nweekly.2010-08-25               6080\nweekly.2010-08-11               6006\nweekly.2010-08-04               5960\nweekly.2010-07-29               5917\nweekly.2010-07-14               5812\nweekly.2010-07-01               5759\nweekly.2010-06-21               5691\nweekly.2010-06-09               5631\nweekly.2010-05-27               5557\nweekly.2010-05-04               5440\nweekly.2010-04-27               5383\nweekly.2010-04-13               5289\nweekly.2010-03-30               5189\nweekly.2010-03-22               5099\nweekly.2010-03-15               5048\nweekly.2010-03-04               4983\nweekly.2010-02-23               4931\nweekly.2010-02-17               4877\nweekly.2010-02-04               4791\nweekly.2010-01-27               4711\nweekly.2010-01-13               4604\nweekly.2010-01-05               4530\nweekly.2009-12-22               4476\nweekly.2009-12-09               4361\nweekly.2009-12-07               4347\nweekly.2009-11-17               4108\nweekly.2009-11-12               4015\nweekly.2009-11-10.1             3975\nweekly.2009-11-10               3952\nweekly.2009-11-06               3851\n\nHere's one possible fix:\n$ hg diff version.bash\ndiff -r d7322ae4d055 src/version.bash\n--- a/src/version.bash  Thu Sep 22 15:06:10 2011 +1000\n+++ b/src/version.bash  Wed Nov 09 14:49:04 2011 -0800\n@@ -19,7 +19,7 @@\n fi\n \n # Get numerical revision\n-VERSION=$(hg identify -n 2\u0026gt;/dev/null)\n+VERSION=$(hg identify -n 2\u0026gt;/dev/null | sed -e 's/[^0-9]//')\n if [ $? != 0 ]; then\n        OLD=$(hg identify | sed 1q)\n        VERSION=$(echo $OLD | awk '{print $1}')\n\nAgain Mercurial says:\n$ hg id\nd7322ae4d055+ weekly.2011-09-21\n\nBut now the version script is correct:\n$ ./version.bash\nweekly.2011-09-21 9839\n\nSo, a better fix (that keeps the + in the version output) may be:\n$ hg diff version.bash \ndiff -r d7322ae4d055 src/version.bash\n--- a/src/version.bash  Thu Sep 22 15:06:10 2011 +1000\n+++ b/src/version.bash  Wed Nov 09 14:51:14 2011 -0800\n@@ -36,7 +36,7 @@\n        grep $BRANCH |\n        sed 's/:.*//' |\n        sort -rn -k2 |\n-       awk -v ver=$VERSION '$2 \u0026lt;= ver \u0026amp;\u0026amp; $1~/^(release|weekly)\\./ {print\n$1}' |\n+       awk -v ver=${VERSION/+/} '$2 \u0026lt;= ver \u0026amp;\u0026amp; $1~/^(release|weekly)\\./\n{print $1}' |\n        sed -n 1p)\n \n if [ \u0026quot;$TAG\u0026quot; != \u0026quot;\u0026quot; ]; then\n\nWhich still has the right output:\n$ hg id\nd7322ae4d055+ weekly.2011-09-21\n$ ./version.bash \nweekly.2011-09-21 9839+\u003c/pre\u003e",
	"user": {
		"login": "kylelemons",
		"id": 322213,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 5,
	"closed_at": "2014-12-08T10:12:59Z",
	"created_at": "2011-11-09T22:56:00Z",
	"updated_at": "2016-06-24T21:20:17Z",
	"milestone": {
		"id": 1061233,
		"number": 7,
		"title": "Go1"
	}
}
