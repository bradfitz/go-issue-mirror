{
	"id": 171353761,
	"number": 16726,
	"state": "open",
	"title": "cmd/compile: panic while compiling empty package in a loop",
	"body": "1. What version of Go are you using (`go version`)?\r\n\r\n`go version go1.7 darwin/amd64`\r\n\r\n2. What operating system and processor architecture are you using (`go env`)?\r\n\r\n```\r\nMac OS 10.11.5 (15F34), MBP mid 2012\r\n```\r\n\r\n```\r\n$ go env\r\nGOARCH=\"amd64\"\r\nGOBIN=\"\"\r\nGOEXE=\"\"\r\nGOHOSTARCH=\"amd64\"\r\nGOHOSTOS=\"darwin\"\r\nGOOS=\"darwin\"\r\nGOPATH=\"/Users/felix/code/go:/Users/felix/.gvm/pkgsets/go1.7/global\"\r\nGORACE=\"\"\r\nGOROOT=\"/Users/felix/.gvm/gos/go1.7\"\r\nGOTOOLDIR=\"/Users/felix/.gvm/gos/go1.7/pkg/tool/darwin_amd64\"\r\nCC=\"clang\"\r\nGOGCCFLAGS=\"-fPIC -m64 -pthread -fno-caret-diagnostics -Qunused-arguments -fmessage-length=0 -fdebug-prefix-map=/var/folders/k3/fmtp404j2gg42s6tx04cw_t40000gn/T/go-build855461703=/tmp/go-build -gno-record-gcc-switches -fno-common\"\r\nCXX=\"clang++\"\r\nCGO_ENABLED=\"1\"\r\n```\r\n\r\n3. What did you do?\r\n\r\n```\r\nmkdir foo\r\ncd foo\r\necho \"package foo\" \u003e foo.go\r\nwhile go test -a .; do :; done\r\n```\r\n\r\n4. What did you expect to see?\r\n\r\n```\r\n$ while go build -a .; do :; done\r\n[no output the pkg recompiles forever]\r\n```\r\n\r\n5. What did you see instead?\r\n\r\nA race condition causing some builds to fail with internal compiler errors. Two examples below:\r\n\r\n```\r\n$ while go build -a .; do :; done\r\n# runtime\r\n../../../.gvm/gos/go1.7/src/runtime/proc.go:314: internal compiler error: panic during generic cse while compiling releaseSudog:\r\n\r\nruntime error: index out of range\r\n\r\ngoroutine 1 [running]:\r\ncmd/compile/internal/ssa.Compile.func1(0xc42399ecf8, 0xc42352cf00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/compile.go:35 +0xc8\r\npanic(0x4b7320, 0xc420014180)\r\n\t/Users/felix/.gvm/gos/go1.7/src/runtime/panic.go:458 +0x243\r\ncmd/compile/internal/ssa.(*partitionByDom).Less(0xc422399530, 0x0, 0x1884733779, 0x2)\r\n\t\u003cautogenerated\u003e:144 +0xda\r\nsort.medianOfThree(0x6cf9c0, 0xc422399530, 0x0, 0x1884733779, 0x3108e66ef2)\r\n\t/Users/felix/.gvm/gos/go1.7/src/sort/sort.go:74 +0x49\r\nsort.doPivot(0x6cf9c0, 0xc422399530, 0x0, 0xc42399bbc8, 0xc4223a4420, 0x2)\r\n\t/Users/felix/.gvm/gos/go1.7/src/sort/sort.go:99 +0x601\r\nsort.quickSort(0x6cf9c0, 0xc422399530, 0x0, 0xc42399bbc8, 0x4f)\r\n\t/Users/felix/.gvm/gos/go1.7/src/sort/sort.go:188 +0x83\r\nsort.Sort(0x6cf9c0, 0xc422399530)\r\n\t/Users/felix/.gvm/gos/go1.7/src/sort/sort.go:222 +0x80\r\ncmd/compile/internal/ssa.cse(0xc42352cf00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/cse.go:140 +0x10ab\r\ncmd/compile/internal/ssa.Compile(0xc42352cf00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/compile.go:64 +0x321\r\ncmd/compile/internal/gc.buildssa(0xc420ece090, 0x0)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/ssa.go:232 +0xc5f\r\ncmd/compile/internal/gc.compile(0xc420ece090)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/pgen.go:405 +0x1377\r\ncmd/compile/internal/gc.funccompile(0xc420ece090)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/dcl.go:1287 +0x186\r\ncmd/compile/internal/gc.Main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/main.go:467 +0x1a02\r\ncmd/compile/internal/amd64.Main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/amd64/galign.go:93 +0x2fa\r\nmain.main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/main.go:33 +0x2a3\r\n\r\n\r\n\r\ngoroutine 1 [running]:\r\nruntime/debug.Stack(0x0, 0x0, 0x0)\r\n\t/Users/felix/.gvm/gos/go1.7/src/runtime/debug/stack.go:24 +0x79\r\ncmd/compile/internal/gc.Fatalf(0x50a8b2, 0x2c, 0xc420b80080, 0x4, 0x4)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/subr.go:165 +0x15d\r\ncmd/compile/internal/gc.(*ssaExport).Fatalf(0x760786, 0x4f9c, 0x50a8b2, 0x2c, 0xc420b80080, 0x4, 0x4)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/ssa.go:4437 +0x74\r\ncmd/compile/internal/ssa.(*Config).Fatalf(0xc422524000, 0xc400004f9c, 0x50a8b2, 0x2c, 0xc420b80080, 0x4, 0x4)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/config.go:200 +0x6e\r\ncmd/compile/internal/ssa.(*Func).Fatalf(0xc42352cf00, 0x50a8b2, 0x2c, 0xc420b80080, 0x4, 0x4)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/func.go:397 +0x6b\r\ncmd/compile/internal/ssa.Compile.func1(0xc42399ecf8, 0xc42352cf00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/compile.go:37 +0x25b\r\npanic(0x4b7320, 0xc420014180)\r\n\t/Users/felix/.gvm/gos/go1.7/src/runtime/panic.go:458 +0x243\r\ncmd/compile/internal/ssa.(*partitionByDom).Less(0xc422399530, 0x0, 0x1884733779, 0x2)\r\n\t\u003cautogenerated\u003e:144 +0xda\r\nsort.medianOfThree(0x6cf9c0, 0xc422399530, 0x0, 0x1884733779, 0x3108e66ef2)\r\n\t/Users/felix/.gvm/gos/go1.7/src/sort/sort.go:74 +0x49\r\nsort.doPivot(0x6cf9c0, 0xc422399530, 0x0, 0xc42399bbc8, 0xc4223a4420, 0x2)\r\n\t/Users/felix/.gvm/gos/go1.7/src/sort/sort.go:99 +0x601\r\nsort.quickSort(0x6cf9c0, 0xc422399530, 0x0, 0xc42399bbc8, 0x4f)\r\n\t/Users/felix/.gvm/gos/go1.7/src/sort/sort.go:188 +0x83\r\nsort.Sort(0x6cf9c0, 0xc422399530)\r\n\t/Users/felix/.gvm/gos/go1.7/src/sort/sort.go:222 +0x80\r\ncmd/compile/internal/ssa.cse(0xc42352cf00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/cse.go:140 +0x10ab\r\ncmd/compile/internal/ssa.Compile(0xc42352cf00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/compile.go:64 +0x321\r\ncmd/compile/internal/gc.buildssa(0xc420ece090, 0x0)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/ssa.go:232 +0xc5f\r\ncmd/compile/internal/gc.compile(0xc420ece090)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/pgen.go:405 +0x1377\r\ncmd/compile/internal/gc.funccompile(0xc420ece090)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/dcl.go:1287 +0x186\r\ncmd/compile/internal/gc.Main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/main.go:467 +0x1a02\r\ncmd/compile/internal/amd64.Main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/amd64/galign.go:93 +0x2fa\r\nmain.main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/main.go:33 +0x2a3\r\n```\r\n\r\nand\r\n\r\n```\r\nwhile go build -a .; do :; done\r\n\r\n# runtime\r\n../../../.gvm/gos/go1.7/src/runtime/alg.go:1: internal compiler error: panic during regalloc while compiling .eq.\"\".stackmap:\r\n\r\nruntime error: index out of range\r\n\r\ngoroutine 1 [running]:\r\ncmd/compile/internal/ssa.Compile.func1(0xc423f3fdf8, 0xc422c79e00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/compile.go:35 +0xc8\r\npanic(0x4b7320, 0xc420014180)\r\n\t/Users/felix/.gvm/gos/go1.7/src/runtime/panic.go:458 +0x243\r\ncmd/compile/internal/ssa.(*regAllocState).regalloc(0xc42324ea00, 0xc422c79e00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/regalloc.go:1405 +0x7566\r\ncmd/compile/internal/ssa.regalloc(0xc422c79e00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/regalloc.go:133 +0x83\r\ncmd/compile/internal/ssa.Compile(0xc422c79e00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/compile.go:64 +0x321\r\ncmd/compile/internal/gc.buildssa(0xc42324c480, 0x0)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/ssa.go:232 +0xc5f\r\ncmd/compile/internal/gc.compile(0xc42324c480)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/pgen.go:405 +0x1377\r\ncmd/compile/internal/gc.funccompile(0xc42324c480)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/dcl.go:1287 +0x186\r\ncmd/compile/internal/gc.geneq(0xc42323eb60, 0xc4218159f0)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/alg.go:512 +0x7f3\r\ncmd/compile/internal/gc.dalgsym(0xc4218159f0, 0xffffffffffffffff)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/reflect.go:1497 +0x116e\r\ncmd/compile/internal/gc.dcommontype(0xc42323ea10, 0x0, 0xc4218159f0, 0x7)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/reflect.go:821 +0xca\r\ncmd/compile/internal/gc.dtypesym(0xc4218159f0, 0xc4218159f0)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/reflect.go:1300 +0xef0\r\ncmd/compile/internal/gc.dtypesym(0xc4218daaa0, 0xc42346e690)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/reflect.go:1284 +0xd37\r\ncmd/compile/internal/gc.dumptypestructs()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/reflect.go:1369 +0xcc\r\ncmd/compile/internal/gc.dumpobj1(0x7fff5fbfdf35, 0x4c, 0x3)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/obj.go:133 +0x55f\r\ncmd/compile/internal/gc.dumpobj()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/obj.go:45 +0x52\r\ncmd/compile/internal/gc.Main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/main.go:490 +0x1aa6\r\ncmd/compile/internal/amd64.Main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/amd64/galign.go:93 +0x2fa\r\nmain.main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/main.go:33 +0x2a3\r\n\r\n\r\n\r\ngoroutine 1 [running]:\r\nruntime/debug.Stack(0x0, 0x0, 0x0)\r\n\t/Users/felix/.gvm/gos/go1.7/src/runtime/debug/stack.go:24 +0x79\r\ncmd/compile/internal/gc.Fatalf(0x50a8b2, 0x2c, 0xc423fd4280, 0x4, 0x4)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/subr.go:165 +0x15d\r\ncmd/compile/internal/gc.(*ssaExport).Fatalf(0x760786, 0x1, 0x50a8b2, 0x2c, 0xc423fd4280, 0x4, 0x4)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/ssa.go:4437 +0x74\r\ncmd/compile/internal/ssa.(*Config).Fatalf(0xc422410000, 0xc400000001, 0x50a8b2, 0x2c, 0xc423fd4280, 0x4, 0x4)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/config.go:200 +0x6e\r\ncmd/compile/internal/ssa.(*Func).Fatalf(0xc422c79e00, 0x50a8b2, 0x2c, 0xc423fd4280, 0x4, 0x4)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/func.go:397 +0x6b\r\ncmd/compile/internal/ssa.Compile.func1(0xc423f3fdf8, 0xc422c79e00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/compile.go:37 +0x25b\r\npanic(0x4b7320, 0xc420014180)\r\n\t/Users/felix/.gvm/gos/go1.7/src/runtime/panic.go:458 +0x243\r\ncmd/compile/internal/ssa.(*regAllocState).regalloc(0xc42324ea00, 0xc422c79e00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/regalloc.go:1405 +0x7566\r\ncmd/compile/internal/ssa.regalloc(0xc422c79e00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/regalloc.go:133 +0x83\r\ncmd/compile/internal/ssa.Compile(0xc422c79e00)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/ssa/compile.go:64 +0x321\r\ncmd/compile/internal/gc.buildssa(0xc42324c480, 0x0)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/ssa.go:232 +0xc5f\r\ncmd/compile/internal/gc.compile(0xc42324c480)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/pgen.go:405 +0x1377\r\ncmd/compile/internal/gc.funccompile(0xc42324c480)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/dcl.go:1287 +0x186\r\ncmd/compile/internal/gc.geneq(0xc42323eb60, 0xc4218159f0)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/alg.go:512 +0x7f3\r\ncmd/compile/internal/gc.dalgsym(0xc4218159f0, 0xffffffffffffffff)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/reflect.go:1497 +0x116e\r\ncmd/compile/internal/gc.dcommontype(0xc42323ea10, 0x0, 0xc4218159f0, 0x7)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/reflect.go:821 +0xca\r\ncmd/compile/internal/gc.dtypesym(0xc4218159f0, 0xc4218159f0)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/reflect.go:1300 +0xef0\r\ncmd/compile/internal/gc.dtypesym(0xc4218daaa0, 0xc42346e690)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/reflect.go:1284 +0xd37\r\ncmd/compile/internal/gc.dumptypestructs()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/reflect.go:1369 +0xcc\r\ncmd/compile/internal/gc.dumpobj1(0x7fff5fbfdf35, 0x4c, 0x3)\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/obj.go:133 +0x55f\r\ncmd/compile/internal/gc.dumpobj()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/obj.go:45 +0x52\r\ncmd/compile/internal/gc.Main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/gc/main.go:490 +0x1aa6\r\ncmd/compile/internal/amd64.Main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/internal/amd64/galign.go:93 +0x2fa\r\nmain.main()\r\n\t/Users/felix/.gvm/gos/go1.7/src/cmd/compile/main.go:33 +0x2a3\r\n```\r\n\r\nI originally saw this error in the test suite of the project I'm working on. This is the minimal way I was able to reproduce it.",
	"user": {
		"login": "felixge",
		"id": 15000,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "WaitingForInfo"
		}
	],
	"comments": 13,
	"created_at": "2016-08-16T08:35:59Z",
	"updated_at": "2016-08-29T05:14:50Z",
	"milestone": {
		"id": 1055141,
		"number": 6,
		"title": "Unplanned"
	}
}
