{
	"id": 51287673,
	"number": 8100,
	"state": "closed",
	"title": "runtime: bad pointer in scanbitvector",
	"body": "\u003cpre\u003ego version go1.3beta2 +77632b0a1c94 Sun May 25 08:38:59 2014 +1000 linux/amd64\n\nllgo crashes with:\n\nbad pointer in frame github.com/go-llvm/llvm.Value.Type at 0xc2080d5418: 0x6\nfatal error: bad pointer in scanbitvector\n\nruntime stack:\nruntime.throw(0x2f758ab)\n\tsrc/pkg/runtime/panic.c:520 +0x69 fp=0x7f7c315b49c0\nscanbitvector(0x2613cb8, 0x2135d01, 0xc2080d5418, 0x7f7c315b4a78, 0x1, 0x7f7c315b4c68)\n\tsrc/pkg/runtime/mgc0.c:1492 +0x38d fp=0x7f7c315b4a28\nscanframe(0x7f7c315b4ae8, 0x7f7c315b4c68)\n\tsrc/pkg/runtime/mgc0.c:1627 +0x198 fp=0x7f7c315b4aa0\nruntime.gentraceback(0xaa2340, 0xc2080d5390, 0x0, 0xc208002120, 0x0, 0x0, 0x7fffffff,\n0xaa6a10, 0x7f7c315b4c68, 0x5ff7c31dbb000)\n\tsrc/pkg/runtime/traceback_x86.c:206 +0x413 fp=0x7f7c315b4b68\naddstackroots(0xc208002120, 0x7f7c315b4c68)\n\tsrc/pkg/runtime/mgc0.c:1688 +0x168 fp=0x7f7c315b4bf8\nmarkroot(0xc208018480, 0x5)\n\tsrc/pkg/runtime/mgc0.c:1321 +0xbe fp=0x7f7c315b4c78\nruntime.parfordo(0xc208018480)\n\tsrc/pkg/runtime/parfor.c:88 +0xa3 fp=0x7f7c315b4cf0\ngc(0x7f7c33d53f20)\n\tsrc/pkg/runtime/mgc0.c:2403 +0x1d6 fp=0x7f7c315b4e20\nmgc(0xc2080026c0)\n\tsrc/pkg/runtime/mgc0.c:2345 +0x2e fp=0x7f7c315b4e30\nruntime.mcall(0xa9a43c)\n\tsrc/pkg/runtime/asm_amd64.s:181 +0x4b fp=0x7f7c315b4e40\n\ngoroutine 19 [garbage collection]:\nruntime.gc(0x1)\n\tsrc/pkg/runtime/mgc0.c:2325 +0x1c6 fp=0x7f7c33d53f38\nrunfinq()\n\tsrc/pkg/runtime/mgc0.c:2699 +0x2ea fp=0x7f7c33d53fa8\nruntime.goexit()\n\tsrc/pkg/runtime/proc.c:1445 fp=0x7f7c33d53fb0\ncreated by runtime.gc\n\tsrc/pkg/runtime/mgc0.c:2264\n\ngoroutine 16 [runnable]:\nendcgo()\n\tsrc/pkg/runtime/cgocall.c:153 fp=0xc2080d5398\nruntime.cgocall(0xa98630, 0xc2080d53f8)\n\tsrc/pkg/runtime/cgocall.c:149 +0x13d fp=0xc2080d53e0\ngithub.com/go-llvm/llvm._Cfunc_LLVMTypeOf(0x4064940, 0x4031b60)\n\tgithub.com/go-llvm/llvm/_obj/_cgo_defun.c:5081 +0x31 fp=0xc2080d53f8\ngithub.com/go-llvm/llvm.Value.Type(0x4064940, 0x6)\n\tgithub.com/go-llvm/llvm/core.go:600 +0x27 fp=0xc2080d5410\ngithub.com/go-llvm/llgo.(*TypeMap).globalStringPtr(0xc2080fe000, 0xc20814ea30, 0x6,\n0x400ce30)\n\tgithub.com/go-llvm/llgo/typemap.go:1279 +0x4f fp=0xc2080d5488\ngithub.com/go-llvm/llgo.(*TypeMap).makeCommonType(0xc2080fe000, 0x7f7c33eca4c0,\n0xc2080a27e0, 0xc2080d5590)\n\tgithub.com/go-llvm/llgo/typemap.go:1020 +0x280 fp=0xc2080d5508\ngithub.com/go-llvm/llgo.(*TypeMap).makeArrayType(0xc2080fe000, 0x7f7c33eca4c0,\n0xc2080a27e0, 0xc2080a27e0, 0xa98401)\n\tgithub.com/go-llvm/llgo/typemap.go:1037 +0x55 fp=0xc2080d5578\ngithub.com/go-llvm/llgo.(*TypeMap).makeTypeDescInitializer(0xc2080fe000, 0x7f7c33eca4c0,\n0xc2080a27e0, 0x40648b0)\n\tgithub.com/go-llvm/llgo/typemap.go:757 +0x2e2 fp=0xc2080d5610\ngithub.com/go-llvm/llgo.(*TypeMap).emitTypeDescInitializers(0xc2080fe000)\n\tgithub.com/go-llvm/llgo/typemap.go:742 +0x1a4 fp=0xc2080d5710\ngithub.com/go-llvm/llgo.(*unit).translatePackage(0xc2080a4900, 0xc20805e070)\n\tgithub.com/go-llvm/llgo/ssa.go:119 +0x32f fp=0xc2080d5850\ngithub.com/go-llvm/llgo.(*compiler).compile(0xc20804a210, 0xc208046980, 0x3, 0x4,\n0x7fff8a58ceb0, 0x1, 0x0, 0x0, 0x0)\n\tgithub.com/go-llvm/llgo/compiler.go:221 +0xa5d fp=0xc2080d5a38\ngithub.com/go-llvm/llgo.(*Compiler).Compile(0xc20805e8c0, 0xc208046980, 0x3, 0x4,\n0x7fff8a58ceb0, 0x1, 0xc20801b0e0, 0x2f, 0x1)\n\tgithub.com/go-llvm/llgo/compiler.go:102 +0x12e fp=0xc2080d5aa0\nmain.performAction(0xc20802a0d0, 0x1, 0xc208046980, 0x3, 0x4, 0x7fff8a58cf28, 0x21, 0x0,\n0x0)\n\tgithub.com/go-llvm/llgo/cmd/gllgo/gllgo.go:326 +0xf6 fp=0xc2080d5cd8\nmain.performActions(0xc20802a0d0, 0x0, 0x0)\n\tgithub.com/go-llvm/llgo/cmd/gllgo/gllgo.go:481 +0x2b0 fp=0xc2080d5e28\nmain.main()\n\tgithub.com/go-llvm/llgo/cmd/gllgo/gllgo.go:505 +0xf3 fp=0xc2080d5f50\nruntime.main()\n\tsrc/pkg/runtime/proc.c:247 +0x11a fp=0xc2080d5fa8\nruntime.goexit()\n\tsrc/pkg/runtime/proc.c:1445 fp=0xc2080d5fb0\ncreated by _rt0_go\n\tsrc/pkg/runtime/asm_amd64.s:97 +0x120\n\ngoroutine 17 [syscall]:\nruntime.notetsleepg(0x7f7c33d57f60, 0xdf8475800)\n\tsrc/pkg/runtime/lock_futex.c:198 +0x46 fp=0x7f7c33d57f38\nruntime.MHeap_Scavenger()\n\tsrc/pkg/runtime/mheap.c:532 +0xa3 fp=0x7f7c33d57fa8\nruntime.goexit()\n\tsrc/pkg/runtime/proc.c:1445 fp=0x7f7c33d57fb0\ncreated by runtime.main\n\tsrc/pkg/runtime/proc.c:207\n\ngoroutine 18 [GC sweep wait]:\nruntime.park(0xab1560, 0x2f8e6f8, 0x2f75ae0)\n\tsrc/pkg/runtime/proc.c:1369 +0x89 fp=0x7f7c33d55f70\nruntime.parkunlock(0x2f8e6f8, 0x2f75ae0)\n\tsrc/pkg/runtime/proc.c:1385 +0x3b fp=0x7f7c33d55f90\nbgsweep()\n\tsrc/pkg/runtime/mgc0.c:1989 +0x9a fp=0x7f7c33d55fa8\nruntime.goexit()\n\tsrc/pkg/runtime/proc.c:1445 fp=0x7f7c33d55fb0\ncreated by runtime.gc\n\tsrc/pkg/runtime/mgc0.c:2264\n\ngoroutine 17 [syscall]:\nruntime.goexit()\n\tsrc/pkg/runtime/proc.c:1445 fp=0xc20806afb0\n\n\nI can't describe how I built it.\n\nBut here is code of the offending function:\n\ntype Type struct {\n\tC C.LLVMTypeRef\n}\nfunc (v Value) Type() (t Type) {\n\tt.C = C.LLVMTypeOf(v.C)  /* line 600 */\n}\n\nHere is disass:\n\n0000000000b46470 \u0026lt;github.com/go-llvm/llvm.Value.Type\u0026gt;:\n  b46470:       64 48 8b 0c 25 f0 ff    mov    %fs:0xfffffffffffffff0,%rcx\n  b46477:       ff ff \n  b46479:       48 3b 21                cmp    (%rcx),%rsp\n  b4647c:       77 07                   ja     b46485 \u0026lt;github.com/go-llvm/llvm.Value.Type+0x15\u0026gt;\n  b4647e:       e8 7d ff f7 ff          callq  ac6400 \u0026lt;runtime.morestack16_noctxt\u0026gt;\n  b46483:       eb eb                   jmp    b46470 \u0026lt;github.com/go-llvm/llvm.Value.Type\u0026gt;\n  b46485:       48 83 ec 10             sub    $0x10,%rsp\n  b46489:       48 8b 5c 24 18          mov    0x18(%rsp),%rbx\n  b4648e:       48 89 1c 24             mov    %rbx,(%rsp)\n  b46492:       e8 89 2e 02 00          callq  b69320 \u0026lt;github.com/go-llvm/llvm._Cfunc_LLVMTypeOf\u0026gt;\n  b46497:       48 8b 5c 24 08          mov    0x8(%rsp),%rbx\n  b4649c:       48 89 5c 24 20          mov    %rbx,0x20(%rsp)\n  b464a1:       48 83 c4 10             add    $0x10,%rsp\n  b464a5:       c3                      retq   \n\nAnd here is -live compiler output:\n../../../llvm/core.go:600: live at entry to Value.Type: v\n../../../llvm/core.go:600: live at call to _Cfunc_LLVMTypeOf: v t\u003c/pre\u003e",
	"user": {
		"login": "dvyukov",
		"id": 1095328,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 3,
	"closed_at": "2014-12-08T10:44:54Z",
	"created_at": "2014-05-26T11:22:14Z",
	"updated_at": "2016-06-25T01:35:21Z",
	"milestone": {
		"id": 1067211,
		"number": 17,
		"title": "Go1.3"
	}
}
