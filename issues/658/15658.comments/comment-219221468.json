{
	"id": 219221468,
	"body": "The \"fatal error: runtime.SetFinalizer: finalizer already set\" bug I was\nseeing a few days ago were on the 1.8 dev.garbage branch and the result of\na TOC write barrier not marking an object as being published, TOC doing a\nrollback, and reallocating a new object over an old one. Both objects had\nfinalizers and the bug was tripped.\n\nNone of the TOC code is in 1.7 or for that matter on TIP. I can force\nmyself to imagine that the 1.7 allocCache code could cause a similar\nsituation if the allocCache and bitmaps were not coherent. but if that were\nthe case it would expect lots of failures all over the place and across all\nplatforms, not just freeBSD.\n\n\nOn Fri, May 13, 2016 at 6:47 PM, Derek Marcotte \u003cnotifications@github.com\u003e\nwrote:\n\n\u003e Here's the heads of a bunch of logs with the epoch at the start of the\n\u003e process, so you can see the interval. I suspected a race vs. memory\n\u003e corruption because by and large it is the finalizer already set that\n\u003e crashes the process. I thought maybe the gc was setting these as free (or\n\u003e otherwise touching them) before the SetFinalizer had a chance to set their\n\u003e value.\n\u003e\n\u003e I didn't include too many of them in my initial report, because I thought\n\u003e they were largely redundant.\n\u003e\n\u003e @bradfitz \u003chttps://github.com/bradfitz\u003e: these logs are against master:\n\u003e\n\u003e 1463168442\n\u003e Starting a bunch of goroutines...\n\u003e fatal error: runtime.SetFinalizer: finalizer already set\n\u003e\n\u003e runtime stack:\n\u003e runtime.throw(0x4c366d, 0x2b)\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/panic.go:566 +0x8b fp=0xc420059f48 sp=0xc420059f30\n\u003e runtime.SetFinalizer.func2()\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/mfinal.go:375 +0x73 fp=0xc420059f80 sp=0xc420059f48\n\u003e runtime.systemstack(0xc420019500)\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/asm_amd64.s:298 +0x79 fp=0xc420059f88 sp=0xc420059f80\n\u003e\n\u003e\n\u003e 1463170469\n\u003e Starting a bunch of goroutines...\n\u003e fatal error: runtime.SetFinalizer: finalizer already set\n\u003e\n\u003e runtime stack:\n\u003e runtime.throw(0x4c366d, 0x2b)\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/panic.go:566 +0x8b fp=0x7fffffffea80 sp=0x7fffffffea68\n\u003e runtime.SetFinalizer.func2()\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/mfinal.go:375 +0x73 fp=0x7fffffffeab8 sp=0x7fffffffea80\n\u003e runtime.systemstack(0x52ad00)\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/asm_amd64.s:298 +0x79 fp=0x7fffffffeac0 sp=0x7fffffffeab8\n\u003e\n\u003e\n\u003e 1463170494\n\u003e Starting a bunch of goroutines...\n\u003e fatal error: runtime.SetFinalizer: finalizer already set\n\u003e\n\u003e runtime stack:\n\u003e runtime.throw(0x4c366d, 0x2b)\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/panic.go:566 +0x8b fp=0xc420067f48 sp=0xc420067f30\n\u003e runtime.SetFinalizer.func2()\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/mfinal.go:375 +0x73 fp=0xc420067f80 sp=0xc420067f48\n\u003e runtime.systemstack(0xc420019500)\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/asm_amd64.s:298 +0x79 fp=0xc420067f88 sp=0xc420067f80\n\u003e\n\u003e\n\u003e 1463171133\n\u003e Starting a bunch of goroutines...\n\u003e fatal error: runtime.SetFinalizer: finalizer already set\n\u003e\n\u003e runtime stack:\n\u003e runtime.throw(0x4c366d, 0x2b)\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/panic.go:566 +0x8b fp=0xc4202cbf48 sp=0xc4202cbf30\n\u003e runtime.SetFinalizer.func2()\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/mfinal.go:375 +0x73 fp=0xc4202cbf80 sp=0xc4202cbf48\n\u003e runtime.systemstack(0xc42001c000)\n\u003e         /home/derek/go/src/github.com/golang/go/src/runtime/asm_amd64.s:298 +0x79 fp=0xc4202cbf88 sp=0xc4202cbf80\n\u003e\n\u003e @aclements \u003chttps://github.com/aclements\u003e: I will try your patch next.\n\u003e One variable at a time.\n\u003e\n\u003e â€”\n\u003e You are receiving this because you were mentioned.\n\u003e Reply to this email directly or view it on GitHub\n\u003e \u003chttps://github.com/golang/go/issues/15658#issuecomment-219177155\u003e\n\u003e\n",
	"user": {
		"login": "RLH",
		"id": 972447,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2016-05-14T13:51:29Z",
	"updated_at": "2016-05-14T13:51:29Z"
}
