{
	"id": 170073757,
	"number": 16644,
	"state": "open",
	"title": "x/mobile: Binding go mobile framework on iOS 9 with golang1.7rc6 crash when call debug.FreeOSMemory()",
	"body": "Please answer these questions before submitting your issue. Thanks!\r\n\r\n1. What version of Go are you using (`go version`)?\r\ngo version go1.7rc5 darwin/amd64\r\n\r\n2. What operating system and processor architecture are you using (`go env`)?\r\nGOARCH=\"amd64\"\r\nGOBIN=\"\"\r\nGOEXE=\"\"\r\nGOHOSTARCH=\"amd64\"\r\nGOHOSTOS=\"darwin\"\r\nGOOS=\"darwin\"\r\nGOPATH=\"\"\r\nGORACE=\"\"\r\nGOROOT=\"/usr/local/go\"\r\nGOTOOLDIR=\"/usr/local/go/pkg/tool/darwin_amd64\"\r\nCC=\"clang\"\r\nGOGCCFLAGS=\"-fPIC -m64 -pthread -fno-caret-diagnostics -Qunused-arguments -fmessage-length=0 -fdebug-prefix-map=/var/folders/m9/qtbxkp6s3p96fk54rln7qhj80000gp/T/go-build097177340=/tmp/go-build -gno-record-gcc-switches -fno-common\"\r\nCXX=\"clang++\"\r\nCGO_ENABLED=\"1\"\r\n\r\n\r\n3. What did you do?\r\nI create a simple one page ios project.\r\nI write a simple package with follow code:\r\n```\r\npackage iosGomobileLib\r\n\r\nimport (\r\n\t\"runtime/debug\"\r\n\t\"fmt\"\r\n)\r\n\r\nfunc RunFromGo(){\r\n\tfmt.Println(\"before debug.FreeOSMemory()\")\r\n\tdebug.FreeOSMemory()\r\n\tfmt.Println(\"after debug.FreeOSMemory()\")\r\n}\r\n```\r\nchange the ViewController.m with follow code:\r\n```\r\n#import \"ViewController.h\"\r\n@import IosGomobileLib;\r\n\r\n@interface ViewController ()\r\n\r\n@end\r\n\r\n@implementation ViewController\r\n\r\n- (void)viewDidLoad {\r\n    [super viewDidLoad];\r\n    GoIosGomobileLibRunFromGo();\r\n    // Do any additional setup after loading the view, typically from a nib.\r\n}\r\n\r\n- (void)didReceiveMemoryWarning {\r\n    [super didReceiveMemoryWarning];\r\n    // Dispose of any resources that can be recreated.\r\n}\r\n\r\n@end\r\n```\r\nI build the framework with follow code(the kmg stuff should be easy to understand):\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"github.com/bronze1man/kmg/kmgCmd\"\r\n\t\"github.com/bronze1man/kmg/kmgConfig\"\r\n\t\"os\"\r\n)\r\n\r\nfunc main(){\r\n\tgoPath := kmgConfig.DefaultEnv().GOPATHToString()\r\n\tandroidSdkPath := \"/usr/local/AndroidSdk\"\r\n\tkmgCmd.CmdString(\"gomobile bind -target ios -o client/ios-gomobile/ufr/iosGomobileLib.framework make/tplIosGomobile/iosGomobileLib\").\r\n\tMustSetEnvMap(map[string]string{\r\n\t\t\"GOPATH\":                     \"/usr/local/gopath:\"+goPath,\r\n\t\t\"PATH\":                           os.Getenv(\"PATH\"),\r\n\t\t\"ANDROID_HOME\":               androidSdkPath,\r\n\t\t\"IPHONEOS_DEPLOYMENT_TARGET\": \"8.0\",\r\n\t}).\r\n\tRunAndReturnOutput()\r\n}\r\n```\r\n\r\n4. What did you expect to see?\r\nsee following in ios console:\r\n```\r\nbefore debug.FreeOSMemory()\r\nafter debug.FreeOSMemory()\r\n```\r\n5. What did you see instead?\r\nsee following in ios console:\r\n```\r\nbefore debug.FreeOSMemory()\r\n```\r\nand crash with EXC_BAD_ACCESS\r\n```\r\n* thread #1: tid = 0x6dd76, 0x00000001000c8cec ufr`notok + 4, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x0)\r\n    frame #0: 0x00000001000c8cec ufr`notok + 4\r\n    frame #1: 0x00000001000c8e48 ufr`runtime.madvise + 32\r\n    frame #2: 0x0000000100080fdc ufr`runtime.sysUnused + 52\r\n    frame #3: 0x00000001000901c4 ufr`runtime.scavengelist + 332\r\n    frame #4: 0x000000010009027c ufr`runtime.(*mheap).scavenge + 132\r\n    frame #5: 0x00000001000bfd68 ufr`runtime.runtime_debug_freeOSMemory.func1 + 64\r\n    frame #6: 0x00000001000c6178 ufr`runtime.systemstack + 144\r\n    frame #7: 0x000000010009d8e8 ufr`runtime.startTheWorldWithSema + 800\r\n    frame #8: 0x0000000100101dbc ufr`GoIosGomobileLibRunFromGo + 12\r\n  * frame #9: 0x000000010006bba8 ufr`-[ViewController viewDidLoad](self=0x0000000127da0c70, _cmd=\"viewDidLoad\") + 72 at ViewController.m:20\r\n    frame #10: 0x00000001898bf610 UIKit`-[UIViewController loadViewIfRequired] + 1124\r\n    frame #11: 0x00000001898bf194 UIKit`-[UIViewController view] + 28\r\n    frame #12: 0x00000001898c5f70 UIKit`-[UIWindow addRootViewControllerViewIfPossible] + 76\r\n    frame #13: 0x00000001898c3454 UIKit`-[UIWindow _setHidden:forced:] + 264\r\n    frame #14: 0x000000018993775c UIKit`-[UIWindow makeKeyAndVisible] + 48\r\n    frame #15: 0x0000000189b5c088 UIKit`-[UIApplication _callInitializationDelegatesForMainScene:transitionContext:] + 3456\r\n    frame #16: 0x0000000189b601a4 UIKit`-[UIApplication _runWithMainScene:transitionContext:completion:] + 1660\r\n    frame #17: 0x0000000189b5d2e4 UIKit`-[UIApplication workspaceDidEndTransaction:] + 168\r\n    frame #18: 0x000000018e3f77ec FrontBoardServices`-[FBSSerialQueue _performNext] + 184\r\n    frame #19: 0x000000018e3f7b6c FrontBoardServices`-[FBSSerialQueue _performNextFromRunLoopSource] + 56\r\n    frame #20: 0x00000001843205a4 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 24\r\n    frame #21: 0x0000000184320038 CoreFoundation`__CFRunLoopDoSources0 + 540\r\n    frame #22: 0x000000018431dd38 CoreFoundation`__CFRunLoopRun + 724\r\n    frame #23: 0x000000018424cdc0 CoreFoundation`CFRunLoopRunSpecific + 384\r\n    frame #24: 0x000000018992c0ac UIKit`-[UIApplication _run] + 460\r\n    frame #25: 0x0000000189926f44 UIKit`UIApplicationMain + 204\r\n    frame #26: 0x000000010006bf40 ufr`main(argc=1, argv=0x000000016fd9bb18) + 124 at main.m:14\r\n    frame #27: 0x000000019a0768b8 libdyld.dylib`start + 4\r\n```\r\n\r\n\r\ngomobile version\r\n```\r\ngomobile version +8ab5dbb Thu Aug 4 01:15:58 2016 +0000 (android,ios); androidSDK=\r\n```\r\nios version: 9.0.2\r\nios device name: iphone 6s\r\n\r\nIt works ok with golang1.6.\r\nI have uploaded several apps with gomobile and golang1.6 to apple app store.\r\n\r\nI can use golang1.6 to work around this problem.\r\nThis issue may be same as https://github.com/golang/go/issues/16598",
	"user": {
		"login": "bronze1man",
		"id": 1107541,
		"type": "User",
		"site_admin": false
	},
	"comments": 1,
	"created_at": "2016-08-09T03:26:14Z",
	"updated_at": "2016-08-09T13:26:51Z"
}
