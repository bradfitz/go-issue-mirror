{
	"id": 136499217,
	"number": 14511,
	"state": "closed",
	"title": "dev.ssa: Performance regressions on BLAS benchmarks vs 1.6",
	"body": "We are seeing some significant performance regressions for BLAS benchmarks vs. 1.6.  These benchmarks are numeric, and consist almost entirely of []float64 indexing and assignment. While they may seem hyper-specialized, calls to Dgemm in particular can make up a significant fraction of runtime in codes we write. \r\n\r\nNote that Dgemm is coded as a concurrent algorithm, while Dgemv is not. \r\n\r\nCode:\r\nhttps://godoc.org/github.com/gonum/blas/native\r\nDgemv: https://github.com/gonum/blas/blob/master/native/level2double.go#L13\r\nDgemm: https://github.com/gonum/blas/blob/master/native/dgemm.go\r\nActual benchmark call is in the packages, but code is in the blas/testblas package.\r\n\r\nCall:\r\n````\r\ngo test -bench Dgem -tags noasm -cpu=1,8 -count 5 -timeout=60m\r\n````\r\nThe noasm flag changes a dot product inner loop call to use the native go version (https://github.com/gonum/internal/blob/master/asm/ddot.go) instead of the assembly version. \r\n\r\nSSA Version:\r\ngo version devel +fb54e03 Thu Feb 25 07:10:07 2016 +0000 darwin/amd64\r\n\r\nGo env output:\r\n````\r\nbrendan:~/Documents/mygo/src/github.com/gonum/blas/native$ go env\r\nGOARCH=\"amd64\"\r\nGOBIN=\"\"\r\nGOEXE=\"\"\r\nGOHOSTARCH=\"amd64\"\r\nGOHOSTOS=\"darwin\"\r\nGOOS=\"darwin\"\r\nGOPATH=\"/Users/brendan/Documents/mygo\"\r\nGORACE=\"\"\r\nGOROOT=\"/Users/brendan/gover/go\"\r\nGOTOOLDIR=\"/Users/brendan/gover/go/pkg/tool/darwin_amd64\"\r\nGO15VENDOREXPERIMENT=\"1\"\r\nCC=\"clang\"\r\nGOGCCFLAGS=\"-fPIC -m64 -pthread -fno-caret-diagnostics -Qunused-arguments -fmessage-length=0 -fno-common\"\r\nCXX=\"clang++\"\r\nCGO_ENABLED=\"1\"\r\n````\r\n\r\n\r\n````\r\nbrendan:~/Documents/mygo$ benchstat blasonesix.txt ssatip.txt\r\nname                      old time/op  new time/op   delta\r\nDgemmSmSmSm               1.89µs ± 0%   2.19µs ± 2%   +16.04%  (p=0.008 n=5+5)\r\nDgemmSmSmSm-8             1.90µs ± 0%   2.15µs ± 1%   +13.65%  (p=0.008 n=5+5)\r\nDgemmMedMedMed            1.35ms ± 0%   1.68ms ± 1%   +24.92%  (p=0.008 n=5+5)\r\nDgemmMedMedMed-8           581µs ± 2%    735µs ± 1%   +26.59%  (p=0.008 n=5+5)\r\nDgemmMedLgMed             13.1ms ± 1%   16.4ms ± 1%   +25.41%  (p=0.008 n=5+5)\r\nDgemmMedLgMed-8           3.96ms ± 2%   5.09ms ± 2%   +28.58%  (p=0.008 n=5+5)\r\nDgemmLgLgLg                1.32s ± 0%    1.66s ± 0%   +26.52%  (p=0.016 n=5+4)\r\nDgemmLgLgLg-8              374ms ± 1%    498ms ± 1%   +33.25%  (p=0.008 n=5+5)\r\nDgemmLgSmLg               19.4ms ± 1%   22.2ms ± 1%   +14.56%  (p=0.008 n=5+5)\r\nDgemmLgSmLg-8             5.28ms ± 3%   6.28ms ± 3%   +18.84%  (p=0.008 n=5+5)\r\nDgemmLgLgSm               14.4ms ± 1%   17.9ms ± 1%   +23.88%  (p=0.008 n=5+5)\r\nDgemmLgLgSm-8             4.11ms ± 5%   5.28ms ± 5%   +28.60%  (p=0.008 n=5+5)\r\nDgemmHgHgSm                1.49s ± 0%    1.85s ± 2%   +24.57%  (p=0.008 n=5+5)\r\nDgemmHgHgSm-8              383ms ± 1%    496ms ± 3%   +29.45%  (p=0.008 n=5+5)\r\nDgemmMedMedMedTNT         1.35ms ± 2%   1.69ms ± 3%   +24.66%  (p=0.008 n=5+5)\r\nDgemmMedMedMedTNT-8        589µs ± 3%    748µs ± 2%   +27.05%  (p=0.008 n=5+5)\r\nDgemmMedMedMedNTT         1.08ms ± 1%   2.42ms ± 1%  +125.10%  (p=0.008 n=5+5)\r\nDgemmMedMedMedNTT-8        480µs ± 2%   1040µs ± 0%  +116.96%  (p=0.008 n=5+5)\r\nDgemmMedMedMedTT          1.61ms ± 0%   1.93ms ± 1%   +19.93%  (p=0.008 n=5+5)\r\nDgemmMedMedMedTT-8         701µs ± 3%    851µs ± 1%   +21.47%  (p=0.008 n=5+5)\r\nDgemvSmSmNoTransInc1       186ns ± 1%    273ns ± 1%   +46.77%  (p=0.008 n=5+5)\r\nDgemvSmSmNoTransInc1-8     186ns ± 0%    274ns ± 0%   +47.31%  (p=0.016 n=4+5)\r\nDgemvSmSmNoTransIncN       227ns ± 0%    317ns ± 1%   +39.74%  (p=0.008 n=5+5)\r\nDgemvSmSmNoTransIncN-8     227ns ± 1%    315ns ± 1%   +38.82%  (p=0.008 n=5+5)\r\nDgemvSmSmTransInc1         212ns ± 3%    240ns ± 1%   +13.29%  (p=0.008 n=5+5)\r\nDgemvSmSmTransInc1-8       212ns ± 2%    240ns ± 1%   +13.61%  (p=0.008 n=5+5)\r\nDgemvSmSmTransIncN         244ns ± 1%    272ns ± 1%   +11.38%  (p=0.008 n=5+5)\r\nDgemvSmSmTransIncN-8       243ns ± 0%    272ns ± 2%   +11.85%  (p=0.016 n=4+5)\r\nDgemvMedMedNoTransInc1    10.0µs ± 1%   24.7µs ± 0%  +147.68%  (p=0.008 n=5+5)\r\nDgemvMedMedNoTransInc1-8  9.82µs ± 2%  24.67µs ± 1%  +151.26%  (p=0.008 n=5+5)\r\nDgemvMedMedNoTransIncN    12.4µs ± 0%   25.6µs ± 0%  +107.05%  (p=0.008 n=5+5)\r\nDgemvMedMedNoTransIncN-8  12.3µs ± 0%   25.8µs ± 2%  +109.16%  (p=0.008 n=5+5)\r\nDgemvMedMedTransInc1      12.2µs ± 0%   15.5µs ± 1%   +26.54%  (p=0.008 n=5+5)\r\nDgemvMedMedTransInc1-8    12.3µs ± 1%   15.5µs ± 1%   +26.48%  (p=0.008 n=5+5)\r\nDgemvMedMedTransIncN      14.3µs ± 1%   17.9µs ± 1%   +25.29%  (p=0.008 n=5+5)\r\nDgemvMedMedTransIncN-8    14.3µs ± 0%   17.9µs ± 0%   +25.42%  (p=0.008 n=5+5)\r\nDgemvLgLgNoTransInc1       909µs ± 0%   2515µs ± 1%  +176.56%  (p=0.008 n=5+5)\r\nDgemvLgLgNoTransInc1-8     906µs ± 1%   2520µs ± 1%  +178.23%  (p=0.008 n=5+5)\r\nDgemvLgLgNoTransIncN      1.14ms ± 0%   2.52ms ± 1%  +120.18%  (p=0.008 n=5+5)\r\nDgemvLgLgNoTransIncN-8    1.15ms ± 1%   2.52ms ± 1%  +119.76%  (p=0.008 n=5+5)\r\nDgemvLgLgTransInc1        1.15ms ± 1%   1.53ms ± 0%   +33.05%  (p=0.008 n=5+5)\r\nDgemvLgLgTransInc1-8      1.15ms ± 0%   1.53ms ± 0%   +32.95%  (p=0.008 n=5+5)\r\nDgemvLgLgTransIncN        1.30ms ± 1%   1.84ms ±10%   +41.65%  (p=0.008 n=5+5)\r\nDgemvLgLgTransIncN-8      1.30ms ± 1%   1.85ms ± 5%   +42.56%  (p=0.008 n=5+5)\r\nDgemvLgSmNoTransInc1      15.4µs ± 0%   23.6µs ± 0%   +53.10%  (p=0.008 n=5+5)\r\nDgemvLgSmNoTransInc1-8    15.4µs ± 1%   23.8µs ± 1%   +54.35%  (p=0.008 n=5+5)\r\nDgemvLgSmNoTransIncN      19.9µs ± 2%   28.0µs ± 1%   +40.57%  (p=0.008 n=5+5)\r\nDgemvLgSmNoTransIncN-8    19.8µs ± 0%   28.1µs ± 1%   +41.70%  (p=0.008 n=5+5)\r\nDgemvLgSmTransInc1        16.8µs ± 1%   19.0µs ± 0%   +12.97%  (p=0.008 n=5+5)\r\nDgemvLgSmTransInc1-8      16.9µs ± 0%   19.0µs ± 1%   +12.80%  (p=0.008 n=5+5)\r\nDgemvLgSmTransIncN        20.3µs ± 0%   23.1µs ± 0%   +13.97%  (p=0.008 n=5+5)\r\nDgemvLgSmTransIncN-8      20.3µs ± 1%   23.1µs ± 0%   +13.47%  (p=0.008 n=5+5)\r\nDgemvSmLgNoTransInc1      8.59µs ± 1%  24.80µs ± 0%  +188.69%  (p=0.008 n=5+5)\r\nDgemvSmLgNoTransInc1-8    8.61µs ± 0%  24.84µs ± 1%  +188.53%  (p=0.008 n=5+5)\r\nDgemvSmLgNoTransIncN      11.2µs ± 1%   25.0µs ± 1%  +123.28%  (p=0.008 n=5+5)\r\nDgemvSmLgNoTransIncN-8    11.3µs ± 3%   25.6µs ± 3%  +125.67%  (p=0.008 n=5+5)\r\nDgemvSmLgTransInc1        12.2µs ± 3%   15.5µs ± 2%   +27.53%  (p=0.008 n=5+5)\r\nDgemvSmLgTransInc1-8      12.0µs ± 1%   16.0µs ± 5%   +32.67%  (p=0.008 n=5+5)\r\nDgemvSmLgTransIncN        13.7µs ± 0%   18.2µs ± 3%   +33.06%  (p=0.008 n=5+5)\r\nDgemvSmLgTransIncN-8      13.6µs ± 0%   17.9µs ± 1%   +31.52%  (p=0.008 n=5+5)\r\n````",
	"user": {
		"login": "btracey",
		"id": 3680859,
		"type": "User",
		"site_admin": false
	},
	"assignee": {
		"login": "randall77",
		"id": 6889504,
		"type": "User",
		"site_admin": false
	},
	"comments": 11,
	"closed_at": "2016-03-03T17:40:00Z",
	"created_at": "2016-02-25T20:20:28Z",
	"updated_at": "2016-03-10T20:58:09Z",
	"milestone": {
		"id": 1414133,
		"number": 31,
		"title": "Go1.7"
	}
}
