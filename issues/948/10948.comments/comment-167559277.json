{
	"id": 167559277,
	"body": "Hi @philhofer.\r\n\r\nThank you for your patch. \r\n\r\nI have make a simple TCP/IP proxy, it transfer small messages between client and backend by `io.Copy()`.\r\n\r\nAfter I apply your patch, the proxy always have 200ms latency. \r\n\r\nAt last, I found that the  `fSpliceMore` flag in the `writeTo()` makes socket work like `TCP_CORK` enabled.\r\n\r\nWhen I remove the flag, the latency gone and the performance better then old `io.Copy()`.\r\n\r\nThis is the simple proxy:\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"io\"\r\n\t\"net\"\r\n)\r\n\r\ntype Proxy struct{}\r\n\r\nfunc newProxy() Proxy {\r\n\treturn Proxy{}\r\n}\r\n\r\nfunc (p Proxy) Transfer(conn1, conn2 net.Conn) error {\r\n\terrChan := make(chan error, 1)\r\n\tgo func() {\r\n\t\t_, err := io.Copy(conn2, conn1)\r\n\t\tconn1.Close()\r\n\t\tconn2.Close()\r\n\t\terrChan \u003c- err\r\n\t}()\r\n\r\n\t_, err1 := io.Copy(conn1, conn2)\r\n\tconn1.Close()\r\n\tconn2.Close()\r\n\terr2 := \u003c-errChan\r\n\r\n\tif err1 != nil {\r\n\t\treturn err1\r\n\t}\r\n\treturn err2\r\n}\r\n```\r\n\r\nThe test case:\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"bytes\"\r\n\t\"io\"\r\n\t\"math/rand\"\r\n\t\"net\"\r\n\t\"testing\"\r\n)\r\n\r\nfunc Test_Proxy(t *testing.T) {\r\n\t// Setup an echo server\r\n\tbackendLsn, err := net.Listen(\"tcp\", \"0.0.0.0:0\")\r\n\tif err != nil {\r\n\t\tt.Fatal(err)\r\n\t}\r\n\tgo func() {\r\n\t\tconn, err := backendLsn.Accept()\r\n\t\tif err != nil {\r\n\t\t\tpanic(err)\r\n\t\t}\r\n\t\tio.Copy(conn, conn)\r\n\t}()\r\n\r\n\t// Setup a proxy server\r\n\tproxyLsn, err := net.Listen(\"tcp\", \"0.0.0.0:0\")\r\n\tif err != nil {\r\n\t\tt.Fatal(err)\r\n\t}\r\n\tgo func() {\r\n\t\tconn, err := proxyLsn.Accept()\r\n\t\tif err != nil {\r\n\t\t\tpanic(err)\r\n\t\t}\r\n\r\n\t\t// Dial to backend echo server\r\n\t\tagent, err := net.Dial(\"tcp\", backendLsn.Addr().String())\r\n\t\tif err != nil {\r\n\t\t\tpanic(err)\r\n\t\t}\r\n\r\n\t\t// Begin transfer\r\n\t\tproxy := newProxy()\r\n\t\tproxy.Transfer(conn, agent)\r\n\t}()\r\n\r\n\tconn, err := net.Dial(\"tcp\", proxyLsn.Addr().String())\r\n\tif err != nil {\r\n\t\tt.Fatal(err)\r\n\t}\r\n\r\n\tfor i := 0; i \u003c 100000; i++ {\r\n\t\tb1 := RandBytes(256)\r\n\t\tb2 := make([]byte, len(b1))\r\n\t\t\r\n\t\t_, err := conn.Write(b1)\r\n\t\tif err != nil {\r\n\t\t\tt.Fatal(err)\r\n\t\t}\r\n\r\n\t\t_, err = io.ReadFull(conn, b2)\r\n\t\tif err != nil {\r\n\t\t\tt.Fatal(err)\r\n\t\t}\r\n\r\n\t\tif !bytes.Equal(b1, b2) {\r\n\t\t\tt.Fatal()\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunc RandBytes(n int) []byte {\r\n\tn = rand.Intn(n) + 1\r\n\tb := make([]byte, n)\r\n\tfor i := 0; i \u003c n; i++ {\r\n\t\tb[i] = byte(rand.Intn(255))\r\n\t}\r\n\treturn b\r\n}\r\n```",
	"user": {
		"login": "idada",
		"id": 259552,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2015-12-28T12:23:59Z",
	"updated_at": "2015-12-28T12:25:02Z"
}
