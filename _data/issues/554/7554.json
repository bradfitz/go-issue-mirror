{
	"id": 51286870,
	"number": 7554,
	"state": "closed",
	"title": "runtime: solaris/amd64 crash in garbage collector",
	"body": "\u003cpre\u003eruntime: gc crash in tests\n\nWe're seeing some crashes in the garbage collector while running runtime\ntests on a particular Solaris machine, for example:\n\n    \u003ca href=\"http://build.golang.org/log/f80b1657689632e2f02fd3976f6b15edc4d130a6\"\u003ehttp://build.golang.org/log/f80b1657689632e2f02fd3976f6b15edc4d130a6\u003c/a\u003e\n    \u003ca href=\"http://build.golang.org/log/09d748b886fe7e70d34f6e4bf58561a3ea5871b1\"\u003ehttp://build.golang.org/log/09d748b886fe7e70d34f6e4bf58561a3ea5871b1\u003c/a\u003e\n\nThe machine exposes 24 CPUs but has little memory. On another machine\nwith 24 CPUs but with more memory I can still see the failures, but much\nmore rarely. On my 4 CPU machine I never see the failures.\n\nIf I disable the GC, the failure goes away.\n\nThis is possibly related to \u003ca href=\"https://golang.org/issue/7502\"\u003eissue #7502\u003c/a\u003e and \u003ca href=\"https://golang.org/issue/7159\"\u003eissue #7159\u003c/a\u003e (the crash seems\nto occur only in tests that use reflection). It happens in various tests,\nbut it always fails in the same place.\n\n    SIGSEGV: segmentation violation\n    PC=0x409620\n    \n    goroutine 0 [idle]:\n    scanblock(0x0, 0x1)\n           /home/aram/go/src/pkg/runtime/mgc0.c:1023 +0xc80\n    runtime.gchelper()\n          /home/aram/go/src/pkg/runtime/mgc0.c:2044 +0x45\n    stopm()\n      /home/aram/go/src/pkg/runtime/proc.c:960 +0x111\n    gcstopm()\n            /home/aram/go/src/pkg/runtime/proc.c:1125 +0xc4\n    schedule()\n           /home/aram/go/src/pkg/runtime/proc.c:1322 +0x4a\n    runtime.gosched0(0xc208044480)\n       /home/aram/go/src/pkg/runtime/proc.c:1437 +0x9e\n    runtime.newstack()\n           /home/aram/go/src/pkg/runtime/stack.c:657 +0x330\n    runtime.morestack()\n         /home/aram/go/src/pkg/runtime/asm_amd64.s:228 +0x6a\n\nThe code in scanblock is:\n\n    case GC_DEFAULT_PTR:\n    \twhile(stack_top.b \u0026lt;= end_b) {\n    \t\tobj = *(byte**)stack_top.b;\n\u0026gt;\u0026gt;\u0026gt;    \t\tstack_top.b += PtrSize;\n    \t\tif(obj \u0026gt;= arena_start \u0026amp;\u0026amp; obj \u0026lt; arena_used) {\n    \t\t\t*sbuf.ptr.pos++ = (PtrTarget){obj, 0};\n    \t\t\tif(sbuf.ptr.pos == sbuf.ptr.end)\n    \t\t\t\tflushptrbuf(\u0026amp;sbuf);\n    \t\t}\n    \t}\n    \tgoto next_block;\n\nI have confirmed in the debugger that stack_top.b is zero.\n\nOther frames related to the GC are:\n\n    goroutine 18 [GC sweep wait]:\n    runtime.park(0x415bf0, 0x856d68, 0x8534ac)\n     /home/aram/go/src/pkg/runtime/proc.c:1370 +0x89\n    runtime.parkunlock(0x856d68, 0x8534ac)\n       /home/aram/go/src/pkg/runtime/proc.c:1386 +0x3b\n    bgsweep()\n            /home/aram/go/src/pkg/runtime/mgc0.c:1918 +0xb2\n    runtime.goexit()\n     /home/aram/go/src/pkg/runtime/proc.c:1446\n    created by runtime.gc\n      /home/aram/go/src/pkg/runtime/mgc0.c:2187\n    \n    goroutine 388 [finalizer wait]:\n    runtime.park(0x415bf0, 0x856d68, 0x853692)\n          /home/aram/go/src/pkg/runtime/proc.c:1370 +0x89\n    runtime.parkunlock(0x856d68, 0x853692)\n       /home/aram/go/src/pkg/runtime/proc.c:1386 +0x3b\n    runfinq()\n            /home/aram/go/src/pkg/runtime/mgc0.c:2555 +0xc2\n    runtime.goexit()\n     /home/aram/go/src/pkg/runtime/proc.c:1446\n    created by runtime.gc\n      /home/aram/go/src/pkg/runtime/mgc0.c:2187\n\n    goroutine 52392 [garbage collection]:\n    runtime.gc(0xfffffd7f00000000)\n     /home/aram/go/src/pkg/runtime/mgc0.c:2250 +0x1b2\n    runtime.mallocgc(0x20, 0x673820, 0x0)\n       /home/aram/go/src/pkg/runtime/malloc.goc:206 +0x1b7\n    runtime.new(0x673820, 0x8)\n       /home/aram/go/src/pkg/runtime/malloc.goc:815 +0x32\n    reflect.Value.MapIndex(0x5f5a20, 0xc208108060, 0x0, 0x150, 0x5f7560, ...)\n         /home/aram/go/src/pkg/reflect/value.go:1165 +0x45\n    runtime_test.func·044()\n           /home/aram/go/src/pkg/runtime/map_test.go:272 +0x15d\n    runtime.goexit()\n        /home/aram/go/src/pkg/runtime/proc.c:1446\n    created by runtime_test.testConcurrentReadsAfterGrowth\n     /home/aram/go/src/pkg/runtime/map_test.go:274 +0x26a\n\nAnd frames related to reflection:\n\n    goroutine 52398 [semacquire]:\n    runtime.park(0x415bf0, 0x864b00, 0x84fac0)\n         /home/aram/go/src/pkg/runtime/proc.c:1370 +0x89\n    runtime.parkunlock(0x864b00, 0x84fac0)\n       /home/aram/go/src/pkg/runtime/proc.c:1386 +0x3b\n    runtime.semacquire(0x849294, 0x0)\n            /home/aram/go/src/pkg/runtime/sema.goc:140 +0x10e\n    runtime.gc(0xfffffd7f00000000)\n     /home/aram/go/src/pkg/runtime/mgc0.c:2220 +0xfc\n    runtime.mallocgc(0x20, 0x673820, 0x0)\n        /home/aram/go/src/pkg/runtime/malloc.goc:206 +0x1b7\n    runtime.new(0x673820, 0x8)\n       /home/aram/go/src/pkg/runtime/malloc.goc:815 +0x32\n    reflect.Value.MapIndex(0x5f5a20, 0xc208108060, 0x0, 0x150, 0x5f7560, ...)\n         /home/aram/go/src/pkg/reflect/value.go:1165 +0x45\n    runtime_test.func·044()\n           /home/aram/go/src/pkg/runtime/map_test.go:272 +0x15d\n    runtime.goexit()\n        /home/aram/go/src/pkg/runtime/proc.c:1446\n    created by runtime_test.testConcurrentReadsAfterGrowth\n     /home/aram/go/src/pkg/runtime/map_test.go:274 +0x26a\n\n    goroutine 52914 [runnable]:\n    reflect.loadScalar(0xc208142e38, 0x8, 0xf2)\n          /home/aram/go/src/pkg/reflect/value.go:223\n    reflect.Value.MapKeys(0x5f5a20, 0xc208108060, 0x0, 0x150, 0x0, ...)\n       /home/aram/go/src/pkg/reflect/value.go:1242 +0x343\n    runtime_test.func·044()\n          /home/aram/go/src/pkg/runtime/map_test.go:270 +0xc3\n    runtime.goexit()\n         /home/aram/go/src/pkg/runtime/proc.c:1446\n    created by runtime_test.testConcurrentReadsAfterGrowth\n     /home/aram/go/src/pkg/runtime/map_test.go:274 +0x26a\n     \n    goroutine 52890 [runnable]:\n    reflect.mapiternext(0xc20810e190)\n            /home/aram/go/src/pkg/runtime/hashmap.goc:1046\n    reflect.Value.MapKeys(0x5f5a20, 0xc208108060, 0x0, 0x150, 0x0, ...)\n           /home/aram/go/src/pkg/reflect/value.go:1244 +0x29c\n    runtime_test.func·044()\n          /home/aram/go/src/pkg/runtime/map_test.go:270 +0xc3\n    runtime.goexit()\n         /home/aram/go/src/pkg/runtime/proc.c:1446\n    created by runtime_test.testConcurrentReadsAfterGrowth\n     /home/aram/go/src/pkg/runtime/map_test.go:274 +0x26a\n    \n    goroutine 52395 [runnable]:\n    reflect.mapiternext(0xc20824c230)\n            /home/aram/go/src/pkg/runtime/hashmap.goc:1046\n    reflect.Value.MapKeys(0x5f5a20, 0xc208108060, 0x0, 0x150, 0x0, ...)\n           /home/aram/go/src/pkg/reflect/value.go:1244 +0x29c\n    runtime_test.func·044()\n          /home/aram/go/src/pkg/runtime/map_test.go:270 +0xc3\n    runtime.goexit()\n         /home/aram/go/src/pkg/runtime/proc.c:1446\n    created by runtime_test.testConcurrentReadsAfterGrowth\n     /home/aram/go/src/pkg/runtime/map_test.go:274 +0x26a\n    \n    goroutine 52917 [runnable]:\n    reflect.loadScalar(0xc20826fb30, 0x8, 0x143)\n         /home/aram/go/src/pkg/reflect/value.go:223\n    reflect.Value.MapKeys(0x5f5a20, 0xc208108060, 0x0, 0x150, 0x0, ...)\n       /home/aram/go/src/pkg/reflect/value.go:1242 +0x343\n    runtime_test.func·044()\n          /home/aram/go/src/pkg/runtime/map_test.go:270 +0xc3\n    runtime.goexit()\n         /home/aram/go/src/pkg/runtime/proc.c:1446\n    created by runtime_test.testConcurrentReadsAfterGrowth\n     /home/aram/go/src/pkg/runtime/map_test.go:274 +0x26a\n\nFull stack trace can be found in the referenced build logs.\u003c/pre\u003e",
	"user": {
		"login": "4ad",
		"id": 1331747,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 20,
	"closed_at": "2014-12-08T10:41:58Z",
	"created_at": "2014-03-15T13:34:31Z",
	"updated_at": "2016-06-25T01:29:56Z"
}
