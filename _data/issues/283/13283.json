{
	"id": 117270880,
	"number": 13283,
	"state": "closed",
	"title": "net: Pure-Go DNS resolver does not properly Round-Robin DNS Names",
	"body": "I was recently debugging an issue with an Amazon Elastic Load Balancer where our traffic was not being evenly balanced across ELB Availability Zones. AWS's ELB uses a number of DNS entries and low TTLs to balance \"front-door\" client traffic, expecting clients to properly round-robin the addresses. This technique works for a large number of clients on the internet.\r\n\r\nUnfortunately, the new pure-Go DNS resolver in 1.5 appears to have some affinity to lower-numbered addresses when returning addresses in round-robin form. The cgo resolver does not exhibit this behavior.\r\n\r\nAfter tracing through some of the code, I believe I have a good reproduction case for this problem. The ELB in question returns 6 IP addresses.\r\n\r\nI have written a small program to demonstrate the affinity behavior:\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"fmt\"\r\n\t\"net\"\r\n)\r\n\r\nfunc main() {\r\n\tfor i := 0; i \u003c= 50; i++ {\r\n\t\taddrs, err := net.LookupHost(\"REMOVED-ELB-HOSTNAME\")\r\n\r\n\t\tif err != nil {\r\n\t\t\tfmt.Println(err)\r\n\t\t} else {\r\n\t\t\tfmt.Println(addrs)\r\n\t\t}\r\n\t}\r\n}\r\n\r\n```\r\n\r\n```\r\nubuntu@ubuntu-scratchbox:~$ export GODEBUG=netdns=go\r\nubuntu@ubuntu-scratchbox:~$ go run dialtest.go\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.21.50.150 23.23.172.185 23.23.134.56 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.21.50.150 23.23.172.185 23.23.134.56 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.21.50.150 23.23.172.185 23.23.134.56 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.21.50.150 23.23.172.185 23.23.134.56 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.21.50.150 23.23.172.185 23.23.134.56 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.21.50.150 23.23.172.185 23.23.134.56 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.21.50.150 23.23.172.185 23.23.134.56 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.21.50.150 23.23.172.185 23.23.134.56 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.134.56 23.21.50.150 23.23.172.185 54.83.193.112 75.101.148.21 184.72.238.214]\r\n[23.23.172.185 23.23.134.56 23.21.50.150 54.83.193.112 75.101.148.21 184.72.238.214]\r\n```\r\n\r\nAn alternate form of this program highlights the issue:\r\n\r\n```\r\nubuntu@ubuntu-scratchbox:~$ export GODEBUG=netdns=go\r\nubuntu@ubuntu-scratchbox:~$ go run dialtest.go\r\n23.21.50.150:80 resolved 26 times\r\n23.23.134.56:80 resolved 16 times\r\n23.23.172.185:80 resolved 8 times\r\n```\r\n\r\nHowever, switching the resolver to `cgo` (on Ubuntu 12.04) causes the resolution to properly round-robin:\r\n```\r\nubuntu@ubuntu-scratchbox:~$ export GODEBUG=netdns=cgo\r\nubuntu@ubuntu-scratchbox:~$ go run dialtest.go\r\n[184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112]\r\n[54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150]\r\n[23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56]\r\n[23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21]\r\n[75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185]\r\n[23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214]\r\n[184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112]\r\n[54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150]\r\n[23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56]\r\n[23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21]\r\n[75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185]\r\n[23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214]\r\n[184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112]\r\n[54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150]\r\n[23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56]\r\n[23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21]\r\n[75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185]\r\n[23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214]\r\n[184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112]\r\n[54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150]\r\n[23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56]\r\n[23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21]\r\n[75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185]\r\n[23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214]\r\n[184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112]\r\n[54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150]\r\n[23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56]\r\n[23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21]\r\n[75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185]\r\n[23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214]\r\n[184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112]\r\n[54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150]\r\n[23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56]\r\n[23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21]\r\n[75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185]\r\n[23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214]\r\n[184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112]\r\n[54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150]\r\n[23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56]\r\n[23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21]\r\n[75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185]\r\n[23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214]\r\n[184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112]\r\n[54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150]\r\n[23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56]\r\n[23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21]\r\n[75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185]\r\n[23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112 184.72.238.214]\r\n[184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150 54.83.193.112]\r\n[54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56 23.21.50.150]\r\n[23.21.50.150 54.83.193.112 184.72.238.214 23.23.172.185 75.101.148.21 23.23.134.56]\r\n```\r\n\r\nAnd again, the even resolution behavior is highlighted by an alternate form of this program:\r\n\r\n```\r\nubuntu@ubuntu-scratchbox:~$ export GODEBUG=netdns=cgo\r\nubuntu@ubuntu-scratchbox:~$ go run dialtest.go\r\n23.23.172.185:80 resolved 9 times\r\n23.21.50.150:80 resolved 9 times\r\n54.83.193.112:80 resolved 8 times\r\n184.72.238.214:80 resolved 8 times\r\n```\r\n\r\nI believe the pure-Go DNS resolver should be updated to round-robin across all returned addresses.",
	"user": {
		"login": "bmhatfield",
		"id": 1119967,
		"type": "User",
		"site_admin": false
	},
	"assignee": {
		"login": "mdempsky",
		"id": 38349,
		"type": "User",
		"site_admin": false
	},
	"comments": 13,
	"closed_at": "2015-11-17T23:49:08Z",
	"created_at": "2015-11-17T02:46:17Z",
	"updated_at": "2015-11-17T23:49:08Z",
	"milestone": {
		"id": 1096159,
		"number": 24,
		"title": "Go1.6"
	}
}
