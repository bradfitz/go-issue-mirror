{
	"id": 51282710,
	"number": 4840,
	"state": "closed",
	"title": "runtime/race: some kind of fork/exec deadlock?",
	"body": "\u003cpre\u003eI've been stalking a strange bug on \u0026quot;stress test\u0026quot; builder that runs under\nJenkins.\n\nI have the Jenkins builder configured to kill a job if it runs for more than 60 minutes.\nThe current set of tests usually finish in about 20 to 30 minutes.\n\nI had 4 builds between 4 February and 14 February that got killed after 60 minutes. At\nfirst I thought that the machine was under high load or that the Jenkins timer was\nmisbehaving, but I added some timing logs to the build script and everything seemed fine.\n\nI disabled the Jenkins build time limit. I caught one this morning that had been stuck\nfor a few hours.\n\nThere were two processes running that were part of the suspect build:\n\n20397 ? Sl 0:48 go test std -short -timeout=120s\n22515 ? S 0:00 go test std -short -timeout=120s\n\nI could tell from their /proc/\u0026lt;PID\u0026gt;/environ file that they were both part of the\nJenkins job.\n\n/proc/20397 had:\n\ncwd -\u0026gt; /build/go.tip/go/src\nexe -\u0026gt; /build/go.tip/go/bin/go\n\n/build/go.tip/go is $GOROOT.\n\n/proc/22515 had:\n\ncwd -\u0026gt; /dev/shm/go-build017000760/sync/_test\nexe -\u0026gt; /build/go.tip/go/bin/go\n\n/dev/shm is TMPDIR.\n\nThis looks like it could be a process stuck between fork and exec?\n\nThe last thing the job had printed out before I killed it was:\n\nok log/syslog 2.187s\n\nIn previous cases I had:\n\n+ go test -v -cpu 1,2,4 std\n...\nok mime/multipart 0.642s\n\nBuild timed out (after 60 minutes). Marking the build as aborted.\n\n+ go test -v -cpu 1,2,4 std\n...\nok crypto/tls 1.182s\nBuild timed out (after 60 minutes). Marking the build as aborted.\n\nand a very nice one:\n\n+ go version\ngo version devel +d8e8634eec4e Thu Feb 14 15:04:22 2013 +1100 linux/amd64\n++ seq 1 5 + for i in '`seq 1 5`'\n+ export GOMAXPROCS=3\n+ GOMAXPROCS=3\n+ ./run.bash --no-rebuild\n# Testing packages.\nok cmd/api 0.055s\n? cmd/cgo [no test files]\nok cmd/fix 2.585s\nok cmd/go 0.058s\n? cmd/godoc [no test files]\nok cmd/gofmt 0.103s\n? cmd/vet [no test files]\n? cmd/yacc [no test files]\nok archive/tar 0.041s\nBuild timed out (after 60 minutes). Marking the build as aborted.\n\nso this doesn't seem to be related to any of the recent issues with log/syslog.\n\nI tried to strace pid 22515 on the way out. I sent a SIGQUIT first, this didn't kill it.\nThen I sent a SIGKILL.\n\n22515 futex(0x7fafb4000020, FUTEX_WAIT_PRIVATE, 2, NULL) = ? ERESTARTSYS (To be\nrestarted if SA_RESTART is set)\n22515 --- SIGQUIT {si_signo=SIGQUIT, si_code=SI_USER, si_pid=13066, si_uid=0} ---\n22515 futex(0xb68930, FUTEX_WAKE, 1) = 0\n22515 rt_sigreturn() = 202\n22515 futex(0x7fafb4000020, FUTEX_WAIT_PRIVATE, 2, NULL) = ? ERESTARTSYS (To be\nrestarted if SA_RESTART is set)\n22515 --- SIGQUIT {si_signo=SIGQUIT, si_code=SI_USER, si_pid=13066, si_uid=0} ---\n22515 rt_sigreturn() = 202\n22515 futex(0x7fafb4000020, FUTEX_WAIT_PRIVATE, 2, NULL \u0026lt;unfinished ...\u0026gt;\n22515 +++ killed by SIGKILL +++\n\nI also straced pid 20397, but that trace is less enlightening.\n\nFinally, I noticed that 22515 had quite a lot of file descriptors hanging around.\nDoesn't look quite right at first glance:\n\n# ls -la /proc/22515/fd\ntotal 0\ndr-x------ 2 jenkins jenkins  0 Feb 18 06:04 .\ndr-xr-xr-x 8 jenkins jenkins  0 Feb 15 21:47 ..\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 0 -\u0026gt; /dev/null\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 1 -\u0026gt; pipe:[566509041]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 10 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 11 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 13 -\u0026gt; pipe:[566509040]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 14 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 15 -\u0026gt; pipe:[566530248]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 16 -\u0026gt; pipe:[566498220]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 17 -\u0026gt; pipe:[566506106]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 18 -\u0026gt; pipe:[566498220]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 19 -\u0026gt; /dev/null\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 2 -\u0026gt; pipe:[566433078]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 20 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 22 -\u0026gt; pipe:[566527240]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 23 -\u0026gt; pipe:[566513584]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 24 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 25 -\u0026gt; pipe:[566508526]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 26 -\u0026gt; pipe:[566508526]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 27 -\u0026gt; pipe:[566536197]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 28 -\u0026gt; /dev/null\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 29 -\u0026gt; pipe:[566530248]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 3 -\u0026gt; pipe:[566527242]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 30 -\u0026gt; pipe:[566506059]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 31 -\u0026gt; pipe:[566521230]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 32 -\u0026gt; /dev/null\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 33 -\u0026gt; pipe:[566506106]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 34 -\u0026gt; pipe:[566527240]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 35 -\u0026gt; pipe:[566521230]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 36 -\u0026gt; pipe:[566521227]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 37 -\u0026gt; pipe:[566509032]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 38 -\u0026gt; pipe:[566514464]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 39 -\u0026gt; pipe:[566521227]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 4 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 40 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 41 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 42 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 43 -\u0026gt; pipe:[566531204]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 44 -\u0026gt; pipe:[566508527]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 45 -\u0026gt; pipe:[566516473]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 46 -\u0026gt; pipe:[566529271]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 47 -\u0026gt; pipe:[566529271]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 48 -\u0026gt; pipe:[566529259]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 49 -\u0026gt; pipe:[566509043]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 5 -\u0026gt; pipe:[566521231]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 50 -\u0026gt; pipe:[566509043]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 51 -\u0026gt; pipe:[566511380]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 52 -\u0026gt; pipe:[566508527]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 53 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 54 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 55 -\u0026gt; pipe:[566520373]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 57 -\u0026gt; pipe:[566520373]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 59 -\u0026gt; pipe:[566525096]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 6 -\u0026gt; pipe:[566521231]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 60 -\u0026gt; pipe:[566525096]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 61 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 63 -\u0026gt; pipe:[566509038]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 65 -\u0026gt; /dev/null\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 66 -\u0026gt; pipe:[566509041]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 67 -\u0026gt; pipe:[566509041]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 68 -\u0026gt; pipe:[566521228]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 69 -\u0026gt; pipe:[566521213]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 7 -\u0026gt; pipe:[566536197]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 70 -\u0026gt; pipe:[566521228]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 73 -\u0026gt; pipe:[566514464]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 75 -\u0026gt; pipe:[566529270]\nl-wx------ 1 jenkins jenkins 64 Feb 18 06:07 76 -\u0026gt; pipe:[566529270]\nlr-x------ 1 jenkins jenkins 64 Feb 18 06:07 9 -\u0026gt; /dev/null\n\nI've seen this issue with:\n\ngo version devel +b67523215571 Mon Feb 04 15:30:41 2013 +1100 linux/amd64 \ngo version devel +a44171137af8 Sat Feb 09 17:36:31 2013 -0500 linux/amd64 \ngo version devel +d8e8634eec4e Thu Feb 14 15:04:22 2013 +1100 linux/amd64\ngo version devel +537555f45dcc Fri Feb 15 13:37:43 2013 -0800 linux/amd64 \n\nKernel is 3.4.7-1.fc16.x86_64.\u003c/pre\u003e",
	"user": {
		"login": "alberts",
		"id": 409689,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		},
		{
			"name": "RaceDetector"
		}
	],
	"comments": 17,
	"closed_at": "2014-12-08T10:25:43Z",
	"created_at": "2013-02-18T06:51:05Z",
	"updated_at": "2016-06-24T22:33:16Z"
}
