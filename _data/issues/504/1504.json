{
	"id": 51277892,
	"number": 1504,
	"state": "closed",
	"title": "GC errors when time benchmarks are run with GOMAXPROCS \u003e 1",
	"body": "by **consalus**:\n\n\u003cpre\u003eUsing 6g on darwin at 0c8b700cc391+ tip, when I run\n\u0026quot;make bench\u0026quot; in src/pkg/time/ with GOMAXPROCS \u0026gt; 1, I get various errors when\nBenchmarkStop runs. It doesn't happen every time, but most of the time.\n\nThe stack trace varies a bit. Here is one example:\n\ntime_test.BenchmarkAfterFunc\t  100000\t     16142 ns/op\ntime_test.BenchmarkAfter\t  100000\t     18120 ns/op\npanic: invalid memory address or nil pointer dereference\nthrow: panic during gc\n\n[signal 0xb code=0x1 addr=0x0 pc=0x97c6]\n\nruntime.throw+0x3b /Users/username/code/go/src/pkg/runtime/runtime.c:78\n\truntime.throw(0x1538c8, 0x153c47)\nruntime.panicstring+0x51 /Users/username/code/go/src/pkg/runtime/runtime.c:89\n\truntime.panicstring(0x153c47, 0x0)\nruntime.sigpanic+0x144 /Users/username/code/go/src/pkg/runtime/darwin/thread.c:469\n\truntime.sigpanic()\nReleaseN+0x30 /Users/username/code/go/src/pkg/runtime/mcache.c:64\n\tReleaseN(0x2170000, 0x2170030, 0x3000000e0, 0xf83fffff00, 0xf840147d08, ...)\nruntime.MCache_ReleaseAll+0x53 /Users/username/code/go/src/pkg/runtime/mcache.c:128\n\truntime.MCache_ReleaseAll(0x2170000, 0xe9db)\nstealcache+0x3a /Users/username/code/go/src/pkg/runtime/mgc0.c:500\n\tstealcache()\nruntime.gc+0x1ca /Users/username/code/go/src/pkg/runtime/mgc0.c:577\n\truntime.gc(0xf800000001, 0xf840000dc0)\nrunfinq+0x112 /Users/username/code/go/src/pkg/runtime/mgc0.c:657\n\trunfinq()\nruntime.goexit /Users/username/code/go/src/pkg/runtime/proc.c:149\n\truntime.goexit()\n\ngoroutine 330315 [3]:\nruntime.entersyscall+0x28 /Users/username/code/go/src/pkg/runtime/proc.c:577\n\truntime.entersyscall()\nsyscall.Syscall6+0x5 /Users/username/code/go/src/pkg/syscall/asm_darwin_amd64.s:38\n\tsyscall.Syscall6()\nsyscall.Select+0x66 /Users/username/code/go/src/pkg/syscall/zsyscall_darwin_amd64.go:704\n\tsyscall.Select(0x0, 0x0, 0x0, 0x0, 0xf84001bfc0, ...)\nsyscall.Sleep+0x7a /Users/username/code/go/src/pkg/syscall/syscall_bsd.go:145\n\tsyscall.Sleep(0x3b90b3f8, 0xf84001bf00, 0x7b420, 0xf8400cd040)\ntime.sleeper+0xa9 /Users/username/code/go/src/pkg/time/sleep.go:154\n\ttime.sleeper(0x35c30, 0x0)\nruntime.goexit /Users/username/code/go/src/pkg/runtime/proc.c:149\n\truntime.goexit()\nfmt.*pp·fmtUint64+0x137 /Users/username/code/go/src/pkg/fmt/print.go:384\n\tfmt.*pp·fmtUint64(0x0, 0x0, 0x0, 0x0, 0x0, ...)\n\ngoroutine 1 [1]:\nruntime.gosched+0x77 /Users/username/code/go/src/pkg/runtime/proc.c:558\n\truntime.gosched()\nruntime.exitsyscall+0xa2 /Users/username/code/go/src/pkg/runtime/proc.c:624\n\truntime.exitsyscall()\nsyscall.Syscall+0x61 /Users/username/code/go/src/pkg/syscall/asm_darwin_amd64.s:34\n\tsyscall.Syscall()\nsyscall.gettimeofday+0x45\n/Users/username/code/go/src/pkg/syscall/zsyscall_darwin_amd64.go:922\n\tsyscall.gettimeofday(0xf840121a60, 0x29, 0x9279, 0x10, 0x40, ...)\nsyscall.Gettimeofday+0x27\n/Users/username/code/go/src/pkg/syscall/syscall_darwin_amd64.go:31\n\tsyscall.Gettimeofday(0xf840121a60, 0xf840121a60, 0x10, 0xf840099e40)\nos.Time+0x4e /Users/username/code/go/src/pkg/os/time.go:16\n\tos.Time(0xf840099e40, 0x100000000, 0x0, 0x0, 0x500002ea1, ...)\ntime.Nanoseconds+0x1c /Users/username/code/go/src/pkg/time/time.go:26\n\ttime.Nanoseconds(0x400000003, 0x4deb)\ntime.after+0x1f /Users/username/code/go/src/pkg/time/sleep.go:119\n\ttime.after(0x3b9aca00, 0xf840099e40, 0xf840000958, 0xf840099e40, 0xf840000958, ...)\ntime.NewTimer+0x83 /Users/username/code/go/src/pkg/time/sleep.go:78\n\ttime.NewTimer(0x3b9aca00, 0xf8400d7001, 0x4a9344f55ee00, 0x19456)\n/Users/username/code/go/src/pkg/time/_xtest_.BenchmarkStop+0x36\n/Users/username/code/go/src/pkg/time/sleep_test.go:75\n\t/Users/username/code/go/src/pkg/time/_xtest_.BenchmarkStop(0xf840099d80, 0x19669)\ntesting.*B·runN+0x48 /Users/username/code/go/src/pkg/testing/benchmark.go:72\n\ttesting.*B·runN(0xf840099d80, 0x7a120, 0x1, 0x7a12000002710)\ntesting.*B·run+0xda /Users/username/code/go/src/pkg/testing/benchmark.go:141\n\ttesting.*B·run(0xf840099d80, 0xf840099d80, 0x6ae30, 0x17)\ntesting.RunBenchmarks+0x1d5 /Users/username/code/go/src/pkg/testing/benchmark.go:199\n\ttesting.RunBenchmarks(0x1e40b, 0xf8400323c0, 0x800000008, 0x2a86)\nmain.main+0x7b /Users/username/code/go/src/pkg/time/_testmain.go:41\n\tmain.main()\nruntime.mainstart+0xf /Users/username/code/go/src/pkg/runtime/amd64/asm.s:77\n\truntime.mainstart()\nruntime.goexit /Users/username/code/go/src/pkg/runtime/proc.c:149\n\truntime.goexit()\nmake: *** [bench] Error 2\n\n\nHere is another stack trace:\n\ntime_test.BenchmarkAfterFunc\t  100000\t     16283 ns/op\ntime_test.BenchmarkAfter\t  100000\t     18473 ns/op\npanic: runtime error: invalid memory address or nil pointer dereference\n\n[signal 0xb code=0x1 addr=0x54 pc=0x13b8f]\n\nruntime.panic+0xa7 /Users/username/code/go/src/pkg/runtime/proc.c:1023\n\truntime.panic(0x77284, 0xf8400f7c20)\nruntime.panicstring+0xa3 /Users/username/code/go/src/pkg/runtime/runtime.c:92\n\truntime.panicstring(0x153c47, 0x2170400)\nruntime.sigpanic+0x144 /Users/username/code/go/src/pkg/runtime/darwin/thread.c:469\n\truntime.sigpanic()\nruntime.destroylock+0x1c /Users/username/code/go/src/pkg/runtime/darwin/thread.c:85\n\truntime.destroylock(0x50, 0xf840097c40)\ndestroychan+0x29 /Users/username/code/go/src/pkg/runtime/chan.c:140\n\tdestroychan(0x0, 0xf840009500)\n----- stack segment boundary -----\nrunfinq+0xc3 /Users/username/code/go/src/pkg/runtime/mgc0.c:650\n\trunfinq()\nruntime.goexit /Users/username/code/go/src/pkg/runtime/proc.c:149\n\truntime.goexit()\n\ngoroutine 330314 [3]:\nruntime.entersyscall+0x28 /Users/username/code/go/src/pkg/runtime/proc.c:577\n\truntime.entersyscall()\nsyscall.Syscall6+0x5 /Users/username/code/go/src/pkg/syscall/asm_darwin_amd64.s:38\n\tsyscall.Syscall6()\nsyscall.Select+0x66 /Users/username/code/go/src/pkg/syscall/zsyscall_darwin_amd64.go:704\n\tsyscall.Select(0x0, 0x0, 0x0, 0x0, 0xf8400e8f00, ...)\nsyscall.Sleep+0x7a /Users/username/code/go/src/pkg/syscall/syscall_bsd.go:145\n\tsyscall.Sleep(0x3b95c0f0, 0xf8400e8ee0, 0x7b398, 0xf840097300)\ntime.sleeper+0xa9 /Users/username/code/go/src/pkg/time/sleep.go:154\n\ttime.sleeper(0x35c2f, 0x0)\nruntime.goexit /Users/username/code/go/src/pkg/runtime/proc.c:149\n\truntime.goexit()\nfmt.*pp·fmtUint64+0xe4 /Users/username/code/go/src/pkg/fmt/print.go:395\n\tfmt.*pp·fmtUint64(0x0, 0x0, 0x0, 0x0, 0x0, ...)\n\ngoroutine 1 [3]:\nruntime.entersyscall+0x28 /Users/username/code/go/src/pkg/runtime/proc.c:577\n\truntime.entersyscall()\nsyscall.Syscall+0x5 /Users/username/code/go/src/pkg/syscall/asm_darwin_amd64.s:14\n\tsyscall.Syscall()\nsyscall.gettimeofday+0x45\n/Users/username/code/go/src/pkg/syscall/zsyscall_darwin_amd64.go:922\n\tsyscall.gettimeofday(0x400000003, 0xf8400d0000, 0x9279, 0x10, 0x155088, ...)\nsyscall.Gettimeofday+0x27\n/Users/username/code/go/src/pkg/syscall/syscall_darwin_amd64.go:31\n\tsyscall.Gettimeofday(0x2000000008, 0xf8400e8ac0, 0xf800000001, 0x2cd88)\nruntime.mal+0x3f /Users/username/code/go/src/pkg/runtime/malloc.c:285\n\truntime.mal(0xf8400abd70, 0x8a86)\nmake: *** [bench] Error 2\u003c/pre\u003e",
	"user": {
		"login": "gopherbot",
		"id": 8566911,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"assignee": {
		"login": "rsc",
		"id": 104030,
		"type": "User",
		"site_admin": false
	},
	"comments": 3,
	"closed_at": "2014-12-08T10:08:37Z",
	"created_at": "2011-02-11T22:22:02Z",
	"updated_at": "2016-06-24T19:25:12Z"
}
