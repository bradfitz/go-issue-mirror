{
	"id": 66085805,
	"body": "\u003ca id=\"c15\"\u003e\u003c/a\u003eComment 15 by **kin.wilson.za**:\n\n\u003cpre\u003eI extracted the relevant test to issue5986.go [1] and ran \"go build -n\" to produce the\neditted build.bat [2] (so I could tinker)\nOutput is at [3]\n\nObservations:\n1. Fails on mingw32 4.8.1 too\n2. Math sqrt introduces the __image_base__ reference (see [3][4][5])\n3. The definition of __image_base__ occurs in _cgo.o (which feeds cgo -dynimport) [6]\n4. The reference __image_base__ occurs in _all.o [7] (only with sqrt)\n5. No reference to _image_base__ anywhere\n\nI suspect 8l/ld is stripping the front underscore but the Go link is still a bit arcane\nto me (only been using Go for about 5 or 6 months).\n\nTony\n\n============ [1] issue5986.go =============\n// Copyright 2013 The Go Authors.  All rights reserved.\npackage main\n/*\n#cgo LDFLAGS: -lm\n#include \u0026lt;stdio.h\u0026gt;\n#include \u0026lt;math.h\u0026gt;\nstatic void output5986()\n{\n    int current_row = 0, row_count = 0;\n    double sum_squares = 0;\n    do {\n        if (current_row == 10) {\n            current_row = 0;\n        }\n        ++row_count;\n    }\n    while (current_row++ != 1);\n    double d = sqrt(sum_squares / row_count);\n    printf(\"sqrt is: %g\\n\", d);\n}\n*/\nimport \"C\"\nfunc main() {\n\tC.output5986()\n}\n============ [2] build.bat =============\n@echo off\nrmdir /q /s WORK\ndel /q issue5986.exe\nmkdir \"WORK/issue5986/obj/\"\nrem PATH=d:/goDev;...\nset GOROOT=d:/goDev\nset GOTOOLS=%GOROOT%/pkg/tool/windows_386\n\"%GOTOOLS%/cgo.exe\" -objdir WORK/issue5986/obj/ -- -I WORK/issue5986/obj/ issue5986.go\n\"%GOTOOLS%/8c.exe\" -F -V -w -I WORK/issue5986/obj/ -I %GOROOT%/pkg/windows_386 -o\nWORK/issue5986/obj/_cgo_defun.8 -D GOOS_windows -D GOARCH_386\nWORK/issue5986/obj/_cgo_defun.c\ngcc -I . -g -O2 -m32 -mthreads -I /issue5986/obj/ -o WORK/issue5986/obj/_cgo_main.o -c\nWORK/issue5986/obj/_cgo_main.c\ngcc -I . -g -O2 -m32 -mthreads -I WORK/issue5986/obj/ -o\nWORK/issue5986/obj/_cgo_export.o -c WORK/issue5986/obj/_cgo_export.c\ngcc -I . -g -O2 -m32 -mthreads -I WORK/issue5986/obj/ -o\nWORK/issue5986/obj/issue5986.cgo2.o -c WORK/issue5986/obj/issue5986.cgo2.c\ngcc -I . -g -O2 -m32 -o WORK/issue5986/obj/_cgo_.o WORK/issue5986/obj/_cgo_main.o\nWORK/issue5986/obj/_cgo_export.o WORK/issue5986/obj/issue5986.cgo2.o -lm\n\"%GOTOOLS%/cgo.exe\" -objdir WORK/issue5986/obj/ -dynimport WORK/issue5986/obj/_cgo_.o\n-dynout WORK/issue5986/obj/_cgo_import.c\n\"%GOTOOLS%/8c.exe\" -F -V -w -I WORK/issue5986/obj/ -I %GOROOT%/pkg/windows_386 -o\nWORK/issue5986/obj/_cgo_import.8 -D GOOS_windows -D GOARCH_386\nWORK/issue5986/obj/_cgo_import.c\nset LIBGCC=q:/qt/qt5.0.1/tools/mingw/bin/../lib/gcc/i686-w64-mingw32/4.7.2/libgcc.a\ngcc -I . -g -O2 -m32 -mthreads -o WORK/issue5986/obj/_all.o\nWORK/issue5986/obj/_cgo_export.o WORK/issue5986/obj/issue5986.cgo2.o -Wl,-r -nostdlib \n-Wl,--start-group -lmingwex -lmingw32 -Wl,--end-group %LIBGCC%\n\"%GOTOOLS%/8g.exe\" -o WORK/issue5986/obj/_go_.8 -p issue5986 -D issue5986 -I WORK\nWORK/issue5986/obj/_cgo_gotypes.go WORK/issue5986/obj/issue5986.cgo1.go\n\"%GOTOOLS%/pack.exe\" grcP WORK WORK/issue5986.a WORK/issue5986/obj/_go_.8\nWORK/issue5986/obj/_cgo_import.8 WORK/issue5986/obj/_cgo_defun.8\nWORK/issue5986/obj/_all.o\n\"%GOTOOLS%/8l.exe\" -o issue5986.exe -L WORK WORK/issue5986.a\nissue5986.exe\nset GOROOT=d:/go\nset GOTOOLS=\nset LIBGCC=\n============ [3] output of build.bat =============\n_image_base__(0): not defined\nsqrt is: 0\n============ [4] issue5986.go =============\n\u0026lt;\u0026lt;\u0026lt; double d = sqrt(sum_squares / row_count);\n\u0026gt;\u0026gt;\u0026gt; double d = (sum_squares / row_count);\n============ [5] output of build.bat =============\nsqrt is: 0\n============ [6] output of objdump -t _cgo_.o =============\nWORK\\issue5986\\obj\\_cgo_.o:     file format pei-i386\n\nSYMBOL TABLE:\n[  0](sec -2)(fl 0x00)(ty   0)(scl 103) (nx 1) 0x0000001d crtexe.c\nFile \n[  2](sec  1)(fl 0x00)(ty  20)(scl   3) (nx 1) 0x00000000\n___mingw_invalidParameterHandler\nAUX tagndx 0 ttlsiz 0x0 lnnos 0 next 0\n[  4](sec  1)(fl 0x00)(ty  20)(scl   3) (nx 0) 0x00000010 _pre_cpp_init\n...\n[1239](sec  2)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000044 ___lc_codepage\n[1240](sec -1)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000000 _GetTickCount@0\n[1241](sec -1)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00400000 __image_base__\n[1242](sec  5)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x000001ec __imp__exit\n[1243](sec -1)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00001000 __section_alignment__\n...\n[1373](sec -1)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000000 _WideCharToMultiByte@32\n[1374](sec  6)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x0000002c ___crt_xt_end__\n[1375](sec  5)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000138 __imp__EnterCriticalSection@4\n============ [7] output of objdump -t _all.o =============\nWORK\\issue5986\\obj\\_all.o:     file format pe-i386\n\nSYMBOL TABLE:\n[  0](sec -2)(fl 0x00)(ty   0)(scl 103) (nx 1) 0x00000010 _cgo_export.c\nFile \n[  2](sec  1)(fl 0x00)(ty   0)(scl   3) (nx 1) 0x00000000 .text\nAUX scnlen 0x0 nreloc 0 nlnno 0\n[  4](sec  2)(fl 0x00)(ty   0)(scl   3) (nx 1) 0x00000000 .data\nAUX scnlen 0x0 nreloc 0 nlnno 0\n...\n[361](sec  3)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x000003a0 ___tens_D2A\n[362](sec  2)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000024 ___lc_codepage\n[363](sec  0)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000000 __image_base__\n[364](sec  0)(fl 0x00)(ty  20)(scl   2) (nx 0) 0x00000000 _atoi\n[365](sec  0)(fl 0x00)(ty  20)(scl   2) (nx 0) 0x00000000 _memcpy\n...\n[385](sec  0)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000000 __imp__DeleteCriticalSection@4\n[386](sec  0)(fl 0x00)(ty  20)(scl   2) (nx 0) 0x00000000 _printf\n[387](sec  0)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x00000000 __imp__EnterCriticalSection@4\u003c/pre\u003e",
	"user": {
		"login": "gopherbot",
		"id": 8566911,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2013-09-22T17:03:17Z",
	"updated_at": "2014-12-22T06:28:52Z"
}
