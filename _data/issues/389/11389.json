{
	"id": 90783475,
	"number": 11389,
	"state": "open",
	"title": "x/image/tiff: excessive memory consumption",
	"body": "The following program:\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"bytes\"\r\n\t\"fmt\"\r\n\t\"golang.org/x/image/tiff\"\r\n)\r\n\r\nfunc main() {\r\n\tcfg, err := tiff.DecodeConfig(bytes.NewReader(data))\r\n\tif err != nil {\r\n\t\tpanic(err)\r\n\t}\r\n\tfmt.Printf(\"%+v\\n\", cfg)\r\n\ttiff.Decode(bytes.NewReader(data))\r\n}\r\n\r\nvar data = []byte(\r\n\t\"II*\\x00\\xc8\\x03\\x00\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\x88\\x88\\x88\\x00\\x00\\x00\\x00dRH=\\xd2eca\\xf0\" +\r\n\t\t\"SSR\\xe91*#\\xe27/\u0026\\xe6\u003c\u003c\u003c$\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\xa2\\xa2\\xa3\\x03/.-\\x9c\\x99\\x87r\\xff\\xbd\\xab\\x95\\xff\" +\r\n\t\t\"\\xff\\xff\\xff\\xff\\x84\\x86\\x88\\xff\\x80q_\\xffp`O\\xffbbc\u003c\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\" +\r\n\t\t\"eee\\x00Z[\\\\\\x00\\x1e\\x1a\\x16\\xab\\xb9\\xb8\\xb8\\xff\\x95\\x94\\x92\\xff\" +\r\n\t\t\"}m\\\\\\xff\\xbd\\xbb\\xb9\\xff\\xc4\\xc0\\xbc\\xff\\xc1\\xaa\\x8f\\xffū\\x8e\\xff\" +\r\n\t\t\"@=;x``a\\x00\\\\\\\\\\\\\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\x02\\x02\\x01A\\x1a\\x16\\x11\\xa8~o]\\xff\\xf1\\xf0\\xef\\xff\" +\r\n\t\t\"\\xc9\\xcb\\xcd\\xff;72\\xffD9,\\xff\\xa9\\x93z\\xff\\u05fb\\x9c\\xff\" +\r\n\t\t\"\\xde¢\\xff`TF\\xda\\x12\\x13\\x15\\x02@@@\\x00\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\x0e\\f\\nz?7.穓{\\xff\" +\r\n\t\t\"\\xbb\\xa8\\x93\\xff\\xbb\\xab\\x99\\xff\\x86ua\\xfftpl\\xff\\xb5\\xa0\\x87\\xff\" +\r\n\t\t\"Թ\\x9a\\xffӹ\\x9b\\xff\\xb7\\x9f\\x84\\xff:98mYZZ\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\x00\\x00\\x00\\x05\\x00\\x00\\x002\" +\r\n\t\t\"i\\\\M\\xeb\\xdfá\\xffҷ\\x97\\xffӹ\\x9a\\xff\\xb6\\xa2\\x8b\\xff\" +\r\n\t\t\"̲\\x95\\xffӹ\\x9a\\xffԹ\\x9a\\xffۿ\\x9f\\xfftj^\\xff\" +\r\n\t\t\"\\r\\x0f\\x10\\x87\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\x00\\x00\\x00\\x00\" +\r\n\t\t\"\\x00\\x00\\x00\\x00\\x15\\x12\\x0f\\x93ʹ\\x96\\xffҸ\\x9a\\xffж\\x98\\xff\" +\r\n\t\t\"չ\\x9a\\xffӸ\\x9a\\xff\\xc0\\xa9\\x8f\\xff\\xb7\\xa2\\x8b\\xffۿ\\x9f\\xff\" +\r\n\t\t\"\\x87vd\\xff\\x00\\x00\\x00\u003c\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x10cVH\\xdfۿ\\xa0\\xff\" +\r\n\t\t\"ж\\x98\\xffж\\x98\\xffպ\\x9b\\xff\\x9c\\x8bw\\xff\\x91\\x87{\\xff\" +\r\n\t\t\"ֻ\\x9b\\xff\\x9d\\x8as\\xff\\x00\\x00\\x00)\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x04\\x03\\x03W\" +\r\n\t\t\"\\xb9\\xa2\\x88\\xffӹ\\x9a\\xffж\\x98\\xffж\\x98\\xffϴ\\x96\\xff\" +\r\n\t\t\"е\\x96\\xffֻ\\x9d\\xff\\xa6\\x91y\\xff\\x00\\x00\\x004\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\" +\r\n\t\t\"\\x00\\x00\\x00\\x12|m[\\xf5ڿ\\x9f\\xffж\\x98\\xffж\\x98\\xff\" +\r\n\t\t\"ж\\x98\\xffж\\x98\\xffֻ\\x9d\\xff\\xa1\\x8dv\\xff\\x00\\x00\\x000\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\" +\r\n\t\t\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x03dXI\\xe8\\xdc\\xc1\\xa1\\xffж\\x98\\xff\" +\r\n\t\t\"ж\\x98\\xffж\\x98\\xffж\\x98\\xffڿ\\xa0\\xff\\x88vc\\xfc\" +\r\n\t\t\"\\x00\\x00\\x00\\x19\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00###\\x00\" +\r\n\t\t\"###\\x00%%%\\x00\\x02\\x03\\x05\\x03gZK\\xe8\\xdd\\xc1\\xa1\\xff\" +\r\n\t\t\"ж\\x98\\xffж\\x98\\xffж\\x98\\xffӸ\\x9a\\xffܿ\\x9f\\xff\" +\r\n\t\t\"vmb\\xff\\v\\f\\x0ee\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\xec\\xec\\xec\\x00\\xec\\xec\\xec\\x00\\xf9\\xf9\\xf9\\x00qrs\\x0e:1'\\xf1\" +\r\n\t\t\"\\xe1Ť\\xffպ\\x9b\\xffؽ\\x9e\\xff\\xdd¢\\xffж\\x98\\xff\" +\r\n\t\t\"qcT\\xeb-..\\x8bAABK\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\u0026\u0026\u0026\\x00\u0026\u0026\u0026\\x00(((\\x00\\x10\\x10\\x10\\f\" +\r\n\t\t\"\\x00\\x00\\x00cxk]\\U000378cd\\xff\\x9d\\x88p\\xffpbR\\xec\" +\r\n\t\t\" \\x1c\\x16\\xa0\\x1f\\x1f\\x1f ~~~\\x00\\xd9\\xd9\\xd9\\x00\\xff\\xff\\xff\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\" +\r\n\t\t\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00344\\xbeFFF\\xb5OOOA\" +\r\n\t\t\"\\x00\\x00\\x00\\x11\\x00\\x00\\x00\\x00!!!\\x00\\u007f\\u007f\\u007f\\x00\\xd9\\xd9\\xd9\\x00\" +\r\n\t\t\"\\xff\\xff\\xff\\x00\\xff\\xff\\xff\\x00\\f\\x00\\x00\\x01\\x03\\x00\\x01\\x00\\x00\\x00\\x10\\x00\" +\r\n\t\t\"\\x00\\x00\\x01\\x01\\x03\\x00\\x01\\x00\\x00\\x00\\x0f\\x00\\x00\\x00\\x02\\x01\\x03\\x00\\x04\\x00\" +\r\n\t\t\"\\x00\\x00^\\x04\\x00\\x00\\x06\\x01\\x03\\x00\\x01\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x11\\x01\" +\r\n\t\t\"\\x04\\x00\\x01\\x00\\x00\\x00\\b\\x00\\x00\\x00\\x15\\x01\\x03\\x00\\x01\\x00\\x00\\x00\\x04\\x00\" +\r\n\t\t\"\\x00\\x00\\x16\\x01\\x03\\x00\\x01\\x00\\x00\\x00\\x0f\\x00\\x00\\x00\\x17\\x01\\x04\\x00\\x01\\x00\" +\r\n\t\t\"\\x00\\x00\\xfa\\x00\\x00\\xfa\\x1a\\x01\\x05\\x00\\x01\\x00\\x00\\x00f\\x04\\x00\\x00\\x1b\\x01\" +\r\n\t\t\"\\x05\\x00\\x01\\x00\\x00\\x00n\\x04\\x00\\x00(\\x01\\x03\\x00\\x01\\x00\\x00\\x00\\x02\\x00\" +\r\n\t\t\"\\x00\\x00R\\x01\\x03\\x00\\x01\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\b\\x00\" +\r\n\t\t\"\\b\\x00\\b\\x00\\b\\x00\")\r\n```\r\nwhen run with ```ulimit -v 1000000``` crashes as:\r\n```\r\n{ColorModel:0xc820032030 Width:16 Height:15}\r\nfatal error: runtime: out of memory\r\nruntime.mallocgc(0xfa0000fa, 0x4fd060, 0x1, 0xc820034c00)\r\n\tsrc/runtime/malloc.go:632 +0x972 fp=0xc820045590 sp=0xc8200454c0\r\nruntime.newarray(0x4fd060, 0xfa0000fa, 0x7fdc0fc12498)\r\n\tsrc/runtime/malloc.go:756 +0xc9 fp=0xc8200455d0 sp=0xc820045590\r\nruntime.makeslice(0x4f5b60, 0xfa0000fa, 0xfa0000fa, 0x0, 0x0, 0x0)\r\n\tsrc/runtime/slice.go:32 +0x165 fp=0xc820045620 sp=0xc8200455d0\r\ngolang.org/x/image/tiff.Decode(0x7fdc0fc12260, 0xc820014420, 0x7fdc0fc12498, 0xc820010440, 0x0, 0x0)\r\n\tsrc/golang.org/x/image/tiff/reader.go:641 +0xc23 fp=0xc820045e10 sp=0xc820045620\r\nmain.main()\r\n\ttiff.go:15 +0x31c fp=0xc820045f50 sp=0xc820045e10\r\n```\r\n\r\nThat is, tiff tries to allocate 0xfa0000fa (4194304250) bytes to decode 15x16 image. That is too much.\r\n\r\non commit eb11b45157c1b71f30b3cec66306f1cd779a689e\r\ngo version devel +3cab476 Sun Jun 21 03:11:01 2015 +0000 linux/amd64",
	"user": {
		"login": "dvyukov",
		"id": 1095328,
		"type": "User",
		"site_admin": false
	},
	"assignee": {
		"login": "nigeltao",
		"id": 8565232,
		"type": "User",
		"site_admin": false
	},
	"comments": 0,
	"created_at": "2015-06-24T21:24:56Z",
	"updated_at": "2015-07-11T12:25:42Z",
	"milestone": {
		"id": 1067491,
		"number": 22,
		"title": "Unreleased"
	}
}
