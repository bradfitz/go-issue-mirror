{
	"id": 96120993,
	"body": "Finally caught it red handed calling runqput between steps 2 and 3. newm calls allocm, which \"borrows\" the P we're about to start and uses it to allocate, which assists GC, which has some chance of finishing the mark, which ready()s the main GC goroutine, which gets put on the borrowed P's run queue. This bug was introduced in ce502b0 when I switched this synchronization from using notes to using park/ready. It doesn't actually have anything to do with the new time slice hand off like I initially thought; this would have happened even without that. Now I just have to figure out a good way to fix it.\r\n\r\nThe full failure is here: https://storage.googleapis.com/go-build-log/7ab81449/windows-amd64-gce_edd15a5c.log from my debug hacks in https://go-review.googlesource.com/#/c/9331/.\r\n\r\nAnd the relevant part:\r\n\r\n\t--- FAIL: TestCgoCrashHandler (1.94s)\r\n\tcrash_test.go:92: building source: exit status 2\r\n\t\t# _/C_/Users/WINGOP~1/AppData/Local/Temp/go-build787559523\r\n\t\trunqput with p.startm = 112 p 0xc082014000\r\n\t\tfatal error: runqput at bad time\r\n\t\t\r\n\t\truntime stack:\r\n\t\truntime.throw(0x677af0, 0x13)\r\n\t\t\tC:/workdir/go/src/runtime/panic.go:543 +0x9d\r\n\t\truntime.runqput(0xc082014000, 0xc082485a40, 0x420501)\r\n\t\t\tC:/workdir/go/src/runtime/proc1.go:3311 +0xd2\r\n\t\truntime.ready(0xc082485a40, 0x0)\r\n\t\t\tC:/workdir/go/src/runtime/proc1.go:148 +0xfe\r\n\t\truntime.gcBgMarkDone()\r\n\t\t\tC:/workdir/go/src/runtime/mgc.go:1102 +0xbc\r\n\t\truntime.gcAssistAlloc.func1()\r\n\t\t\tC:/workdir/go/src/runtime/mgcmark.go:248 +0x12a\r\n\t\truntime.systemstack(0x39fc60)\r\n\t\t\tC:/workdir/go/src/runtime/asm_amd64.s:278 +0xb5\r\n\t\truntime.gcAssistAlloc(0x400, 0x401)\r\n\t\t\tC:/workdir/go/src/runtime/mgcmark.go:258 +0x16f\r\n\t\truntime.mallocgc(0x400, 0x63c5a0, 0xc000000000, 0x220000)\r\n\t\t\tC:/workdir/go/src/runtime/malloc.go:694 +0x560\r\n\t\truntime.newobject(0x63c5a0, 0x0)\r\n\t\t\tC:/workdir/go/src/runtime/malloc.go:725 +0x50\r\n\t\truntime.allocm(0xc082014000, 0x6bb290, 0x4138a6)\r\n\t\t\tC:/workdir/go/src/runtime/proc1.go:777 +0x7d\r\n\t\truntime.newm(0x6bb290, 0xc082014000)\r\n\t\t\tC:/workdir/go/src/runtime/proc1.go:995 +0x39\r\n\t\truntime.startm(0xc082014000, 0x100000001)\r\n\t\t\tC:/workdir/go/src/runtime/proc1.go:1088 +0x195\r\n\t\truntime.handoffp(0xc082014000)\r\n\t\t\tC:/workdir/go/src/runtime/proc1.go:1126 +0x126\r\n\t\truntime.retake(0x55bd86dfcc, 0x0)\r\n\t\t\tC:/workdir/go/src/runtime/proc1.go:3016 +0x1ea\r\n\t\truntime.sysmon()\r\n\t\t\tC:/workdir/go/src/runtime/proc1.go:2939 +0x209\r\n\t\truntime.mstart1()\r\n\t\t\tC:/workdir/go/src/runtime/proc1.go:735 +0x100\r\n\t\truntime.mstart()\r\n\t\t\tC:/workdir/go/src/runtime/proc1.go:705 +0x79\r\n",
	"user": {
		"login": "aclements",
		"id": 2688315,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2015-04-25T01:55:41Z",
	"updated_at": "2015-04-25T01:55:41Z"
}
