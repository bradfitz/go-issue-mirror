{
	"id": 162365182,
	"number": 16190,
	"state": "closed",
	"title": "go1.6 File method WriteStringfrequent calls led to a large system cache",
	"body": "go env\r\n```\r\nGOARCH=\"amd64\"\r\nGOBIN=\"\"\r\nGOEXE=\"\"\r\nGOHOSTARCH=\"amd64\"\r\nGOHOSTOS=\"linux\"\r\nGOOS=\"linux\"\r\nGOPATH=\"\"\r\nGORACE=\"\"\r\nGOROOT=\"/usr/local/go\"\r\nGOTOOLDIR=\"/usr/local/go/pkg/tool/linux_amd64\"\r\nGO15VENDOREXPERIMENT=\"1\"\r\nCC=\"gcc\"\r\nGOGCCFLAGS=\"-fPIC -m64 -pthread -fmessage-length=0\"\r\nCXX=\"g++\"\r\nCGO_ENABLED=\"1\"\r\n```\r\n\r\n\r\n\r\ngo code\r\n```go\r\npackage main\r\n\r\nimport (\r\n    \"fmt\"\r\n    \"net/http\"\r\n    \"os\"\r\n    \"time\"\r\n)\r\n\r\nvar logCtxCh chan *http.Request\r\nvar accessLogFile *os.File\r\n\r\ntype HandlerHttp struct{}\r\n\r\nfunc (this *HandlerHttp) ServeHTTP(w http.ResponseWriter, req *http.Request) {\r\n    sendAccessLog(req) \r\n    w.Write([]byte(\"Hello Word\"))\r\n}\r\n\r\nfunc main() {\r\n    s := \u0026http.Server{\r\n        Addr:    \":8012\",\r\n        Handler: \u0026HandlerHttp{},\r\n    }\r\n    logCtxCh = make(chan *http.Request, 500)\r\n    go startAcessLog()\r\n\r\n   err:= s.ListenAndServe()\r\n   fmt.Println(err.Error())\r\n}\r\n\r\nfunc startAcessLog() {\r\n    for {\r\n        select {\r\n        case ctx := \u003c-logCtxCh:\r\n            handleAccessLog(ctx)\r\n        }\r\n    }\r\n}\r\n\r\nfunc sendAccessLog(req *http.Request) {\r\n    logCtxCh \u003c- req\r\n}\r\n\r\nfunc handleAccessLog(req *http.Request) {\r\n    uri := req.RequestURI\r\n    ip := req.RemoteAddr\r\n    agent := req.UserAgent()\r\n    refer := req.Referer()\r\n    method := req.Method\r\n    now := time.Now().Format(\"2006-01-02 15:04:05\")\r\n\r\n    logText := fmt.Sprintf(\"%s %s %s %s %s %s\\n\",\r\n        now,\r\n        ip,\r\n        method,\r\n        uri,\r\n        agent,\r\n        refer,\r\n    )\r\n\r\n    fileName := fmt.Sprintf(\"/data/logs/zyapi/access_zyapi%s.log\",\r\n        time.Now().Format(\"2006010215\"),\r\n    )\r\n    writeLog(fileName, logText)\r\n}\r\n\r\nfunc writeLog(fileName, logText string) {\r\n    var err error\r\n    var exist = true\r\n\r\n    if _, err = os.Stat(fileName); os.IsNotExist(err) {\r\n        exist = false\r\n    }\r\n\r\n    if exist == false {\r\n        if accessLogFile != nil {\r\n            accessLogFile.Sync()\r\n            accessLogFile.Close()\r\n        }\r\n\r\n        accessLogFile, err = os.OpenFile(fileName, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, 0644)\r\n        if err == nil {\r\n            _, err = accessLogFile.WriteString(logText)\r\n        }\r\n        if err != nil {\r\n            fmt.Errorf(err.Error())\r\n        }\r\n    } else {\r\n        if accessLogFile == nil {\r\n            accessLogFile, err = os.OpenFile(fileName, os.O_WRONLY|os.O_APPEND, 0666)\r\n            if err != nil {\r\n                fmt.Errorf(err.Error())\r\n                return\r\n            }\r\n        }\r\n        _, err = accessLogFile.WriteString(logText)\r\n        if err != nil {\r\n            fmt.Errorf(err.Error())\r\n        }\r\n    }\r\n}\r\n```\r\nReproduction:\r\n```\r\nab -n100000 -c10 -k \"http://127.0.0.1:8012/\"\r\nab -n100000 -c10 -k \"http://127.0.0.1:8012/\"\r\nab -n100000 -c10 -k \"http://127.0.0.1:8012/\"\r\nab -n100000 -c10 -k \"http://127.0.0.1:8012/\"\r\nab -n100000 -c10 -k \"http://127.0.0.1:8012/\"\r\n```\r\nAfter running several times the system file cache becomes very large\r\n```\r\nCONTAINER    CPU %        MEM USAGE / LIMIT     MEM %         NET I/O             BLOCK I/O\r\nzyapi_8011    38.47%        6.442 GB / 6.442 GB   100.00%         0 B / 0 B           0 B / 115.4 MB\r\nzyapi_8012    36.90%        6.442 GB / 6.442 GB   99.99%           0 B / 0 B           0 B / 115.6 MB\r\n```\r\n\r\n\r\n",
	"user": {
		"login": "JoseFeng",
		"id": 4816994,
		"type": "User",
		"site_admin": false
	},
	"comments": 3,
	"closed_at": "2016-06-27T07:11:41Z",
	"created_at": "2016-06-27T02:51:50Z",
	"updated_at": "2016-06-27T07:11:41Z"
}
