{
	"id": 140135445,
	"number": 14771,
	"state": "closed",
	"title": "Crash with method call removal optimization",
	"body": "Please answer these questions before submitting your issue. Thanks!\r\n\r\n1. What version of Go are you using (`go version`)?\r\ngo version devel +53900ce Thu Mar 10 17:46:46 2016 +0000 darwin/amd64\r\n\r\n2. What operating system and processor architecture are you using (`go env`)?\r\ndarwin/amd64\r\n\r\n3. What did you do?\r\nAfter compiling an existing codebase (https://github.com/rasky/ndsemu) with latest go tip, I get a crash on a method value call, probably related to the recent optimization that removes method calls\r\n\r\n4. What did you expect to see?\r\nThe program should start\r\n\r\n5. What did you see instead?\r\n```\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal 0xb code=0x1 addr=0x0 pc=0x0]\r\n\r\ngoroutine 1 [running, locked to thread]:\r\npanic(0x4283ea0, 0xc8200100f0)\r\n\t/Users/rasky/Sources/gosrc/src/runtime/panic.go:500 +0x189\r\nreflect.callMethod(0xc8200ab290, 0xc82004f768)\r\n\t/Users/rasky/Sources/gosrc/src/reflect/value.go:630 +0x1ad\r\nreflect.methodValueCall(0x0, 0x4087541, 0xc8200a6228, 0xffffff0000000000, 0x0, 0x40230aa, 0x445f508, 0x4d81ee0, 0x0, 0x0, ...)\r\n\t/Users/rasky/Sources/gosrc/src/reflect/asm_amd64.s:29 +0x36\r\nndsemu/emu/hwio.(*Reg32).write(0xc8200a6228, 0xffffff0000000000)\r\n\t/Users/rasky/Sources/go/src/ndsemu/emu/hwio/reg.go:172 +0x55\r\nndsemu/emu/hwio.(*Reg32).Write8(0xc8200a6228, 0x4000208)\r\n\t/Users/rasky/Sources/go/src/ndsemu/emu/hwio/reg.go:236 +0x2f1\r\nndsemu/emu/hwio.(*Table).Write8(0xc8205af500, 0x4000208)\r\n\t/Users/rasky/Sources/go/src/ndsemu/emu/hwio/table.go:278 +0x453\r\nndsemu/arm.(*Cpu).opWrite8(0xc8205b6480, 0x4000208)\r\n\t/Users/rasky/Sources/go/src/ndsemu/arm/mem.go:172 +0x154\r\nndsemu/arm.(*Cpu).opArm5C0(0xc8205b6480, 0xe5c44208)\r\n\t/Users/rasky/Sources/go/src/ndsemu/arm/ops_arm_table.go:14126 +0x79\r\nndsemu/arm.(*Cpu).Run(0xc8205b6480, 0x648)\r\n\t/Users/rasky/Sources/go/src/ndsemu/arm/ops.go:248 +0x346\r\nmain.(*NDS7).Run(0xc8205c6000, 0x648)\r\n\t/Users/rasky/Sources/go/src/ndsemu/nds7.go:105 +0x2e\r\nndsemu/emu.syncSubsystem.Run(0x4d81c00, 0xc8205c6000, 0x100, 0x42e878b, 0x4, 0x648)\r\n\t/Users/rasky/Sources/go/src/ndsemu/emu/sync.go:85 +0x5b\r\nndsemu/emu.(*Sync).RunUntil(0xc8205c2780, 0x648)\r\n\t/Users/rasky/Sources/go/src/ndsemu/emu/sync.go:383 +0x17c\r\nndsemu/emu.(*Sync).RunOneFrame(0xc8205c2780)\r\n\t/Users/rasky/Sources/go/src/ndsemu/emu/sync.go:342 +0xad\r\nmain.(*NDSEmulator).RunOneFrame(0xc82009c1e0, 0xc820960000, 0x100, 0x1da, 0x400)\r\n\t/Users/rasky/Sources/go/src/ndsemu/emulator.go:262 +0x1dd\r\nmain.main()\r\n\t/Users/rasky/Sources/go/src/ndsemu/ndsemu.go:250 +0x8f6\r\n```\r\n\r\nI think the culprit is in `emu/hwio/table.go`, around line 232:\r\n\r\n```\r\n\t\t\tif meth := val.Addr().MethodByName(rcb); !meth.IsValid() {\r\n\t\t\t\treturn fmt.Errorf(\"cannot find method: %q\", rcb)\r\n\t\t\t} else {\r\n\t\t\t\tvalueField.FieldByName(\"ReadCb\").Set(meth)\r\n\t\t\t}\r\n```\r\n\r\nwhere valueField comes from a structure like:\r\n\r\n```\r\ntype Reg32 struct {\r\n\tName   string\r\n\tValue  uint32\r\n\tRoMask uint32\r\n\r\n\tFlags   RegFlags\r\n\tReadCb  func(val uint32) uint32\r\n\tWriteCb func(old uint32, val uint32)\r\n}\r\n```\r\n\r\nIt looks like the method is now removed from the code generation.\r\n",
	"user": {
		"login": "rasky",
		"id": 1014109,
		"type": "User",
		"site_admin": false
	},
	"comments": 3,
	"closed_at": "2016-03-11T10:57:39Z",
	"created_at": "2016-03-11T09:32:01Z",
	"updated_at": "2016-03-11T10:58:15Z"
}
