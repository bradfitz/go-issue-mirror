{
	"id": 77829810,
	"number": 10903,
	"state": "closed",
	"title": "x/mobile/app: race condition between initSeq and user code",
	"body": "app.run(...) in app/android.go closes mainCalled to signal callMain that it can return to call_main_and_wait, which returns to Go.run(), which finally returns from go.Go.init(), letting user code continue. If user code calls anything touching the seq machinery after the closing of mainCalled but before app.stateStart calls java.Init, a crash will happen. One such crash trace is copied in the end of this report.\r\n\r\nIt suffices to insert a time.Sleep(2*time.Second) just after the close(mainCalled) in app/android.go to allow calls from java into Go and thereby reproduce the bug:\r\n\r\n```\r\n// notifyInitDone informs Java that the program is initialized.\r\n// A NativeActivity will not create a window until this is called.\r\nfunc run(callbacks []Callbacks) {\r\n    // We want to keep the event loop on a consistent OS thread.\r\n    runtime.LockOSThread()\r\n\r\n    ctag := C.CString(\"Go\")\r\n    cstr := C.CString(\"app.Run\")\r\n    C.__android_log_write(C.ANDROID_LOG_INFO, ctag, cstr)\r\n    C.free(unsafe.Pointer(ctag))\r\n    C.free(unsafe.Pointer(cstr))\r\n\r\n    close(mainCalled)\r\n    time.Sleep(2 * time.Second) \u003c\u003c\u003c\u003c\u003c\u003c\u003c insert sleep here\r\n    if C.current_native_activity == nil {\r\n        stateStart(callbacks)\r\n        // TODO: stateStop under some conditions.\r\n        select {}\r\n    } else {\r\n        for w := range windowCreated {\r\n            windowDraw(callbacks, w, queue)\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nI have yet to find a satisfactory fix; simply moving the close(mainCalled) just after the stateStart() call results in a panic:\r\n\r\n```\r\nE/Go      (20546): panic: app.GetConfig is not available before app.Run is called\r\nE/Go      (20546): goroutine 7 [running, locked to thread]:\r\nE/Go      (20546): golang.org/x/mobile/app.GetConfig(0x0, 0x0)\r\nE/Go      (20546): \t/home/elias/dev/go/src/golang.org/x/mobile/app/app.go:111 +0x108\r\nE/Go      (20546): golang.org/x/mobile/bind/java.initSeq()\r\nE/Go      (20546): \t/home/elias/dev/go/src/golang.org/x/mobile/bind/java/seq_android.go:82 +0x1c\r\nE/Go      (20546): golang.org/x/mobile/bind/java.Init()\r\nE/Go      (20546): \t/home/elias/dev/go/src/golang.org/x/mobile/bind/java/doc.go:15 +0x1c\r\nE/Go      (20546): golang.org/x/mobile/app.stateStart(0x93adc320, 0x1, 0x1)\r\nE/Go      (20546): \t/home/elias/dev/go/src/golang.org/x/mobile/app/state.go:63 +0xe4\r\nE/Go      (20546): golang.org/x/mobile/app.run(0x93adc320, 0x1, 0x1)\r\nE/Go      (20546): \t/home/elias/dev/go/src/golang.org/x/mobile/app/android.go:272 +0x114\r\nE/Go      (20546): golang.org/x/mobile/app.Run(0xaf38ecf4, 0x0, 0x0, 0x0, 0x0)\r\nE/Go      (20546): \t/home/elias/dev/go/src/golang.org/x/mobile/app/app.go:26 +0xe4\r\nE/Go      (20546): main.main()\r\nE/Go      (20546): \t/tmp/gomobile-bind-work-212601191/androidlib/main.go:12 +0x58\r\nE/Go      (20546): golang.org/x/mobile/app/internal/callfn.CallFn(0xaf263428)\r\nE/Go      (20546): \t/home/elias/dev/go/src/golang.org/x/mobile/app/internal/callfn/callfn_arm.s:10 +0x20\r\nE/Go      (20546): created by golang.org/x/mobile/app.callMain\r\nE/Go      (20546): \t/home/elias/dev/go/src/golang.org/x/mobile/app/android.go:79 +0x16c\r\nE/Go      (20546): goroutine 17 [chan receive, locked to thread]:\r\nE/Go      (20546): golang.org/x/mobile/app.callMain(0xaf263428)\r\nE/Go      (20546): \t/home/elias/dev/go/src/golang.org/x/mobile/app/android.go:80 +0x18c\r\n...\r\n```\r\n\r\nCrash trace:\r\n```\r\nF/art     (21085): art/runtime/check_jni.cc:65] JNI DETECTED ERROR IN APPLICATION: jfieldID was NULL\r\nF/art     (21085): art/runtime/check_jni.cc:65]     in call to GetLongField\r\nF/art     (21085): art/runtime/check_jni.cc:65]     from void go.Seq.ensure(int)\r\nF/art     (21085): art/runtime/check_jni.cc:65] \"GoReceive\" prio=5 tid=14 Runnable\r\nF/art     (21085): art/runtime/check_jni.cc:65]   | group=\"main\" sCount=0 dsCount=0 obj=0x12c07e20 self=0xb4a35c00\r\nF/art     (21085): art/runtime/check_jni.cc:65]   | sysTid=21121 nice=0 cgrp=default sched=0/0 handle=0xb491cb80\r\nF/art     (21085): art/runtime/check_jni.cc:65]   | state=R schedstat=( 1233439 33281 6 ) utm=0 stm=0 core=2 HZ=100\r\nF/art     (21085): art/runtime/check_jni.cc:65]   | stack=0x835a6000-0x835a8000 stackSize=1036KB\r\nF/art     (21085): art/runtime/check_jni.cc:65]   | held mutexes= \"mutator lock\"(shared held)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   native: #00 pc 00004e64  /system/lib/libbacktrace_libc++.so (UnwindCurrent::Unwind(unsigned int, ucontext*)+23)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   native: #01 pc 00003665  /system/lib/libbacktrace_libc++.so (Backtrace::Unwind(unsigned int, ucontext*)+8)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   native: #02 pc 00256429  /system/lib/libart.so (art::DumpNativeStack(std::__1::basic_ostream\u003cchar, std::__1::char_traits\u003cchar\u003e \u003e\u0026, int, char const*, art::mirror::ArtMethod*)+84)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   native: #03 pc 00238fe7  /system/lib/libart.so (art::Thread::Dump(std::__1::basic_ostream\u003cchar, std::__1::char_traits\u003cchar\u003e \u003e\u0026) const+158)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   native: #04 pc 000b191b  /system/lib/libart.so (art::JniAbort(char const*, char const*)+610)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   native: #05 pc 000b2055  /system/lib/libart.so (art::JniAbortF(char const*, char const*, ...)+68)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   native: #06 pc 000b41c9  /system/lib/libart.so (art::ScopedCheck::CheckInstanceFieldID(_jobject*, _jfieldID*)+588)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   native: #07 pc 000b94ed  /system/lib/libart.so (art::CheckJNI::GetLongField(_JNIEnv*, _jobject*, _jfieldID*)+60)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   native: #08 pc 0006a7f0  /data/app/com.eliasnaur.goreentrant-2/lib/arm/libgojni.so (mem_get+52)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   at go.Seq.ensure(Native method)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   at go.Seq.\u003cinit\u003e(Seq.java:21)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   at go.Seq.receive(Seq.java:109)\r\nF/art     (21085): art/runtime/check_jni.cc:65]   at go.Go$1.run(Go.java:30)\r\n...\r\n```",
	"user": {
		"login": "eliasnaur",
		"id": 524812,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 1,
	"closed_at": "2015-05-28T18:39:22Z",
	"created_at": "2015-05-18T22:28:27Z",
	"updated_at": "2016-06-25T02:09:10Z"
}
