{
	"id": 51286388,
	"number": 7229,
	"state": "closed",
	"title": "cmd/gc: regalloc introduces spurious loads, breaking liveness analysis",
	"body": "\u003cpre\u003eCompile this code:\n\npackage main\n\ntype err1 error\ntype err2 error\n\nvar e interface{}\nvar f err2\n\nfunc foo() {\n\tswitch err := e.(type) {\n\tcase err1:\n\t\tpanic(e)\n\tcase err2:\n\t\tf = err\n\t}\n}\n\n6g -S issue7205a.go\n\n\u0026quot;\u0026quot;.foo t=1 size=256 value=0 args=0 locals=0x60\n\t000000 0000 (/Users/khr/go/issue7205a.go:9) TEXT    \u0026quot;\u0026quot;.foo+0(SB),$96-0\n\t000000 0000 (/Users/khr/go/issue7205a.go:9) MOVQ    2208(GS),CX\n\t0x0009 0000 (/Users/khr/go/issue7205a.go:9) CMPQ    SP,(CX)\n\t0x000c 0000 (/Users/khr/go/issue7205a.go:9) JHI     ,\u0026lt;nil\u0026gt;\n\t0x000e 0000 (/Users/khr/go/issue7205a.go:9) CALL    ,\u0026lt;nil\u0026gt;\n\t0x0013 0000 (/Users/khr/go/issue7205a.go:9) JMP     ,\u0026lt;nil\u0026gt;\n\t0x0015 0000 (/Users/khr/go/issue7205a.go:9) SUBQ    $96,SP\n\t0x0019 0001 (/Users/khr/go/issue7205a.go:9) FUNCDATA $2,\u0026quot;\u0026quot;.gcargs·0+0(SB)\n\t0x0019 0002 (/Users/khr/go/issue7205a.go:9) FUNCDATA $3,\u0026quot;\u0026quot;.gclocals·1+0(SB)\n\t0x0019 0010 (/Users/khr/go/issue7205a.go:10) MOVQ    \u0026quot;\u0026quot;.e+0(SB),CX\n\t0x0021 0011 (/Users/khr/go/issue7205a.go:10) MOVQ    \u0026quot;\u0026quot;.e+8(SB),AX\n\t0x0029 9999 (/Users/khr/go/issue7205a.go:10) MOVQ    CX,\u0026quot;\u0026quot;.autotmp_0000+80(SP)\n\t0x002e 0015 (/Users/khr/go/issue7205a.go:10) MOVQ    CX,(SP)\n\t0x0032 9999 (/Users/khr/go/issue7205a.go:10) MOVQ    AX,\u0026quot;\u0026quot;.autotmp_0000+88(SP)\n\t0x0037 0017 (/Users/khr/go/issue7205a.go:10) MOVQ    AX,8(SP)\n\t0x003c 0018 (/Users/khr/go/issue7205a.go:10) PCDATA  $0,$24\n\t0x003c 0085 (/Users/khr/go/issue7205a.go:10) PCDATA  $1,$1\n\t0x003c 0019 (/Users/khr/go/issue7205a.go:10) CALL    ,\u0026lt;nil\u0026gt;\n\t0x0041 0020 (/Users/khr/go/issue7205a.go:10) PCDATA  $0,$-1\n\t0x0041 0021 (/Users/khr/go/issue7205a.go:10) MOVL    16(SP),BX\n\t0x0045 0023 (/Users/khr/go/issue7205a.go:10) MOVQ    $type.\u0026quot;\u0026quot;.err1+0(SB),(SP)\n\t0x004d 0024 (/Users/khr/go/issue7205a.go:10) MOVQ    \u0026quot;\u0026quot;.autotmp_0000+80(SP),BX\n\t0x0052 0025 (/Users/khr/go/issue7205a.go:10) MOVQ    BX,8(SP)\n\t0x0057 0026 (/Users/khr/go/issue7205a.go:10) MOVQ    \u0026quot;\u0026quot;.autotmp_0000+88(SP),BX\n\t0x005c 0027 (/Users/khr/go/issue7205a.go:10) MOVQ    BX,16(SP)\n\t0x0061 0028 (/Users/khr/go/issue7205a.go:10) PCDATA  $0,$48\n\t0x0061 0084 (/Users/khr/go/issue7205a.go:10) PCDATA  $1,$2\n\t0x0061 0029 (/Users/khr/go/issue7205a.go:10) CALL    ,\u0026lt;nil\u0026gt;\n\t0x0066 9999 (/Users/khr/go/issue7205a.go:10) MOVQ    \u0026quot;\u0026quot;.err+64(SP),DX      ***** BUG *****\n\t0x006b 9999 (/Users/khr/go/issue7205a.go:10) MOVQ    \u0026quot;\u0026quot;.err+72(SP),CX      ***** BUG *****\n\t0x0070 0030 (/Users/khr/go/issue7205a.go:10) PCDATA  $0,$-1\n\t0x0070 0031 (/Users/khr/go/issue7205a.go:10) MOVQ    24(SP),BX\n\t0x0075 0032 (/Users/khr/go/issue7205a.go:10) MOVQ    BX,\u0026quot;\u0026quot;.err+48(SP)\n\t0x007a 0033 (/Users/khr/go/issue7205a.go:10) MOVQ    32(SP),BX\n\t0x007f 0034 (/Users/khr/go/issue7205a.go:10) MOVQ    BX,\u0026quot;\u0026quot;.err+56(SP)\n\t0x0084 0035 (/Users/khr/go/issue7205a.go:10) MOVBQZX 40(SP),BX\n\t0x008a 0039 (/Users/khr/go/issue7205a.go:10) CMPB    BL,$0\n\t0x008d 0040 (/Users/khr/go/issue7205a.go:10) JEQ     ,43\n\t0x008f 0064 (/Users/khr/go/issue7205a.go:12) MOVQ    \u0026quot;\u0026quot;.e+0(SB),BX\n\t0x0097 0065 (/Users/khr/go/issue7205a.go:12) MOVQ    BX,(SP)\n\t0x009b 0066 (/Users/khr/go/issue7205a.go:12) MOVQ    \u0026quot;\u0026quot;.e+8(SB),BX\n\t0x00a3 0067 (/Users/khr/go/issue7205a.go:12) MOVQ    BX,8(SP)\n\t0x00a8 0068 (/Users/khr/go/issue7205a.go:12) PCDATA  $0,$16\n\t0x00a8 0086 (/Users/khr/go/issue7205a.go:12) PCDATA  $1,$3\n\t0x00a8 0069 (/Users/khr/go/issue7205a.go:12) CALL    ,\u0026lt;nil\u0026gt;\n\t0x00ad 0070 (/Users/khr/go/issue7205a.go:12) UNDEF   ,\n\t0x00af 0043 (/Users/khr/go/issue7205a.go:10) MOVQ    $type.\u0026quot;\u0026quot;.err2+0(SB),(SP)\n\t0x00b7 0044 (/Users/khr/go/issue7205a.go:10) MOVQ    \u0026quot;\u0026quot;.autotmp_0000+80(SP),BX\n\t0x00bc 0045 (/Users/khr/go/issue7205a.go:10) MOVQ    BX,8(SP)\n\t0x00c1 0046 (/Users/khr/go/issue7205a.go:10) MOVQ    \u0026quot;\u0026quot;.autotmp_0000+88(SP),BX\n\t0x00c6 0047 (/Users/khr/go/issue7205a.go:10) MOVQ    BX,16(SP)\n\t0x00cb 0048 (/Users/khr/go/issue7205a.go:10) PCDATA  $0,$48\n\t0x00cb 0087 (/Users/khr/go/issue7205a.go:10) PCDATA  $1,$4\n\t0x00cb 0049 (/Users/khr/go/issue7205a.go:10) CALL    ,\u0026lt;nil\u0026gt;\n\t0x00d0 0050 (/Users/khr/go/issue7205a.go:10) PCDATA  $0,$-1\n\t0x00d0 0051 (/Users/khr/go/issue7205a.go:10) MOVQ    24(SP),DX\n\t0x00d5 0052 (/Users/khr/go/issue7205a.go:10) MOVQ    32(SP),CX\n\t0x00da 0055 (/Users/khr/go/issue7205a.go:10) MOVBQZX 40(SP),BX\n\t0x00e0 0059 (/Users/khr/go/issue7205a.go:10) CMPB    BL,$0\n\t0x00e3 0060 (/Users/khr/go/issue7205a.go:10) JEQ     ,79\n\t0x00e5 0074 (/Users/khr/go/issue7205a.go:14) MOVQ    DX,\u0026quot;\u0026quot;.f+0(SB)\n\t0x00ed 0076 (/Users/khr/go/issue7205a.go:14) MOVQ    CX,\u0026quot;\u0026quot;.f+8(SB)\n\t0x00f5 0079 (/Users/khr/go/issue7205a.go:16) ADDQ    $96,SP\n\t0x00f9 0000 (/Users/khr/go/issue7205a.go:16) RET     ,\n\trel 15+4 t=247 runtime.morestack00+0\n\trel 29+4 t=120 \u0026quot;\u0026quot;.e+0\n\trel 37+4 t=120 \u0026quot;\u0026quot;.e+8\n\trel 61+4 t=247 runtime.efacethash+0\n\trel 73+4 t=120 type.\u0026quot;\u0026quot;.err1+0\n\trel 98+4 t=247 runtime.assertE2I2+0\n\trel 147+4 t=120 \u0026quot;\u0026quot;.e+0\n\trel 159+4 t=120 \u0026quot;\u0026quot;.e+8\n\trel 169+4 t=247 runtime.panic+0\n\trel 179+4 t=120 type.\u0026quot;\u0026quot;.err2+0\n\trel 204+4 t=247 runtime.assertE2I2+0\n\trel 233+4 t=120 \u0026quot;\u0026quot;.f+0\n\trel 241+4 t=120 \u0026quot;\u0026quot;.f+8\n\nThere are two spurious loads of \u0026quot;\u0026quot;.err.  At the point of the loads,\n\u0026quot;\u0026quot;.err is undefined, and the results of the load are unused.  So the code\nstill runs correctly, but the spurious load messes up the liveness analysis.\n\nThe spurious loads are introduced in the register allocator:\n\n6g -R -v issue7205a.go\n\n...\nregisterize err+8 (bit=43 et=PTR64) in CX\n0029 (/Users/khr/go/issue7205a.go:10) CALL    ,runtime.assertE2I2+0(SB) ===add=== 9999\n(/Users/khr/go/issue7205a.go:10) MOVQ    \u0026quot;\u0026quot;.err+8(SP),CX\n0054 (/Users/khr/go/issue7205a.go:10) MOVQ    BX,\u0026quot;\u0026quot;.err+8(SP) ===change== 0054\n(/Users/khr/go/issue7205a.go:10) MOVQ    BX,CX\n0075 (/Users/khr/go/issue7205a.go:14) MOVQ    \u0026quot;\u0026quot;.err+8(SP),BX ===change== 0075\n(/Users/khr/go/issue7205a.go:14) MOVQ    CX,BX\nregisterize err+0 (bit=42 et=PTR64) in DX\n0029 (/Users/khr/go/issue7205a.go:10) CALL    ,runtime.assertE2I2+0(SB) ===add=== 9999\n(/Users/khr/go/issue7205a.go:10) MOVQ    \u0026quot;\u0026quot;.err+0(SP),DX\n0073 (/Users/khr/go/issue7205a.go:14) MOVQ    \u0026quot;\u0026quot;.err+0(SP),BX ===change== 0073\n(/Users/khr/go/issue7205a.go:14) MOVQ    DX,BX\n0052 (/Users/khr/go/issue7205a.go:10) MOVQ    BX,\u0026quot;\u0026quot;.err+0(SP) ===change== 0052\n(/Users/khr/go/issue7205a.go:10) MOVQ    BX,DX\n...\n\nNote the ===add=== lines, which introduce the offending loads.\u003c/pre\u003e",
	"user": {
		"login": "randall77",
		"id": 6889504,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 8,
	"closed_at": "2014-12-08T10:40:12Z",
	"created_at": "2014-01-28T17:23:22Z",
	"updated_at": "2016-06-25T01:26:33Z",
	"milestone": {
		"id": 1067211,
		"number": 17,
		"title": "Go1.3"
	}
}
