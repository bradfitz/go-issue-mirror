{
	"id": 221195841,
	"body": "I can provide program now.\r\n\r\nThe client code\r\n\r\n```\r\npackage main\r\n\r\nimport (\r\n        \"bytes\"\r\n        \"encoding/json\"\r\n        \"fmt\"\r\n        \"net/http\"\r\n)\r\n\r\nfunc main() {\r\n        for {\r\n                req()\r\n        }\r\n}\r\n\r\nfunc ret() string {\r\n        s := \"k\"\r\n        for i := 0; i \u003c 12; i++ {\r\n                s = s + s\r\n        }\r\n        return s\r\n}\r\n\r\nfunc req() {\r\n        fmt.Println(\"start req\")\r\n        val := struct {\r\n                Data string `json:\"data\"`\r\n        }{Data: ret()}\r\n        data, _ := json.Marshal(val)\r\n        r, err := http.Post(\"http://127.0.0.1:9989\", \"application/json\", bytes.NewBuffer(data))\r\n        if err != nil {\r\n                fmt.Println(err)\r\n        } else {\r\n                fmt.Println(\"Status Code: \", r.Status)\r\n        }\r\n        r.Body.Close()\r\n}\r\n```\r\n\r\nThe server code \r\n\r\n```\r\npackage main\r\n\r\nimport (\r\n        \"compress/gzip\"\r\n        \"encoding/json\"\r\n        \"io\"\r\n        \"io/ioutil\"\r\n        \"net/http\"\r\n)\r\n\r\nfunc main() {\r\n        mux := http.NewServeMux()\r\n        mux.HandleFunc(\"/\", HelloHandler)\r\n        server := \u0026http.Server{Addr: \":8998\", Handler: mux}\r\n        server.ListenAndServe()\r\n}\r\n\r\nfunc HelloHandler(w http.ResponseWriter, r *http.Request) {\r\n        reader, err := gzip.NewReader(r.Body) // I make this mistake Purposely.\r\n        if err == nil {\r\n                io.Copy(ioutil.Discard, reader)\r\n        }\r\n        w.Header().Set(\"Content-Type\", \"application/json\")\r\n        w.WriteHeader(http.StatusOK)\r\n        val := struct {\r\n                Message string `json:\"message\"`\r\n        }{\r\n                Message: \"Hello World!\",\r\n        }\r\n        body, _ := json.Marshal(val)\r\n        w.Write(body)\r\n}\r\n```\r\n\r\nThe nginx config\r\n\r\n```\r\nworker_processes  1;\r\n\r\nevents {\r\n    worker_connections  111024;\r\n}\r\n\r\nhttp {\r\n    include       mime.types;\r\n    default_type  application/octet-stream;\r\n    sendfile        on;\r\n\r\n    upstream myapp {\r\n        server 127.0.0.1:8998;\r\n    }\r\n\r\n    server {\r\n        listen       9989;\r\n        server_name  localhost;\r\n\r\n        location / {\r\n            proxy_pass http://myapp;\r\n        }\r\n\r\n        error_page   500 502 503 504  /50x.html;\r\n        location = /50x.html {\r\n            root   html;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nThe nginx error log \r\n\r\n```\r\n2016/05/24 15:50:53 [error] 53509#0: *394941 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\r\n2016/05/24 15:50:53 [error] 53509#0: *394955 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\r\n2016/05/24 15:50:53 [error] 53509#0: *395009 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\r\n2016/05/24 15:50:53 [error] 53509#0: *395029 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\r\n2016/05/24 15:50:53 [error] 53509#0: *395049 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\r\n2016/05/24 15:50:53 [error] 53509#0: *395069 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\r\n2016/05/24 15:50:53 [error] 53509#0: *395077 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\r\n2016/05/24 15:50:53 [error] 53509#0: *395129 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\r\n2016/05/24 15:50:53 [error] 53509#0: *395169 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\r\n2016/05/24 15:50:53 [error] 53509#0: *395319 readv() failed (104: Connection reset by peer) while reading upstream, client: 127.0.0.1, server: localhost, request: \"POST / HTTP/1.1\", upstream: \"http://127.0.0.1:8998/\", host: \"127.0.0.1:9989\"\r\n```\r\n\r\nwhen I build server code with go1.3.3 version, there is no \"reset by peer\" error in nginx error log,\r\nbut I build server code with go1.6.2 version, the \"reset by peer\" error appear in nginx error log.\r\n\r\nIn the server code, I use gzip reader to read body,  I know this will return error, I just want to make this case.\r\n\r\n\u003e nginx version is 1.9.15\r\n\r\n@ianlancetaylor ",
	"user": {
		"login": "cloudaice",
		"id": 747028,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2016-05-24T08:06:54Z",
	"updated_at": "2016-05-24T08:09:13Z"
}
