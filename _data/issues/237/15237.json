{
	"id": 147548954,
	"number": 15237,
	"state": "closed",
	"title": "net: zoneToIndex will not cache the RIB and is called on each IPv6-linklocal datagram read",
	"body": "\r\n\r\nPlease answer these questions before submitting your issue. Thanks!\r\n\r\n1. What version of Go are you using (`go version`)?\r\ngo version go1.6 linux/amd64\r\n\r\n2. What operating system and processor architecture are you using (`go env`)?\r\nGOARCH=\"amd64\"\r\nGOBIN=\"\"\r\nGOEXE=\"\"\r\nGOHOSTARCH=\"amd64\"\r\nGOHOSTOS=\"linux\"\r\nGOOS=\"linux\"\r\nGOPATH=\"/home/magnus/Projects/go\"\r\nGORACE=\"\"\r\nGOROOT=\"/opt/go\"\r\nGOTOOLDIR=\"/opt/go/pkg/tool/linux_amd64\"\r\nGO15VENDOREXPERIMENT=\"1\"\r\nCC=\"gcc\"\r\nGOGCCFLAGS=\"-fPIC -m64 -pthread -fmessage-length=0\"\r\nCXX=\"g++\"\r\nCGO_ENABLED=\"1\"\r\n\r\n\r\n3. What did you do?\r\nIf possible, provide a recipe for reproducing the error.\r\nA complete runnable program is good.\r\nA link on play.golang.org is best.\r\n\r\nThis is a performance issue rather than an error. When ReadFromUDP returns with an IPv6\r\naddress of the peer it will map the Zone field using zoneToString. This will call syscall.NetlinkRIB\r\nto get the interfaces of the host. This information is not cached and syscall.NetlinkRIB will be called\r\nfor every received packet.\r\n\r\nTo see the problem the following code can be run with strace -f on linux:\r\n\r\n------------------------------------------------------------------------\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"net\"\r\n\t\"fmt\"\r\n)\r\n\r\nvar myhost=\"fe80::461e:a1ff:fece:f4a9\"\r\n\r\nfunc transmitter(port int) {\r\n\tb := make([]byte,1200)\r\n\t\r\n\traddr, err := net.ResolveUDPAddr(\"udp6\", fmt.Sprintf(\"[%s]:%d\",myhost, port))\r\n\tif err!=nil {\r\n\t\tpanic(err)\r\n\t}\r\n\r\n\tconn, err := net.ListenUDP(\"udp6\", nil)\r\n\tif err!=nil {\r\n\t\tpanic(err)\r\n\t}\r\n\tfor ii:=2; ii\u003e0; ii-- {\r\n\t\t_, err := conn.WriteToUDP(b,raddr)\r\n\t\tif err!=nil {\r\n\t\t\tpanic(err)\r\n\t\t}\r\n\t}\r\n\r\n\t\r\n}\r\n\r\n\r\nfunc receiver() (int, chan bool) {\r\n\tladdr,err := net.ResolveUDPAddr(\"udp6\", \":0\")\r\n\tif err!=nil {\r\n\t\tpanic(err)\r\n\t}\r\n\r\n\tconn, err := net.ListenUDP(\"udp6\", laddr)\r\n\tif err!=nil {\r\n\t\tpanic(err)\r\n\t}\r\n\r\n\tdc := make(chan bool)\r\n\r\n\tgo func() {\r\n\t\tb := make([]byte,1200)\r\n\t\tfor ii:=2; ii\u003e0; ii-- {\r\n\t\t\tfmt.Println( \"                       PRE ReadFromUDP\" )\r\n\t\t\t_, addr, err := conn.ReadFromUDP(b)\r\n\t\t\tfmt.Println( \"                       POST ReadFromUDP, addr=\", addr.Zone )\r\n\t\t\tif err!=nil {\r\n\t\t\t\tpanic(err)\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\tdc \u003c- true\r\n\t}()\r\n\treturn conn.LocalAddr().(*net.UDPAddr).Port, dc\r\n\r\n}\r\n\r\nfunc main() {\r\n\tport, dc := receiver()\r\n\r\n       transmitter(port)\r\n\r\n\t\u003c- dc\r\n}\r\n\r\n```-------------------------------------------------------------------------------------\r\n\r\n4. What did you expect to see?\r\n\r\nRunning the testcode with strace in linux I get\r\n\t.\r\n\t.\r\n\t. \r\n7[pid 23098] write(1, \"                       PRE ReadF\"..., 39                       PRE ReadFromUDP\r\n \u003cunfinished ...\u003e\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] \u003c... write resumed\u003e )       = 39\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] recvfrom(3, \"\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\"..., 1200, 0, {sa_family=AF_INET6, sin6_port=htons(50115), inet_pton(AF_INET6, \"fe80::461e:a1ff:fece:f4a9\", \u0026sin6_addr), sin6_flowinfo=0, sin6_scope_id=if_nametoindex(\"eth0\")}, [28]) = 1200\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] write(1, \"interfaceTable ifindex= 2\\n\", 26interfaceTable ifindex= 2\r\n) = 26\r\n[pid 23098] socket(PF_NETLINK, SOCK_RAW, 0) = 6\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] bind(6, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12 \u003cunfinished ...\u003e\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] \u003c... bind resumed\u003e )        = 0\r\n[pid 23098] sendto(6, \"\\21\\0\\0\\0\\22\\0\\1\\3\\1\\0\\0\\0\\0\\0\\0\\0\\0\", 17, 0, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12 \u003cunfinished ...\u003e\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] \u003c... sendto resumed\u003e )      = 17\r\n[pid 23098] recvfrom(6,  \u003cunfinished ...\u003e\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] \u003c... recvfrom resumed\u003e \"|\\4\\0\\0\\20\\0\\2\\0\\1\\0\\0\\0:Z\\0\\0\\0\\0\\4\\3\\1\\0\\0\\0I\\0\\1\\0\\0\\0\\0\\0\"..., 4096, 0, {sa_family=AF_NETLINK, pid=0, groups=00000000}, [12]) = 3452\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] getsockname(6, {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n[pid 23098] getsockname(6, {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] getsockname(6,  \u003cunfinished ...\u003e\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] \u003c... getsockname resumed\u003e {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n[pid 23098] recvfrom(6, \"\\24\\0\\0\\0\\3\\0\\2\\0\\1\\0\\0\\0:Z\\0\\0\\0\\0\\0\\0\", 4096, 0, {sa_family=AF_NETLINK, pid=0, groups=00000000}, [12]) = 20\r\n[pid 23098] getsockname(6,  \u003cunfinished ...\u003e\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] \u003c... getsockname resumed\u003e {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] write(1, \"ReadMsgUDP:IPv6: addr [fe80::461\"..., 73 \u003cunfinished ...\u003e\r\nReadMsgUDP:IPv6: addr [fe80::461e:a1ff:fece:f4a9%eth0]:50115 , zoneid= 2\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] \u003c... write resumed\u003e )       = 73\r\n[pid 23098] write(1, \"                       POST Read\"..., 52                       POST ReadFromUDP, addr= eth0\r\n) = 52\r\n[pid 23098] write(1, \"                       PRE ReadF\"..., 39 \u003cunfinished ...\u003e\r\n                       PRE ReadFromUDP\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] \u003c... write resumed\u003e )       = 39\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] recvfrom(3, \"\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\"..., 1200, 0, {sa_family=AF_INET6, sin6_port=htons(50115), inet_pton(AF_INET6, \"fe80::461e:a1ff:fece:f4a9\", \u0026sin6_addr), sin6_flowinfo=0, sin6_scope_id=if_nametoindex(\"eth0\")}, [28]) = 1200\r\n[pid 23098] write(1, \"interfaceTable ifindex= 2\\n\", 26 \u003cunfinished ...\u003e\r\ninterfaceTable ifindex= 2\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] \u003c... write resumed\u003e )       = 26\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] write(1, \"ReadMsgUDP:IPv6: addr [fe80::461\"..., 73ReadMsgUDP:IPv6: addr [fe80::461e:a1ff:fece:f4a9%eth0]:50115 , zoneid= 2\r\n) = 73\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] write(1, \"                       POST Read\"..., 52                       POST ReadFromUDP, addr= eth0\r\n\r\n\r\n5. What did you see instead?\r\n\r\n\r\nRunning the testcode with strace in linux I get\r\n\t.\r\n\t.\r\n\t. \r\n7[pid 23098] write(1, \"                       PRE ReadF\"..., 39                       PRE ReadFromUDP\r\n \u003cunfinished ...\u003e\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] \u003c... write resumed\u003e )       = 39\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] recvfrom(3, \"\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\"..., 1200, 0, {sa_family=AF_INET6, sin6_port=htons(50115), inet_pton(AF_INET6, \"fe80::461e:a1ff:fece:f4a9\", \u0026sin6_addr), sin6_flowinfo=0, sin6_scope_id=if_nametoindex(\"eth0\")}, [28]) = 1200\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] write(1, \"interfaceTable ifindex= 2\\n\", 26interfaceTable ifindex= 2\r\n) = 26\r\n[pid 23098] socket(PF_NETLINK, SOCK_RAW, 0) = 6\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] bind(6, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12 \u003cunfinished ...\u003e\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] \u003c... bind resumed\u003e )        = 0\r\n[pid 23098] sendto(6, \"\\21\\0\\0\\0\\22\\0\\1\\3\\1\\0\\0\\0\\0\\0\\0\\0\\0\", 17, 0, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12 \u003cunfinished ...\u003e\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] \u003c... sendto resumed\u003e )      = 17\r\n[pid 23098] recvfrom(6,  \u003cunfinished ...\u003e\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] \u003c... recvfrom resumed\u003e \"|\\4\\0\\0\\20\\0\\2\\0\\1\\0\\0\\0:Z\\0\\0\\0\\0\\4\\3\\1\\0\\0\\0I\\0\\1\\0\\0\\0\\0\\0\"..., 4096, 0, {sa_family=AF_NETLINK, pid=0, groups=00000000}, [12]) = 3452\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] getsockname(6, {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n[pid 23098] getsockname(6, {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] getsockname(6,  \u003cunfinished ...\u003e\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] \u003c... getsockname resumed\u003e {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n[pid 23098] recvfrom(6, \"\\24\\0\\0\\0\\3\\0\\2\\0\\1\\0\\0\\0:Z\\0\\0\\0\\0\\0\\0\", 4096, 0, {sa_family=AF_NETLINK, pid=0, groups=00000000}, [12]) = 20\r\n[pid 23098] getsockname(6,  \u003cunfinished ...\u003e\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] \u003c... getsockname resumed\u003e {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] close(6)                    = 0\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] write(1, \"ReadMsgUDP:IPv6: addr [fe80::461\"..., 73 \u003cunfinished ...\u003e\r\nReadMsgUDP:IPv6: addr [fe80::461e:a1ff:fece:f4a9%eth0]:50115 , zoneid= 2\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] \u003c... write resumed\u003e )       = 73\r\n[pid 23098] write(1, \"                       POST Read\"..., 52                       POST ReadFromUDP, addr= eth0\r\n) = 52\r\n[pid 23098] write(1, \"                       PRE ReadF\"..., 39 \u003cunfinished ...\u003e\r\n                       PRE ReadFromUDP\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] \u003c... write resumed\u003e )       = 39\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n[pid 23098] recvfrom(3, \"\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\"..., 1200, 0, {sa_family=AF_INET6, sin6_port=htons(50115), inet_pton(AF_INET6, \"fe80::461e:a1ff:fece:f4a9\", \u0026sin6_addr), sin6_flowinfo=0, sin6_scope_id=if_nametoindex(\"eth0\")}, [28]) = 1200\r\n[pid 23098] write(1, \"interfaceTable ifindex= 2\\n\", 26 \u003cunfinished ...\u003e\r\ninterfaceTable ifindex= 2\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] \u003c... write resumed\u003e )       = 26\r\n[pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n\r\n     \t    These commands are a superfluous read of the RIB\r\n     \t    \t      \t    [pid 23098] socket(PF_NETLINK, SOCK_RAW, 0) = 6\r\n\t\t\t    [pid 23098] bind(6, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12) = 0\r\n\t\t\t    [pid 23098] sendto(6, \"\\21\\0\\0\\0\\22\\0\\1\\3\\1\\0\\0\\0\\0\\0\\0\\0\\0\", 17, 0, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12 \u003cunfinished ...\u003e\r\n\t\t\t    [pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n\t\t\t    [pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n\t\t\t    [pid 23098] \u003c... sendto resumed\u003e )      = 17\r\n\t\t\t    [pid 23098] recvfrom(6, \"|\\4\\0\\0\\20\\0\\2\\0\\1\\0\\0\\0:Z\\0\\0\\0\\0\\4\\3\\1\\0\\0\\0I\\0\\1\\0\\0\\0\\0\\0\"..., 4096, 0, {sa_family=AF_NETLINK, pid=0, groups=00000000}, [12]) = 3452\r\n\t\t\t    [pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n\t\t\t    [pid 23098] mmap(NULL, 1439992, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0 \u003cunfinished ...\u003e\r\n\t\t\t    [pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n\t\t\t    [pid 23098] \u003c... mmap resumed\u003e )        = 0x2b7c4c96e000\r\n\t\t\t    [pid 23098] getsockname(6, {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n\t\t\t    [pid 23098] getsockname(6,  \u003cunfinished ...\u003e\r\n\t\t\t    [pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n\t\t\t    [pid 23098] \u003c... getsockname resumed\u003e {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n\t\t\t    [pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n\t\t\t    [pid 23098] getsockname(6, {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n\t\t\t    [pid 23098] recvfrom(6, \"\\24\\0\\0\\0\\3\\0\\2\\0\\1\\0\\0\\0:Z\\0\\0\\0\\0\\0\\0\", 4096, 0, {sa_family=AF_NETLINK, pid=0, groups=00000000}, [12]) = 20\r\n\t\t\t    [pid 23098] getsockname(6,  \u003cunfinished ...\u003e\r\n\t\t\t    [pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n\t\t\t    [pid 23098] \u003c... getsockname resumed\u003e {sa_family=AF_NETLINK, pid=23098, groups=00000000}, [12]) = 0\r\n\t\t\t    [pid 23099] select(0, NULL, NULL, NULL, {0, 20} \u003cunfinished ...\u003e\r\n\t\t\t    [pid 23098] close(6)                    = 0\r\n[pid 23098] write(1, \"ReadMsgUDP:IPv6: addr [fe80::461\"..., 73ReadMsgUDP:IPv6: addr [fe80::461e:a1ff:fece:f4a9%eth0]:50115 , zoneid= 2\r\n) = 73\r\n[pid 23099] \u003c... select resumed\u003e )      = 0 (Timeout)\r\n[pid 23098] write(1, \"                       POST Read\"..., 52                       POST ReadFromUDP, addr= eth0\r\n",
	"user": {
		"login": "maghul",
		"id": 3647496,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "Performance"
		}
	],
	"comments": 8,
	"closed_at": "2016-04-15T01:45:52Z",
	"created_at": "2016-04-11T20:41:06Z",
	"updated_at": "2016-04-15T03:55:01Z",
	"milestone": {
		"id": 1414133,
		"number": 31,
		"title": "Go1.7"
	}
}
