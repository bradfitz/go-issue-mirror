{
	"id": 66072247,
	"body": "\u003ca id=\"c5\"\u003e\u003c/a\u003eComment 5:\n\n\u003cpre\u003eWow. I am surprised I am totally able to reproduce. I use Archlinux too.\n\n$ strace -e write -f gofmt -l src/pkg\n[pid  2284] --- SIGCONT {si_signo=SIGCONT, si_code=SI_USER, si_pid=1722, si_uid=1000} ---\n[pid  2285] --- SIGSEGV {si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x7f305ef8aff8}\n---\n[pid  2285] --- SIGSEGV {si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x7f305ef8aff8}\n---\n[pid  2285] +++ killed by SIGSEGV (core dumped) +++\n+++ killed by SIGSEGV (core dumped) +++\nzsh: segmentation fault  strace -e write -f gofmt -l src/pkg\n\n$ pmap 2285\n2285:   gofmt -l src/pkg\n0000000000400000   2260K r-x--  /opt/remy/go/bin/gofmt\n0000000000635000     68K rw---  /opt/remy/go/bin/gofmt\n0000000000646000 262268K rw---    [ anon ]\n000000c1fffd0000   3264K rwx--    [ anon ]\n00007f305ed0a000   3012K rwx--    [ anon ]\n00007fff66974000    132K rw---    [ stack ]\n00007fff669ce000      4K r-x--    [ anon ]\nffffffffff600000      4K r-x--    [ anon ]\n total           271012K\n\nI don't know what this 3012k mapping is. Lets disable address space randomization:\nNow the fault address is deterministic:\n\n% setarch x86_64 -R strace -e write -f gofmt -l src/pkg\nProcess 2351 attached\n[pid  2351] --- SIGSEGV {si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x7ffff7f8dff8}\n---\n[pid  2351] --- SIGSEGV {si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x7ffff7f8dff8}\n---\n[pid  2351] +++ killed by SIGSEGV (core dumped) +++\n+++ killed by SIGSEGV (core dumped) +++\nzsh: segmentation fault  setarch x86_64 -R strace -e write -f gofmt -l src/pkg\n$ setarch x86_64 -R strace -e write -f gofmt -l src/pkg\nProcess 2357 attached\n[pid  2357] --- SIGSEGV {si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x7ffff7f8dff8}\n---\n[pid  2357] --- SIGSEGV {si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x7ffff7f8dff8}\n---\n[pid  2357] +++ killed by SIGSEGV (core dumped) +++\n+++ killed by SIGSEGV (core dumped) +++\nzsh: segmentation fault  setarch x86_64 -R strace -e write -f gofmt -l src/pkg\n\nand pmap:\n\n0000000000400000   2260K r-x--  /opt/remy/go/bin/gofmt\n0000000000635000     68K rw---  /opt/remy/go/bin/gofmt\n0000000000646000 262268K rw---    [ anon ]\n000000c1fffd0000   3264K rwx--    [ anon ]\n00007ffff7d0d000   3012K rwx--    [ anon ]\n00007ffff7ffe000      4K r-x--    [ anon ]  \u0026lt;- we're just at the boundary here\n00007ffffffde000    132K rw---    [ stack ]\nffffffffff600000      4K r-x--    [ anon ]\n total           271012K\n\nAnd what actually happens:\n\n$ gdb --args gofmt -l src/pkg\nGNU gdb (GDB) 7.5\nCopyright (C) 2012 Free Software Foundation, Inc.\n[blah...]\n(gdb) handle SIGSEGV stop nopass print\nSignal        Stop\tPrint\tPass to program\tDescription\nSIGSEGV       Yes\tYes\tNo\t\tSegmentation fault\n(gdb) run\nStarting program: /home/remy/bin/gofmt -l src/pkg\n[New LWP 1958]\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to LWP 1958]\n0x00007ffff7ffe600 in ?? ()\n(gdb) bt\n#0  0x00007ffff7ffe600 in ?? ()\n#1  0x00007ffff7ffe8ac in clock_gettime ()\n#2  0x0000000000420c3b in time.now (sec=void, nsec=void) at\n/opt/remy/go/src/pkg/runtime/sys_linux_amd64.s:110\n#3  0x0000000000420c99 in runtime.nanotime () at\n/opt/remy/go/src/pkg/runtime/sys_linux_amd64.s:129\n#4  0x0000000000411f3c in sweepspan (idx=void) at /opt/remy/go/src/pkg/runtime/mgc0.c:710\n#5  0x0000000000415554 in runtime.parfordo (desc=void) at\n/opt/remy/go/src/pkg/runtime/parfor.c:101\n#6  0x000000000041256a in runtime.gc (force=void) at\n/opt/remy/go/src/pkg/runtime/mgc0.c:1053\n#7  0x000000000041cfdb in runtime.mallocgc (size=void, flag=void, dogc=void, zeroed=void)\n    at /opt/remy/go/src/pkg/runtime/malloc.goc:114\n#8  0x000000000041e0af in runtime.mal (n=void) at\n/opt/remy/go/src/pkg/runtime/malloc.goc:689\n#9  0x000000000040af3d in hash_subtable_new (h=void, power=void, used=void) at\n/opt/remy/go/src/pkg/runtime/hashmap.c:84\n#10 0x000000000040b0c3 in hash_init (h=void, datasize=void, hint=void) at\n/opt/remy/go/src/pkg/runtime/hashmap.c:128\n#11 0x000000000040ca9e in runtime.makemap_c (typ=void, hint=void) at\n/opt/remy/go/src/pkg/runtime/hashmap.c:780\n#12 0x000000000040cb4f in runtime.makemap (typ=void, hint=void, ret=void) at\n/opt/remy/go/src/pkg/runtime/hashmap.c:797\n#13 0x000000000043d95c in go/ast.NewScope (outer=0x0, noname=void) at\n/opt/remy/go/src/pkg/go/ast/scope.go:27\n#14 0x000000000044739c in go/parser.(*parser).openLabelScope (p=0xc2002b4480)\n    at /opt/remy/go/src/pkg/go/parser/parser.go:92\n#15 0x000000000044d720 in go/parser.(*parser).parseBody (p=0xc2002b4480,\nscope=0xc20047b060, noname=void)\n    at /opt/remy/go/src/pkg/go/parser/parser.go:1007\n#16 0x0000000000455b6d in go/parser.(*parser).parseFuncDecl (p=0xc2002b4480, noname=void)\n    at /opt/remy/go/src/pkg/go/parser/parser.go:2230\n#17 0x0000000000455e75 in go/parser.(*parser).parseDecl (p=0xc2002b4480, sync=\n    {void (struct go/parser.parser *)} 0x7ffff7f8e680, noname=void) at /opt/remy/go/src/pkg/go/parser/parser.go:2274\n#18 0x000000000045636d in go/parser.(*parser).parseFile (p=0xc2002b4480, noname=void)\n    at /opt/remy/go/src/pkg/go/parser/parser.go:2329\n#19 0x0000000000446e24 in go/parser.ParseFile (fset=0xc20006b280, filename=..., src=...,\nmode=4, noname=void)\n    at /opt/remy/go/src/pkg/go/parser/interface.go:92\n#20 0x0000000000402564 in main.parse (fset=0xc20006b280, filename=..., src=...,\nstdin=false, noname=void)\n    at /opt/remy/go/src/cmd/gofmt/gofmt.go:259\n#21 0x0000000000401095 in main.processFile (filename=..., in=..., out=..., stdin=false,\nnoname=void)\n    at /opt/remy/go/src/cmd/gofmt/gofmt.go:101\n#22 0x00000000004019a5 in main.visitFile (path=..., f=..., err=..., noname=void)\n    at /opt/remy/go/src/cmd/gofmt/gofmt.go:160\n#23 0x000000000047dded in path/filepath.walk (path=..., info=..., walkFn=\n    {void (struct string, os.FileInfo, error, error *)} 0x7ffff7f8ebd8, noname=void)\n    at /opt/remy/go/src/pkg/path/filepath/path.go:344\n#24 0x000000000047e0ad in path/filepath.walk (path=..., info=..., walkFn=\n    {void (struct string, os.FileInfo, error, error *)} 0x7ffff7f8ec98, noname=void)\n    at /opt/remy/go/src/pkg/path/filepath/path.go:362\n#25 0x000000000047e0ad in path/filepath.walk (path=..., info=..., walkFn=\n    {void (struct string, os.FileInfo, error, error *)} 0x7ffff7f8ed58, noname=void)\n    at /opt/remy/go/src/pkg/path/filepath/path.go:362\n#26 0x000000000047e0ad in path/filepath.walk (path=..., info=..., walkFn=\n    {void (struct string, os.FileInfo, error, error *)} 0x7ffff7f8ee18, noname=void)\n    at /opt/remy/go/src/pkg/path/filepath/path.go:362\n---Type \u0026lt;return\u0026gt; to continue, or q \u0026lt;return\u0026gt; to quit---apropos \n#27 0x000000000047e24f in path/filepath.Walk (root=..., walkFn=\n    {void (struct string, os.FileInfo, error, error *)} 0x7ffff7f8ee50, noname=void)\n    at /opt/remy/go/src/pkg/path/filepath/path.go:382\n#28 0x0000000000401a59 in main.walkDir (path=...) at\n/opt/remy/go/src/cmd/gofmt/gofmt.go:169\n#29 0x000000000040200e in main.gofmtMain () at /opt/remy/go/src/cmd/gofmt/gofmt.go:218\n#30 0x0000000000401a7c in main.main () at /opt/remy/go/src/cmd/gofmt/gofmt.go:176\n\nThe segfault is here:\n\n   ...\n   0x00007ffff7ffe867 \u0026lt;+567\u0026gt;:\tmov    %eax,%eax\n   0x00007ffff7ffe869 \u0026lt;+569\u0026gt;:\tsub    0xffffffffff5ff090,%rax\n   0x00007ffff7ffe871 \u0026lt;+577\u0026gt;:\tmov    0xffffffffff5ff0a0,%edx\n   0x00007ffff7ffe878 \u0026lt;+584\u0026gt;:\tmov    0xffffffffff5ff0a4,%ecx\n   0x00007ffff7ffe87f \u0026lt;+591\u0026gt;:\tand    0xffffffffff5ff098,%rax\n   0x00007ffff7ffe887 \u0026lt;+599\u0026gt;:\timul   %rdx,%rax\n   0x00007ffff7ffe88b \u0026lt;+603\u0026gt;:\tsar    %cl,%rax\n   0x00007ffff7ffe88e \u0026lt;+606\u0026gt;:\tjmpq   0x7ffff7ffe7d2 \u0026lt;clock_gettime+418\u0026gt;\n   0x00007ffff7ffe893 \u0026lt;+611\u0026gt;:\tnopl   0x0(%rax,%rax,1)\n   0x00007ffff7ffe898 \u0026lt;+616\u0026gt;:\txor    %edx,%edx\n   0x00007ffff7ffe89a \u0026lt;+618\u0026gt;:\tjmpq   0x7ffff7ffe761 \u0026lt;clock_gettime+305\u0026gt;\n   0x00007ffff7ffe89f \u0026lt;+623\u0026gt;:\tnop\n   0x00007ffff7ffe8a0 \u0026lt;+624\u0026gt;:\tmov    %rsi,-0x20(%rbp)\n   0x00007ffff7ffe8a4 \u0026lt;+628\u0026gt;:\tmov    %edi,-0x18(%rbp)\n   0x00007ffff7ffe8a7 \u0026lt;+631\u0026gt;:\tcallq  0x7ffff7ffe600\n=\u0026gt; 0x00007ffff7ffe8ac \u0026lt;+636\u0026gt;:\tmov    -0x20(%rbp),%rsi\n   0x00007ffff7ffe8b0 \u0026lt;+640\u0026gt;:\tmov    -0x18(%rbp),%edi\n   0x00007ffff7ffe8b3 \u0026lt;+643\u0026gt;:\tjmp    0x7ffff7ffe869 \u0026lt;clock_gettime+569\u0026gt;\n   0x00007ffff7ffe8b5 \u0026lt;+645\u0026gt;:\tnopl   (%rax)\n   0x00007ffff7ffe8b8 \u0026lt;+648\u0026gt;:\tmov    0xffffffffff5fe0f0,%eax\n   0x00007ffff7ffe8bf \u0026lt;+655\u0026gt;:\tmov    %eax,%eax\n   0x00007ffff7ffe8c1 \u0026lt;+657\u0026gt;:\tjmpq   0x7ffff7ffe833 \u0026lt;clock_gettime+515\u0026gt;\n   0x00007ffff7ffe8c6 \u0026lt;+662\u0026gt;:\tpause  \n   0x00007ffff7ffe8c8 \u0026lt;+664\u0026gt;:\tjmpq   0x7ffff7ffe788 \u0026lt;clock_gettime+344\u0026gt;\n\nWhich I think corresponds to this in the kernel.\n\nnotrace static inline long vgetns(void)\n{\n  long v;\n  cycles_t cycles;\n  if (gtod-\u0026gt;clock.vclock_mode == VCLOCK_TSC)\n    cycles = vread_tsc();\n  else if (gtod-\u0026gt;clock.vclock_mode == VCLOCK_HPET)\n    cycles = vread_hpet();\n  else\n    return 0;\n  v = (cycles - gtod-\u0026gt;clock.cycle_last) \u0026 gtod-\u0026gt;clock.mask;\n  return (v * gtod-\u0026gt;clock.mult) \u0026gt;\u0026gt; gtod-\u0026gt;clock.shift;\n}\n\nAt least, bisecting tells me the vDSO thing introduces the regression:\n\nchangeset 14848:42c8d3aadc40: bad\nThe first bad revision is:\nchangeset:   14848:42c8d3aadc40\nuser:        Shenghou Ma \u0026lt;minux.ma@gmail.com\u0026gt;\ndate:        Fri Nov 09 14:19:07 2012 +0800\nsummary:     runtime: use vDSO clock_gettime for time.now \u0026 runtime.nanotime on\nLinux/amd64\n\nI don't understand why it doesn't work.\u003c/pre\u003e",
	"user": {
		"login": "remyoudompheng",
		"id": 175246,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2012-11-17T09:24:29Z",
	"updated_at": "2014-12-22T06:20:44Z"
}
