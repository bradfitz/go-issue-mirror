{
	"id": 171249259,
	"body": "Maybe it's good to mention that the C library (libmilter) spawns a new thread per incoming connection, then does a callback to my go code. The machine this happens on handles a few connections at a time, max.\r\n\r\nHowever, doing 'info threads' on the core dump shows that at the moment the machine shows the high load, there are well over 300 threads:\r\n```\r\n(gdb) info threads \r\n  Id   Target Id         Frame \r\n  320  Thread 802406400 (LWP 101329) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  319  Thread 802406800 (LWP 100443) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  318  Thread 802406c00 (LWP 100451) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  317  Thread 802407000 (LWP 100632) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  316  Thread 802407400 (LWP 100646) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  315  Thread 802810400 (LWP 100924) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  314  Thread 802810800 (LWP 101236) 0x0000000801b613ba in poll () from /lib/libc.so.7\r\n  313  Thread 802c10400 (LWP 101237) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  312  Thread 802c10800 (LWP 101322) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  311  Thread 802c10c00 (LWP 101419) runtime.kevent () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:340\r\n  310  Thread 802c11000 (LWP 101420) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  309  Thread 802c11400 (LWP 101421) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  308  Thread 803013400 (LWP 101422) 0x0000000801af8a8a in _sigwait () from /lib/libc.so.7\r\n  307  Thread 803014800 (LWP 101395) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  306  Thread 803013800 (LWP 100673) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  305  Thread 803015000 (LWP 101277) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  304  Thread 803014000 (LWP 100126) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  303  Thread 803014c00 (LWP 100895) runtime.sys_umtx_op () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:21\r\n  302  Thread 803014400 (LWP 101096) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  301  Thread 803015c00 (LWP 101417) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  300  Thread 803016400 (LWP 101430) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  299  Thread 803016800 (LWP 101431) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  298  Thread 803015400 (LWP 101432) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  297  Thread 803016000 (LWP 101433) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  296  Thread 803015800 (LWP 101434) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  295  Thread 803016c00 (LWP 101435) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  294  Thread 803017000 (LWP 101436) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  293  Thread 803017400 (LWP 101437) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  292  Thread 803017800 (LWP 101438) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n...\r\n  144  Thread 803104000 (LWP 101586) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  143  Thread 803104400 (LWP 101587) 0x0000000000484daf in runtime.lockextra (nilokay=false, ~r1=0x0) at /usr/local/go/src/runtime/proc1.go:1062\r\n  142  Thread 803104800 (LWP 101588) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  141  Thread 803104c00 (LWP 101589) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  140  Thread 803105000 (LWP 101590) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  139  Thread 803105400 (LWP 101591) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  138  Thread 803105800 (LWP 101592) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  137  Thread 803105c00 (LWP 101593) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  136  Thread 803106000 (LWP 101594) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  135  Thread 803106400 (LWP 101595) runtime.lockextra (nilokay=false, ~r1=0x0) at /usr/local/go/src/runtime/proc1.go:1062\r\n  134  Thread 803106800 (LWP 101596) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  133  Thread 803106c00 (LWP 101597) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  132  Thread 803107000 (LWP 101598) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  131  Thread 803107400 (LWP 101599) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  130  Thread 803107800 (LWP 101600) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  129  Thread 803107c00 (LWP 101601) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  128  Thread 803108000 (LWP 101602) runtime.atomicload64 (ptr=0xff4020 \u003cruntime.extram\u003e, ~r1=1) at /usr/local/go/src/runtime/atomic_amd64x.go:30\r\n  127  Thread 803108400 (LWP 101603) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n...\r\n  13   Thread 8031eb400 (LWP 101717) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  12   Thread 8031eb800 (LWP 101718) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  11   Thread 8031ebc00 (LWP 101719) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  10   Thread 8031ec000 (LWP 101720) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  9    Thread 8031ec400 (LWP 101721) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  8    Thread 8031ec800 (LWP 101722) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  7    Thread 8031ecc00 (LWP 101723) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  6    Thread 8031ed000 (LWP 101724) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  5    Thread 8031ed400 (LWP 101725) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  4    Thread 8031ed800 (LWP 101726) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  3    Thread 8031edc00 (LWP 101727) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n  2    Thread 8031ee000 (LWP 101728) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n* 1    Thread 8031ee400 (LWP 101729) runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n(gdb) \r\n```\r\n\r\nBacktraces all look very similar:\r\n```\r\n(gdb) thread 238\r\n[Switching to thread 238 (Thread 803083400 (LWP 101492))]\r\n#0  runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\n306\tin /usr/local/go/src/runtime/sys_freebsd_amd64.s\r\n(gdb) bt full\r\n#0  runtime.osyield () at /usr/local/go/src/runtime/sys_freebsd_amd64.s:306\r\nNo locals.\r\n#1  0x0000000000484dcb in runtime.lockextra (nilokay=false, ~r1=0x0) at /usr/local/go/src/runtime/proc1.go:1065\r\n        old = 0\r\n#2  0x00000000004849ef in runtime.needm (x=0 '\\000') at /usr/local/go/src/runtime/proc1.go:942\r\n        mp = 0x0\r\n#3  0x00000000004b04f1 in runtime.cgocallback_gofunc () at /usr/local/go/src/runtime/asm_amd64.s:742\r\nNo locals.\r\n#4  0x00000000004b041a in runtime.cgocallback () at /usr/local/go/src/runtime/asm_amd64.s:714\r\nNo locals.\r\n#5  0x00000000006aa488 in _cgoexp_564f5a6b344f_Go_xxfi_connect (a=0x7ffff57abdc8, n=32)\r\n        fn = {void (struct github.com/Freeaqingme/gomilter._Ctype_struct_smfi_str *, github.com/Freeaqingme/gomilter._Ctype_char *, \r\n    struct github.com/Freeaqingme/gomilter._Ctype_struct_sockaddr *, github.com/Freeaqingme/gomilter._Ctype_sfsistat *)} 0x7ffff57abd50\r\n#6  0x000000000075d23d in crosscall2 () at /usr/local/go/src/runtime/cgo/asm_amd64.s:36\r\nNo locals.\r\n#7  0x00007ffff57abdc8 in ?? ()\r\nNo symbol table info available.\r\n#8  0x0000000000000020 in ?? ()\r\nNo symbol table info available.\r\n#9  0x0000000000000036 in ?? ()\r\nNo symbol table info available.\r\n#10 0x00007ffff57abe00 in ?? ()\r\nNo symbol table info available.\r\n#11 0x0000000000403c40 in ?? ()\r\nNo symbol table info available.\r\n#12 0x00007ffff57abf28 in ?? ()\r\nNo symbol table info available.\r\n#13 0x000000080307c280 in ?? ()\r\nNo symbol table info available.\r\n#14 0x0000000801e20ff0 in ?? () from /lib/libc.so.7\r\nNo symbol table info available.\r\n#15 0x000000080307c280 in ?? ()\r\nNo symbol table info available.\r\n#16 0x0000000801e20ff0 in ?? () from /lib/libc.so.7\r\nNo symbol table info available.\r\n#17 0x00007ffff57abe00 in ?? ()\r\nNo symbol table info available.\r\n#18 0x0000000000403c88 in Go_xxfi_connect ()\r\nNo symbol table info available.\r\nBacktrace stopped: previous frame inner to this frame (corrupt stack?)\r\n(gdb) \r\n```",
	"user": {
		"login": "Freeaqingme",
		"id": 33034,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2016-01-13T10:32:57Z",
	"updated_at": "2016-01-13T10:35:34Z"
}
