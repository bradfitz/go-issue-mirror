{
	"id": 51278256,
	"number": 1753,
	"state": "closed",
	"title": "windows: split stack overflow and malloc/free - deadlock",
	"body": "by **tarmigan**:\n\n\u003cpre\u003ehg 304d7d2b1d6c (\u0026quot;image: png \u0026amp; jpeg encoding benchmarks\u0026quot;)\n\nruntime os is windows 386\n\nI have been cross-compiling a go program for windows from OSX with 8g.  The program\nsends and receives data over 4 serial ports, and at any time, there should be 4\ngoroutines Read()ing from the serial ports, which you can see in the backtraces.  The\nsame program works fine on OSX 386 and works fine when I don't ask it to do too much on\nwindows.  This will be hard for someone else to reproduce because running it depends on\na bunch of different files and some external hardware.\n\nI am seeing two different panics both included below.  They occur at about the some\npoint in program execution.  It is not entirely deterministic (the exact point it crashs\nvaries a little bit between runs), but it does panic every time.  The two\npanics/backtraces may not be related, but I'm including them together in case they are. \nLet me know if I should split this into two different issues.\n\nSome of the unicode symbols in the backtrace are screwed up because I cut and paste from\na windows cmd window.\n\nIs there other information that would be helpful?  runtime.MemStats or anything?\n\nruntime: split stack overflow: 0x1094b75c \u0026lt; 0x1094b800\nthrow: runtime: split stack overflow\n\nruntime.throw+0x42 /Users/tarm/devel/go/src/pkg/runtime/runtime.c:102\n        runtime.throw(0x4d7acd, 0x1094b75c)\nruntime.newstack+0x9b /Users/tarm/devel/go/src/pkg/runtime/proc.c:741\n        runtime.newstack()\nruntime.morestack+0x4c /Users/tarm/devel/go/src/pkg/runtime/386/asm.s:220\n        runtime.morestack()\n----- morestack called from goroutine 1 -----\nruntime.sigtramp1+0x19 /Users/tarm/devel/go/src/pkg/runtime/windows/386/sys.s:68\n\n        runtime.sigtramp1(0x1094b778, 0x1094b784, 0x7c9032a8, 0x1094b84c, 0x314d\nffa8, ...)\nruntime.sigtramp+0xd /Users/tarm/devel/go/src/pkg/runtime/windows/386/sys.s:63\n        runtime.sigtramp()\n----- goroutine created by -----\n_rt0_386+0xbf /Users/tarm/devel/go/src/pkg/runtime/386/asm.s:80\n\ngoroutine 6 [3]:\nruntime.entersyscall+0x6d /Users/tarm/devel/go/src/pkg/runtime/proc.c:639\n        runtime.entersyscall()\nruntime.syscall+0x8c /Users/tarm/devel/go/src/pkg/runtime/windows/thread.c:240\n        runtime.syscall(0x7c8315cc, 0x4, 0x109a6d74, 0x109a6d94, 0x8, ...)\nsyscall.Syscall6+0x40 /Users/tarm/devel/go/src/pkg/runtime/windows/syscall.c:52\n        syscall.Syscall6(0x7c8315cc, 0x4, 0x66c, 0x109bc440, 0x10940dd0, ...)\nos/serial.getOverlappedResult+0x72 /Users/tarm/devel/gosocket/serial/serial_wind\nows.go:192\n        os/serial.getOverlappedResult(0x66c, 0x109bc440, 0x10944aa0, 0x10940dd8)\n\nos/serial.*serialPort┬╖Read+0x17a /Users/tarm/devel/gosocket/serial/serial_windo\nws.go:247\n        os/serial.*serialPort┬╖Read(0x10940608, 0x109ac000, 0x800, 0x800, 0x5, .\n..)\nmain._func_002+0x97 /Users/tarm/devel/gofenixtester/main.go:183\n        main._func_002(0x41484e, 0x10969f84, 0x0)\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\nmain.*serialConfig┬╖Connect+0x220 /Users/tarm/devel/gofenixtester/main.go:193\n\ngoroutine 5 [3]:\nruntime.entersyscall+0x6d /Users/tarm/devel/go/src/pkg/runtime/proc.c:639\n        runtime.entersyscall()\nruntime.syscall+0x8c /Users/tarm/devel/go/src/pkg/runtime/windows/thread.c:240\n        runtime.syscall(0x7c8315cc, 0x4, 0x109a5574, 0x109a5594, 0x8, ...)\nsyscall.Syscall6+0x40 /Users/tarm/devel/go/src/pkg/runtime/windows/syscall.c:52\n        syscall.Syscall6(0x7c8315cc, 0x4, 0x678, 0x109bcf40, 0x10940888, ...)\nos/serial.getOverlappedResult+0x72 /Users/tarm/devel/gosocket/serial/serial_wind\nows.go:192\n        os/serial.getOverlappedResult(0x678, 0x109bcf40, 0x10944aa0, 0x109408a0)\n\nos/serial.*serialPort┬╖Read+0x17a /Users/tarm/devel/gosocket/serial/serial_windo\nws.go:247\n        os/serial.*serialPort┬╖Read(0x109405e8, 0x109a7000, 0x800, 0x800, 0x1, .\n..)\nmain._func_002+0x97 /Users/tarm/devel/gofenixtester/main.go:183\n        main._func_002(0x41484e, 0x10969f58, 0x0)\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\nmain.*serialConfig┬╖Connect+0x220 /Users/tarm/devel/gofenixtester/main.go:193\n\ngoroutine 4 [3]:\nruntime.entersyscall+0x6d /Users/tarm/devel/go/src/pkg/runtime/proc.c:639\n        runtime.entersyscall()\nruntime.syscall+0x8c /Users/tarm/devel/go/src/pkg/runtime/windows/thread.c:240\n        runtime.syscall(0x7c8315cc, 0x4, 0x1097ad74, 0x1097ad94, 0x8, ...)\nsyscall.Syscall6+0x40 /Users/tarm/devel/go/src/pkg/runtime/windows/syscall.c:52\n        syscall.Syscall6(0x7c8315cc, 0x4, 0x684, 0x10944e80, 0x109bbe90, ...)\nos/serial.getOverlappedResult+0x72 /Users/tarm/devel/gosocket/serial/serial_wind\nows.go:192\n        os/serial.getOverlappedResult(0x684, 0x10944e80, 0x10944aa0, 0x109bbe88)\n\nos/serial.*serialPort┬╖Read+0x17a /Users/tarm/devel/gosocket/serial/serial_windo\nws.go:247\n        os/serial.*serialPort┬╖Read(0x109405e0, 0x109a3000, 0x800, 0x800, 0x3, .\n..)\nmain._func_002+0x97 /Users/tarm/devel/gofenixtester/main.go:183\n        main._func_002(0x41484e, 0x10969f2c, 0x3)\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\nmain.*serialConfig┬╖Connect+0x220 /Users/tarm/devel/gofenixtester/main.go:193\n\ngoroutine 3 [1]:\nruntime.gosched+0x55 /Users/tarm/devel/go/src/pkg/runtime/proc.c:603\n        runtime.gosched()\nruntime.exitsyscall+0x6b /Users/tarm/devel/go/src/pkg/runtime/proc.c:683\n        runtime.exitsyscall()\nruntime.syscall+0xa7 /Users/tarm/devel/go/src/pkg/runtime/windows/thread.c:243\n        runtime.syscall(0x7c8315cc, 0x4, 0x1094dd74, 0x1094dd94, 0x8, ...)\nsyscall.Syscall6+0x40 /Users/tarm/devel/go/src/pkg/runtime/windows/syscall.c:52\n        syscall.Syscall6(0x7c8315cc, 0x4, 0x6b0, 0x10951c80, 0x109bb9a0, ...)\nos/serial.getOverlappedResult+0x72 /Users/tarm/devel/gosocket/serial/serial_wind\nows.go:192\n        os/serial.getOverlappedResult(0x6b0, 0x10951c80, 0x10944aa0, 0x109bb998)\n\nos/serial.*serialPort┬╖Read+0x17a /Users/tarm/devel/gosocket/serial/serial_windo\nws.go:247\n        os/serial.*serialPort┬╖Read(0x109405d8, 0x109a2000, 0x800, 0x800, 0xb, .\n..)\nmain._func_002+0x97 /Users/tarm/devel/gofenixtester/main.go:183\n        main._func_002(0x41484e, 0x10969f00, 0x0)\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\nmain.*serialConfig┬╖Connect+0x220 /Users/tarm/devel/gofenixtester/main.go:193\n\ngoroutine 2 [4]:\nruntime.gosched+0x55 /Users/tarm/devel/go/src/pkg/runtime/proc.c:603\n        runtime.gosched()\nrunfinq+0x4c /Users/tarm/devel/go/src/pkg/runtime/mgc0.c:671\n        runfinq()\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\nruntime.gc /Users/tarm/devel/go/src/pkg/runtime/mgc0.c:547\n\ngoroutine 1 [2]:\nruntime.entersyscall+0x6d /Users/tarm/devel/go/src/pkg/runtime/proc.c:639\n        runtime.entersyscall()\n----- goroutine created by -----\n_rt0_386+0xbf /Users/tarm/devel/go/src/pkg/runtime/386/asm.s:80\n\n##########################################\n\n##########################################\nthrow: malloc/free - deadlock\n\n[signal 0xc0000005 code=0x0 addr=0x1 pc=0x410359]\n\nruntime.throw+0x42 /Users/tarm/devel/go/src/pkg/runtime/runtime.c:102\n        runtime.throw(0x4d6fb8, 0x0)\nruntime.mallocgc+0x65 /Users/tarm/devel/go/src/pkg/runtime/malloc.c:36\n        runtime.mallocgc(0x8, 0x0, 0x1, 0x1, 0x138, ...)\nruntime.mal+0x42 /Users/tarm/devel/go/src/pkg/runtime/malloc.c:289\n        runtime.mal(0x8, 0x190680)\ncopyin+0x63 /Users/tarm/devel/go/src/pkg/runtime/iface.c:169\n        copyin(0x46ab04, 0x1094bef4, 0x1094bf00, 0x0)\nruntime.convT2E+0x46 /Users/tarm/devel/go/src/pkg/runtime/iface.c:218\n        runtime.convT2E(0x46ab04, 0x4d68c5)\nruntime.newErrorString+0x33 /Users/tarm/devel/go/src/pkg/runtime/error.go:107\n        runtime.newErrorString(0x4d68c5, 0x31, 0x1094bf34, 0x1094bd60)\nruntime.panicstring+0x80 /Users/tarm/devel/go/src/pkg/runtime/runtime.c:115\n        runtime.panicstring(0x4d68c5, 0x0)\nruntime.sigpanic+0x8e /Users/tarm/devel/go/src/pkg/runtime/windows/thread.c:275\n        runtime.sigpanic()\nMCentral_Alloc+0x47 /Users/tarm/devel/go/src/pkg/runtime/mcentral.c:81\n        MCentral_Alloc(0x8e3f70, 0x109c2058)\nruntime.MCentral_AllocList+0x71 /Users/tarm/devel/go/src/pkg/runtime/mcentral.c:\n55\n        runtime.MCentral_AllocList(0x8e3f70, 0x20, 0x1094bfa8, 0x0)\nruntime.MCache_Alloc+0x6a /Users/tarm/devel/go/src/pkg/runtime/mcache.c:23\n        runtime.MCache_Alloc(0x270ed8, 0x1, 0x8, 0x1, 0x1094c008, ...)\nruntime.mallocgc+0xdf /Users/tarm/devel/go/src/pkg/runtime/malloc.c:47\n        runtime.mallocgc(0x8, 0x0, 0x1, 0x1, 0x10969e44, ...)\nruntime.mal+0x42 /Users/tarm/devel/go/src/pkg/runtime/malloc.c:289\n        runtime.mal(0x4, 0x10940208)\nruntime.new+0x28 /Users/tarm/devel/go/src/pkg/runtime/malloc.c:296\n        runtime.new(0x4, 0x10969e40, 0xe)\nmain.*testCmd┬╖Run+0x2f /Users/tarm/devel/gofenixtester/main.go:38\n        main.*testCmd┬╖Run(0x109446e0, 0x2, 0x0, 0x0)\nmain.*test┬╖Run+0x1d2 /Users/tarm/devel/gofenixtester/main.go:79\n        main.*test┬╖Run(0x109448e0, 0x10944940, 0x0, 0x0)\nmain.main+0x881 /Users/tarm/devel/gofenixtester/main.go:992\n        main.main()\nruntime.mainstart+0xf /Users/tarm/devel/go/src/pkg/runtime/386/asm.s:93\n        runtime.mainstart()\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\n_rt0_386+0xbf /Users/tarm/devel/go/src/pkg/runtime/386/asm.s:80\n\ngoroutine 6 [3]:\nruntime.entersyscall+0x6d /Users/tarm/devel/go/src/pkg/runtime/proc.c:639\n        runtime.entersyscall()\nruntime.syscall+0x8c /Users/tarm/devel/go/src/pkg/runtime/windows/thread.c:240\n        runtime.syscall(0x7c8315cc, 0x4, 0x109a6d74, 0x109a6d94, 0x8, ...)\nsyscall.Syscall6+0x40 /Users/tarm/devel/go/src/pkg/runtime/windows/syscall.c:52\n        syscall.Syscall6(0x7c8315cc, 0x4, 0x66c, 0x109c3ba0, 0x109b3e10, ...)\nos/serial.getOverlappedResult+0x72 /Users/tarm/devel/gosocket/serial/serial_wind\nows.go:192\n        os/serial.getOverlappedResult(0x66c, 0x109c3ba0, 0x10944aa0, 0x109b3e08)\n\nos/serial.*serialPort┬╖Read+0x17a /Users/tarm/devel/gosocket/serial/serial_windo\nws.go:247\n        os/serial.*serialPort┬╖Read(0x10940608, 0x109ac000, 0x800, 0x800, 0x5, .\n..)\nmain._func_002+0x97 /Users/tarm/devel/gofenixtester/main.go:183\n        main._func_002(0x41484e, 0x10969f84, 0x0)\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\nmain.*serialConfig┬╖Connect+0x220 /Users/tarm/devel/gofenixtester/main.go:193\n\ngoroutine 5 [3]:\nruntime.entersyscall+0x6d /Users/tarm/devel/go/src/pkg/runtime/proc.c:639\n        runtime.entersyscall()\nruntime.syscall+0x8c /Users/tarm/devel/go/src/pkg/runtime/windows/thread.c:240\n        runtime.syscall(0x7c8315cc, 0x4, 0x109a5574, 0x109a5594, 0x8, ...)\nsyscall.Syscall6+0x40 /Users/tarm/devel/go/src/pkg/runtime/windows/syscall.c:52\n        syscall.Syscall6(0x7c8315cc, 0x4, 0x678, 0x109b0700, 0x109c2568, ...)\nos/serial.getOverlappedResult+0x72 /Users/tarm/devel/gosocket/serial/serial_wind\nows.go:192\n        os/serial.getOverlappedResult(0x678, 0x109b0700, 0x10944aa0, 0x109c2560)\n\nos/serial.*serialPort┬╖Read+0x17a /Users/tarm/devel/gosocket/serial/serial_windo\nws.go:247\n        os/serial.*serialPort┬╖Read(0x109405e8, 0x109a7000, 0x800, 0x800, 0x1, .\n..)\nmain._func_002+0x97 /Users/tarm/devel/gofenixtester/main.go:183\n        main._func_002(0x41484e, 0x10969f58, 0x0)\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\nmain.*serialConfig┬╖Connect+0x220 /Users/tarm/devel/gofenixtester/main.go:193\n\ngoroutine 4 [3]:\nruntime.entersyscall+0x6d /Users/tarm/devel/go/src/pkg/runtime/proc.c:639\n        runtime.entersyscall()\nruntime.syscall+0x8c /Users/tarm/devel/go/src/pkg/runtime/windows/thread.c:240\n        runtime.syscall(0x7c8315cc, 0x4, 0x1097ad74, 0x1097ad94, 0x8, ...)\nsyscall.Syscall6+0x40 /Users/tarm/devel/go/src/pkg/runtime/windows/syscall.c:52\n        syscall.Syscall6(0x7c8315cc, 0x4, 0x684, 0x109b08c0, 0x109c26b8, ...)\nos/serial.getOverlappedResult+0x72 /Users/tarm/devel/gosocket/serial/serial_wind\nows.go:192\n        os/serial.getOverlappedResult(0x684, 0x109b08c0, 0x10944aa0, 0x109c26b0)\n\nos/serial.*serialPort┬╖Read+0x17a /Users/tarm/devel/gosocket/serial/serial_windo\nws.go:247\n        os/serial.*serialPort┬╖Read(0x109405e0, 0x109a3000, 0x800, 0x800, 0x15,\n...)\nmain._func_002+0x97 /Users/tarm/devel/gofenixtester/main.go:183\n        main._func_002(0x41484e, 0x10969f2c, 0x3)\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\nmain.*serialConfig┬╖Connect+0x220 /Users/tarm/devel/gofenixtester/main.go:193\n\ngoroutine 3 [3]:\nruntime.entersyscall+0x6d /Users/tarm/devel/go/src/pkg/runtime/proc.c:639\n        runtime.entersyscall()\nruntime.syscall+0x8c /Users/tarm/devel/go/src/pkg/runtime/windows/thread.c:240\n        runtime.syscall(0x7c8315cc, 0x4, 0x1094dd74, 0x1094dd94, 0x8, ...)\nsyscall.Syscall6+0x40 /Users/tarm/devel/go/src/pkg/runtime/windows/syscall.c:52\n        syscall.Syscall6(0x7c8315cc, 0x4, 0x6b0, 0x1097cf80, 0x109c2398, ...)\nos/serial.getOverlappedResult+0x72 /Users/tarm/devel/gosocket/serial/serial_wind\nows.go:192\n        os/serial.getOverlappedResult(0x6b0, 0x1097cf80, 0x10944aa0, 0x109c2390)\n\nos/serial.*serialPort┬╖Read+0x17a /Users/tarm/devel/gosocket/serial/serial_windo\nws.go:247\n        os/serial.*serialPort┬╖Read(0x109405d8, 0x109a2000, 0x800, 0x800, 0xf, .\n..)\nmain._func_002+0x97 /Users/tarm/devel/gofenixtester/main.go:183\n        main._func_002(0x41484e, 0x10969f00, 0x0)\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\nmain.*serialConfig┬╖Connect+0x220 /Users/tarm/devel/gofenixtester/main.go:193\n\ngoroutine 2 [4]:\nruntime.gosched+0x55 /Users/tarm/devel/go/src/pkg/runtime/proc.c:603\n        runtime.gosched()\nrunfinq+0x4c /Users/tarm/devel/go/src/pkg/runtime/mgc0.c:671\n        runfinq()\nruntime.goexit /Users/tarm/devel/go/src/pkg/runtime/proc.c:178\n        runtime.goexit()\n----- goroutine created by -----\nruntime.gc /Users/tarm/devel/go/src/pkg/runtime/mgc0.c:547\u003c/pre\u003e",
	"user": {
		"login": "gopherbot",
		"id": 8566911,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 11,
	"closed_at": "2014-12-08T10:09:44Z",
	"created_at": "2011-04-29T19:31:30Z",
	"updated_at": "2016-06-24T19:28:16Z"
}
