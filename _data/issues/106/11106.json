{
	"id": 85822156,
	"number": 11106,
	"state": "closed",
	"title": "testing: Delay in test causes timeouts in tests that follow it.",
	"body": "1 `go version`: go version go1.4.2 linux/amd64\r\n\r\n2\r\nOS: Linux Mint 16\r\n`uname -a`: Linux mint 3.11.0-12-generic #19-Ubuntu SMP Wed Oct 9 16:20:46 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n3 Ran `go test` with the following test file:\r\n\r\n\tpackage p\r\n\r\n\timport (\r\n\t\t\"net\"\r\n\t\t\"testing\"\r\n\t\t\"time\"\r\n\t)\r\n\r\n\tfunc Test1(t *testing.T) {\r\n\t\ttestTunnelWithinSecond(t, time.Millisecond)\r\n\t}\r\n\r\n\tfunc Test2(t *testing.T) {\r\n\t\ttestTunnelWithinSecond(t, time.Millisecond)\r\n\t}\r\n\r\n\tfunc Test3(t *testing.T) {\r\n\t\ttestTunnelWithinSecond(t, 0)\r\n\t}\r\n\r\n\tfunc Test4(t *testing.T) {\r\n\t\ttestTunnelWithinSecond(t, time.Millisecond)\r\n\t}\r\n\r\n\tfunc Test5(t *testing.T) {\r\n\t\ttestTunnelWithinSecond(t, time.Millisecond)\r\n\t}\r\n\r\n\tfunc testTunnelWithinSecond(t *testing.T, timeout time.Duration) {\r\n\t\tch := make(chan struct{}, 1)\r\n\r\n\t\tgo func() {\r\n\t\t\tin, err := pipeConn()\r\n\t\t\tif err != nil {\r\n\t\t\t\tt.Fatalf(\"Unexpected error: %v\", err)\r\n\t\t\t}\r\n\r\n\t\t\tfor err == nil {\r\n\t\t\t\tin[1].SetReadDeadline(time.Now().Add(timeout))\r\n\t\t\t\t_, err = in[1].Read(make([]byte, 0))\r\n\t\t\t\tif e, ok := err.(net.Error); ok \u0026\u0026 e.Timeout() {\r\n\t\t\t\t\terr = nil\r\n\t\t\t\t\tcontinue\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tclose(ch)\r\n\t\t}()\r\n\r\n\t\tselect {\r\n\t\tcase \u003c-time.After(time.Millisecond):\r\n\t\t\tt.Fatalf(\"Test timed out\")\r\n\t\tcase \u003c-ch:\r\n\t\t}\r\n\t}\r\n\r\n\t// `pipeConn` returns a pair of `net.Conn`s that are connected to each other.\r\n\tfunc pipeConn() ([2]net.Conn, error) {\r\n\t\terrs := make(chan error, 1)\r\n\t\tports := make(chan int, 1)\r\n\t\tconns := make(chan net.Conn, 1)\r\n\r\n\t\tgo func() {\r\n\t\t\tln, err := net.ListenTCP(\"tcp4\", \u0026net.TCPAddr{IP: localhost})\r\n\t\t\tif err != nil {\r\n\t\t\t\terrs \u003c- err\r\n\t\t\t} else {\r\n\t\t\t\tports \u003c- ln.Addr().(*net.TCPAddr).Port\r\n\r\n\t\t\t\tconn, err := ln.Accept()\r\n\t\t\t\tconns \u003c- conn\r\n\t\t\t\terrs \u003c- err\r\n\t\t\t}\r\n\t\t}()\r\n\r\n\t\tselect {\r\n\t\tcase err := \u003c-errs:\r\n\t\t\treturn [2]net.Conn{nil, nil}, err\r\n\t\tcase port := \u003c-ports:\r\n\t\t\tconn, _ := net.DialTCP(\r\n\t\t\t\t\"tcp4\",\r\n\t\t\t\tnil,\r\n\t\t\t\t\u0026net.TCPAddr{IP: localhost, Port: port},\r\n\t\t\t)\r\n\t\t\treturn [2]net.Conn{conn, \u003c-conns}, \u003c-errs\r\n\t\t}\r\n\t}\r\n\r\n\tvar localhost = net.IPv4(127, 0, 0, 1)\r\n\r\n4 I expected all tests to pass except for `Test3`, which I expected to fail with \"Test timed out\".\r\n\r\n5 `Test1` and `Test2` always passed, but `Test4` and `Test5` intermittently (but with high probability) failed with \"Test timed out\". The following script was run to break down the frequency of failures:\r\n\r\n    import collections\r\n    import pprint\r\n    import re\r\n    import subprocess\r\n\r\n    output = collections.defaultdict(int)\r\n    for i in xrange(100):\r\n        try:\r\n            subprocess.check_output([\"go\", \"test\"])\r\n        except subprocess.CalledProcessError, e:\r\n            output[re.sub(\"0\\.\\d*s\", \"\", e.output)] += 1\r\n\r\n    for k, v in output.items():\r\n        print \"%d%%\" % v\r\n        print '\\t' + k.replace('\\n', '\\n\\t')\r\n\r\nThe above script gave the following results on a sample run, providing preliminary evidence to the presence of cross-contamination of tests.\r\n\r\n    18%\r\n        --- FAIL: Test3 ()\r\n            tunnel_test.go:52: Test timed out\r\n        --- FAIL: Test4 ()\r\n            tunnel_test.go:52: Test timed out\r\n        FAIL\r\n        exit status 1\r\n        FAIL\tbitbucket.com/ezanmoto/repogate/lab\t\r\n        \r\n    69%\r\n        --- FAIL: Test3 ()\r\n            tunnel_test.go:52: Test timed out\r\n        --- FAIL: Test4 ()\r\n            tunnel_test.go:52: Test timed out\r\n        --- FAIL: Test5 ()\r\n            tunnel_test.go:52: Test timed out\r\n        FAIL\r\n        exit status 1\r\n        FAIL\tbitbucket.com/ezanmoto/repogate/lab\t\r\n        \r\n    1%\r\n        --- FAIL: Test3 ()\r\n            tunnel_test.go:52: Test timed out\r\n        FAIL\r\n        exit status 1\r\n        FAIL\tbitbucket.com/ezanmoto/repogate/lab\t\r\n        \r\n    12%\r\n        --- FAIL: Test3 ()\r\n            tunnel_test.go:52: Test timed out\r\n        --- FAIL: Test5 ()\r\n            tunnel_test.go:52: Test timed out\r\n        FAIL\r\n        exit status 1\r\n        FAIL\tbitbucket.com/ezanmoto/repogate/lab\t\r\n        ",
	"user": {
		"login": "eZanmoto",
		"id": 701099,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 1,
	"closed_at": "2015-06-07T00:49:58Z",
	"created_at": "2015-06-06T23:26:54Z",
	"updated_at": "2016-06-25T02:10:37Z"
}
