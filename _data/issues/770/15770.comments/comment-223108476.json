{
	"id": 223108476,
	"body": "Here is a simple way to reproduce the problem I found.  There are actually two problems.\r\n1) If you use the -linkshared option with go get, it does not use linux_ppc64le_dynlink as the install directory.\r\ngo get -u -x -linkshared golang.org/x/sys/unix\r\ncd .\r\ngit clone https://go.googlesource.com/sys /home/boger/golang.work/src/golang.org/x/sys\r\ncd /home/boger/golang.work/src/golang.org/x/sys\r\ngit submodule update --init --recursive\r\ncd /home/boger/golang.work/src/golang.org/x/sys\r\ngit show-ref\r\ncd /home/boger/golang.work/src/golang.org/x/sys\r\ngit submodule update --init --recursive\r\nWORK=/tmp/go-build954411439\r\nmkdir -p $WORK/golang.org/x/sys/unix/_obj/\r\nmkdir -p $WORK/golang.org/x/sys/\r\ncd /home/boger/golang.work/src/golang.org/x/sys/unix\r\n/home/boger/golang/go1.6/go/pkg/tool/linux_ppc64le/compile -o $WORK/golang.org/x/sys/unix.a -trimpath $WORK -dynlink -p golang.org/x/sys/unix -installsuffix dynlink -buildid c6471c5554bcf97afeb2aba390b30ab58fbaf41d -D _/home/boger/golang.work/src/golang.org/x/sys/unix -I $WORK -pack -asmhdr $WORK/golang.org/x/sys/unix/_obj/go_asm.h ./bluetooth_linux.go ./constants.go ./env_unix.go ./env_unset.go ./flock.go ./race0.go ./sockcmsg_linux.go ./sockcmsg_unix.go ./str.go ./syscall.go ./syscall_linux.go ./syscall_linux_ppc64x.go ./syscall_unix.go ./zerrors_linux_ppc64le.go ./zsyscall_linux_ppc64le.go ./zsysnum_linux_ppc64le.go ./ztypes_linux_ppc64le.go\r\n/home/boger/golang/go1.6/go/pkg/tool/linux_ppc64le/asm -o $WORK/golang.org/x/sys/unix/_obj/asm.o -trimpath $WORK -I $WORK/golang.org/x/sys/unix/_obj/ -I /home/boger/golang/go1.6/go/pkg/include -D GOOS_linux -D GOARCH_ppc64le -D=GOBUILDMODE_shared=1 -dynlink ./asm.s\r\n/home/boger/golang/go1.6/go/pkg/tool/linux_ppc64le/asm -o $WORK/golang.org/x/sys/unix/_obj/asm_linux_ppc64x.o -trimpath $WORK -I $WORK/golang.org/x/sys/unix/_obj/ -I /home/boger/golang/go1.6/go/pkg/include -D GOOS_linux -D GOARCH_ppc64le -D=GOBUILDMODE_shared=1 -dynlink ./asm_linux_ppc64x.s\r\npack r $WORK/golang.org/x/sys/unix.a $WORK/golang.org/x/sys/unix/_obj/asm.o $WORK/golang.org/x/sys/unix/_obj/asm_linux_ppc64x.o # internal\r\nmkdir -p /home/boger/golang.work/pkg/linux_ppc64le/golang.org/x/sys/\r\ncp $WORK/golang.org/x/sys/unix.a /home/boger/golang.work/pkg/linux_ppc64le/golang.org/x/sys/unix.a\r\n2) If I use go get -d followed by go install -linkshared, it generates the correct directory:\r\ngo install -x -linkshared golang.org/x/sys/unix\r\nWORK=/tmp/go-build696097881\r\nmkdir -p $WORK/golang.org/x/sys/unix/_obj/\r\nmkdir -p $WORK/golang.org/x/sys/\r\ncd /home/boger/golang.work/src/golang.org/x/sys/unix\r\n/home/boger/golang/go1.6/go/pkg/tool/linux_ppc64le/compile -o $WORK/golang.org/x/sys/unix.a -trimpath $WORK -dynlink -p golang.org/x/sys/unix -installsuffix dynlink -buildid c6471c5554bcf97afeb2aba390b30ab58fbaf41d -D _/home/boger/golang.work/src/golang.org/x/sys/unix -I $WORK -pack -asmhdr $WORK/golang.org/x/sys/unix/_obj/go_asm.h ./bluetooth_linux.go ./constants.go ./env_unix.go ./env_unset.go ./flock.go ./race0.go ./sockcmsg_linux.go ./sockcmsg_unix.go ./str.go ./syscall.go ./syscall_linux.go ./syscall_linux_ppc64x.go ./syscall_unix.go ./zerrors_linux_ppc64le.go ./zsyscall_linux_ppc64le.go ./zsysnum_linux_ppc64le.go ./ztypes_linux_ppc64le.go\r\n/home/boger/golang/go1.6/go/pkg/tool/linux_ppc64le/asm -o $WORK/golang.org/x/sys/unix/_obj/asm.o -trimpath $WORK -I $WORK/golang.org/x/sys/unix/_obj/ -I /home/boger/golang/go1.6/go/pkg/include -D GOOS_linux -D GOARCH_ppc64le -D=GOBUILDMODE_shared=1 -dynlink ./asm.s\r\n/home/boger/golang/go1.6/go/pkg/tool/linux_ppc64le/asm -o $WORK/golang.org/x/sys/unix/_obj/asm_linux_ppc64x.o -trimpath $WORK -I $WORK/golang.org/x/sys/unix/_obj/ -I /home/boger/golang/go1.6/go/pkg/include -D GOOS_linux -D GOARCH_ppc64le -D=GOBUILDMODE_shared=1 -dynlink ./asm_linux_ppc64x.s\r\npack r $WORK/golang.org/x/sys/unix.a $WORK/golang.org/x/sys/unix/_obj/asm.o $WORK/golang.org/x/sys/unix/_obj/asm_linux_ppc64x.o # internal\r\nmkdir -p /home/boger/golang.work/pkg/linux_ppc64le_dynlink/golang.org/x/sys/\r\ncp $WORK/golang.org/x/sys/unix.a /home/boger/golang.work/pkg/linux_ppc64le_dynlink/golang.org/x/sys/unix.a\r\n3) But then if I use this testcase with the unix package I see the same errors as above:\r\npackage main\r\n\r\nimport (\r\n \"fmt\"\r\n \"golang.org/x/sys/unix\"\r\n)\r\n\r\nfunc main() {\r\n    fmt.Printf(\"pagesize: %d \\n\", unix.Getpagesize())\r\n}\r\n\r\nI see multiple errors.\r\ngo build -linkshared sharedtest.go\r\n# command-line-arguments\r\n/home/boger/golang/go1.6/go/pkg/tool/linux_ppc64le/link: running gcc failed: exit status 1\r\n/usr/bin/ld: /tmp/go-link-460846081/go.o: In function `local.golang.org/x/sys/unix.(*mmapper).Lock':\r\n(.text+0x10c4): call to `sync.(*Mutex).Lock' lacks nop, can't restore toc; recompile with -fPIC\r\n/usr/bin/ld: /tmp/go-link-460846081/go.o: In function `local.golang.org/x/sys/unix.(*mmapper).Lock':\r\n(.text+0x10c4): unresolvable R_PPC64_REL24 against `sync.(*Mutex).Lock'\r\n/usr/bin/ld: /tmp/go-link-460846081/go.o: In function `local.golang.org/x/sys/unix.(*mmapper).Unlock':\r\n(.text+0x1114): call to `sync.(*Mutex).Unlock' lacks nop, can't restore toc; recompile with -fPIC\r\n/usr/bin/ld: /tmp/go-link-460846081/go.o: In function `local.golang.org/x/sys/unix.(*mmapper).Unlock':\r\n(.text+0x1114): unresolvable R_PPC64_REL24 against `sync.(*Mutex).Unlock'\r\n/usr/bin/ld: /tmp/go-link-460846081/go.o: In function `local.golang.org/x/sys/unix.Syscall':\r\n(.text+0x1128): call to `syscall.Syscall' lacks nop, can't restore toc; recompile with -fPIC\r\n/usr/bin/ld: /tmp/go-link-460846081/go.o: In function `local.golang.org/x/sys/unix.Syscall':\r\n(.text+0x1128): unresolvable R_PPC64_REL24 against `syscall.Syscall'\r\n/usr/bin/ld: /tmp/go-link-460846081/go.o: In function `local.golang.org/x/sys/unix.Syscall6':\r\n(.text+0x1138): call to `syscall.Syscall6' lacks nop, can't restore toc; recompile with -fPIC\r\n/usr/bin/ld: /tmp/go-link-460846081/go.o: In function `local.golang.org/x/sys/unix.Syscall6':\r\n(.text+0x1138): unresolvable R_PPC64_REL24 against `syscall.Syscall6'\r\n/usr/bin/ld: final link failed: Bad value\r\ncollect2: error: ld returned 1 exit status\r\n\r\n\r\n",
	"user": {
		"login": "laboger",
		"id": 9433228,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2016-06-01T20:05:21Z",
	"updated_at": "2016-06-01T20:05:21Z"
}
