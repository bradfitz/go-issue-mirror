{
	"id": 128850723,
	"number": 14101,
	"state": "closed",
	"title": "runtime: fatal error: missed stack barrier",
	"body": "A program with trace enabled (`runtime/trace.Start`) compiled with Go tip (e634765) panics with *fatal error: missed stack barrier* fairly consistently (1 run in 2).\r\n\r\nOS: Debian 8.2\r\nHardware: 4 cores i7-4700MQ\r\nFull source code: https://github.com/kostya-sh/sandbox/blob/master/tfb-go/app-files/src/hello/hello.go\r\nTo trigger a panic: \r\n\r\n    $ curl http://localhost:8080/profile/start?f=x\r\n    $ wrk -t4 -c4 -d60 http://localhost:8080/json\r\n\r\nFull stack trace:\r\n```\r\nfound next stack barrier at 0xc82045ff90; expected [@@@ *0xc82045ff90=0x464401 ==\u003e]\r\nfatal error: missed stack barrier\r\n\r\nruntime stack:\r\nruntime.throw(0x8d7130, 0x14)\r\n\t/home/ksh/work/os-code/go/src/runtime/panic.go:530 +0x90\r\nruntime.gentraceback(0x654185, 0xc82045f8a8, 0x0, 0xc820001680, 0x0, 0x7f74a4400020, 0x80, 0x0, 0x0, 0x0, ...)\r\n\t/home/ksh/work/os-code/go/src/runtime/traceback.go:295 +0x1560\r\nruntime.gcallers(0xc820001680, 0x1, 0x7f74a4400020, 0x80, 0x80, 0x944138)\r\n\t/home/ksh/work/os-code/go/src/runtime/traceback.go:609 +0x7f\r\nruntime.traceEvent(0x4d821c, 0x1, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/runtime/trace.go:532 +0x599\r\nruntime.traceGoSysCall()\r\n\t/home/ksh/work/os-code/go/src/runtime/trace.go:873 +0x36\r\nruntime.systemstack(0xc82016a4c0)\r\n\t/home/ksh/work/os-code/go/src/runtime/asm_amd64.s:291 +0x79\r\nruntime.mstart()\r\n\t/home/ksh/work/os-code/go/src/runtime/proc.go:1048\r\n\r\ngoroutine 8 [syscall]:\r\nsyscall.Syscall(0x1, 0xb, 0xc8201a4000, 0x94, 0x43110d, 0xc82045f8f8, 0x4d5448)\r\n\t/home/ksh/work/os-code/go/src/syscall/asm_linux_amd64.s:18 +0x5 fp=0xc82045f8b0 sp=0xc82045f8a8\r\nsyscall.write(0xb, 0xc8201a4000, 0x94, 0x1000, 0x77, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/syscall/zsyscall_linux_amd64.go:1064 +0x5f fp=0xc82045f8f0 sp=0xc82045f8b0\r\nsyscall.Write(0xb, 0xc8201a4000, 0x94, 0x1000, 0xc81ffe0a02, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/syscall/syscall_unix.go:180 +0x4d fp=0xc82045f930 sp=0xc82045f8f0\r\nnet.(*netFD).Write(0xc82001a1c0, 0xc8201a4000, 0x94, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/fd_unix.go:328 +0x1c7 fp=0xc82045fa00 sp=0xc82045f930\r\nnet.(*conn).Write(0xc82002c050, 0xc8201a4000, 0x94, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/net.go:184 +0xe4 fp=0xc82045fa68 sp=0xc82045fa00\r\nnet/http.checkConnErrorWriter.Write(0xc8200e2380, 0xc8201a4000, 0x94, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:2538 +0x71 fp=0xc82045fab8 sp=0xc82045fa68\r\nbufio.(*Writer).flush(0xc820058580, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/bufio/bufio.go:562 +0xe0 fp=0xc82045fb80 sp=0xc82045fab8\r\nbufio.(*Writer).Flush(0xc820058580, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/bufio/bufio.go:551 +0x2d fp=0xc82045fba0 sp=0xc82045fb80\r\nnet/http.(*response).finishRequest(0xc8204ad110)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:1251 +0xab fp=0xc82045fbd0 sp=0xc82045fba0\r\nnet/http.(*conn).serve(0xc8200e2380)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:1474 +0xf68 fp=0xc82045ff98 sp=0xc82045fbd0\r\nruntime.goexit()\r\n\t/home/ksh/work/os-code/go/src/runtime/asm_amd64.s:1998 +0x1 fp=0xc82045ffa0 sp=0xc82045ff98\r\ncreated by net/http.(*Server).Serve\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:2135 +0x44e\r\n\r\ngoroutine 1 [IO wait]:\r\nnet.runtime_pollWait(0x7f74a44f1138, 0x72, 0x0)\r\n\t/home/ksh/work/os-code/go/src/runtime/netpoll.go:160 +0x60\r\nnet.(*pollDesc).Wait(0xc82013a300, 0x72, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/fd_poll_runtime.go:73 +0x3a\r\nnet.(*pollDesc).WaitRead(0xc82013a300, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/fd_poll_runtime.go:78 +0x36\r\nnet.(*netFD).accept(0xc82013a2a0, 0x0, 0x7f74a44f13f8, 0xc82010c8a0)\r\n\t/home/ksh/work/os-code/go/src/net/fd_unix.go:426 +0x27c\r\nnet.(*TCPListener).AcceptTCP(0xc820128058, 0x459440, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/tcpsock_posix.go:254 +0x4d\r\nnet/http.tcpKeepAliveListener.Accept(0xc820128058, 0x0, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:2423 +0x41\r\nnet/http.(*Server).Serve(0xc82012a480, 0x7f74a44f15e0, 0xc820128058, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:2115 +0x129\r\nnet/http.(*Server).ListenAndServe(0xc82012a480, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:2096 +0x136\r\nnet/http.ListenAndServe(0x87ecd8, 0x5, 0x0, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:2193 +0x98\r\nmain.main()\r\n\t/home/ksh/work/go/src/github.com/kostya-sh/sandbox/tfb-go/app-files/src/hello/hello.go:147 +0x3aa\r\n\r\ngoroutine 17 [syscall, locked to thread]:\r\nruntime.goexit()\r\n\t/home/ksh/work/os-code/go/src/runtime/asm_amd64.s:1998 +0x1\r\n\r\ngoroutine 34 [IO wait]:\r\nnet.runtime_pollWait(0x7f74a44f0ef8, 0x72, 0xc82013f000)\r\n\t/home/ksh/work/os-code/go/src/runtime/netpoll.go:160 +0x60\r\nnet.(*pollDesc).Wait(0xc82015e060, 0x72, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/fd_poll_runtime.go:73 +0x3a\r\nnet.(*pollDesc).WaitRead(0xc82015e060, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/fd_poll_runtime.go:78 +0x36\r\nnet.(*netFD).Read(0xc82015e000, 0xc82013f000, 0x1000, 0x1000, 0x0, 0x7f74a4530050, 0xc82000a1d0)\r\n\t/home/ksh/work/os-code/go/src/net/fd_unix.go:250 +0x23a\r\nnet.(*conn).Read(0xc820162000, 0xc82013f000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/net.go:172 +0xe4\r\nnet/http.(*connReader).Read(0xc82010c840, 0xc82013f000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:526 +0x196\r\nbufio.(*Reader).fill(0xc82012e120)\r\n\t/home/ksh/work/os-code/go/src/bufio/bufio.go:97 +0x1e9\r\nbufio.(*Reader).ReadSlice(0xc82012e120, 0xa, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/bufio/bufio.go:328 +0x21a\r\nbufio.(*Reader).ReadLine(0xc82012e120, 0x0, 0x0, 0x0, 0x861800, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/bufio/bufio.go:357 +0x53\r\nnet/textproto.(*Reader).readLineSlice(0xc82048d800, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/textproto/reader.go:55 +0x81\r\nnet/textproto.(*Reader).ReadLine(0xc82048d800, 0x0, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/textproto/reader.go:36 +0x40\r\nnet/http.readRequest(0xc82012e120, 0x0, 0xc8203940e0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/request.go:707 +0xb6\r\nnet/http.(*conn).readRequest(0xc820166000, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:703 +0x359\r\nnet/http.(*conn).serve(0xc820166000)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:1423 +0x947\r\ncreated by net/http.(*Server).Serve\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:2135 +0x44e\r\n\r\ngoroutine 18 [chan receive]:\r\ndatabase/sql.(*DB).connectionOpener(0xc820130000)\r\n\t/home/ksh/work/os-code/go/src/database/sql/sql.go:728 +0x45\r\ncreated by database/sql.Open\r\n\t/home/ksh/work/os-code/go/src/database/sql/sql.go:494 +0x33f\r\n\r\ngoroutine 21 [runnable]:\r\nnet/textproto.(*Reader).ReadLine(0xc820410000, 0xc82029b7a0, 0xc820062c00, 0x457490, 0xc820062c00)\r\n\t/home/ksh/work/os-code/go/src/net/textproto/reader.go:35\r\nnet/http.readRequest(0xc82012e1e0, 0x0, 0xc82029b7a0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/request.go:707 +0xb6\r\nnet/http.(*conn).readRequest(0xc82012a700, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:703 +0x359\r\nnet/http.(*conn).serve(0xc82012a700)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:1423 +0x947\r\ncreated by net/http.(*Server).Serve\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:2135 +0x44e\r\n\r\ngoroutine 20 [trace reader (blocked)]:\r\nruntime.ReadTrace(0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/runtime/trace.go:356 +0x1cc\r\nruntime/trace.Start.func1(0x7f74a4534218, 0xc820128070)\r\n\t/home/ksh/work/os-code/go/src/runtime/trace/trace.go:28 +0x18\r\ncreated by runtime/trace.Start\r\n\t/home/ksh/work/os-code/go/src/runtime/trace/trace.go:34 +0x78\r\n\r\ngoroutine 22 [runnable]:\r\nnet.(*pollDesc).PrepareWrite(0xc82013a4c0, 0x944138, 0xc82013a460)\r\n\t/home/ksh/work/os-code/go/src/net/fd_poll_runtime.go:68\r\nnet.(*netFD).Write(0xc82013a460, 0xc82015a000, 0x94, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/fd_unix.go:323 +0x105\r\nnet.(*conn).Write(0xc8201280b0, 0xc82015a000, 0x94, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/net.go:184 +0xe4\r\nnet/http.checkConnErrorWriter.Write(0xc82012a880, 0xc82015a000, 0x94, 0x1000, 0x0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:2538 +0x71\r\nbufio.(*Writer).flush(0xc82011e7c0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/bufio/bufio.go:562 +0xe0\r\nbufio.(*Writer).Flush(0xc82011e7c0, 0x0, 0x0)\r\n\t/home/ksh/work/os-code/go/src/bufio/bufio.go:551 +0x2d\r\nnet/http.(*response).finishRequest(0xc8203961a0)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:1251 +0xab\r\nnet/http.(*conn).serve(0xc82012a880)\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:1474 +0xf68\r\ncreated by net/http.(*Server).Serve\r\n\t/home/ksh/work/os-code/go/src/net/http/server.go:2135 +0x44e\r\n```",
	"user": {
		"login": "kostya-sh",
		"id": 7126275,
		"type": "User",
		"site_admin": false
	},
	"assignee": {
		"login": "aclements",
		"id": 2688315,
		"type": "User",
		"site_admin": false
	},
	"comments": 4,
	"closed_at": "2016-01-27T02:22:32Z",
	"created_at": "2016-01-26T15:17:09Z",
	"updated_at": "2016-01-27T02:22:32Z",
	"milestone": {
		"id": 1096159,
		"number": 24,
		"title": "Go1.6"
	}
}
