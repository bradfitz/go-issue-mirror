{
	"id": 51278484,
	"number": 1920,
	"state": "closed",
	"title": "386 linux: string concat causes: \"runtime: memory allocated by OS not in usable range\"",
	"body": "by **goprogger@gmx.de**:\n\n\u003cpre\u003eBefore filing a bug, please check whether it has been fixed since\nthe latest release: run \u0026quot;hg pull -u\u0026quot; and retry what you did to\nreproduce the problem.  Thanks.\n\nWhat steps will reproduce the problem?\npackage main\n\nVersion 1.go:\n-------------\n\nimport (\n\t\u0026quot;fmt\u0026quot;\n\t\u0026quot;runtime\u0026quot;\n)\n\nfunc main() {\n\tF(15000000)\n}\n\nfunc F(n int) (r string) {\n\tr2 := \u0026quot;\u0026quot;\n\tfor len(r2 + r) \u0026lt; n {\n\t\tt := \u0026quot;\u0026quot;\n\n\t\tfor i := 0; i \u0026lt; 5000; i++ {\n\t\t\tt += \u0026quot;10\u0026quot;\n\t\t}\n\t\tr += t\n\n\t\tif len(r) \u0026gt; 1000000 {\n\t\t\tfmt.Printf(\u0026quot;Alloc:  %12d\\n\u0026quot;, runtime.MemStats.Alloc)\n\t\t\tr2 += r\n\t\t\tr = \u0026quot;\u0026quot;\n\t\t}\n\t}\n\n\tr2 += r\n\treturn r2[:n]\n}\n\nVersion 0.go (crushes ever faster):\n-----------------------------------\n\npackage main\n\nimport (\n\t\u0026quot;fmt\u0026quot;\n\t\u0026quot;runtime\u0026quot;\n\t\u0026quot;crypto/rand\u0026quot;\n)\n\nfunc main() {\n\tF(15000000)\n\n\tb := make([]byte, 1000)\n\t_, err := rand.Read(b)\n\tif err != nil {\n\t\treturn\n\t}\n}\n\nfunc F(n int) (r string) {\n\tr2 := \u0026quot;\u0026quot;\n\tfor len(r2 + r) \u0026lt; n {\n\t\tt := \u0026quot;\u0026quot;\n\n\t\tfor i := 0; i \u0026lt; 5000; i++ {\n\t\t\tt += \u0026quot;10\u0026quot;\n\t\t}\n\t\tr += t\n\n\t\tif len(r) \u0026gt; 1000000 {\n\t\t\tfmt.Printf(\u0026quot;Alloc:    %10d\\n\u0026quot;, runtime.MemStats.Alloc)\n\t\t\tr2 += r\n\t\t\tr = \u0026quot;\u0026quot;\n\t\t}\n\t}\n\n\tr2 += r\n\treturn r2[:n]\n}\n\n\nWhat is the expected output?\nOutput of 0.go compiled with 6g\n\nAlloc:       2730712\nAlloc:       4285864\nAlloc:       6966696\nAlloc:       6770088\nAlloc:      13104552\nAlloc:      13534632\nAlloc:      17578920\nAlloc:      19774376\nAlloc:      18771368\nAlloc:      17745320\nAlloc:      16735656\nAlloc:      16569768\nAlloc:      58090368\nAlloc:      60248960\n\n\nWhat do you see instead?\n\nOutput 386 0.go\n\nAlloc:       4590192\nAlloc:      18337264\nAlloc:      24819696\nAlloc:     354659856\nruntime: memory allocated by OS not in usable range\nruntime: out of memory: cannot allocate 4325376-byte block (535953408 in use)\nthrow: out of memory\n\nruntime.throw+0x43 /home/ubuntu/go/src/pkg/runtime/runtime.c:102\n\truntime.throw(0x80f3005, 0x413)\nruntime.mallocgc+0x2cd /home/ubuntu/go/src/pkg/runtime/malloc.c:60\n\truntime.mallocgc(0x4127b1, 0x0, 0x1, 0x1, 0x0, ...)\nruntime.mal+0x43 /home/ubuntu/go/src/pkg/runtime/malloc.c:289\n\truntime.mal(0x4127b1, 0x805bfb1)\nruntime.gostringsize+0x49 /home/ubuntu/go/src/pkg/runtime/string.c:40\n\truntime.gostringsize(0x80fe4c, 0x4127b0, 0x2710)\nconcatstring+0x79 /home/ubuntu/go/src/pkg/runtime/string.c:126\n\tconcatstring(0x80fe88, 0x2, 0x80fe78, 0x80fe78)\nruntime.concatstring+0x1f /home/ubuntu/go/src/pkg/runtime/string.c:141\n\truntime.concatstring(0x2, 0xaf067000, 0x3da540)\nmain.F+0x6a /home/ubuntu/test/0.go:21\n\tmain.F(0xe4e1c0, 0xb6c33000, 0x38270)\nmain.main+0x26 /home/ubuntu/test/0.go:10\n\tmain.main()\nruntime.mainstart+0xf /home/ubuntu/go/src/pkg/runtime/386/asm.s:93\n\truntime.mainstart()\nruntime.goexit /home/ubuntu/go/src/pkg/runtime/proc.c:178\n\truntime.goexit()\n----- goroutine created by -----\n_rt0_386+0xc1 /home/ubuntu/go/src/pkg/runtime/386/asm.s:80\n\n\n\n--------------------------------------------------------------------------\nOutput 386 1.go\n\nAlloc:       3840488\nAlloc:       4666216\nAlloc:       8051560\nAlloc:       6943592\nAlloc:       8584040\nAlloc:      13527912\nAlloc:      20775784\nAlloc:      91599424\nAlloc:     424534984\nruntime: memory allocated by OS not in usable range\nruntime: out of memory: cannot allocate 9175040-byte block (536805376 in use)\nthrow: out of memory\n\nruntime.throw+0x43 /home/ubuntu/go/src/pkg/runtime/runtime.c:102\n\truntime.throw(0x80e9005, 0x8b1)\nruntime.mallocgc+0x2cd /home/ubuntu/go/src/pkg/runtime/malloc.c:60\n\truntime.mallocgc(0x8b01f1, 0x0, 0x1, 0x1, 0x0, ...)\nruntime.mal+0x43 /home/ubuntu/go/src/pkg/runtime/malloc.c:289\n\truntime.mal(0x8b01f1, 0x805bf4a)\nruntime.gostringsize+0x49 /home/ubuntu/go/src/pkg/runtime/string.c:40\n\truntime.gostringsize(0x307e8c, 0x8b01f0, 0x2710)\nconcatstring+0x79 /home/ubuntu/go/src/pkg/runtime/string.c:126\n\tconcatstring(0x307ec8, 0x2, 0x307eb8, 0x307eb8)\nruntime.concatstring+0x1f /home/ubuntu/go/src/pkg/runtime/string.c:141\n\truntime.concatstring(0x2, 0xb5d6d000, 0x8ab3d0)\nmain.F+0x6a /home/ubuntu/test/1.go:14\n\tmain.F(0xe4e1c0, 0xb451f000, 0x4e20)\nmain.main+0x26 /home/ubuntu/test/1.go:9\n\tmain.main()\nruntime.mainstart+0xf /home/ubuntu/go/src/pkg/runtime/386/asm.s:93\n\truntime.mainstart()\nruntime.goexit /home/ubuntu/go/src/pkg/runtime/proc.c:178\n\truntime.goexit()\n----- goroutine created by -----\n_rt0_386+0xc1 /home/ubuntu/go/src/pkg/runtime/386/asm.s:80\n\nWhich compiler are you using (5g, 6g, 8g, gccgo)?\n8g\n\nWhich operating system are you using?\nubuntu 10.04, 10.10, 11.04\n\nWhich revision are you using?  (hg identify)\ne1e194eb5c8e (release-branch.r57)\n\nPlease provide any additional information below.\u003c/pre\u003e",
	"user": {
		"login": "gopherbot",
		"id": 8566911,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 1,
	"closed_at": "2014-12-08T10:10:35Z",
	"created_at": "2011-06-06T11:35:49Z",
	"updated_at": "2016-06-24T19:30:26Z"
}
