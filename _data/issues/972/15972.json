{
	"id": 158737725,
	"number": 15972,
	"state": "open",
	"title": "cmd/go, testing: race detector finding a data race doesn't fail a test",
	"body": "### Environment details:\r\n```\r\n$ go version\r\ngo version go1.6.2 linux/amd64\r\n```\r\n\r\n```\r\n$ go env\r\nGOARCH=\"amd64\"\r\nGOBIN=\"\"\r\nGOEXE=\"\"\r\nGOHOSTARCH=\"amd64\"\r\nGOHOSTOS=\"linux\"\r\nGOOS=\"linux\"\r\nGOPATH=\"/home/skuznets/Documents/go\"\r\nGORACE=\"\"\r\nGOROOT=\"/home/skuznets/.gvm/gos/go1.6.2\"\r\nGOTOOLDIR=\"/home/skuznets/.gvm/gos/go1.6.2/pkg/tool/linux_amd64\"\r\nGO15VENDOREXPERIMENT=\"1\"\r\nCC=\"gcc\"\r\nGOGCCFLAGS=\"-fPIC -m64 -pthread -fmessage-length=0\"\r\nCXX=\"g++\"\r\nCGO_ENABLED=\"1\"\r\n```\r\n\r\n### What did you do?\r\n\r\nRun a unit test with a data race using the following invocation:\r\n```\r\ngo test  -v -race -cover -covermode atomic -timeout 120s github.com/openshift/origin/pkg/service/controller/servingcert\r\n```\r\n\r\n### What did you expect to see?\r\n\r\nWhen the race detector is enabled and a data race is found, the unit test will fail.\r\n\r\n### What did you see instead?\r\n\r\nThe test passes, but the package fails:\r\n```\r\n=== RUN   TestSecretCreationErrorControllerFlow\r\nI0606 13:37:58.051502   25372 controller.go:132] Shutting down service signing cert controller\r\n==================\r\nWARNING: DATA RACE\r\nWrite by goroutine 54:\r\n  runtime.mapassign1()\r\n      /home/skuznets/.gvm/gos/go1.6.2/src/runtime/hashmap.go:429 +0x0\r\n  github.com/openshift/origin/pkg/service/controller/servingcert.(*ServiceServingCertController).syncService()\r\n      github.com/openshift/origin/pkg/service/controller/servingcert/_test/_obj_test/controller.go:288 +0x21af\r\n  github.com/openshift/origin/pkg/service/controller/servingcert.TestAlreadyExistingSecretForDifferentUIDControllerFlow.func2()\r\n      /home/skuznets/Documents/go/src/github.com/openshift/origin/pkg/service/controller/servingcert/controller_test.go:234 +0xc2\r\n  github.com/openshift/origin/pkg/service/controller/servingcert.(*ServiceServingCertController).worker_inner()\r\n      github.com/openshift/origin/pkg/service/controller/servingcert/_test/_obj_test/controller.go:173 +0x20e\r\n  github.com/openshift/origin/pkg/service/controller/servingcert.(*ServiceServingCertController).worker()\r\n      github.com/openshift/origin/pkg/service/controller/servingcert/_test/_obj_test/controller.go:155 +0x6a\r\n  github.com/openshift/origin/pkg/service/controller/servingcert.(*ServiceServingCertController).(github.com/openshift/origin/pkg/service/controller/servingcert.worker)-fm()\r\n      github.com/openshift/origin/pkg/service/controller/servingcert/_test/_obj_test/controller.go:127 +0x2d\r\n  k8s.io/kubernetes/pkg/util/wait.JitterUntil.func1()\r\n      /home/skuznets/Documents/go/src/github.com/openshift/origin/Godeps/_workspace/src/k8s.io/kubernetes/pkg/util/wait/wait.go:66 +0x58\r\n  k8s.io/kubernetes/pkg/util/wait.JitterUntil()\r\n      /home/skuznets/Documents/go/src/github.com/openshift/origin/Godeps/_workspace/src/k8s.io/kubernetes/pkg/util/wait/wait.go:67 +0x7d\r\n  k8s.io/kubernetes/pkg/util/wait.Until()\r\n      /home/skuznets/Documents/go/src/github.com/openshift/origin/Godeps/_workspace/src/k8s.io/kubernetes/pkg/util/wait/wait.go:47 +0x4b\r\n\r\nPrevious read by goroutine 50:\r\n  reflect.maplen()\r\n      /home/skuznets/.gvm/gos/go1.6.2/src/runtime/hashmap.go:1029 +0x0\r\n  reflect.Value.Len()\r\n      /home/skuznets/.gvm/gos/go1.6.2/src/reflect/value.go:1007 +0x150\r\n  reflect.deepValueEqual()\r\n      /home/skuznets/.gvm/gos/go1.6.2/src/reflect/deepequal.go:106 +0xa14\r\n  reflect.DeepEqual()\r\n      /home/skuznets/.gvm/gos/go1.6.2/src/reflect/deepequal.go:185 +0x263\r\n  github.com/openshift/origin/pkg/service/controller/servingcert.TestAlreadyExistingSecretForDifferentUIDControllerFlow()\r\n      /home/skuznets/Documents/go/src/github.com/openshift/origin/pkg/service/controller/servingcert/controller_test.go:269 +0x163b\r\n  testing.tRunner()\r\n      /home/skuznets/.gvm/gos/go1.6.2/src/testing/testing.go:473 +0xdc\r\n\r\nGoroutine 54 (running) created at:\r\n  github.com/openshift/origin/pkg/service/controller/servingcert.(*ServiceServingCertController).Run()\r\n      github.com/openshift/origin/pkg/service/controller/servingcert/_test/_obj_test/controller.go:127 +0x180\r\n\r\nGoroutine 50 (finished) created at:\r\n  testing.RunTests()\r\n      /home/skuznets/.gvm/gos/go1.6.2/src/testing/testing.go:582 +0xae2\r\n  testing.(*M).Run()\r\n      /home/skuznets/.gvm/gos/go1.6.2/src/testing/testing.go:515 +0x11d\r\n  main.main()\r\n      github.com/openshift/origin/pkg/service/controller/servingcert/_test/_testmain.go:108 +0x385\r\n==================\r\n--- PASS: TestSecretCreationErrorControllerFlow (13.63s)\r\ncoverage: 81.2% of statements\r\nFound 1 data race(s)\r\nFAIL\tgithub.com/openshift/origin/pkg/service/controller/servingcert\t37.923s\r\n```\r\n\r\n",
	"user": {
		"login": "stevekuznetsov",
		"id": 7328370,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "NeedsFix"
		}
	],
	"comments": 1,
	"created_at": "2016-06-06T18:01:32Z",
	"updated_at": "2016-10-21T13:13:55Z",
	"milestone": {
		"id": 1709363,
		"number": 38,
		"title": "Go1.8"
	}
}
