{
	"id": 154361346,
	"number": 15655,
	"state": "closed",
	"title": "runtime: Some delay-loaded system DLLs fail to load on Windows Server 2016",
	"body": "**1. What version of Go are you using (`go version`)?**\r\n\r\ngo version go1.6.2 windows/amd64\r\n\r\n**2. What operating system and processor architecture are you using (`go env`)?**\r\n\r\nWindows Server 2016 Technical Preview 5 (x64)\r\n\r\n**3. What did you do?**\r\n\r\nCompile the example code for [`rand.Read`](https://golang.org/pkg/crypto/rand/#Read):\r\n\r\n```\r\n\u003e type test.go\r\n\r\npackage main\r\n\r\nimport (\r\n        \"bytes\"\r\n        \"crypto/rand\"\r\n        \"fmt\"\r\n)\r\n\r\nfunc main() {\r\n        c := 10\r\n        b := make([]byte, c)\r\n        _, err := rand.Read(b)\r\n        if err != nil {\r\n                fmt.Println(\"error:\", err)\r\n                return\r\n        }\r\n        // The slice should now contain random bytes instead of only zeroes.\r\n        fmt.Println(bytes.Equal(b, make([]byte, c)))\r\n}\r\n\r\n\u003e go build test.go\r\n```\r\n\r\nAnd then try to run it:\r\n\r\n```\r\n\u003e test.exe\r\nerror: CryptAcquireContext: The specified procedure could not be found.\r\n```\r\n\r\n**4. What did you expect to see?**\r\n\r\nExpected the correct output for the program: `false`.\r\n\r\n**5. What did you see instead?**\r\n\r\nAn error returned from `rand.Read` regarding `CryptAcquireContext`. Other entry points from other DLLs are also affected. This breaks a large amount of functionality, e.g. `go get` for SSH remotes.\r\n\r\n**Additional information**\r\n\r\nI traced this to a problem somewhere in the Windows loader when trying to resolve DLL paths for certain delay-loaded libraries. I don't know if this is a Go bug or a Windows bug.\r\n\r\nIn the example above the problem is caused when the first call to `advapi32!CryptAcquireContextW` in [`rand.Read`](https://github.com/golang/go/blob/683448a304a3871039ab44fc01e839f05ac36f05/src/crypto/rand/rand_windows.go#L31) triggers the delay load of `cryptsp.dll` to resolve that forwarded export (`advapi32.dll` doesn't implement that API, `cryptsp.dll` does). For some reason this delay load fails and all forwarded crypto entry points in `advapi32.dll` are then replaced with a stub that always returns an error.\r\n\r\nThe reason for the delay load failure is mysterious, but it's somehow related to `LdrpComputeLazyDllPath` in `ntdll.dll`. You can see some relevant error messages from the Windows loader if you turn on loader snaps via [`gflags`](https://msdn.microsoft.com/en-us/library/windows/hardware/ff549557(v=vs.85).aspx) for the `test.exe` binary, as explained [here](https://blogs.msdn.microsoft.com/junfeng/2006/11/20/debugging-loadlibrary-failures/):\r\n\r\n1. Install the [Windows 10 SDK](https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk) so you get `gflags` and the debuggers.\r\n2. Enable loader snaps: `\"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\gflags.exe\" -i test.exe +sls`\r\n3. Run `test.exe` under the debugger to dump the loader debug output: `\"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\cdb.exe\" -c \"g; q\" test.exe \u003e test.txt`\r\n\r\nYou should get some very verbose output. Now grep for `LdrpComputeLazyDllPath` and you should see two occurrences, one for `tsappcmp.dll` which works fine and then one for `cryptsp.dll` which doesn't:\r\n\r\n```\r\n\u003e type test.txt | grep LdrpComputeLazyDllPath -B 5 -A 6\r\n\r\n1e9c:147c @ 103841203 - LdrLoadDll - ENTER: DLL name: tsappcmp.dll\r\n1e9c:147c @ 103841203 - LdrpLoadDllInternal - ENTER: DLL name: tsappcmp.dll\r\n1e9c:147c @ 103841203 - LdrpFindKnownDll - ENTER: DLL name: tsappcmp.dll\r\n1e9c:147c @ 103841203 - LdrpFindKnownDll - RETURN: Status: 0xc0000135\r\n1e9c:147c @ 103841203 - LdrpSearchPath - ENTER: DLL name: tsappcmp.dll\r\n1e9c:147c @ 103841203 - LdrpComputeLazyDllPath - INFO: DLL search path computed: C:\\Windows\\SYSTEM32\r\n1e9c:147c @ 103841203 - LdrpResolveDllName - ENTER: DLL name: C:\\Windows\\SYSTEM32\\tsappcmp.dll\r\n1e9c:147c @ 103841203 - LdrpResolveDllName - RETURN: Status: 0x00000000\r\n1e9c:147c @ 103841203 - LdrpSearchPath - RETURN: Status: 0x00000000\r\n1e9c:147c @ 103841203 - LdrpMapViewOfSection - ENTER: DLL name: C:\\Windows\\SYSTEM32\\tsappcmp.dll\r\nModLoad: 00007ffb`1bbf0000 00007ffb`1bc0a000   C:\\Windows\\SYSTEM32\\tsappcmp.dll\r\n1e9c:147c @ 103841203 - LdrpMapViewOfSection - RETURN: Status: 0x00000000\r\n\r\n---\r\n\r\n1e9c:147c @ 103842156 - LdrpGetProcedureAddress - INFO: Locating procedure \"LoadLibraryExW\" by name\r\n1e9c:147c @ 103842156 - LdrpLoadDllInternal - ENTER: DLL name: CRYPTSP.dll\r\n1e9c:147c @ 103842156 - LdrpFindKnownDll - ENTER: DLL name: CRYPTSP.dll\r\n1e9c:147c @ 103842171 - LdrpFindKnownDll - RETURN: Status: 0xc0000135\r\n1e9c:147c @ 103842171 - LdrpSearchPath - ENTER: DLL name: CRYPTSP.dll\r\n1e9c:147c @ 103842171 - LdrpComputeLazyDllPath - INFO: DLL search path computed: ??\r\n1e9c:147c @ 103842171 - LdrpResolveDllName - ENTER: DLL name: ??\\CRYPTSP.dll\r\n1e9c:147c @ 103842171 - LdrpResolveDllName - RETURN: Status: 0xc0000135\r\n1e9c:147c @ 103842171 - LdrpSearchPath - RETURN: Status: 0xc0000135\r\n1e9c:147c @ 103842171 - LdrpProcessWork - ERROR: Unable to load DLL: \"CRYPTSP.dll\", Parent Module: \"C:\\Windows\\system32\\ADVAPI32.dll\", Status: 0xc0000135\r\n1e9c:147c @ 103842171 - LdrpLoadDllInternal - RETURN: Status: 0xc0000135\r\n1e9c:147c @ 103842171 - LdrpRedirectDelayloadFailure - ERROR: Failed to find export CRYPTSP.dll!CryptAcquireContextW (Ordinal:0) in \"ADVAPI32.dll\"  0xc0000135\r\n```\r\n\r\nThe critical lines are:\r\n\r\n```\r\n1e9c:147c @ 103842171 - LdrpComputeLazyDllPath - INFO: DLL search path computed: ??\r\n1e9c:147c @ 103842171 - LdrpResolveDllName - ENTER: DLL name: ??\\CRYPTSP.dll\r\n```\r\n\r\nFor some reason the loader is unable to compute the DLL path for `cryptsp.dll`, but it can do so fine for other DLLs.\r\n\r\nIt's not just `cryptsp.dll` that fails to load. There are at least 4 other delay-loaded DLLs with the same problem (`iphlpapi.dll`, `userenv.dll`, `netapi32.dll`, `secur32.dll`). You can see these other failed loads by running the Go unit tests:\r\n\r\n```\r\n\u003e cd %GOROOT%\\src\r\n\u003e run.bat\r\n##### Testing packages.\r\nok  \tarchive/tar\t2.156s\r\nok  \tarchive/zip\t1.781s\r\nok  \tbufio\t2.031s\r\nok  \tbytes\t1.641s\r\nok  \tcompress/bzip2\t1.078s\r\nok  \tcompress/flate\t3.780s\r\nok  \tcompress/gzip\t1.391s\r\nok  \tcompress/lzw\t0.392s\r\nok  \tcompress/zlib\t1.344s\r\nok  \tcontainer/heap\t0.578s\r\nok  \tcontainer/list\t0.594s\r\nok  \tcontainer/ring\t0.328s\r\nok  \tcrypto/aes\t1.188s\r\n--- FAIL: ExampleNewCTR (0.00s)\r\npanic: CryptAcquireContext: The specified procedure could not be found. [recovered]\r\n\tpanic: CryptAcquireContext: The specified procedure could not be found.\r\n\r\ngoroutine 1 [running]:\r\npanic(0x59a4e0, 0xc082002e60)\r\n\tC:/Go/src/runtime/panic.go:481 +0x3f4\r\ntesting.runExample.func2(0xecec5ad98, 0xc010d8236c, 0x6ccce0, 0xc08202c068, 0xc08202c010, 0xc082010d20, 0x5dbf00, 0xd, 0x627640, 0x5e16c0, ...)\r\n\tC:/Go/src/testing/example.go:93 +0x401\r\npanic(0x59a4e0, 0xc082002e60)\r\n\tC:/Go/src/runtime/panic.go:443 +0x4f7\r\ncrypto/cipher_test.ExampleNewCTR()\r\n\tC:/Go/src/crypto/cipher/example_test.go:207 +0x221\r\ntesting.runExample(0x5dbf00, 0xd, 0x627640, 0x5e16c0, 0xf, 0x0)\r\n\tC:/Go/src/testing/example.go:98 +0x3de\r\ntesting.RunExamples(0x6276d8, 0x6c9980, 0x4, 0x4, 0x1)\r\n\tC:/Go/src/testing/example.go:36 +0x31b\r\ntesting.(*M).Run(0xc082037ee8, 0x1)\r\n\tC:/Go/src/testing/testing.go:516 +0xc4\r\nmain.main()\r\n\tcrypto/cipher/_test/_testmain.go:104 +0x11e\r\nFAIL\tcrypto/cipher\t2.141s\r\nok  \tcrypto/des\t1.172s\r\n--- FAIL: TestSignAndVerify (0.00s)\r\n\tdsa_test.go:17: 0: error signing: CryptAcquireContext: The specified procedure could not be found.\r\nFAIL\r\nFAIL\tcrypto/dsa\t0.391s\r\n--- FAIL: TestKeyGeneration (0.00s)\r\n\tecdsa_test.go:27: p224: error: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestSignAndVerify (0.00s)\r\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal 0xc0000005 code=0x1 addr=0x0 pc=0x483002]\r\n\r\ngoroutine 7 [running]:\r\npanic(0x5d19a0, 0xc082006110)\r\n\tC:/Go/src/runtime/panic.go:481 +0x3f4\r\ntesting.tRunner.func1(0xc082080090)\r\n\tC:/Go/src/testing/testing.go:467 +0x199\r\npanic(0x5d19a0, 0xc082006110)\r\n\tC:/Go/src/runtime/panic.go:443 +0x4f7\r\ncrypto/ecdsa.Sign(0x9844f0, 0xc0820065d0, 0x0, 0xc082006718, 0x7, 0x8, 0x0, 0x0, 0x0, 0x0)\r\n\tC:/Go/src/crypto/ecdsa/ecdsa.go:152 +0x8e2\r\ncrypto/ecdsa.testSignAndVerify(0xc082080090, 0x984600, 0xc08200e3f0, 0x60b1c8, 0x4)\r\n\tC:/Go/src/crypto/ecdsa/ecdsa_test.go:84 +0xf2\r\ncrypto/ecdsa.TestSignAndVerify(0xc082080090)\r\n\tC:/Go/src/crypto/ecdsa/ecdsa_test.go:101 +0x63\r\ntesting.tRunner(0xc082080090, 0x70b678)\r\n\tC:/Go/src/testing/testing.go:473 +0x9f\r\ncreated by testing.RunTests\r\n\tC:/Go/src/testing/testing.go:582 +0x899\r\nFAIL\tcrypto/ecdsa\t0.672s\r\n--- FAIL: TestMarshal (0.00s)\r\n\telliptic_test.go:460: CryptAcquireContext: The specified procedure could not be found.\r\nFAIL\r\nFAIL\tcrypto/elliptic\t1.375s\r\nok  \tcrypto/hmac\t0.686s\r\nok  \tcrypto/md5\t1.391s\r\n--- FAIL: TestRead (0.00s)\r\n\trand_test.go:22: ReadFull(buf) = 0, CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestReadEmpty (0.00s)\r\n\trand_test.go:37: Read(make([]byte, 0)) = 0, CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestPrimeSmall (0.00s)\r\n\tutil_test.go:18: Can't generate 2-bit prime: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestInt (0.00s)\r\n\tutil_test.go:41: Can't generate random value: \u003cnil\u003e, CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: ExampleRead (0.00s)\r\ngot:\r\nerror: CryptAcquireContext: The specified procedure could not be found.\r\nwant:\r\nfalse\r\nFAIL\r\nFAIL\tcrypto/rand\t1.891s\r\nok  \tcrypto/rc4\t1.094s\r\n--- FAIL: TestEncryptPKCS1v15 (0.00s)\r\n\tpkcs1v15_test.go:88: error encrypting: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestEncryptPKCS1v15DecrypterSessionKey (0.00s)\r\n\tpkcs1v15_test.go:156: #0: error decrypting: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestNonZeroRandomBytes (0.00s)\r\n\tpkcs1v15_test.go:174: returned error: CryptAcquireContext: The specified procedure could not be found.\r\n\tpkcs1v15_test.go:178: Zero octet found\r\n--- FAIL: TestShortSessionKey (0.00s)\r\n\tpkcs1v15_test.go:262: Failed to encrypt short message: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestPSSSigning (0.00s)\r\n\tpss_test.go:224: #0: error while signing: CryptAcquireContext: The specified procedure could not be found.\r\n\tpss_test.go:224: #1: error while signing: CryptAcquireContext: The specified procedure could not be found.\r\n\tpss_test.go:224: #2: error while signing: CryptAcquireContext: The specified procedure could not be found.\r\n\tpss_test.go:224: #3: error while signing: CryptAcquireContext: The specified procedure could not be found.\r\n\tpss_test.go:224: #4: error while signing: CryptAcquireContext: The specified procedure could not be found.\r\n\tpss_test.go:224: #5: error while signing: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestKeyGeneration (0.00s)\r\n\trsa_test.go:24: failed to generate key\r\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal 0xc0000005 code=0x0 addr=0x0 pc=0x48f3b8]\r\n\r\ngoroutine 49 [running]:\r\npanic(0x5bac40, 0xc082006110)\r\n\tC:/Go/src/runtime/panic.go:481 +0x3f4\r\ntesting.tRunner.func1(0xc082522f30)\r\n\tC:/Go/src/testing/testing.go:467 +0x199\r\npanic(0x5bac40, 0xc082006110)\r\n\tC:/Go/src/runtime/panic.go:443 +0x4f7\r\ncrypto/rsa.TestKeyGeneration(0xc082522f30)\r\n\tC:/Go/src/crypto/rsa/rsa_test.go:26 +0xe8\r\ntesting.tRunner(0xc082522f30, 0x6e95e8)\r\n\tC:/Go/src/testing/testing.go:473 +0x9f\r\ncreated by testing.RunTests\r\n\tC:/Go/src/testing/testing.go:582 +0x899\r\nFAIL\tcrypto/rsa\t1.969s\r\nok  \tcrypto/sha1\t0.485s\r\nok  \tcrypto/sha256\t0.841s\r\nok  \tcrypto/sha512\t0.844s\r\nok  \tcrypto/subtle\t0.297s\r\n--- FAIL: TestClientResumption (0.00s)\r\n\thandshake_client_test.go:445: Handshake: handshake failed: remote error: internal error\r\npanic: test timed out after 6m0s\r\n\r\ngoroutine 97 [running]:\r\npanic(0x67b4c0, 0xc0825cc050)\r\n\tC:/Go/src/runtime/panic.go:481 +0x3f4\r\ntesting.startAlarm.func1()\r\n\tC:/Go/src/testing/testing.go:725 +0x152\r\ncreated by time.goFunc\r\n\tC:/Go/src/time/sleep.go:129 +0x41\r\n\r\ngoroutine 1 [chan receive, 5 minutes]:\r\ntesting.RunTests(0x7be5a0, 0x8bf120, 0x40, 0x40, 0x0)\r\n\tC:/Go/src/testing/testing.go:583 +0x8d9\r\ntesting.(*M).Run(0xc082325ef8, 0xc08207de60)\r\n\tC:/Go/src/testing/testing.go:515 +0x88\r\nmain.main()\r\n\tcrypto/tls/_test/_testmain.go:182 +0x11e\r\n\r\ngoroutine 82 [semacquire, 5 minutes]:\r\nsync.runtime_Syncsemacquire(0xc0820876f8)\r\n\tC:/Go/src/runtime/sema.go:241 +0x20f\r\nsync.(*Cond).Wait(0xc0820876e8)\r\n\tC:/Go/src/sync/cond.go:63 +0xa2\r\nio.(*pipe).write(0xc082087680, 0xc08231cb8a, 0x5, 0x5, 0x0, 0x0, 0x0)\r\n\tC:/Go/src/io/pipe.go:94 +0x241\r\nio.(*PipeWriter).Write(0xc08202c158, 0xc08231cb8a, 0x5, 0x5, 0x0, 0x0, 0x0)\r\n\tC:/Go/src/io/pipe.go:161 +0x57\r\ncrypto/tls.TestServerSelectingUnconfiguredCipherSuite(0xc0825c85a0)\r\n\tC:/Go/src/crypto/tls/handshake_client_test.go:689 +0x9ce\r\ntesting.tRunner(0xc0825c85a0, 0x8bf2d0)\r\n\tC:/Go/src/testing/testing.go:473 +0x9f\r\ncreated by testing.RunTests\r\n\tC:/Go/src/testing/testing.go:582 +0x899\r\nFAIL\tcrypto/tls\t361.078s\r\n--- FAIL: TestEncrypt (0.00s)\r\n\tpem_decrypt_test.go:43: test 0. 1\r\n\tpem_decrypt_test.go:51: encrypt:  x509: cannot generate IV: CryptAcquireContext: The specified procedure could not be found.\r\n\tpem_decrypt_test.go:43: test 1. 2\r\n\tpem_decrypt_test.go:51: encrypt:  x509: cannot generate IV: CryptAcquireContext: The specified procedure could not be found.\r\n\tpem_decrypt_test.go:43: test 2. 3\r\n\tpem_decrypt_test.go:51: encrypt:  x509: cannot generate IV: CryptAcquireContext: The specified procedure could not be found.\r\n\tpem_decrypt_test.go:43: test 3. 4\r\n\tpem_decrypt_test.go:51: encrypt:  x509: cannot generate IV: CryptAcquireContext: The specified procedure could not be found.\r\n\tpem_decrypt_test.go:43: test 4. 5\r\n\tpem_decrypt_test.go:51: encrypt:  x509: cannot generate IV: CryptAcquireContext: The specified procedure could not be found.\r\n\tpem_decrypt_test.go:43: test 5. 3\r\n\tpem_decrypt_test.go:51: encrypt:  x509: cannot generate IV: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestSystemVerify (0.40s)\r\n\tverify_test.go:358: #1: unexpected error: winapi error #3221225594\r\n\tverify_test.go:367: #1: wanted 1 chains, got 0\r\n\tverify_test.go:358: #2: unexpected error: winapi error #3221225594\r\n\tverify_test.go:367: #2: wanted 1 chains, got 0\r\n\tverify_test.go:242: #3: error was not a HostnameError: winapi error #3221225594\r\n--- FAIL: TestCreateSelfSignedCertificate (0.00s)\r\n\tx509_test.go:325: Failed to generate ECDSA key: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestUnknownCriticalExtension (0.00s)\r\n\tx509_test.go:507: Failed to generate ECDSA key: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestCRLCreation (0.14s)\r\n\tx509_test.go:793: error creating CRL: CryptAcquireContext: The specified procedure could not be found.\r\n\tx509_test.go:798: error reparsing CRL: asn1: syntax error: sequence truncated\r\n--- FAIL: TestImports (2.39s)\r\n\tx509_test.go:866: failed to run x509_test_import.go: exit status 1\r\n--- FAIL: TestCreateCertificateRequest (0.00s)\r\n\tx509_test.go:885: Failed to generate ECDSA key: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestCertificateRequestOverrides (0.00s)\r\n\tx509_test.go:962: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestMaxPathLen (0.00s)\r\n\tx509_test.go:1138: failed to create certificate: CryptAcquireContext: The specified procedure could not be found.\r\nFAIL\r\nFAIL\tcrypto/x509\t3.750s\r\nok  \tdatabase/sql\t0.906s\r\nok  \tdatabase/sql/driver\t0.719s\r\nok  \tdebug/dwarf\t0.906s\r\nok  \tdebug/elf\t0.954s\r\nok  \tdebug/gosym\t1.312s\r\nok  \tdebug/macho\t0.719s\r\nok  \tdebug/pe\t1.610s\r\nok  \tdebug/plan9obj\t0.500s\r\nok  \tencoding/ascii85\t1.016s\r\nok  \tencoding/asn1\t1.000s\r\nok  \tencoding/base32\t0.892s\r\nok  \tencoding/base64\t0.766s\r\nok  \tencoding/binary\t0.938s\r\nok  \tencoding/csv\t0.484s\r\nok  \tencoding/gob\t0.782s\r\nok  \tencoding/hex\t0.423s\r\nok  \tencoding/json\t1.906s\r\nok  \tencoding/pem\t0.456s\r\nok  \tencoding/xml\t0.501s\r\nok  \terrors\t0.844s\r\nok  \texpvar\t0.938s\r\nok  \tflag\t1.016s\r\nok  \tfmt\t0.845s\r\nok  \tgo/ast\t0.781s\r\nok  \tgo/build\t1.922s\r\nok  \tgo/constant\t1.453s\r\nok  \tgo/doc\t1.484s\r\nok  \tgo/format\t0.875s\r\nok  \tgo/internal/gccgoimporter\t0.984s\r\nok  \tgo/internal/gcimporter\t1.610s\r\nok  \tgo/parser\t1.094s\r\nok  \tgo/printer\t1.564s\r\nok  \tgo/scanner\t0.856s\r\nok  \tgo/token\t0.406s\r\nok  \tgo/types\t2.532s\r\nok  \thash/adler32\t0.326s\r\nok  \thash/crc32\t0.952s\r\nok  \thash/crc64\t0.938s\r\nok  \thash/fnv\t0.500s\r\nok  \thtml\t0.328s\r\nok  \thtml/template\t1.031s\r\nok  \timage\t1.453s\r\nok  \timage/color\t0.453s\r\nok  \timage/draw\t0.797s\r\nok  \timage/gif\t1.391s\r\nok  \timage/jpeg\t1.766s\r\nok  \timage/png\t1.875s\r\nok  \tindex/suffixarray\t0.467s\r\nok  \tinternal/golang.org/x/net/http2/hpack\t0.688s\r\nok  \tinternal/singleflight\t0.344s\r\n--- FAIL: TestGetMUIStringValue (0.00s)\r\n\tregistry_test.go:718: GetMUIStringValue: MUI_Std: Got \"Pacific Standard Time\", want \"@tzres.dll,-212\"\r\n\tregistry_test.go:718: GetMUIStringValue: MUI_Dlt: Got \"Pacific Daylight Time\", want \"@tzres.dll,-211\"\r\nFAIL\r\nFAIL\tinternal/syscall/windows/registry\t0.781s\r\nok  \tinternal/trace\t0.628s\r\nok  \tio\t1.110s\r\nok  \tio/ioutil\t1.234s\r\nok  \tlog\t0.672s\r\nok  \tmath\t0.656s\r\nok  \tmath/big\t1.250s\r\nok  \tmath/cmplx\t1.127s\r\nok  \tmath/rand\t0.828s\r\nok  \tmime\t0.563s\r\npanic: CryptAcquireContext: The specified procedure could not be found.\r\n\r\ngoroutine 1 [running]:\r\npanic(0x5fddc0, 0xc082002c00)\r\n\tC:/Go/src/runtime/panic.go:481 +0x3f4\r\nmime/multipart.randomBoundary(0x0, 0x0)\r\n\tC:/Go/src/mime/multipart/writer.go:76 +0xef\r\nmime/multipart.NewWriter(0x9f8808, 0xc08200e0e0, 0x787478)\r\n\tC:/Go/src/mime/multipart/writer.go:29 +0x23\r\nmime/multipart.roundTripParseTest(0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n\tC:/Go/src/mime/multipart/multipart_test.go:798 +0xdf9\r\nmime/multipart.init()\r\n\tC:/Go/src/mime/multipart/multipart_test.go:700 +0x1ddd\r\nmain.init()\r\n\tmime/multipart/_test/_testmain.go:94 +0x51\r\nFAIL\tmime/multipart\t0.500s\r\nok  \tmime/quotedprintable\t1.859s\r\npanic: Failed to load iphlpapi.dll: The specified module could not be found.\r\n\r\ngoroutine 1 [running]:\r\npanic(0x6e3b00, 0xc082062cc0)\r\n\tC:/Go/src/runtime/panic.go:481 +0x3f4\r\nsyscall.(*LazyProc).mustFind(0xc082005fb0)\r\n\tC:/Go/src/syscall/dll_windows.go:280 +0x6a\r\nsyscall.(*LazyProc).Addr(0xc082005fb0, 0x0)\r\n\tC:/Go/src/syscall/dll_windows.go:287 +0x28\r\ninternal/syscall/windows.GetAdaptersAddresses(0x1000000000, 0x0, 0xc08207c000, 0xc082079374, 0x0, 0x0)\r\n\tC:/Go/src/internal/syscall/windows/zsyscall_windows.go:23 +0x42\r\nnet.adapterAddresses(0x0, 0x0, 0x0, 0x0, 0x0)\r\n\tC:/Go/src/net/interface_windows.go:42 +0xf3\r\nnet.interfaceTable(0x0, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n\tC:/Go/src/net/interface_windows.go:67 +0x5a\r\nnet.Interfaces(0x0, 0x0, 0x0, 0x0, 0x0)\r\n\tC:/Go/src/net/interface.go:89 +0x4e\r\nnet.loopbackInterface(0x7078e0)\r\n\tC:/Go/src/net/interface_test.go:17 +0x2b\r\nnet.setupTestData()\r\n\tC:/Go/src/net/main_test.go:94 +0x157b\r\nnet.TestMain(0xc082079ed8)\r\n\tC:/Go/src/net/main_test.go:47 +0x1f\r\nmain.main()\r\n\tnet/_test/_testmain.go:396 +0x11b\r\nFAIL\tnet\t0.750s\r\n--- FAIL: TestReadResponseCloseInMiddle (0.03s)\r\n\tresponse_test.go:568: on test chunked=true, compressed=true: rand.Reader ReadFull: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33764: remote error: internal error\r\n--- FAIL: TestClientHead_h2 (0.00s)\r\n\tclient_test.go:94: Head https://127.0.0.1:33763: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33778: remote error: internal error\r\n--- FAIL: TestStreamingGet_h2 (0.00s)\r\n\tclient_test.go:531: Get https://127.0.0.1:33777: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestClientInsecureTransport (0.00s)\r\n\tclient_test.go:623: insecure=true: got unexpected err=Get https://127.0.0.1:33781: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33785: remote error: internal error\r\n--- FAIL: TestClientWithCorrectTLSServerName (0.00s)\r\n\tclient_test.go:685: expected successful TLS connection, got error: Get https://127.0.0.1:33784: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestClientWithIncorrectTLSServerName (0.00s)\r\n\tclient_test.go:704: wanted error mentioning 127.0.0.1 and badserver; got error: Get https://127.0.0.1:33786: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33789: remote error: internal error\r\n--- FAIL: TestTransportUsesTLSConfigServerName (0.00s)\r\n\tclient_test.go:741: Get https://some-other-host.tld/: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33791: remote error: internal error\r\n--- FAIL: TestResponseSetsTLSConnectionState (0.00s)\r\n\tclient_test.go:762: Get https://example.com/: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestHTTPSClientDetectsHTTPServer (0.00s)\r\n\tclient_test.go:783: error = \"Get https://127.0.0.1:33792: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\"; want error indicating HTTP response to HTTPS request\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33797: remote error: internal error\r\n--- FAIL: TestClientHeadContentLength_h2 (0.02s)\r\n\tclient_test.go:816: Head https://127.0.0.1:33796/?cl=1234: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33803: remote error: internal error\r\n--- FAIL: TestClientRedirectEatsBody_h2 (0.00s)\r\n\tclient_test.go:1072: Get https://127.0.0.1:33802: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33807: remote error: internal error\r\n--- FAIL: TestNewClientServerTest (0.00s)\r\n\tclientserver_test.go:101: Head https://127.0.0.1:33806: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n--- FAIL: TestChunkedResponseHeaders_h2 (0.00s)\r\n\tclientserver_test.go:127: Get error: Get https://127.0.0.1:33810: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33815: remote error: internal error\r\n--- FAIL: TestH12_HeadContentLengthNoBody (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Head https://127.0.0.1:33813: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33819: remote error: internal error\r\n--- FAIL: TestH12_HeadContentLengthSmallBody (0.02s)\r\n\tclientserver_test.go:176: HTTP/2 request: Head https://127.0.0.1:33817: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33823: remote error: internal error\r\n--- FAIL: TestH12_HeadContentLengthLargeBody (0.05s)\r\n\tclientserver_test.go:176: HTTP/2 request: Head https://127.0.0.1:33821: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33827: remote error: internal error\r\n--- FAIL: TestH12_200NoBody (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33825: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33831: remote error: internal error\r\n--- FAIL: TestH2_204NoBody (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33829: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33835: remote error: internal error\r\n--- FAIL: TestH2_304NoBody (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33833: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33839: remote error: internal error\r\n--- FAIL: TestH2_404NoBody (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33837: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33843: remote error: internal error\r\n--- FAIL: TestH12_SmallBody (0.02s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33841: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33847: remote error: internal error\r\n--- FAIL: TestH12_ExplicitContentLength (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33845: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33851: remote error: internal error\r\n--- FAIL: TestH12_FlushBeforeBody (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33849: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33855: remote error: internal error\r\n--- FAIL: TestH12_FlushMidBody (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33853: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33859: remote error: internal error\r\n--- FAIL: TestH12_Head_ExplicitLen (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Head https://127.0.0.1:33857: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33863: remote error: internal error\r\n--- FAIL: TestH12_Head_ImplicitLen (0.02s)\r\n\tclientserver_test.go:176: HTTP/2 request: Head https://127.0.0.1:33861: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33867: remote error: internal error\r\n--- FAIL: TestH12_HandlerWritesTooLittle (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33865: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33871: remote error: internal error\r\n--- FAIL: TestH12_HandlerWritesTooMuch (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33869: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33875: remote error: internal error\r\n--- FAIL: TestH12_AutoGzip (0.05s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33873: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33879: remote error: internal error\r\n--- FAIL: TestH12_AutoGzip_Disabled (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33877: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33883: remote error: internal error\r\n--- FAIL: Test304Responses_h2 (0.00s)\r\n\tclientserver_test.go:427: Get https://127.0.0.1:33882: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33887: remote error: internal error\r\n--- FAIL: TestH12_ServerEmptyContentLength (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Get https://127.0.0.1:33885: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33891: remote error: internal error\r\n--- FAIL: TestH12_RequestContentLength_Known_NonZero (0.02s)\r\n\tclientserver_test.go:176: HTTP/2 request: Post https://127.0.0.1:33889: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33895: remote error: internal error\r\n--- FAIL: TestH12_RequestContentLength_Known_Zero (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Post https://127.0.0.1:33893: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33899: remote error: internal error\r\n--- FAIL: TestH12_RequestContentLength_Unknown (0.00s)\r\n\tclientserver_test.go:176: HTTP/2 request: Post https://127.0.0.1:33897: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33903: remote error: internal error\r\n--- FAIL: TestCancelRequestMidBody_h2 (0.00s)\r\n\tclientserver_test.go:503: Get https://127.0.0.1:33902: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33907: remote error: internal error\r\n--- FAIL: TestTrailersClientToServer_h2 (0.00s)\r\n\tclientserver_test.go:577: Post https://127.0.0.1:33906: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33911: remote error: internal error\r\n--- FAIL: TestTrailersServerToClient_h2 (0.02s)\r\n\tclientserver_test.go:614: Get https://127.0.0.1:33910: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33915: remote error: internal error\r\n--- FAIL: TestTrailersServerToClient_Flush_h2 (0.00s)\r\n\tclientserver_test.go:614: Get https://127.0.0.1:33914: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33919: remote error: internal error\r\n--- FAIL: TestResponseBodyReadAfterClose_h2 (0.00s)\r\n\tclientserver_test.go:673: Get https://127.0.0.1:33918: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33923: remote error: internal error\r\n--- FAIL: TestConcurrentReadWriteReqBody_h2 (0.00s)\r\n\tclientserver_test.go:723: Post https://127.0.0.1:33922: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33927: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33928: remote error: internal error\r\n--- FAIL: TestConnectRequest_h2 (0.06s)\r\n\tclientserver_test.go:776: 0. RoundTrip = tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:776: 1. RoundTrip = tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33932: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33933: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33934: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33935: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33936: remote error: internal error\r\n--- FAIL: TestTransportUserAgent_h2 (0.00s)\r\n\tclientserver_test.go:839: 0. RoundTrip = Get https://127.0.0.1:33931: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:839: 1. RoundTrip = Get https://127.0.0.1:33931: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:839: 2. RoundTrip = Get https://127.0.0.1:33931: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:839: 3. RoundTrip = Get https://127.0.0.1:33931: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:839: 4. RoundTrip = Get https://127.0.0.1:33931: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33940: read tcp 127.0.0.1:33939-\u003e127.0.0.1:33940: use of closed network connection\r\n--- FAIL: TestStarRequestFoo_h2 (0.00s)\r\n\tclientserver_test.go:882: RoundTrip = tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33944: remote error: internal error\r\n--- FAIL: TestStarRequestOptions_h2 (0.00s)\r\n\tclientserver_test.go:882: RoundTrip = tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33946: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33949: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33947: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33948: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33950: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33951: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33952: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33953: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33954: remote error: internal error\r\n2016/05/11 15:48:27 http: TLS handshake error from 127.0.0.1:33955: remote error: internal error\r\n--- FAIL: TestTransportDiscardsUnneededConns (2.52s)\r\n\tclientserver_test.go:963: Get: Get https://127.0.0.1:33945: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:963: Get: Get https://127.0.0.1:33945: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:963: Get: Get https://127.0.0.1:33945: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:963: Get: Get https://127.0.0.1:33945: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:963: Get: Get https://127.0.0.1:33945: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:963: Get: Get https://127.0.0.1:33945: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:963: Get: Get https://127.0.0.1:33945: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:963: Get: Get https://127.0.0.1:33945: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:963: Get: Get https://127.0.0.1:33945: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:963: Get: Get https://127.0.0.1:33945: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tclientserver_test.go:1000: 10 connections opened, 10 closed; want 9 to close\r\n2016/05/11 15:48:30 http: TLS handshake error from 127.0.0.1:33965: remote error: internal error\r\n--- FAIL: TestTransportGCRequest_Body_h2 (0.00s)\r\n\tclientserver_test.go:1025: Post https://127.0.0.1:33964: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:30 http: TLS handshake error from 127.0.0.1:33969: remote error: internal error\r\n--- FAIL: TestTransportGCRequest_NoBody_h2 (0.00s)\r\n\tclientserver_test.go:1025: Post https://127.0.0.1:33968: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:30 http: panic serving 127.0.0.1:33971: CryptAcquireContext: The specified procedure could not be found.\r\ngoroutine 672 [running]:\r\nnet/http.(*conn).serve.func1(0xc08253c400)\r\n\tC:/Go/src/net/http/server.go:1389 +0xc8\r\npanic(0x8d5a60, 0xc082613140)\r\n\tC:/Go/src/runtime/panic.go:443 +0x4f7\r\nmime/multipart.randomBoundary(0x0, 0x0)\r\n\tC:/Go/src/mime/multipart/writer.go:76 +0xef\r\nmime/multipart.NewWriter(0xf9eae8, 0xc082113ed8, 0xc281a8)\r\n\tC:/Go/src/mime/multipart/writer.go:29 +0x23\r\nnet/http.rangesMIMESize(0xc082613100, 0x2, 0x2, 0x9f0e60, 0x19, 0xb, 0x0)\r\n\tC:/Go/src/net/http/fs.go:606 +0x86\r\nnet/http.serveContent(0x2ed09f0, 0xc082588f70, 0xc082146700, 0xc082113ec9, 0x4, 0xecea91da0, 0x0, 0xc0b960, 0xc0826130a0, 0xf88d78, ...)\r\n\tC:/Go/src/net/http/fs.go:224 +0xa55\r\nnet/http.serveFile(0x2ed09f0, 0xc082588f70, 0xc082146700, 0xf88bd0, 0xc082113e70, 0x9951c9, 0x4, 0x2ed0800)\r\n\tC:/Go/src/net/http/fs.go:422 +0x932\r\nnet/http.ServeFile(0x2ed09f0, 0xc082588f70, 0xc082146700, 0x9951c0, 0xd)\r\n\tC:/Go/src/net/http/fs.go:475 +0x17a\r\nnet/http_test.TestServeFile.func1(0x2ed09f0, 0xc082588f70, 0xc082146700)\r\n\tC:/Go/src/net/http/fs_test.go:76 +0x51\r\nnet/http.HandlerFunc.ServeHTTP(0xa6bac0, 0x2ed09f0, 0xc082588f70, 0xc082146700)\r\n\tC:/Go/src/net/http/server.go:1618 +0x41\r\nnet/http.serverHandler.ServeHTTP(0xc08253c300, 0x2ed09f0, 0xc082588f70, 0xc082146700)\r\n\tC:/Go/src/net/http/server.go:2081 +0x1a5\r\nnet/http.(*conn).serve(0xc08253c400)\r\n\tC:/Go/src/net/http/server.go:1472 +0xf35\r\ncreated by net/http.(*Server).Serve\r\n\tC:/Go/src/net/http/server.go:2137 +0x455\r\n2016/05/11 15:48:30 http: panic serving 127.0.0.1:33972: CryptAcquireContext: The specified procedure could not be found.\r\ngoroutine 852 [running]:\r\nnet/http.(*conn).serve.func1(0xc08253c800)\r\n\tC:/Go/src/net/http/server.go:1389 +0xc8\r\npanic(0x8d5a60, 0xc082613460)\r\n\tC:/Go/src/runtime/panic.go:443 +0x4f7\r\nmime/multipart.randomBoundary(0x0, 0x0)\r\n\tC:/Go/src/mime/multipart/writer.go:76 +0xef\r\nmime/multipart.NewWriter(0xf9eae8, 0xc08220c158, 0xc08220c0eb)\r\n\tC:/Go/src/mime/multipart/writer.go:29 +0x23\r\nnet/http.rangesMIMESize(0xc0826133c0, 0x2, 0x2, 0x9f0e60, 0x19, 0xb, 0x0)\r\n\tC:/Go/src/net/http/fs.go:606 +0x86\r\nnet/http.serveContent(0x2ed09f0, 0xc082589380, 0xc082146000, 0xc08220c149, 0x4, 0xecea91da0, 0x0, 0xc0b960, 0xc082613360, 0xf88d78, ...)\r\n\tC:/Go/src/net/http/fs.go:224 +0xa55\r\nnet/http.serveFile(0x2ed09f0, 0xc082589380, 0xc082146000, 0xf88bd0, 0xc08220c0f0, 0x9951c9, 0x4, 0x2ed0800)\r\n\tC:/Go/src/net/http/fs.go:422 +0x932\r\nnet/http.ServeFile(0x2ed09f0, 0xc082589380, 0xc082146000, 0x9951c0, 0xd)\r\n\tC:/Go/src/net/http/fs.go:475 +0x17a\r\nnet/http_test.TestServeFile.func1(0x2ed09f0, 0xc082589380, 0xc082146000)\r\n\tC:/Go/src/net/http/fs_test.go:76 +0x51\r\nnet/http.HandlerFunc.ServeHTTP(0xa6bac0, 0x2ed09f0, 0xc082589380, 0xc082146000)\r\n\tC:/Go/src/net/http/server.go:1618 +0x41\r\nnet/http.serverHandler.ServeHTTP(0xc08253c300, 0x2ed09f0, 0xc082589380, 0xc082146000)\r\n\tC:/Go/src/net/http/server.go:2081 +0x1a5\r\nnet/http.(*conn).serve(0xc08253c800)\r\n\tC:/Go/src/net/http/server.go:1472 +0xf35\r\ncreated by net/http.(*Server).Serve\r\n\tC:/Go/src/net/http/server.go:2137 +0x455\r\n--- FAIL: TestServeFile (0.00s)\r\n\tfs_test.go:1007: range test \"bytes=0-0,-2\": for URL \"http://127.0.0.1:33970\", send error: Get http://127.0.0.1:33970: EOF\r\n2016/05/11 15:48:30 http: TLS handshake error from 127.0.0.1:33994: remote error: internal error\r\n--- FAIL: TestServeFileWithContentEncoding_h2 (0.00s)\r\n\tfs_test.go:533: Get https://127.0.0.1:33993: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:30 http: TLS handshake error from 127.0.0.1:34008: remote error: internal error\r\n--- FAIL: TestNextProtoUpgrade (0.00s)\r\n\tnpn_test.go:51: Get https://127.0.0.1:34007: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:30 http: TLS handshake error from 127.0.0.1:34012: remote error: internal error\r\n--- FAIL: TestRedirect_h2 (0.00s)\r\n\trequest_test.go:199: Get https://127.0.0.1:34011: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:30 http: TLS handshake error from 127.0.0.1:34033: remote error: internal error\r\n--- FAIL: TestSetsRemoteAddr_h2 (0.00s)\r\n\tserve_test.go:756: Get error: Get https://127.0.0.1:34032: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n2016/05/11 15:48:30 http: TLS handshake error from 127.0.0.1:34042: remote error: internal error\r\n--- FAIL: TestHeadResponses_h2 (0.02s)\r\n\tserve_test.go:919: Head https://127.0.0.1:34041: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal 0xc0000005 code=0x0 addr=0x60 pc=0x57a72a]\r\n\r\ngoroutine 1102 [running]:\r\npanic(0x8f49a0, 0xc082006110)\r\n\tC:/Go/src/runtime/panic.go:481 +0x3f4\r\ntesting.tRunner.func1(0xc08223ca20)\r\n\tC:/Go/src/testing/testing.go:467 +0x199\r\npanic(0x8f49a0, 0xc082006110)\r\n\tC:/Go/src/runtime/panic.go:443 +0x4f7\r\nnet/http_test.testHeadResponses(0xc08223ca20, 0xc013a87801)\r\n\tC:/Go/src/net/http/serve_test.go:921 +0x28a\r\nnet/http_test.TestHeadResponses_h2(0xc08223ca20)\r\n\tC:/Go/src/net/http/serve_test.go:900 +0x2d\r\ntesting.tRunner(0xc08223ca20, 0xc090f0)\r\n\tC:/Go/src/testing/testing.go:473 +0x9f\r\ncreated by testing.RunTests\r\n\tC:/Go/src/testing/testing.go:582 +0x899\r\nFAIL\tnet/http\t4.609s\r\nok  \tnet/http/cgi\t1.735s\r\nok  \tnet/http/cookiejar\t1.158s\r\nok  \tnet/http/fcgi\t0.734s\r\nok  \tnet/http/httptest\t1.812s\r\nok  \tnet/http/httputil\t0.860s\r\nok  \tnet/http/internal\t0.484s\r\nok  \tnet/internal/socktest\t0.360s\r\nok  \tnet/mail\t0.484s\r\nok  \tnet/rpc\t1.344s\r\nok  \tnet/rpc/jsonrpc\t0.764s\r\n--- FAIL: TestTLSClient (0.00s)\r\n\tsmtp_test.go:567: failed to handle connection: remote error: internal error\r\n--- FAIL: TestTLSConnState (0.00s)\r\n\tsmtp_test.go:602: StartTLS: tls: short read from Rand: CryptAcquireContext: The specified procedure could not be found.\r\n\tsmtp_test.go:588: server error: remote error: internal error\r\nFAIL\r\nFAIL\tnet/smtp\t0.752s\r\nok  \tnet/textproto\t0.529s\r\nok  \tnet/url\t0.844s\r\nok  \tos\t1.391s\r\nok  \tos/exec\t19.909s\r\nok  \tos/signal\t3.781s\r\n--- FAIL: TestCurrent (0.00s)\r\npanic: Failed to load userenv.dll: The specified module could not be found. [recovered]\r\n\tpanic: Failed to load userenv.dll: The specified module could not be found.\r\n\r\ngoroutine 6 [running]:\r\npanic(0x5668e0, 0xc082064270)\r\n\tC:/Go/src/runtime/panic.go:481 +0x3f4\r\ntesting.tRunner.func1(0xc08207a000)\r\n\tC:/Go/src/testing/testing.go:467 +0x199\r\npanic(0x5668e0, 0xc082064270)\r\n\tC:/Go/src/runtime/panic.go:443 +0x4f7\r\nsyscall.(*LazyProc).mustFind(0xc082005c80)\r\n\tC:/Go/src/syscall/dll_windows.go:280 +0x6a\r\nsyscall.(*LazyProc).Addr(0xc082005c80, 0x43dd5c)\r\n\tC:/Go/src/syscall/dll_windows.go:287 +0x28\r\nsyscall.GetUserProfileDirectory(0x18c, 0xc082040d00, 0xc082033dcc, 0x0, 0x0)\r\n\tC:/Go/src/syscall/zsyscall_windows.go:1865 +0x3f\r\nsyscall.Token.GetUserProfileDirectory(0x18c, 0x0, 0x0, 0x0, 0x0)\r\n\tC:/Go/src/syscall/security_windows.go:365 +0xae\r\nos/user.current(0x0, 0x0, 0x0)\r\n\tC:/Go/src/os/user/lookup_windows.go:115 +0x1e1\r\nos/user.Current(0xc08207a000, 0x0, 0x0)\r\n\tC:/Go/src/os/user/lookup.go:9 +0x2b\r\nos/user.TestCurrent(0xc08207a000)\r\n\tC:/Go/src/os/user/user_test.go:21 +0x3f\r\ntesting.tRunner(0xc08207a000, 0x670ac0)\r\n\tC:/Go/src/testing/testing.go:473 +0x9f\r\ncreated by testing.RunTests\r\n\tC:/Go/src/testing/testing.go:582 +0x899\r\nFAIL\tos/user\t0.375s\r\nok  \tpath\t0.719s\r\nok  \tpath/filepath\t5.672s\r\nok  \treflect\t2.469s\r\nok  \tregexp\t2.125s\r\nok  \tregexp/syntax\t1.328s\r\nok  \truntime\t101.468s\r\nok  \truntime/debug\t0.753s\r\nok  \truntime/internal/atomic\t1.141s\r\nok  \truntime/pprof\t3.283s\r\nok  \truntime/trace\t23.406s\r\nok  \tsort\t2.453s\r\nok  \tstrconv\t0.875s\r\nok  \tstrings\t2.765s\r\nok  \tsync\t4.361s\r\nok  \tsync/atomic\t3.748s\r\nok  \tsyscall\t0.716s\r\nok  \ttesting\t4.282s\r\nok  \ttesting/quick\t0.514s\r\nok  \ttext/scanner\t0.719s\r\nok  \ttext/tabwriter\t0.544s\r\nok  \ttext/template\t1.266s\r\nok  \ttext/template/parse\t0.532s\r\n--- FAIL: TestLocalZoneAbbr (0.09s)\r\n\tzoneinfo_windows_test.go:19: Parse failed: parsing time \"Wed, 11 May 2016 15:48:51 -0700\" as \"Mon, 02 Jan 2006 15:04:05 MST\": cannot parse \"-0700\" as \"MST\"\r\nFAIL\r\nFAIL\ttime\t7.297s\r\nok  \tunicode\t0.859s\r\nok  \tunicode/utf16\t0.269s\r\nok  \tunicode/utf8\t1.047s\r\nok  \tcmd/addr2line\t4.861s\r\nok  \tcmd/asm/internal/asm\t1.578s\r\nok  \tcmd/asm/internal/lex\t0.359s\r\nok  \tcmd/compile/internal/big\t1.406s\r\nok  \tcmd/compile/internal/gc\t2.016s\r\nok  \tcmd/cover\t6.016s\r\nok  \tcmd/doc\t0.548s\r\nok  \tcmd/fix\t0.566s\r\nok  \tcmd/go\t148.876s\r\nok  \tcmd/gofmt\t0.500s\r\nok  \tcmd/internal/goobj\t0.359s\r\nok  \tcmd/internal/obj\t0.361s\r\nok  \tcmd/internal/obj/x86\t0.438s\r\nok  \tcmd/internal/unvendor/golang.org/x/arch/arm/armasm\t0.391s\r\nok  \tcmd/internal/unvendor/golang.org/x/arch/x86/x86asm\t2.297s\r\nok  \tcmd/nm\t5.312s\r\nok  \tcmd/objdump\t6.641s\r\nok  \tcmd/pack\t8.844s\r\nok  \tcmd/pprof/internal/profile\t1.456s\r\nok  \tcmd/vet\t0.734s\r\n```\r\n\r\n**Workaround**\r\n\r\nThis is a giant hack, but a possible workaround for this problem is to eagerly load the problematic DLLs instead of letting the delay-load machinery attempt to do so. What I did locally to unblock me was adding `LoadLibrary` calls to `loadOptionalSyscalls` in `os1_windows.go`:\r\n\r\n```\r\n@@ -116,6 +116,11 @@\r\n func loadOptionalSyscalls() {\r\n \tvar (\r\n \t\tkernel32dll                 = []byte(\"kernel32.dll\\000\")\r\n+\t\tcryptspdll                  = []byte(\"cryptsp.dll\\000\")\r\n+\t\tiphlpapidll                 = []byte(\"iphlpapi.dll\\000\")\r\n+\t\tnetapi32dll                 = []byte(\"netapi32.dll\\000\")\r\n+\t\tuserenvdll                  = []byte(\"userenv.dll\\000\")\r\n+\t\tsecur32dll                  = []byte(\"secur32.dll\\000\")\r\n \t\taddVectoredContinueHandler  = []byte(\"AddVectoredContinueHandler\\000\")\r\n \t\tgetQueuedCompletionStatusEx = []byte(\"GetQueuedCompletionStatusEx\\000\")\r\n \t\taddDllDirectory             = []byte(\"AddDllDirectory\\000\")\r\n@@ -130,6 +135,12 @@\r\n \t_AddVectoredContinueHandler = windowsFindfunc(addVectoredContinueHandler, k32)\r\n \t_GetQueuedCompletionStatusEx = windowsFindfunc(getQueuedCompletionStatusEx, k32)\r\n \t_LoadLibraryExW = windowsFindfunc(loadLibraryExW, k32)\r\n+\r\n+\tstdcall1(_LoadLibraryA, uintptr(unsafe.Pointer(\u0026cryptspdll[0])))\r\n+\tstdcall1(_LoadLibraryA, uintptr(unsafe.Pointer(\u0026iphlpapidll[0])))\r\n+\tstdcall1(_LoadLibraryA, uintptr(unsafe.Pointer(\u0026userenvdll[0])))\r\n+\tstdcall1(_LoadLibraryA, uintptr(unsafe.Pointer(\u0026netapi32dll[0])))\r\n+\tstdcall1(_LoadLibraryA, uintptr(unsafe.Pointer(\u0026secur32dll[0])))\r\n }\r\n```",
	"user": {
		"login": "jblazquez",
		"id": 5482684,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "OS-Windows"
		}
	],
	"comments": 7,
	"closed_at": "2016-05-21T18:53:08Z",
	"created_at": "2016-05-11T22:56:03Z",
	"updated_at": "2016-05-21T18:53:09Z",
	"milestone": {
		"id": 1714149,
		"number": 40,
		"title": "Go1.7Maybe"
	}
}
