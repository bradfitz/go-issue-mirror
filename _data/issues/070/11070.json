{
	"id": 85227415,
	"number": 11070,
	"state": "closed",
	"title": "net: builtin DNS stub resolver fails to parse responses from consul with \"cannot unmarshal DNS message\"",
	"body": "Hi,\r\n\r\nif you have a CNAME like registry-1.docker.io, using a DNS resolver like consul and try to resolve the record by using a go 1.4.2 application using netgo, the resolution fails.\r\n\r\nThis can be reproduced by running a recursor like consul, pointing /etc/resolv.conf to it and compile this: https://gist.github.com/discordianfish/467ea55ae86426815a21 with `CGO_ENABLED=0 go build -installsuffix netgo`.\r\n\r\nThis particular behaviour is something I only observed with consul, so it might be very well a bug there. But compiling the same with default options / CGO enabled, the resolution works just fine. All other tools can resolve the record just fine as well. And we couldn't reproduce it with go 1.2 nor go 1.3.\r\n\r\n# Consul\r\nRun consul and provide upstream `-recursors`\r\n## Without search domain\r\n```\r\n2015/06/04 18:35:42 Get https://registry-1.docker.io: dial tcp: lookup registry-1.docker.io on 127.0.0.1:53: cannot unmarshal DNS message\r\n```\r\n\r\ntcpdump shows:\r\n```\r\n18:37:15.401845 IP (tos 0x0, ttl 64, id 62857, offset 0, flags [DF], proto UDP (17), length 66)\r\n    10.128.40.4.48468 \u003e 10.128.0.2.53: [bad udp cksum 0x3d45 -\u003e 0xe807!] 34126+ A? registry-1.docker.io. (38)\r\n18:37:15.401968 IP (tos 0x0, ttl 64, id 62858, offset 0, flags [DF], proto UDP (17), length 66)\r\n    10.128.40.4.33424 \u003e 10.128.0.2.53: [bad udp cksum 0x3d45 -\u003e 0x0346!] 42169+ AAAA? registry-1.docker.io. (38)\r\n18:37:15.402745 IP (tos 0x0, ttl 64, id 10096, offset 0, flags [none], proto UDP (17), length 242)\r\n    10.128.0.2.53 \u003e 10.128.40.4.48468: [udp sum ok] 34126 q: A? registry-1.docker.io. 7/0/0 registry-1.docker.io. CNAME us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com., us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.5.4.145, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.6.136.158, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.164.219.90, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.172.137.222, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 107.21.22.134, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.0.31.125 (214)\r\n18:37:15.402949 IP (tos 0x0, ttl 64, id 10097, offset 0, flags [none], proto UDP (17), length 228)\r\n    10.128.0.2.53 \u003e 10.128.40.4.33424: [udp sum ok] 42169 q: AAAA? registry-1.docker.io. 1/1/0 registry-1.docker.io. CNAME us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. ns: us-east-1.elb.amazonaws.com. SOA ns-1119.awsdns-11.org. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 60 (200)\r\n18:37:15.403562 IP (tos 0x0, ttl 64, id 62859, offset 0, flags [DF], proto UDP (17), length 66)\r\n    10.128.40.4.57356 \u003e 10.128.0.2.53: [bad udp cksum 0x3d45 -\u003e 0xb92e!] 37231+ A? registry-1.docker.io. (38)\r\n18:37:15.403735 IP (tos 0x0, ttl 64, id 10098, offset 0, flags [none], proto UDP (17), length 242)\r\n    10.128.0.2.53 \u003e 10.128.40.4.57356: [udp sum ok] 37231 q: A? registry-1.docker.io. 7/0/0 registry-1.docker.io. CNAME us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com., us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.0.31.125, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.5.4.145, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.6.136.158, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.164.219.90, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.172.137.222, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 107.21.22.134 (214)\r\n```\r\n## With search domain\r\nIf you use some search domain, the results are different:\r\n\r\n```2015/06/04 18:04:14 Get https://registry-1.docker.io: dial tcp: lookup registry-1.docker.io: no such host```\r\n\r\nTcpdump:\r\n```\r\n18:38:37.157005 IP (tos 0x0, ttl 64, id 62874, offset 0, flags [DF], proto UDP (17), length 66)\r\n    10.128.40.4.39343 \u003e 10.128.0.2.53: [bad udp cksum 0x3d45 -\u003e 0x11e3!] 32536+ A? registry-1.docker.io. (38)\r\n18:38:37.157131 IP (tos 0x0, ttl 64, id 62875, offset 0, flags [DF], proto UDP (17), length 66)\r\n    10.128.40.4.52552 \u003e 10.128.0.2.53: [bad udp cksum 0x3d45 -\u003e 0x7ced!] 57433+ AAAA? registry-1.docker.io. (38)\r\n18:38:37.157924 IP (tos 0x0, ttl 64, id 10113, offset 0, flags [none], proto UDP (17), length 228)\r\n    10.128.0.2.53 \u003e 10.128.40.4.52552: [udp sum ok] 57433 q: AAAA? registry-1.docker.io. 1/1/0 registry-1.docker.io. CNAME us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. ns: us-east-1.elb.amazonaws.com. SOA ns-1119.awsdns-11.org. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 60 (200)\r\n18:38:37.158132 IP (tos 0x0, ttl 64, id 10114, offset 0, flags [none], proto UDP (17), length 242)\r\n    10.128.0.2.53 \u003e 10.128.40.4.39343: [udp sum ok] 32536 q: A? registry-1.docker.io. 7/0/0 registry-1.docker.io. CNAME us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com., us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.6.136.158, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.164.219.90, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.172.137.222, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 107.21.22.134, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.0.31.125, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.5.4.145 (214)\r\n18:38:37.160648 IP (tos 0x0, ttl 64, id 62876, offset 0, flags [DF], proto UDP (17), length 78)\r\n    10.128.40.4.46128 \u003e 10.128.0.2.53: [bad udp cksum 0x3d51 -\u003e 0xdce0!] 11418+ AAAA? registry-1.docker.io.example.com. (50)\r\n18:38:37.160760 IP (tos 0x0, ttl 64, id 62877, offset 0, flags [DF], proto UDP (17), length 66)\r\n    10.128.40.4.51488 \u003e 10.128.0.2.53: [bad udp cksum 0x3d45 -\u003e 0x418c!] 8190+ A? registry-1.docker.io. (38)\r\n18:38:37.160919 IP (tos 0x0, ttl 64, id 10115, offset 0, flags [none], proto UDP (17), length 242)\r\n    10.128.0.2.53 \u003e 10.128.40.4.51488: [udp sum ok] 8190 q: A? registry-1.docker.io. 7/0/0 registry-1.docker.io. CNAME us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com., us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.5.4.145, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.6.136.158, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.164.219.90, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.172.137.222, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 107.21.22.134, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.0.31.125 (214)\r\n18:38:37.162057 IP (tos 0x0, ttl 64, id 62878, offset 0, flags [DF], proto UDP (17), length 78)\r\n    10.128.40.4.34535 \u003e 10.128.0.2.53: [bad udp cksum 0x3d51 -\u003e 0x3f74!] 63338+ A? registry-1.docker.io.example.com. (50)\r\n18:38:37.163365 IP (tos 0x0, ttl 64, id 10116, offset 0, flags [none], proto UDP (17), length 135)\r\n    10.128.0.2.53 \u003e 10.128.40.4.46128: [udp sum ok] 11418 NXDomain q: AAAA? registry-1.docker.io.example.com. 0/1/0 ns: example.com. SOA sns.dns.icann.org. noc.dns.icann.org. 2015060216 7200 3600 1209600 3600 (107)\r\n18:38:37.164818 IP (tos 0x0, ttl 64, id 10117, offset 0, flags [none], proto UDP (17), length 135)\r\n    10.128.0.2.53 \u003e 10.128.40.4.34535: [udp sum ok] 63338 NXDomain q: A? registry-1.docker.io.example.com. 0/1/0 ns: example.com. SOA sns.dns.icann.org. noc.dns.icann.org. 2015060216 7200 3600 1209600 3600 (107)\r\n```\r\nThis later one is different, but might be related to https://github.com/docker/docker/issues/10863\r\n\r\n# Other DNS servers\r\nOther DNS servers seem to work, yet the DNS requests look very similar. I'm using the same nameservers I provided as upstream recursors for consul before to rule out it's somehow related to those.\r\n\r\n## Without search domain\r\n```\r\n2015/06/04 18:46:20 No error\r\n```\r\nTcpdump:\r\n```\r\n18:46:20.642497 IP (tos 0x0, ttl 64, id 62917, offset 0, flags [DF], proto UDP (17), length 66)\r\n    10.128.40.4.36033 \u003e 10.128.0.2.53: [bad udp cksum 0x3d45 -\u003e 0x81e9!] 7168+ A? registry-1.docker.io. (38)\r\n18:46:20.642592 IP (tos 0x0, ttl 64, id 62918, offset 0, flags [DF], proto UDP (17), length 66)\r\n    10.128.40.4.40689 \u003e 10.128.0.2.53: [bad udp cksum 0x3d45 -\u003e 0xbd21!] 52860+ AAAA? registry-1.docker.io. (38)\r\n18:46:20.644876 IP (tos 0x0, ttl 64, id 10156, offset 0, flags [none], proto UDP (17), length 242)\r\n    10.128.0.2.53 \u003e 10.128.40.4.36033: [udp sum ok] 7168 q: A? registry-1.docker.io. 7/0/0 registry-1.docker.io. CNAME us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com., us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.6.136.158, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.164.219.90, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.172.137.222, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 107.21.22.134, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.0.31.125, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.5.4.145 (214)\r\n18:46:20.644895 IP (tos 0x0, ttl 64, id 10157, offset 0, flags [none], proto UDP (17), length 228)\r\n    10.128.0.2.53 \u003e 10.128.40.4.40689: [udp sum ok] 52860 q: AAAA? registry-1.docker.io. 1/1/0 registry-1.docker.io. CNAME us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. ns: us-east-1.elb.amazonaws.com. SOA ns-1119.awsdns-11.org. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 60 (200)\r\n```\r\n\r\n## With search domain\r\n\r\nTcpdump:\r\n```\r\ntcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes\r\n18:48:19.693146 IP (tos 0x0, ttl 64, id 62941, offset 0, flags [DF], proto UDP (17), length 66)\r\n    10.128.40.4.44090 \u003e 10.128.0.2.53: [bad udp cksum 0x3d45 -\u003e 0x1c34!] 25148+ A? registry-1.docker.io. (38)\r\n18:48:19.693243 IP (tos 0x0, ttl 64, id 62942, offset 0, flags [DF], proto UDP (17), length 66)\r\n    10.128.40.4.47151 \u003e 10.128.0.2.53: [bad udp cksum 0x3d45 -\u003e 0xf1ff!] 32864+ AAAA? registry-1.docker.io. (38)\r\n18:48:19.694158 IP (tos 0x0, ttl 64, id 10180, offset 0, flags [none], proto UDP (17), length 242)\r\n    10.128.0.2.53 \u003e 10.128.40.4.44090: [udp sum ok] 25148 q: A? registry-1.docker.io. 7/0/0 registry-1.docker.io. CNAME us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com., us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.6.136.158, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.164.219.90, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 54.172.137.222, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 107.21.22.134, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.0.31.125, us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. A 52.5.4.145 (214)\r\n18:48:19.711674 IP (tos 0x0, ttl 64, id 10181, offset 0, flags [none], proto UDP (17), length 228)\r\n    10.128.0.2.53 \u003e 10.128.40.4.47151: [udp sum ok] 32864 q: AAAA? registry-1.docker.io. 1/1/0 registry-1.docker.io. CNAME us-east-1-elbio-rm5bon1qaeo4-623296237.us-east-1.elb.amazonaws.com. ns: us-east-1.elb.amazonaws.com. SOA ns-1119.awsdns-11.org. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 60 (200)\r\n18:48:19.711821 IP (tos 0x0, ttl 64, id 62943, offset 0, flags [DF], proto UDP (17), length 94)\r\n    10.128.40.4.37072 \u003e 10.128.0.2.53: [bad udp cksum 0x3d61 -\u003e 0x282a!] 30733+ AAAA? registry-1.docker.io.stage-us-east-1.aws.dckr.io. (66)\r\n18:48:19.714437 IP (tos 0x0, ttl 64, id 10182, offset 0, flags [none], proto UDP (17), length 181)\r\n    10.128.0.2.53 \u003e 10.128.40.4.37072: [udp sum ok] 30733 NXDomain q: AAAA? registry-1.docker.io.stage-us-east-1.aws.dckr.io. 0/1/0 ns: aws.dckr.io. SOA ns-1870.awsdns-41.co.uk. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 86400 (153)\r\n```",
	"user": {
		"login": "discordianfish",
		"id": 275966,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 13,
	"closed_at": "2015-06-05T12:20:20Z",
	"created_at": "2015-06-04T18:51:56Z",
	"updated_at": "2016-06-25T02:10:22Z",
	"milestone": {
		"id": 905105,
		"number": 1,
		"title": "Go1.5"
	}
}
