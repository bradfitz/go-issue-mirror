{
	"id": 97803016,
	"number": 11913,
	"state": "closed",
	"title": "cmd/go: cgo crashes with GO15VENDOREXPERIMENT=1",
	"body": "When performing a clean build of our project with GO15VENDOREXPERIMENT=1 we need to run \"go install\" twice. The first time always fails in cgo-related compile or link steps. The second time always works fine.\r\n\r\nI'm running \"go version go1.5beta2 linux/amd64\".\r\n\r\nThe error from cgo is usually different from run to run. I've also seen cgo crash with a nil pointer error. These are the environment variables we set when building:\r\n\r\nBUILD=/\u003cmount\u003e/home/adgar/go/src/\u003cproject-dir\u003e/vendor/libgit2/build\r\nPCFILE=/\u003cmount\u003e/home/adgar/go/src/\u003cproject-dir\u003e/vendor/libgit2/build/libgit2.pc\r\nPKG_CONFIG_PATH=/\u003cmount\u003e/home/adgar/go/src/\u003cproject-dir\u003e/vendor/libgit2/build:\r\nFLAGS='-L/\u003cmount\u003e/home/adgar/go/src/\u003cproject-dir\u003e/vendor/libgit2/install/lib -lgit2 -lcurl -lrt -lssl -lcrypto -ldl -lz  '\r\nCGO_LDFLAGS='/\u003cmount\u003e/home/adgar/go/src/\u003cproject-dir\u003e/vendor/libgit2/build/libgit2.a -L/\u003cmount\u003e/home/adgar/go/src/\u003cproject-dir\u003e/vendor/libgit2/build -L/\u003cmount\u003e/home/adgar/go/src/\u003cproject-dir\u003e/vendor/libgit2/install/lib -lgit2 -lcurl -lrt -lssl -lcrypto -ldl -lz  '\r\nCGO_CFLAGS=-I/\u003cmount\u003e/home/adgar/go/src/\u003cproject-dir\u003e/vendor/libgit2/include\r\n\r\nHere are 3 example errors I've seen in the past ~5 minutes of reproducing the issue.\r\n\r\n[run 1]\r\ncannot parse gcc output $WORK/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go/_obj//_cgo_.o as ELF, Mach-O, PE object\r\n\r\n[run 2]\r\nvendor/github.com/libgit2/git2go/diff.go:20:31: unable to find value of constant C.GIT_DIFF_FLAG_BINARY\r\nvendor/github.com/libgit2/git2go/diff.go:21:31: unable to find value of constant C.GIT_DIFF_FLAG_NOT_BINARY\r\nvendor/github.com/libgit2/git2go/diff.go:22:31: unable to find value of constant C.GIT_DIFF_FLAG_VALID_ID\r\nvendor/github.com/libgit2/git2go/diff.go:42:38: unable to find value of constant C.GIT_DIFF_LINE_CONTEXT\r\nvendor/github.com/libgit2/git2go/diff.go:43:38: unable to find value of constant C.GIT_DIFF_LINE_ADDITION\r\nvendor/github.com/libgit2/git2go/diff.go:44:38: unable to find value of constant C.GIT_DIFF_LINE_DELETION\r\nvendor/github.com/libgit2/git2go/diff.go:45:38: unable to find value of constant C.GIT_DIFF_LINE_CONTEXT_EOFNL\r\nvendor/github.com/libgit2/git2go/diff.go:46:38: unable to find value of constant C.GIT_DIFF_LINE_ADD_EOFNL\r\nvendor/github.com/libgit2/git2go/diff.go:47:38: unable to find value of constant C.GIT_DIFF_LINE_DEL_EOFNL\r\nvendor/github.com/libgit2/git2go/diff.go:49:33: unable to find value of constant C.GIT_DIFF_LINE_FILE_HDR\r\nvendor/github.com/libgit2/git2go/diff.go:50:33: unable to find value of constant C.GIT_DIFF_LINE_HUNK_HDR\r\nvendor/github.com/libgit2/git2go/diff.go:51:33: unable to find value of constant C.GIT_DIFF_LINE_BINARY\r\nvendor/github.com/libgit2/git2go/diff.go:62:26: type C.git_diff_file: undefined C type 'git_diff_file'\r\nvendor/github.com/libgit2/git2go/diff.go:64:10: call of non-function C.GoString\r\nvendor/github.com/libgit2/git2go/diff.go:80:28: type C.git_diff_delta: undefined C type 'git_diff_delta'\r\nvendor/github.com/libgit2/git2go/diff.go:98:26: type C.git_diff_hunk: undefined C type 'git_diff_hunk'\r\nvendor/github.com/libgit2/git2go/diff.go:104:13: call of non-function C.GoStringN\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal 0xb code=0x1 addr=0x0 pc=0x40ec96]\r\n\r\ngoroutine 1 [running]:\r\nmain.(*Package).rewriteRef(0xc8200942a0, 0xc8202fc300)\r\n        /\u003cmount\u003e/home/adgar/go15/go/src/cmd/cgo/gcc.go:610 +0x1466\r\nmain.(*Package).Translate(0xc8200942a0, 0xc8202fc300)\r\n        /\u003cmount\u003e/home/adgar/go15/go/src/cmd/cgo/gcc.go:170 +0x197\r\nmain.main()\r\n        /\u003cmount\u003e/home/adgar/go15/go/src/cmd/cgo/main.go:269 +0x1059\r\n\r\n[run 3, mojibaked]\r\n# \u003cproject-dir\u003e/cmd/ws-daemon\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.aþ       ): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(ü                                                                                                                                ): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(8\r\n                                                                                                                                   ): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(X\r\n                                                                                                                                 ): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(ex\r\n                                                                                                                                   ): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(\r\n                                                                                                                                  %p\r\n                                                                                                                                     ): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(°\r\n                                                                                                                                   2): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a( \r\n                                                                                                                                  ¡): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(\r\n): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(E¬): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(W.\r\n): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(\r\n=): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(£.\r\n): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(\r\n«): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(0/\r\n): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(\r\nƏ): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(¤/\r\n): not an object file\r\n/\u003cmount\u003e/home/adgar/go/pkg/linux_amd64/\u003cproject-dir\u003e/vendor/github.com/libgit2/git2go.a(\r\n): not an object file\r\n/\u003cmount\u003e/home/adgar/go15/go/pkg/tool/linux_amd64/link: too many errors\r\n",
	"user": {
		"login": "michaeledgar",
		"id": 65914,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"assignee": {
		"login": "rsc",
		"id": 104030,
		"type": "User",
		"site_admin": false
	},
	"comments": 6,
	"closed_at": "2015-07-31T18:50:53Z",
	"created_at": "2015-07-28T21:10:57Z",
	"updated_at": "2016-08-05T16:11:31Z",
	"milestone": {
		"id": 905105,
		"number": 1,
		"title": "Go1.5"
	}
}
