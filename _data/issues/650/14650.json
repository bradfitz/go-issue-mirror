{
	"id": 138585196,
	"number": 14650,
	"state": "closed",
	"title": "cmd/compile: regular panic on Plan 9",
	"body": "Since early January we started to experience occasional cmd/compile failures reported by the Plan 9 (386) trybots on the dev.ssa branch. When the dev.ssa branch was merged to master on March 1, the failures started to become much more frequent, because the master branch is more active.\r\n\r\nThe failures happen when building go_bootstrap. They look like:\r\n\r\n```\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal 0x3 code=0x0 addr=0x0 pc=0x20b307]\r\n\r\ngoroutine 1 [running]:\r\nbootstrap/internal/obj/x86.doasm(0x10adc000, 0x114481a0)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:3221 +0x11c27\r\nbootstrap/internal/obj/x86.asmins(0x10adc000, 0x114481a0)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:4577 +0xf26\r\nbootstrap/internal/obj/x86.span6(0x10adc000, 0x10fefd40)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:1778 +0x81f\r\nbootstrap/internal/obj.Flushplist(0x10adc000)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/objfile.go:300 +0x278\r\nbootstrap/internal/obj.Writeobjdirect(0x10adc000, 0x119fff00)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/objfile.go:114 +0x27\r\nbootstrap/compile/internal/gc.dumpobj()\r\n\t/tmp/workdir/go/src/cmd/compile/internal/gc/obj.go:88 +0xafc\r\nbootstrap/compile/internal/gc.Main()\r\n\t/tmp/workdir/go/src/cmd/compile/internal/gc/lex.go:497 +0x1c75\r\nbootstrap/compile/internal/x86.Main()\r\n\t/tmp/workdir/go/src/cmd/compile/internal/x86/galign.go:108 +0x5ff\r\nmain.main()\r\n\t/tmp/workdir/go/src/cmd/compile/main.go:30 +0xe5\r\n```\r\n\r\nor\r\n\r\n```\r\nsys: trap: invalid opcode pc=0x0020c008\r\nPC=0x20c008\r\n\r\ngoroutine 1 [running]:\r\nbootstrap/internal/obj/x86.asmidx(0x10b16000, 0x0, 0x10b18ebc, 0x10b160de)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:2637 +0x78 fp=0x111d5774 sp=0x111d572c\r\nbootstrap/internal/obj/x86.relput4(0x10b16000, 0x10b1903c, 0x10b19044)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:2700 +0x28b fp=0x111d5818 sp=0x111d5774\r\nbootstrap/internal/obj/x86.doasm(0x10b16000, 0x10b1903c)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:3505 +0xebf9 fp=0x111d5b08 sp=0x111d5818\r\nbootstrap/internal/obj/x86.asmins(0x10b16000, 0x10b1903c)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:4726 +0xcd5 fp=0x111d5bb0 sp=0x111d5b08\r\nbootstrap/internal/obj/x86.span6(0x10b16000, 0x113655c0)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:1925 +0x836 fp=0x111d5c7c sp=0x111d5bb0\r\nbootstrap/internal/obj.flushplist(0x10b16000, 0x10b1f601)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/objfile.go:308 +0x281 fp=0x111d5cfc sp=0x111d5c7c\r\nbootstrap/internal/obj.Flushplist(0x10b16000)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/objfile.go:119 +0x34 fp=0x111d5d08 sp=0x111d5cfc\r\nbootstrap/compile/internal/gc.funccompile(0x110009c0)\r\n\t/tmp/workdir/go/src/cmd/compile/internal/gc/dcl.go:1445 +0x1d3 fp=0x111d5d44 sp=0x111d5d08\r\nbootstrap/compile/internal/gc.Main()\r\n\t/tmp/workdir/go/src/cmd/compile/internal/gc/lex.go:488 +0x1bd9 fp=0x111d5ef4 sp=0x111d5d44\r\nbootstrap/compile/internal/x86.Main()\r\n\t/tmp/workdir/go/src/cmd/compile/internal/x86/galign.go:97 +0x5c6 fp=0x111d5f60 sp=0x111d5ef4\r\nmain.main()\r\n\t/tmp/workdir/go/src/cmd/compile/main.go:30 +0xe5 fp=0x111d5fcc sp=0x111d5f60\r\nruntime.main()\r\n\t/tmp/buildlet-scatch798455816/src/runtime/proc.go:63 +0xcb fp=0x111d5ff0 sp=0x111d5fcc\r\nruntime.goexit()\r\n\t/tmp/buildlet-scatch798455816/src/runtime/asm_386.s:2287 +0x1 fp=0x111d5ff4 sp=0x111d5ff0\r\n```\r\n\r\nor\r\n\r\n```\r\nunexpected fault address 0xf0000000\r\nfatal error: fault\r\n[signal 0x3 code=0x0 addr=0xf0000000 pc=0x20b307]\r\n\r\ngoroutine 1 [running]:\r\nruntime.gothrow(0x40f108, 0x5)\r\n\t/tmp/buildlet-scatch798455816/src/runtime/panic.go:503 +0x67 fp=0x10ef3730 sp=0x10ef3724\r\nruntime.sigpanic()\r\n\t/tmp/buildlet-scatch798455816/src/runtime/os_plan9.go:50 +0x151 fp=0x10ef3764 sp=0x10ef3730\r\nbootstrap/internal/obj/x86.doasm(0x10adc000, 0x113a5930)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:3221 +0x11c27 fp=0x10ef3a60 sp=0x10ef3764\r\nbootstrap/internal/obj/x86.asmins(0x10adc000, 0x113a5930)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:4577 +0xf26 fp=0x10ef3b40 sp=0x10ef3a60\r\nbootstrap/internal/obj/x86.span6(0x10adc000, 0x10f58ba0)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/x86/asm6.go:1778 +0x81f fp=0x10ef3c08 sp=0x10ef3b40\r\nbootstrap/internal/obj.Flushplist(0x10adc000)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/objfile.go:300 +0x278 fp=0x10ef3c88 sp=0x10ef3c08\r\nbootstrap/internal/obj.Writeobjdirect(0x10adc000, 0x1112f240)\r\n\t/tmp/workdir/go/src/cmd/internal/obj/objfile.go:114 +0x27 fp=0x10ef3c94 sp=0x10ef3c88\r\nbootstrap/compile/internal/gc.dumpobj()\r\n\t/tmp/workdir/go/src/cmd/compile/internal/gc/obj.go:88 +0xafc fp=0x10ef3d94 sp=0x10ef3c94\r\nbootstrap/compile/internal/gc.Main()\r\n\t/tmp/workdir/go/src/cmd/compile/internal/gc/lex.go:495 +0x1c75 fp=0x10ef3ef4 sp=0x10ef3d94\r\nbootstrap/compile/internal/x86.Main()\r\n\t/tmp/workdir/go/src/cmd/compile/internal/x86/galign.go:108 +0x5ff fp=0x10ef3f60 sp=0x10ef3ef4\r\nmain.main()\r\n\t/tmp/workdir/go/src/cmd/compile/main.go:30 +0xe5 fp=0x10ef3fcc sp=0x10ef3f60\r\nruntime.main()\r\n\t/tmp/buildlet-scatch798455816/src/runtime/proc.go:63 +0xcb fp=0x10ef3ff0 sp=0x10ef3fcc\r\nruntime.goexit()\r\n\t/tmp/buildlet-scatch798455816/src/runtime/asm_386.s:2287 +0x1 fp=0x10ef3ff4 sp=0x10ef3ff0\r\n```\r\n\r\nI looked at all the Plan 9 trybot failures for the past few months. Here are the failures that seem related to the issue:\r\n\r\n2016-01-07 https://storage.googleapis.com/go-build-log/08d47646/plan9-386_a0c8a6de.log\r\n2016-02-07 https://storage.googleapis.com/go-build-log/786cb6aa/plan9-386_3caaf30b.log\r\n2016-02-08 https://storage.googleapis.com/go-build-log/6284fd7d/plan9-386_0eb811c9.log\r\n2016-02-08 https://storage.googleapis.com/go-build-log/c3e8473c/plan9-386_a81fe2b3.log\r\n2016-02-08 https://storage.googleapis.com/go-build-log/74693682/plan9-386_af2ede70.log\r\n2016-02-10 https://storage.googleapis.com/go-build-log/fd458ba4/plan9-386_32443634.log\r\n2016-02-10 https://storage.googleapis.com/go-build-log/c05edc82/plan9-386_d9e2152a.log\r\n2016-03-02 https://storage.googleapis.com/go-build-log/bb017f22/plan9-386_675f6af8.log\r\n2016-03-02 https://storage.googleapis.com/go-build-log/7a15fb26/plan9-386_8300a8d5.log\r\n2016-03-03 https://storage.googleapis.com/go-build-log/45983827/plan9-386_964f732b.log\r\n2016-03-03 https://storage.googleapis.com/go-build-log/8ce703f2/plan9-386_f1266bd9.log\r\n2016-03-03 https://storage.googleapis.com/go-build-log/99f4402a/plan9-386_359912ab.log\r\n2016-03-03 https://storage.googleapis.com/go-build-log/8ce703f2/plan9-386_f1266bd9.log\r\n2016-03-03 https://storage.googleapis.com/go-build-log/b1f365e1/plan9-386_bb0c78ee.log\r\n2016-03-03 https://storage.googleapis.com/go-build-log/628190d2/plan9-386_dd54d34f.log\r\n2016-03-03 https://storage.googleapis.com/go-build-log/2a89b4fa/plan9-386_b11a651b.log\r\n2016-03-03 https://storage.googleapis.com/go-build-log/e360bef5/plan9-386_dd273260.log\r\n2016-03-04 https://storage.googleapis.com/go-build-log/39cfd5ed/plan9-386_ac6a3ddb.log\r\n2016-03-04 https://storage.googleapis.com/go-build-log/d02312c3/plan9-386_416636ef.log\r\n2016-03-04 https://storage.googleapis.com/go-build-log/4af86c05/plan9-386_1b187278.log\r\n2016-03-04 https://storage.googleapis.com/go-build-log/1023603d/plan9-386_f379247a.log\r\n\r\nThe error appeared the first time on 2016-01-07. Then, it appeared on 2016-02-07, 2016-02-08 and 2016-02-10. All these failures are related to changes on the dev.ssa branch.\r\nThen, the dev.ssa branch was merged to master on 2016-03-01 and the issue started to appear on master as well.\r\n\r\nHere are the issues on the build [dashboard](http://build.golang.org/?branch=dev.ssa) for the dev.ssa branch:\r\n\r\n2016-01-13 http://build.golang.org/log/16064baa23820f462d88b62091555e3f3206a2c2\r\n2016-02-07 http://build.golang.org/log/5f7bd41b60d44c44553b8a6c5fa09a3c11e1919b\r\n2016-02-07 http://build.golang.org/log/f18355544e9b52cac265ab46181915bced101a03\r\n2016-02-08 http://build.golang.org/log/752ad760aa459d182d494fd78b2ee027ad9d37a4\r\n2016-02-08 http://build.golang.org/log/1cc97297b15cc3537bfe0b355412af7c5d655e1d\r\n2016-02-09 http://build.golang.org/log/ff9ad04c40f3618ea25c752879182cab5d06d9d9\r\n2016-02-09 http://build.golang.org/log/4cfeffddb1ce4b2ef3beab43a7020a5bade1b27e\r\n\r\nThe very first failure (2016-01-07) was noticed by the Plan 9 trybot in [CL 18390](https://golang.org/cl/18390), which was submitted on 2016-01-13. Then, the first failure from the [dashboard](http://build.golang.org/) (2016-01-13) appeared when the [CL 18267 (https://golang.org/cl/18267) was submitted, just after [CL 18390](https://golang.org/cl/18390).\r\n\r\nI tried to reproduce the issue by running make.rc dozens of times on various machines, including the same image running the Plan 9 builder on GCE. So far, I haven't been able to reproduce the issue.",
	"user": {
		"login": "0intro",
		"id": 6043744,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "Builders"
		},
		{
			"name": "OS-Plan9"
		}
	],
	"assignee": {
		"login": "0intro",
		"id": 6043744,
		"type": "User",
		"site_admin": false
	},
	"comments": 5,
	"closed_at": "2016-04-01T23:56:22Z",
	"created_at": "2016-03-04T21:01:18Z",
	"updated_at": "2016-04-01T23:56:22Z",
	"milestone": {
		"id": 1414133,
		"number": 31,
		"title": "Go1.7"
	}
}
