{
	"id": 169522829,
	"number": 16612,
	"state": "closed",
	"title": "x/net/http2: hung request to vision.googleapis.com (bad flow control?)",
	"body": "I narrowed the issue to c558a539b5efaeda4b6f8e61f51c21f64d1b94f6.\r\nI suspect it's caused by https://golang.org/cl/25382.\r\n\r\n```\r\n$ GODEBUG=http2debug=2 GOLANG_SAMPLES_PROJECT_ID=\u003cELIDED\u003e go test -v github.com/GoogleCloudPlatform/golang-samples/vision/label\r\n=== RUN   TestLabel\r\n2016/08/04 20:28:16 http2: Transport failed to get client conn for accounts.google.com:443: http2: no cached connection was available\r\n2016/08/04 20:28:16 http2: Transport creating client conn to [2607:f8b0:4005:804::200d]:443\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote SETTINGS len=18, settings: ENABLE_PUSH=0, INITIAL_WINDOW_SIZE=4194304, MAX_HEADER_LIST_SIZE=10485760\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote WINDOW_UPDATE len=4 (conn) incr=1073741824\r\n2016/08/04 20:28:16 http2: Transport encoding header \":authority\" = \"accounts.google.com\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \":method\" = \"POST\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \":path\" = \"/o/oauth2/token\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \":scheme\" = \"https\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \"content-type\" = \"application/x-www-form-urlencoded\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \"content-length\" = \"208\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \"accept-encoding\" = \"gzip\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \"user-agent\" = \"Go-http-client/2.0\"\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote HEADERS flags=END_HEADERS stream=1 len=80\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote DATA stream=1 len=208 data=\"client_id=\u003cELIDED\u003e\u0026client_secret=\u003cELIDED\u003e\u0026grant_type=refresh_token\u0026refresh_token=\u003cELIDED\u003e\"\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: read SETTINGS len=24, settings: MAX_CONCURRENT_STREAMS=100, INITIAL_WINDOW_SIZE=1048576, MAX_FRAME_SIZE=16384, MAX_HEADER_LIST_SIZE=16384\r\n2016/08/04 20:28:16 http2: Transport received SETTINGS len=24, settings: MAX_CONCURRENT_STREAMS=100, INITIAL_WINDOW_SIZE=1048576, MAX_FRAME_SIZE=16384, MAX_HEADER_LIST_SIZE=16384\r\n2016/08/04 20:28:16 Unhandled Setting: [MAX_HEADER_LIST_SIZE = 16384]\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote DATA flags=END_STREAM stream=1 len=0 data=\"\"\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote SETTINGS flags=ACK len=0\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: read WINDOW_UPDATE len=4 (conn) incr=983041\r\n2016/08/04 20:28:16 http2: Transport received WINDOW_UPDATE len=4 (conn) incr=983041\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: read SETTINGS flags=ACK len=0\r\n2016/08/04 20:28:16 http2: Transport received SETTINGS flags=ACK len=0\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: read HEADERS flags=END_HEADERS stream=1 len=1429\r\n2016/08/04 20:28:16 http2: Transport received HEADERS flags=END_HEADERS stream=1 len=1429\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: read DATA flags=PADDED stream=1 len=341 data=\"\u003cELIDED\u003e\"\r\n2016/08/04 20:28:16 http2: Transport received DATA flags=PADDED stream=1 len=341 data=\"\u003cELIDED\u003e\"\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote WINDOW_UPDATE len=4 (conn) incr=192\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote WINDOW_UPDATE stream=1 len=4 incr=192\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: read DATA flags=END_STREAM|PADDED stream=1 len=216 data=\"\u003cELIDED\u003e\"\r\n2016/08/04 20:28:16 http2: Transport received DATA flags=END_STREAM|PADDED stream=1 len=216 data=\"\u003cELIDED\u003e\"\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote WINDOW_UPDATE len=4 (conn) incr=206\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote WINDOW_UPDATE stream=1 len=4 incr=206\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: read PING len=8 ping=\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"\r\n2016/08/04 20:28:16 http2: Transport received PING len=8 ping=\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"\r\n2016/08/04 20:28:16 http2: Framer 0xc420208180: wrote PING flags=ACK len=8 ping=\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"\r\n2016/08/04 20:28:16 http2: Transport failed to get client conn for vision.googleapis.com:443: http2: no cached connection was available\r\n2016/08/04 20:28:16 http2: Transport creating client conn to [2607:f8b0:4005:804::200a]:443\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: wrote SETTINGS len=18, settings: ENABLE_PUSH=0, INITIAL_WINDOW_SIZE=4194304, MAX_HEADER_LIST_SIZE=10485760\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: wrote WINDOW_UPDATE len=4 (conn) incr=1073741824\r\n2016/08/04 20:28:16 http2: Transport encoding header \":authority\" = \"vision.googleapis.com\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \":method\" = \"POST\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \":path\" = \"https://vision.googleapis.com/v1/images:annotate?alt=json\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \":scheme\" = \"https\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \"content-type\" = \"application/json\"\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: read SETTINGS len=24, settings: MAX_CONCURRENT_STREAMS=100, INITIAL_WINDOW_SIZE=1048576, MAX_FRAME_SIZE=16384, MAX_HEADER_LIST_SIZE=16384\r\n2016/08/04 20:28:16 http2: Transport encoding header \"authorization\" = \"Bearer \u003cELIDED\u003e\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \"user-agent\" = \"google-api-go-client/0.5\"\r\n2016/08/04 20:28:16 http2: Transport encoding header \"content-length\" = \"163636\"\r\n2016/08/04 20:28:16 http2: Transport received SETTINGS len=24, settings: MAX_CONCURRENT_STREAMS=100, INITIAL_WINDOW_SIZE=1048576, MAX_FRAME_SIZE=16384, MAX_HEADER_LIST_SIZE=16384\r\n2016/08/04 20:28:16 http2: Transport encoding header \"accept-encoding\" = \"gzip\"\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: wrote HEADERS flags=END_HEADERS stream=1 len=171\r\n2016/08/04 20:28:16 Unhandled Setting: [MAX_HEADER_LIST_SIZE = 16384]\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: wrote SETTINGS flags=ACK len=0\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: read WINDOW_UPDATE len=4 (conn) incr=983041\r\n2016/08/04 20:28:16 http2: Transport received WINDOW_UPDATE len=4 (conn) incr=983041\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: wrote DATA stream=1 len=16384 data=\"{\\\"requests\\\":[{\\\"features\\\":[{\\\"type\\\":\\\"LABEL_DETECTION\\\"}],\\\"image\\\":{\\\"content\\\":\\\"/9j/2wCEAAMCAggICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgHBwcHBwcHCAcHBwoHBwcICQkJBwcLDQoIDQcICQgBAwQEBgUGCAYGCAgHBwcNCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICP\" (16128 bytes omitted)\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: wrote DATA stream=1 len=16384 data=\"\u003cELIDED\u003e\" (16128 bytes omitted)\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: wrote DATA stream=1 len=16384 data=\"\u003cELIDED\u003e\" (16128 bytes omitted)\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: read SETTINGS flags=ACK len=0\r\n2016/08/04 20:28:16 http2: Transport received SETTINGS flags=ACK len=0\r\n2016/08/04 20:28:16 http2: Framer 0xc4200266c0: wrote DATA stream=1 len=16383 data=\"\u003cELIDED\u003e\" (16127 bytes omitted)\r\n\r\n\u003cfour minutes later\u003e\r\n\r\n2016/08/04 20:32:16 http2: Framer 0xc420208180: read GOAWAY len=25 LastStreamID=1 ErrCode=NO_ERROR Debug=\"session_timed_out\"\r\n2016/08/04 20:32:16 http2: Transport received GOAWAY len=25 LastStreamID=1 ErrCode=NO_ERROR Debug=\"session_timed_out\"\r\n2016/08/04 20:32:16 Transport readFrame error: (*errors.errorString) EOF\r\n2016/08/04 20:32:17 http2: Framer 0xc4200266c0: read HEADERS flags=END_HEADERS stream=1 len=439\r\n2016/08/04 20:32:17 http2: Transport received HEADERS flags=END_HEADERS stream=1 len=439\r\n2016/08/04 20:32:17 http2: Framer 0xc4200266c0: read DATA flags=END_STREAM stream=1 len=1613 data=\"\u003c!DOCTYPE html\u003e\\n\u003chtml lang=en\u003e\\n  \u003cmeta charset=utf-8\u003e\\n  \u003cmeta name=viewport content=\\\"initial-scale=1, minimum-scale=1, width=device-width\\\"\u003e\\n  \u003ctitle\u003eError 502 (Server Error)!!1\u003c/title\u003e\\n  \u003cstyle\u003e\\n    *{margin:0;padding:0}html,code{font:15px/22px arial,sans-\" (1357 bytes omitted)\r\n2016/08/04 20:32:17 http2: Transport received DATA flags=END_STREAM stream=1 len=1613 data=\"\u003c!DOCTYPE html\u003e\\n\u003chtml lang=en\u003e\\n  \u003cmeta charset=utf-8\u003e\\n  \u003cmeta name=viewport content=\\\"initial-scale=1, minimum-scale=1, width=device-width\\\"\u003e\\n  \u003ctitle\u003eError 502 (Server Error)!!1\u003c/title\u003e\\n  \u003cstyle\u003e\\n    *{margin:0;padding:0}html,code{font:15px/22px arial,sans-\" (1357 bytes omitted)\r\n2016/08/04 20:32:17 http2: Framer 0xc4200266c0: read PING len=8 ping=\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"\r\n2016/08/04 20:32:17 http2: Transport received PING len=8 ping=\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"\r\n2016/08/04 20:32:17 http2: Framer 0xc4200266c0: wrote PING flags=ACK len=8 ping=\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"\r\n```\r\n\r\nEasiest way to reproduce... [install Cloud SDK](https://cloud.google.com/sdk/downloads), do a `gcloud auth login`, then:\r\n```\r\ngo get github.com/GoogleCloudPlatform/golang-samples/vision/label\r\n$GOPATH/bin/label $GOROOT/doc/gopher/gophercolor.png\r\n```",
	"user": {
		"login": "broady",
		"id": 24982,
		"type": "User",
		"site_admin": false
	},
	"assignee": {
		"login": "bradfitz",
		"id": 2621,
		"type": "User",
		"site_admin": false
	},
	"comments": 8,
	"closed_at": "2016-08-05T17:09:15Z",
	"created_at": "2016-08-05T03:45:28Z",
	"updated_at": "2016-08-05T17:09:15Z",
	"milestone": {
		"id": 1414133,
		"number": 31,
		"title": "Go1.7"
	}
}
