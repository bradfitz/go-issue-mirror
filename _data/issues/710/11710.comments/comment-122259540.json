{
	"id": 122259540,
	"body": "I did some investigating, but first a small disclamier: I have very little knowledge of C and CGO, so I might be missing something obvious.\r\n\r\nOk, I'm using go-oci8 to debug, and the function that is causing the error is this: https://github.com/mattn/go-oci8/blob/master/oci8.go#L142-161\r\n\r\nI modified it to print values that are passed to OCIEnvCreate:\r\n\r\n```c\r\nstatic ret2ptr\r\nWrapOCIEnvCreate(ub4 mode, size_t extra) {\r\n  ret2ptr vvv = {NULL, NULL, 0};\r\n  \r\n  void *ptr;\r\n  if (extra == 0)  {\r\n    ptr = NULL;\r\n  } else {\r\n    ptr = \u0026vvv.extra;\r\n  }\r\n  printf(\"OciEnv: %p\\n\", (OCIEnv**)(\u0026vvv.ptr));\r\n  printf(\"Mode: %d\\n\", mode);\r\n  printf(\"Extra: %d\\n\", extra);\r\n  printf(\"Extra Ptr: %p\\n\", ptr);\r\n  vvv.rv = OCIEnvCreate(\r\n    (OCIEnv**)(\u0026vvv.ptr),\r\n    mode,\r\n    NULL,\r\n    NULL,\r\n    NULL,\r\n    NULL,\r\n    extra,\r\n    ptr);\r\n  printf(\"worked\\n\");\r\n  return vvv;\r\n}\r\n```\r\n\r\nAnd this is the output:\r\n\r\nGo 1.5:\r\n```\r\nOciEnv: 000000000022FD60\r\nMode: 1\r\nExtra: 0\r\nExtra Ptr: 0000000000000000\r\nException 0xc0000005 0x0 0xd7d526 0x69c018\r\nPC=0x69c018\r\nsignal arrived during external code execution\r\n\r\ngithub.com/mattn/go-oci8._Cfunc_WrapOCIEnvCreate(0x1, 0x0, 0x0, 0x0, 0x0)\r\n        ??:0 +0x5a\r\ngithub.com/mattn/go-oci8.(*OCI8Driver).Open(0x6db678, 0x5f8ba0, 0x1c, 0x0, 0x0,\r\n0x0, 0x0)\r\n        c:/projetos/go/src/github.com/mattn/go-oci8/oci8.go:538 +0x4a8\r\ndatabase/sql.(*DB).conn(0xc08206a140, 0x44be01, 0xc08205bea0, 0x0, 0x0)\r\n        c:/go/src/database/sql/sql.go:710 +0x458\r\ndatabase/sql.(*DB).Ping(0xc08206a140, 0x0, 0x0)\r\n        c:/go/src/database/sql/sql.go:491 +0x3d\r\nmain.main()\r\n        C:/Projetos/Go/oracle-connect.go:17 +0x16a\r\n\r\ngoroutine 17 [syscall, locked to thread]:\r\nruntime.goexit()\r\n        c:/go/src/runtime/asm_amd64.s:1696 +0x1\r\n\r\ngoroutine 5 [chan receive]:\r\ndatabase/sql.(*DB).connectionOpener(0xc08206a140)\r\n        c:/go/src/database/sql/sql.go:634 +0x4c\r\ncreated by database/sql.Open\r\n        c:/go/src/database/sql/sql.go:481 +0x33d\r\nrax     0x1c\r\nrbx     0xc08205ba20\r\nrcx     0x22fd60\r\nrdi     0x22fd60\r\nrsi     0x0\r\nrbp     0x1\r\nrsp     0x22fd18\r\nr8      0x0\r\nr9      0x0\r\nr10     0x0\r\nr11     0x246\r\nr12     0x0\r\nr13     0xc08205bfa0\r\nr14     0x38\r\nr15     0x0\r\nrip     0x69c018\r\nrflags  0x10246\r\ncs      0x33\r\nfs      0x53\r\ngs      0x2b\r\n```\r\n\r\nGo 1.4:\r\n```\r\nOciEnv: 000000000022FE60\r\nMode: 1\r\nExtra: 0\r\nExtra Ptr: 0000000000000000\r\nworked\r\n```\r\n\r\nApparently the parameters are passed correctly.\r\n\r\nThe problem is on the line that calls OCIEnvCreate, however I monitored calls to API using a program called API Monitor V2, and while the 1.4 version shows the DLL being called, the 1.5 version shows nothing. So the problem is most likely inside the C code in oci8.go.\r\n\r\n![go1 4](https://cloud.githubusercontent.com/assets/6311027/8746703/62a5eb50-2c62-11e5-9366-17a25bd121aa.PNG)\r\n\r\n![go1 5](https://cloud.githubusercontent.com/assets/6311027/8746705/67f77cc2-2c62-11e5-9c1d-a12350fcc82c.PNG)\r\n\r\nI also tried forcing an error passing an invalid parameter in 1.4, but I got a treated message from this code block:\r\n\r\n```go\r\nif rv := C.WrapOCIEnvCreate(\r\n\t\tC.OCI_DEFAULT|C.OCI_THREADED,\r\n\t\t0); rv.rv != C.OCI_SUCCESS \u0026\u0026 rv.rv != C.OCI_SUCCESS_WITH_INFO {\r\n\t\t// TODO: error handle not yet allocated, we can't get string error from oracle\r\n\t\treturn nil, errors.New(\"can't OCIEnvCreate\")\r\n```\r\n\r\nAnd the call is also shown in API Monitor.\r\n\r\nIs there anything else I can do to help identify the problem? In the meantime I'll see if I can simulate it with a simpler DLL call.",
	"user": {
		"login": "ricsmania",
		"id": 6311027,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2015-07-17T12:22:25Z",
	"updated_at": "2015-07-17T12:22:25Z"
}
