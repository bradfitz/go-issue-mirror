{
	"id": 91921028,
	"number": 11476,
	"state": "closed",
	"title": "net/http: TestTransportCloseResponseBody failing on Plan 9",
	"body": "In [CL 11601](https://go-review.googlesource.com/11601), TestTransportCloseResponseBody is failing on Plan 9:\r\n\r\n```\r\n--- FAIL: TestTransportCloseResponseBody (0.10s)\r\n\ttransport_test.go:1587: EOF\r\nFAIL\r\nFAIL\tnet/http\t19.029s\r\n2015/06/29 01:34:18 Failed: exit status: 'go 3306: 1'\r\n```\r\n\r\nSee https://storage.googleapis.com/go-build-log/10feb7f2/plan9-386_6337f8ae.log.\r\n\r\nIt only fails when TestCancelRequestWithChannelBeforeDo and TestTransportCloseResponseBody are run consecutively, but not systematically.\r\n\r\nOnly TestCancelRequestWithChannelBeforeDo:\r\n\r\n```\r\ncpu% go test -v -run TestCancelRequestWithChannelBeforeDo\r\n=== RUN   TestCancelRequestWithChannelBeforeDo\r\n--- PASS: TestCancelRequestWithChannelBeforeDo (0.27s)\r\nPASS\r\nok  \tnet/http\t0.334s\r\n```\r\n\r\nOnly TestTransportCloseResponseBody:\r\n\r\n```\r\ncpu% go test -v -run TestTransportCloseResponseBody\r\n=== RUN   TestTransportCloseResponseBody\r\n--- PASS: TestTransportCloseResponseBody (0.34s)\r\nPASS\r\nok  \tnet/http\t0.421s\r\n```\r\n\r\nTestCancelRequestWithChannelBeforeDo and TestTransportCloseResponseBody:\r\n\r\n```\r\ncpu% go test -v -run '(TestCancelRequestWithChannelBeforeDo|TestTransportCloseResponseBody)'\r\n=== RUN   TestCancelRequestWithChannelBeforeDo\r\n--- PASS: TestCancelRequestWithChannelBeforeDo (0.00s)\r\n=== RUN   TestTransportCloseResponseBody\r\n--- FAIL: TestTransportCloseResponseBody (0.12s)\r\n\ttransport_test.go:1587: EOF\r\nFAIL\r\nexit status: 'http.test 124221: 1'\r\nFAIL\tnet/http\t0.197s\r\n```\r\n\r\nHere is the stack trace:\r\n\r\n```\r\ncpu% go test -v -run '(TestCancelRequestWithChannelBeforeDo|TestTransportCloseResponseBody)'\r\n=== RUN   TestCancelRequestWithChannelBeforeDo\r\n--- PASS: TestCancelRequestWithChannelBeforeDo (0.01s)\r\n=== RUN   TestTransportCloseResponseBody\r\n--- FAIL: TestTransportCloseResponseBody (0.13s)\r\npanic:  [recovered]\r\n\tpanic: \r\n\r\ngoroutine 9 [running]:\r\ntesting.tRunner.func1(0x106e46c0)\r\n\t/usr/go/src/testing/testing.go:449 +0x130\r\nnet/http_test.TestTransportCloseResponseBody(0x106e46c0)\r\n\t/usr/go/src/net/http/transport_test.go:1587 +0x54a\r\ntesting.tRunner(0x106e46c0, 0x5430c0)\r\n\t/usr/go/src/testing/testing.go:455 +0x8e\r\ncreated by testing.RunTests\r\n\t/usr/go/src/testing/testing.go:560 +0x6e8\r\n\r\ngoroutine 1 [chan receive]:\r\ntesting.RunTests(0x42edc4, 0x542700, 0xe5, 0xe5, 0x701)\r\n\t/usr/go/src/testing/testing.go:561 +0x71a\r\ntesting.(*M).Run(0x10709f5c, 0x14669c)\r\n\t/usr/go/src/testing/testing.go:493 +0x67\r\nnet/http_test.TestMain(0x10709f5c)\r\n\t/usr/go/src/net/http/main_test.go:19 +0x20\r\nmain.main()\r\n\tnet/http/_test/_testmain.go:552 +0xff\r\n\r\ngoroutine 6 [runnable]:\r\nsyscall.Syscall(0x10679d00, 0x0, 0x0, 0x0, 0xffffffff, 0x0, 0x10676080, 0x22)\r\n\t/usr/go/src/syscall/asm_plan9_386.s:22 +0x5\r\nsyscall.open(0x10679ce0, 0x12, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/syscall/zsyscall_plan9_386.go:61 +0x81\r\nsyscall.Open(0x10679ce0, 0x12, 0x0, 0x12, 0x0, 0x0)\r\n\t/usr/go/src/syscall/syscall_plan9.go:321 +0x41\r\nos.OpenFile(0x10679ce0, 0x12, 0x0, 0x0, 0x10680dd0, 0x0, 0x0)\r\n\t/usr/go/src/os/file_plan9.go:111 +0x35c\r\nos.Open(0x10679ce0, 0x12, 0xb, 0x0, 0x0)\r\n\t/usr/go/src/os/file.go:246 +0x44\r\nnet.(*netFD).acceptPlan9(0x106a4ac0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/ipsock_plan9.go:222 +0x14c\r\nnet.(*TCPListener).AcceptTCP(0x106887e8, 0x106a72c0, 0x0, 0x0)\r\n\t/usr/go/src/net/tcpsock_plan9.go:144 +0x55\r\nnet.(*TCPListener).Accept(0x106887e8, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/tcpsock_plan9.go:157 +0x5d\r\nnet/http/httptest.(*historyListener).Accept(0x10679820, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/http/httptest/server.go:48 +0x52\r\nnet/http.(*Server).Serve(0x106a4b00, 0x307695f8, 0x10679820, 0x0, 0x0)\r\n\t/usr/go/src/net/http/server.go:1820 +0x97\r\ncreated by net/http/httptest.(*Server).Start\r\n\t/usr/go/src/net/http/httptest/server.go:109 +0x2cc\r\n\r\ngoroutine 10 [syscall]:\r\nsyscall.Syscall(0x10679e40, 0x0, 0x0, 0x0, 0x0, 0x10664d00, 0x42f7c4, 0x10679da0)\r\n\t/usr/go/src/syscall/asm_plan9_386.s:22 +0x5\r\nsyscall.open(0x10679e00, 0x12, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/syscall/zsyscall_plan9_386.go:61 +0x81\r\nsyscall.Open(0x10679e00, 0x12, 0x0, 0x12, 0x0, 0x0)\r\n\t/usr/go/src/syscall/syscall_plan9.go:321 +0x41\r\nos.OpenFile(0x10679e00, 0x12, 0x0, 0x0, 0x10683dd0, 0x0, 0x0)\r\n\t/usr/go/src/os/file_plan9.go:111 +0x35c\r\nos.Open(0x10679e00, 0x12, 0xb, 0x0, 0x0)\r\n\t/usr/go/src/os/file.go:246 +0x44\r\nnet.(*netFD).acceptPlan9(0x106a4d00, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/ipsock_plan9.go:222 +0x14c\r\nnet.(*TCPListener).AcceptTCP(0x10688860, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/tcpsock_plan9.go:144 +0x55\r\nnet.(*TCPListener).Accept(0x10688860, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/tcpsock_plan9.go:157 +0x5d\r\nnet/http/httptest.(*historyListener).Accept(0x10679a00, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/http/httptest/server.go:48 +0x52\r\nnet/http.(*Server).Serve(0x106a4d40, 0x307695f8, 0x10679a00, 0x0, 0x0)\r\n\t/usr/go/src/net/http/server.go:1820 +0x97\r\ncreated by net/http/httptest.(*Server).Start\r\n\t/usr/go/src/net/http/httptest/server.go:109 +0x2cc\r\n\r\ngoroutine 14 [syscall]:\r\nsyscall.Syscall6(0x7, 0x10730000, 0x1000, 0xffffffff, 0xffffffff, 0x0, 0x0, 0x19, 0x10731070, 0xf90, ...)\r\n\t/usr/go/src/syscall/asm_plan9_386.s:57 +0x5\r\nsyscall.Pread(0x7, 0x10730000, 0x1000, 0x1000, 0xffffffff, 0xffffffff, 0x1cee5b, 0x0, 0x0)\r\n\t/usr/go/src/syscall/zsyscall_plan9_386.go:228 +0x72\r\nsyscall.Read(0x7, 0x10730000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/syscall/syscall_plan9.go:123 +0x54\r\nos.(*File).read(0x106888f0, 0x10730000, 0x1000, 0x1000, 0x46230, 0x0, 0x0)\r\n\t/usr/go/src/os/file_plan9.go:248 +0x49\r\nos.(*File).Read(0x106888f0, 0x10730000, 0x1000, 0x1000, 0x1d, 0x0, 0x0)\r\n\t/usr/go/src/os/file.go:95 +0x6e\r\nnet.(*netFD).Read(0x106a5080, 0x10730000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/fd_plan9.go:134 +0xf6\r\nnet.(*conn).Read(0x10688900, 0x10730000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/net.go:124 +0x88\r\nnet/http.(*liveSwitchReader).Read(0x106e4804, 0x10730000, 0x1000, 0x1000, 0x1073005e, 0x0, 0x0)\r\n\t/usr/go/src/net/http/server.go:219 +0x83\r\nio.(*LimitedReader).Read(0x106a72c0, 0x10730000, 0x1000, 0x1000, 0x30769818, 0x0, 0x0)\r\n\t/usr/go/src/io/io.go:427 +0xca\r\nbufio.(*Reader).fill(0x106a84e0)\r\n\t/usr/go/src/bufio/bufio.go:97 +0x171\r\nbufio.(*Reader).ReadSlice(0x106a84e0, 0x1065e80a, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/bufio/bufio.go:328 +0x1b3\r\nbufio.(*Reader).ReadLine(0x106a84e0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/bufio/bufio.go:357 +0x4a\r\nnet/textproto.(*Reader).readLineSlice(0x10679d20, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/textproto/reader.go:55 +0x58\r\nnet/textproto.(*Reader).ReadLine(0x10679d20, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/textproto/reader.go:36 +0x38\r\nnet/http.ReadRequest(0x106a84e0, 0x106bb3b0, 0x0, 0x0)\r\n\t/usr/go/src/net/http/request.go:631 +0x99\r\nnet/http.(*conn).readRequest(0x106e47e0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/http/server.go:628 +0x367\r\nnet/http.(*conn).serve(0x106e47e0)\r\n\t/usr/go/src/net/http/server.go:1252 +0x7a8\r\ncreated by net/http.(*Server).Serve\r\n\t/usr/go/src/net/http/server.go:1843 +0x342\r\n\r\ngoroutine 12 [syscall]:\r\nsyscall.Syscall6(0x5, 0x1072e000, 0x1000, 0xffffffff, 0xffffffff, 0x0, 0x0, 0x0, 0x1065c7eb, 0x0, ...)\r\n\t/usr/go/src/syscall/asm_plan9_386.s:57 +0x5\r\nsyscall.Pread(0x5, 0x1072e000, 0x1000, 0x1000, 0xffffffff, 0xffffffff, 0x1cee5b, 0x0, 0x0)\r\n\t/usr/go/src/syscall/zsyscall_plan9_386.go:228 +0x72\r\nsyscall.Read(0x5, 0x1072e000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/syscall/syscall_plan9.go:123 +0x54\r\nos.(*File).read(0x106888b8, 0x1072e000, 0x1000, 0x1000, 0x46230, 0x0, 0x0)\r\n\t/usr/go/src/os/file_plan9.go:248 +0x49\r\nos.(*File).Read(0x106888b8, 0x1072e000, 0x1000, 0x1000, 0x2da300, 0x0, 0x0)\r\n\t/usr/go/src/os/file.go:95 +0x6e\r\nnet.(*netFD).Read(0x106a4fc0, 0x1072e000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/fd_plan9.go:134 +0xf6\r\nnet.(*conn).Read(0x106888c8, 0x1072e000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/net/net.go:124 +0x88\r\nnet/http.noteEOFReader.Read(0x30769680, 0x106888c8, 0x106e47ac, 0x1072e000, 0x1000, 0x1000, 0x2de180, 0x0, 0x0)\r\n\t/usr/go/src/net/http/transport.go:1352 +0x54\r\nnet/http.(*noteEOFReader).Read(0x106a71d0, 0x1072e000, 0x1000, 0x1000, 0x1, 0x0, 0x0)\r\n\t\u003cautogenerated\u003e:128 +0xad\r\nbufio.(*Reader).fill(0x106a8480)\r\n\t/usr/go/src/bufio/bufio.go:97 +0x171\r\nbufio.(*Reader).Peek(0x106a8480, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n\t/usr/go/src/bufio/bufio.go:132 +0xac\r\nnet/http.(*persistConn).readLoop(0x106e4780)\r\n\t/usr/go/src/net/http/transport.go:883 +0xe2\r\ncreated by net/http.(*Transport).dialConn\r\n\t/usr/go/src/net/http/transport.go:692 +0xa7c\r\n\r\ngoroutine 13 [runnable]:\r\nnet/http.(*persistConn).writeLoop(0x106e4780)\r\n\t/usr/go/src/net/http/transport.go:1009 +0x302\r\ncreated by net/http.(*Transport).dialConn\r\n\t/usr/go/src/net/http/transport.go:693 +0xa9c\r\nexit status: 'http.test 124488: 2'\r\nFAIL\tnet/http\t0.650s\r\n```",
	"user": {
		"login": "0intro",
		"id": 6043744,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "OS-Plan9"
		}
	],
	"assignee": {
		"login": "0intro",
		"id": 6043744,
		"type": "User",
		"site_admin": false
	},
	"comments": 4,
	"closed_at": "2016-10-18T13:32:50Z",
	"created_at": "2015-06-29T22:07:47Z",
	"updated_at": "2016-10-18T13:32:50Z",
	"milestone": {
		"id": 1055141,
		"number": 6,
		"title": "Unplanned"
	}
}
