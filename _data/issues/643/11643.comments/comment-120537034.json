{
	"id": 120537034,
	"body": "This is the same program as #11644. I'll see if it's reproducible with gcstackbarrieroff=1 (and then also try gccheckmark=1).\r\n\r\nI've reduced it to the following test, which crashes on darwin/amd64 with GOMAXPROCS=4 after 5-10 seconds:\r\n\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"runtime\"\r\n\t\"sync\"\r\n)\r\n\r\ntype response struct {\r\n\ta bool\r\n\tb int\r\n\tc string\r\n\td []interface{}\r\n}\r\n\r\ntype myError struct {\r\n\ta int\r\n\tb string\r\n}\r\n\r\nfunc (myError) Error() string { return \"\" }\r\nfunc doRequest() (*response, error) {\r\n\ttype async struct {\r\n\t\tresp *response\r\n\t\terr  error\r\n\t}\r\n\tch := make(chan *async, 0)\r\n\tdone := make(chan struct{}, 0)\r\n\tcancel := make(chan struct{}, 0)\r\n\r\n\tgo func() {\r\n\t\tselect {\r\n\t\tcase ch \u003c- \u0026async{resp: nil, err: myError{}}:\r\n\t\tcase \u003c-done:\r\n\t\t}\r\n\t}()\r\n\r\n\tselect {\r\n\tcase r := \u003c-ch:\r\n\t\truntime.Gosched()\r\n\t\treturn r.resp, r.err\r\n\tcase \u003c-cancel:\r\n\t\tpanic(\"unreachable\")\r\n\t}\r\n}\r\n\r\nfunc main() {\r\n\tvar wg sync.WaitGroup\r\n\tfor i := 0; i \u003c 100; i++ {\r\n\t\twg.Add(1)\r\n\t\tgo func() {\r\n\t\t\tdefer wg.Done()\r\n\t\t\tvar garbage []byte\r\n\t\t\tfor j := 0; j \u003c 1e9; j++ {\r\n\r\n\t\t\t\t// BEGIN\r\n\t\t\t\tfunc() error {\r\n\t\t\t\t\tresp, err := doRequest()\r\n\t\t\t\t\tif err != nil {\r\n\t\t\t\t\t\tif merr, ok := err.(myError); ok { // \u003c- this is the line that calls runtime.assertI2T2\r\n\t\t\t\t\t\t\t_ = merr\r\n\t\t\t\t\t\t\treturn nil\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn err\r\n\t\t\t\t\t}\r\n\t\t\t\t\t_ = resp\r\n\t\t\t\t\treturn nil\r\n\t\t\t\t}()\r\n\t\t\t\t// END\r\n\r\n\t\t\t\tgarbage = make([]byte, 1\u003c\u003c10)\r\n\t\t\t}\r\n\t\t\t_ = garbage\r\n\t\t}()\r\n\t}\r\n\twg.Wait()\r\n}\r\n```\r\n\r\n```\r\nunexpected fault address 0xb01dfacedebac1e\r\nfatal error: fault\r\n[signal 0xb code=0x1 addr=0xb01dfacedebac1e pc=0x9053]\r\n\r\ngoroutine 125 [running]:\r\nruntime.throw(0x72e50, 0x5)\r\n\t/usr/local/go/src/runtime/panic.go:527 +0x96 fp=0x820771e58 sp=0x820771e40\r\nruntime.sigpanic()\r\n\t/usr/local/go/src/runtime/sigpanic_unix.go:27 +0x2ba fp=0x820771ea8 sp=0x820771e58\r\nruntime.assertI2T2(0x66c20, 0xdeaddeaddeaddead, 0x820e79940, 0x820771f28, 0x20c01)\r\n\t/usr/local/go/src/runtime/iface.go:201 +0x33 fp=0x820771ec8 sp=0x820771ea8\r\nmain.main.func1.1(0x0, 0x0)\r\n\t/Users/rhysh/Downloads/lucky.go:59 +0x99 fp=0x820771f48 sp=0x820771ec8\r\nmain.main.func1(0x820164000)\r\n\t/Users/rhysh/Downloads/lucky.go:67 +0x6f fp=0x820771fa8 sp=0x820771f48\r\nruntime.goexit()\r\n\t/usr/local/go/src/runtime/asm_amd64.s:1696 +0x1 fp=0x820771fb0 sp=0x820771fa8\r\ncreated by main.main\r\n\t/Users/rhysh/Downloads/lucky.go:73 +0x7e\r\n\r\ngoroutine 1 [semacquire]:\r\nsync.runtime_Semacquire(0x82016400c)\r\n\t/usr/local/go/src/runtime/sema.go:43 +0x26\r\nsync.(*WaitGroup).Wait(0x820164000)\r\n\t/usr/local/go/src/sync/waitgroup.go:126 +0xb4\r\nmain.main()\r\n\t/Users/rhysh/Downloads/lucky.go:75 +0xaf\r\n\r\n[snip]\r\n```\r\n\r\nAnd with `GODEBUG=gcstackbarrieroff=1,gccheckmark=1,gctrace=1 go run -gcflags '-N -l' ~/Downloads/lucky.go`, I see the following crash:\r\n\r\n```\r\ngc #1403 @9.184s 17%: 0.082+0.45+2.1+0.46+0.80 ms clock, 0.24+0.45+0+0/0.34/0+2.4 ms cpu, 4-\u003e5-\u003e0 MB, 4 MB goal, 4 P\r\ngc #1404 @9.192s 17%: 0.028+0.21+1.5+0.70+1.1 ms clock, 0.084+0.21+0+0/0.50/0+3.4 ms cpu, 4-\u003e4-\u003e0 MB, 5 MB goal, 4 P\r\ngc #1405 @9.200s 17%: 0.064+2.7+0.026+0.61+0.72 ms clock, 0.19+2.7+0+0/0.42/0+2.1 ms cpu, 4-\u003e5-\u003e0 MB, 4 MB goal, 4 P\r\nruntime:greyobject: checkmarks finds unexpected unmarked object obj=0x820fefac0\r\nruntime: found obj at *(0x82047adf8+0x20)\r\nbase=0x82047adf8 k=0x41023d s.start*_PageSize=0x82047a000 s.limit=0x820456000 s.sizeclass=0 s.elemsize=0\r\nobj=0x820fefac0 k=0x4107f7 s.start*_PageSize=0x820fee000 s.limit=0x820ff0000 s.sizeclass=3 s.elemsize=32\r\n *(obj+0) = 0x0\r\n *(obj+8) = 0x88202a2028\r\n *(obj+16) = 0x820fefb60\r\n *(obj+24) = 0x0\r\nfatal error: checkmark found unmarked object\r\n\r\nruntime stack:\r\nruntime.throw(0x80460, 0x1f)\r\n\t/usr/local/go/src/runtime/panic.go:527 +0x96 fp=0x820157918 sp=0x820157900\r\nruntime.greyobject(0x820fefac0, 0x82047adf8, 0x20, 0x820078029, 0x8800000000, 0x8820372f50, 0x82010d220)\r\n\t/usr/local/go/src/runtime/mgcmark.go:867 +0x204 fp=0x8201579a0 sp=0x820157918\r\nruntime.scanblock(0x82047adf8, 0xc8, 0x86ec0, 0x82010d220)\r\n\t/usr/local/go/src/runtime/mgcmark.go:755 +0x152 fp=0x820157a28 sp=0x8201579a0\r\nruntime.scanframeworker(0x820157be0, 0x0, 0x82010d220)\r\n\t/usr/local/go/src/runtime/mgcmark.go:424 +0x14c fp=0x820157ac0 sp=0x820157a28\r\nruntime.scanstack.func1(0x820157be0, 0x0, 0x1)\r\n\t/usr/local/go/src/runtime/mgcmark.go:344 +0x65 fp=0x820157b08 sp=0x820157ac0\r\nruntime.gentraceback(0x24d59, 0x82047abe0, 0x0, 0x82019c780, 0x0, 0x0, 0x7fffffff, 0x820157d00, 0x0, 0x0, ...)\r\n\t/usr/local/go/src/runtime/traceback.go:336 +0xa7e fp=0x820157c38 sp=0x820157b08\r\nruntime.scanstack(0x82019c780)\r\n\t/usr/local/go/src/runtime/mgcmark.go:366 +0x391 fp=0x820157d40 sp=0x820157c38\r\nruntime.scang(0x82019c780)\r\n\t/usr/local/go/src/runtime/proc1.go:417 +0x96 fp=0x820157d60 sp=0x820157d40\r\nruntime.markroot(0x82010a000, 0x4c)\r\n\t/usr/local/go/src/runtime/mgcmark.go:135 +0x1ba fp=0x820157e00 sp=0x820157d60\r\nruntime.parfordo(0x82010a000)\r\n\t/usr/local/go/src/runtime/parfor.go:110 +0x1d4 fp=0x820157e88 sp=0x820157e00\r\nruntime.gchelper()\r\n\t/usr/local/go/src/runtime/mgc.go:1617 +0x59 fp=0x820157ed0 sp=0x820157e88\r\nruntime.stopm()\r\n\t/usr/local/go/src/runtime/proc1.go:1125 +0x15e fp=0x820157ef8 sp=0x820157ed0\r\nruntime.gcstopm()\r\n\t/usr/local/go/src/runtime/proc1.go:1315 +0xfe fp=0x820157f28 sp=0x820157ef8\r\nruntime.schedule()\r\n\t/usr/local/go/src/runtime/proc1.go:1574 +0xa5 fp=0x820157f60 sp=0x820157f28\r\nruntime.goschedImpl(0x820172600)\r\n\t/usr/local/go/src/runtime/proc1.go:1691 +0x136 fp=0x820157f78 sp=0x820157f60\r\nruntime.gosched_m(0x820172600)\r\n\t/usr/local/go/src/runtime/proc1.go:1699 +0x32 fp=0x820157f88 sp=0x820157f78\r\nruntime.mcall(0x0)\r\n\t/usr/local/go/src/runtime/asm_amd64.s:204 +0x5e fp=0x820157f98 sp=0x820157f88\r\n\r\ngoroutine 1 [semacquire]:\r\nruntime.gopark(0x8ab80, 0xbc8c0, 0x763f0, 0xa, 0x19, 0x4)\r\n\t/usr/local/go/src/runtime/proc.go:185 +0x169 fp=0x8201a7e40 sp=0x8201a7e18\r\nruntime.goparkunlock(0xbc8c0, 0x763f0, 0xa, 0x21d19, 0x4)\r\n\t/usr/local/go/src/runtime/proc.go:191 +0x54 fp=0x8201a7e78 sp=0x8201a7e40\r\nruntime.semacquire(0x82016400c, 0x51701)\r\n\t/usr/local/go/src/runtime/sema.go:100 +0x2fa fp=0x8201a7ed8 sp=0x8201a7e78\r\nsync.runtime_Semacquire(0x82016400c)\r\n\t/usr/local/go/src/runtime/sema.go:43 +0x26 fp=0x8201a7ef0 sp=0x8201a7ed8\r\nsync.(*WaitGroup).Wait(0x820164000)\r\n\t/usr/local/go/src/sync/waitgroup.go:126 +0xb4 fp=0x8201a7f38 sp=0x8201a7ef0\r\nmain.main()\r\n\t/Users/rhysh/Downloads/lucky.go:75 +0xaf fp=0x8201a7f70 sp=0x8201a7f38\r\nruntime.main()\r\n\t/usr/local/go/src/runtime/proc.go:111 +0x2bf fp=0x8201a7fc0 sp=0x8201a7f70\r\nruntime.goexit()\r\n\t/usr/local/go/src/runtime/asm_amd64.s:1696 +0x1 fp=0x8201a7fc8 sp=0x8201a7fc0\r\n\r\ngoroutine 2 [force gc (idle)]:\r\nruntime.gopark(0x8ab80, 0xb6b70, 0x75240, 0xf, 0x14, 0x1)\r\n\t/usr/local/go/src/runtime/proc.go:185 +0x169 fp=0x820118758 sp=0x820118730\r\nruntime.goparkunlock(0xb6b70, 0x75240, 0xf, 0x8200f0114, 0x1)\r\n\t/usr/local/go/src/runtime/proc.go:191 +0x54 fp=0x820118790 sp=0x820118758\r\nruntime.forcegchelper()\r\n\t/usr/local/go/src/runtime/proc.go:152 +0xb8 fp=0x8201187c0 sp=0x820118790\r\nruntime.goexit()\r\n\t/usr/local/go/src/runtime/asm_amd64.s:1696 +0x1 fp=0x8201187c8 sp=0x8201187c0\r\ncreated by runtime.init.4\r\n\t/usr/local/go/src/runtime/proc.go:141 +0x2b\r\n\r\ngoroutine 17 [GC sweep wait]:\r\nruntime.gopark(0x8ab80, 0xb6c40, 0x74520, 0xd, 0x44214, 0x1)\r\n\t/usr/local/go/src/runtime/proc.go:185 +0x169 fp=0x820114748 sp=0x820114720\r\nruntime.goparkunlock(0xb6c40, 0x74520, 0xd, 0x14, 0x1)\r\n\t/usr/local/go/src/runtime/proc.go:191 +0x54 fp=0x820114780 sp=0x820114748\r\nruntime.bgsweep(0x82015c000)\r\n\t/usr/local/go/src/runtime/mgcsweep.go:67 +0x14d fp=0x8201147b8 sp=0x820114780\r\nruntime.goexit()\r\n\t/usr/local/go/src/runtime/asm_amd64.s:1696 +0x1 fp=0x8201147c0 sp=0x8201147b8\r\ncreated by runtime.gcenable\r\n\t/usr/local/go/src/runtime/mgc.go:200 +0x53\r\n\r\ngoroutine 18 [runnable]:\r\nruntime.Gosched()\r\n\t/usr/local/go/src/runtime/proc.go:166 +0x14 fp=0x820780dd0 sp=0x820780dc0\r\nmain.doRequest(0x0, 0x0, 0x0)\r\n\t/Users/rhysh/Downloads/lucky.go:39 +0x144 fp=0x820780ec8 sp=0x820780dd0\r\nmain.main.func1.1(0x0, 0x0)\r\n\t/Users/rhysh/Downloads/lucky.go:57 +0x2e fp=0x820780f48 sp=0x820780ec8\r\nmain.main.func1(0x820164000)\r\n\t/Users/rhysh/Downloads/lucky.go:67 +0x6f fp=0x820780fa8 sp=0x820780f48\r\nruntime.goexit()\r\n\t/usr/local/go/src/runtime/asm_amd64.s:1696 +0x1 fp=0x820780fb0 sp=0x820780fa8\r\ncreated by main.main\r\n\t/Users/rhysh/Downloads/lucky.go:73 +0x7e\r\n\r\ngoroutine 19 [runnable]:\r\nruntime.Gosched()\r\n\t/usr/local/go/src/runtime/proc.go:166 +0x14 fp=0x8204d3dd0 sp=0x8204d3dc0\r\nmain.doRequest(0x0, 0x0, 0x0)\r\n\t/Users/rhysh/Downloads/lucky.go:39 +0x144 fp=0x8204d3ec8 sp=0x8204d3dd0\r\nmain.main.func1.1(0x0, 0x0)\r\n\t/Users/rhysh/Downloads/lucky.go:57 +0x2e fp=0x8204d3f48 sp=0x8204d3ec8\r\nmain.main.func1(0x820164000)\r\n\t/Users/rhysh/Downloads/lucky.go:67 +0x6f fp=0x8204d3fa8 sp=0x8204d3f48\r\nruntime.goexit()\r\n\t/usr/local/go/src/runtime/asm_amd64.s:1696 +0x1 fp=0x8204d3fb0 sp=0x8204d3fa8\r\ncreated by main.main\r\n\t/Users/rhysh/Downloads/lucky.go:73 +0x7e\r\n\r\n\r\n[snip]\r\n```\r\n\r\n```\r\n$ go version\r\ngo version devel +b6ead9f Tue Jul 7 21:53:11 2015 +0000 darwin/amd64\r\n$ uname -a\r\nDarwin Rhyss-MacBook-Pro.local 14.4.0 Darwin Kernel Version 14.4.0: Thu May 28 11:35:04 PDT 2015; root:xnu-2782.30.5~1/RELEASE_X86_64 x86_64\r\n```\r\n",
	"user": {
		"login": "rhysh",
		"id": 230685,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2015-07-10T21:47:20Z",
	"updated_at": "2015-07-10T21:47:20Z"
}
