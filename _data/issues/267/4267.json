{
	"id": 51281890,
	"number": 4267,
	"state": "closed",
	"title": "cmd/cgo: _crosscall2 not found from .dylib/.so generated by Swig in OS X Mountain Lion",
	"body": "by **nigel@vannevartech.com**:\n\n\u003cpre\u003eI had to use Swig to wrap some C++ code and had run into an issue with undefined symbols\nwhile trying to run the Go executable in OS X Mountain Lion.\n\nBackground:\n\nThe C code generated by Swig is compiled into a .so using Clang c++, which has\ncrosscall2 as an undefined symbol. The Go executable is compiled separately using go\ntools, which contains crosscall2().\n\nI have a simplified example, illustrated here:\n\n$ nm go/bin/main | grep crosscall2\n0000000000026cc5 T _crosscall2\n$ nm go/lib/example.so | grep crosscall2\n                 U _crosscall2\n\nAnd the main executable is linked to example.so by \u0026quot;go build\u0026quot; (presumably by\n6l under the hood) like so:\n\n$ DYLD_LIBRARY_PATH=go/lib otool -L go/bin/main \ngo/bin/main:\n\texample.so (compatibility version 0.0.0, current version 0.0.0)\n\t/usr/lib/libSystem.B.dylib (compatibility version 0.0.0, current version 0.0.0)\n\nIn the example, I'm wrapping a simple function in C that returns a const char *, which\nis then returned to Go as a string.\n\nconst char *message() {\n  return \u0026quot;A Message\u0026quot;;\n}\n\nI use this function in Go like:\n\nfunc main() {\n        fmt.Printf(\u0026quot;Message is: %v\\n\u0026quot;, example.Message())\n}\n\nOnce everything has been compiled, I than run\n$ DYLD_LIBRARY_PATH=go/lib go/bin/main \n\nThis operation triggers a call to crosscall2() in the generated C Swig code to create a\nGo string. That forces a lazy resolution for crosscall2. In Mountain Lion, it failed to\nresolve _crosscall2.\n\nSee attached package for complete source code.\n\nWhat is the expected output?\n\nThe expected output is a successful execution with the output:\n\n\u0026quot;Message is: A Message\u0026quot;\n\nWhat do you see instead?\n\n$ DYLD_LIBRARY_PATH=go/lib go/bin/main \ndyld: lazy symbol binding failed: Symbol not found: _crosscall2\n  Referenced from: go/lib/example.so\n  Expected in: flat namespace\n\ndyld: Symbol not found: _crosscall2\n  Referenced from: go/lib/example.so\n  Expected in: flat namespace\n\nSIGTRAP: trace trap\npc: 0x7fff6d36109d\n\n\ngoroutine 1 [syscall]:\nexample.Message(0xf84002b0d0, 0xf84002b0f0)\n\t/Users/nigelchoi/Code/crosscall2/go/src/example/example_gc.c:33 +0x32\nmain.main()\n\t/Users/nigelchoi/Code/crosscall2/go/src/main/main.go:9 +0x1c\n\ngoroutine 2 [syscall]:\ncreated by runtime.main\n\t/usr/local/go/src/pkg/runtime/proc.c:221\nrax     0x0\nrbx     0x2400000\nrcx     0x0\nrdx     0x0\nrdi     0x7fff6d3d0060\nrsi     0x0\nrbp     0xb0080c80\nrsp     0xb0080c68\nr8      0x7fff6d37ca14\nr9      0xf\nr10     0xb0080b38\nr11     0x7fff6d3d0060\nr12     0x1203\nr13     0x0\nr14     0x7fff6d3d0060\nr15     0x269df\nrip     0x7fff6d36109d\nrflags  0x246\ncs      0x2b\nfs      0x0\ngs      0x0\n\nWhich compiler are you using (5g, 6g, 8g, gccgo)?\n\nI'm using the standard Go tools to compile the Go portion (go 1.0.3)\n\nClang c++ to compile the C portion (Apple clang version 4.1 (tags/Apple/clang-421.11.65)\n(based on LLVM 3.1svn))\n\nWhich operating system are you using?\n\nOS X Mountain Lion 10.8.2 (12C60)\n\nWhich version are you using?  (run 'go version')\n\ngo 1.0.3\n\nPlease provide any additional information below.\n\nCuriously, another undefined symbol in example.so can be resolved back to the Go\nexecutable, the __cgo_allocate symbol. Could it be bad formatting of the _crosscall2\nfunction in the Mach-O?\n\n$ DYLD_PRINT_BINDINGS=1 DYLD_LIBRARY_PATH=go/lib go/bin/main \ndyld: bind: example.so:0x020FC010 = main:__cgo_allocate, *0x020FC010 = 0x00026801\n...\ndyld: lazy symbol binding failed: Symbol not found: _crosscall2\u003c/pre\u003e\n\n\n\n\n\nAttachments:\n\n1. \u003ca href=\"https://storage.googleapis.com/go-attachment/4267/0/crosscall2.tgz\"\u003ecrosscall2.tgz\u003c/a\u003e (879 bytes)",
	"user": {
		"login": "gopherbot",
		"id": 8566911,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 9,
	"closed_at": "2014-12-08T10:22:42Z",
	"created_at": "2012-10-20T06:21:06Z",
	"updated_at": "2016-06-24T22:26:48Z",
	"milestone": {
		"id": 1067207,
		"number": 14,
		"title": "Go1.2"
	}
}
