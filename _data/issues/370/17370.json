{
	"id": 181542127,
	"number": 17370,
	"state": "open",
	"title": "cmd/compile: eliminate more bounds checks",
	"body": "### What version of Go are you using (`go version`)?\r\ngo version devel +fe77c5b Mon Oct 3 18:26:43 2016 +0000 linux/amd64\r\n\r\n\r\n### What operating system and processor architecture are you using (`go env`)?\r\n\r\n\r\n### What did you do?\r\nhttps://play.golang.org/p/KvKjpisUOl\r\n\r\n### What did you expect to see?\r\nbounds checks eliminated from assembly\r\n\r\n### What did you see instead?\r\n```\r\nTEXT main.blah(SB) /home/notcarl/Desktop/bce.go\r\n\tbce.go:9\t0x401000\t64488b0c25f8ffffff\tFS MOVQ FS:0xfffffff8, CX\t\t\r\n\tbce.go:9\t0x401009\t483b6110\t\tCMPQ 0x10(CX), SP\t\t\t\r\n\tbce.go:9\t0x40100d\t0f864b010000\t\tJBE 0x40115e\t\t\t\t\r\n\tbce.go:9\t0x401013\t4883ec38\t\tSUBQ $0x38, SP\t\t\t\t\r\n\tbce.go:9\t0x401017\t48896c2430\t\tMOVQ BP, 0x30(SP)\t\t\t\r\n\tbce.go:9\t0x40101c\t488d6c2430\t\tLEAQ 0x30(SP), BP\t\t\t\r\n\tbce.go:10\t0x401021\t488b0570620900\t\tMOVQ 0x96270(IP), AX\t\t\t\r\n\tbce.go:10\t0x401028\t488b0d61620900\t\tMOVQ 0x96261(IP), CX\t\t\t\r\n\tbce.go:12\t0x40102f\t488b1502080b00\t\tMOVQ 0xb0802(IP), DX\t\t\t\r\n\tbce.go:12\t0x401036\t4889c3\t\t\tMOVQ AX, BX\t\t\t\t\r\n\tbce.go:12\t0x401039\t4829d0\t\t\tSUBQ DX, AX\t\t\t\t\r\n\tbce.go:12\t0x40103c\t4883f804\t\tCMPQ $0x4, AX\t\t\t\t\r\n\tbce.go:12\t0x401040\t0f8ccf000000\t\tJL 0x401115\t\t\t\t\r\n\tbce.go:15\t0x401046\t488d4203\t\tLEAQ 0x3(DX), AX\t\t\t\r\n\tbce.go:15\t0x40104a\t4839d8\t\t\tCMPQ BX, AX\t\t\t\t\r\n\tbce.go:15\t0x40104d\t0f83bb000000\t\tJAE 0x40110e\t\t\t\t\r\n\tbce.go:16\t0x401053\t4839da\t\t\tCMPQ BX, DX\t\t\t\t\r\n\tbce.go:16\t0x401056\t0f83ab000000\t\tJAE 0x401107\t\t\t\t\r\n\tbce.go:16\t0x40105c\t0fb60c11\t\tMOVZX 0(CX)(DX*1), CX\t\t\t\r\n\tbce.go:16\t0x401060\t80f980\t\t\tCMPL $0x80, CL\t\t\t\t\r\n\tbce.go:16\t0x401063\t760a\t\t\tJBE 0x40106f\t\t\t\t\r\n\tbce.go:34\t0x401065\t488b6c2430\t\tMOVQ 0x30(SP), BP\t\t\t\r\n\tbce.go:34\t0x40106a\t4883c438\t\tADDQ $0x38, SP\t\t\t\t\r\n\tbce.go:34\t0x40106e\tc3\t\t\tRET\t\t\t\t\t\r\n\tbce.go:19\t0x40106f\t488d4a01\t\tLEAQ 0x1(DX), CX\t\t\t\r\n\tbce.go:19\t0x401073\t48890dbe070b00\t\tMOVQ CX, 0xb07be(IP)\t\t\t\r\n\tbce.go:20\t0x40107a\t488b1d17620900\t\tMOVQ 0x96217(IP), BX\t\t\t\r\n\tbce.go:20\t0x401081\t488b3508620900\t\tMOVQ 0x96208(IP), SI\t\t\t\r\n\tbce.go:20\t0x401088\t4839d9\t\t\tCMPQ BX, CX\t\t\t\t\r\n\tbce.go:20\t0x40108b\t7373\t\t\tJAE 0x401100\t\t\t\t\r\n\tbce.go:20\t0x40108d\t0fb64c1601\t\tMOVZX 0x1(SI)(DX*1), CX\t\t\t\r\n\tbce.go:20\t0x401092\t80f980\t\t\tCMPL $0x80, CL\t\t\t\t\r\n\tbce.go:20\t0x401095\t77ce\t\t\tJA 0x401065\t\t\t\t\r\n\tbce.go:23\t0x401097\t488d4a02\t\tLEAQ 0x2(DX), CX\t\t\t\r\n\tbce.go:23\t0x40109b\t48890d96070b00\t\tMOVQ CX, 0xb0796(IP)\t\t\t\r\n\tbce.go:24\t0x4010a2\t488b1def610900\t\tMOVQ 0x961ef(IP), BX\t\t\t\r\n\tbce.go:24\t0x4010a9\t488b35e0610900\t\tMOVQ 0x961e0(IP), SI\t\t\t\r\n\tbce.go:24\t0x4010b0\t4839d9\t\t\tCMPQ BX, CX\t\t\t\t\r\n\tbce.go:24\t0x4010b3\t7344\t\t\tJAE 0x4010f9\t\t\t\t\r\n\tbce.go:24\t0x4010b5\t0fb64c1602\t\tMOVZX 0x2(SI)(DX*1), CX\t\t\t\r\n\tbce.go:24\t0x4010ba\t80f980\t\t\tCMPL $0x80, CL\t\t\t\t\r\n\tbce.go:24\t0x4010bd\t77a6\t\t\tJA 0x401065\t\t\t\t\r\n\tbce.go:27\t0x4010bf\t48890572070b00\t\tMOVQ AX, 0xb0772(IP)\t\t\t\r\n\tbce.go:28\t0x4010c6\t488b0dcb610900\t\tMOVQ 0x961cb(IP), CX\t\t\t\r\n\tbce.go:28\t0x4010cd\t488b1dbc610900\t\tMOVQ 0x961bc(IP), BX\t\t\t\r\n\tbce.go:28\t0x4010d4\t4839c8\t\t\tCMPQ CX, AX\t\t\t\t\r\n\tbce.go:28\t0x4010d7\t7319\t\t\tJAE 0x4010f2\t\t\t\t\r\n\tbce.go:28\t0x4010d9\t0fb6441303\t\tMOVZX 0x3(BX)(DX*1), AX\t\t\t\r\n\tbce.go:28\t0x4010de\t3c80\t\t\tCMPL $0x80, AL\t\t\t\t\r\n\tbce.go:28\t0x4010e0\t7783\t\t\tJA 0x401065\t\t\t\t\r\n\tbce.go:31\t0x4010e2\t488d4204\t\tLEAQ 0x4(DX), AX\t\t\t\r\n\tbce.go:31\t0x4010e6\t4889054b070b00\t\tMOVQ AX, 0xb074b(IP)\t\t\t\r\n\tbce.go:34\t0x4010ed\te973ffffff\t\tJMP 0x401065\t\t\t\t\r\n\tbce.go:28\t0x4010f2\te8c9ed0100\t\tCALL runtime.panicindex(SB)\t\t\r\n\tbce.go:28\t0x4010f7\t0f0b\t\t\tUD2\t\t\t\t\t\r\n\tbce.go:24\t0x4010f9\te8c2ed0100\t\tCALL runtime.panicindex(SB)\t\t\r\n\tbce.go:24\t0x4010fe\t0f0b\t\t\tUD2\t\t\t\t\t\r\n\tbce.go:20\t0x401100\te8bbed0100\t\tCALL runtime.panicindex(SB)\t\t\r\n\tbce.go:20\t0x401105\t0f0b\t\t\tUD2\t\t\t\t\t\r\n\tbce.go:16\t0x401107\te8b4ed0100\t\tCALL runtime.panicindex(SB)\t\t\r\n\tbce.go:16\t0x40110c\t0f0b\t\t\tUD2\t\t\t\t\t\r\n\tbce.go:15\t0x40110e\te8aded0100\t\tCALL runtime.panicindex(SB)\t\t\r\n\tbce.go:15\t0x401113\t0f0b\t\t\tUD2\t\t\t\t\t\r\n\tbce.go:36\t0x401115\t488d05ad430600\t\tLEAQ 0x643ad(IP), AX\t\t\t\r\n\tbce.go:36\t0x40111c\t4889442420\t\tMOVQ AX, 0x20(SP)\t\t\t\r\n\tbce.go:36\t0x401121\t48c744242803000000\tMOVQ $0x3, 0x28(SP)\t\t\t\r\n\tbce.go:36\t0x40112a\t488d056f380500\t\tLEAQ 0x5386f(IP), AX\t\t\t\r\n\tbce.go:36\t0x401131\t48890424\t\tMOVQ AX, 0(SP)\t\t\t\t\r\n\tbce.go:36\t0x401135\t488d442420\t\tLEAQ 0x20(SP), AX\t\t\t\r\n\tbce.go:36\t0x40113a\t4889442408\t\tMOVQ AX, 0x8(SP)\t\t\t\r\n\tbce.go:36\t0x40113f\te81c770000\t\tCALL runtime.convT2E(SB)\t\t\r\n\tbce.go:36\t0x401144\t488b442410\t\tMOVQ 0x10(SP), AX\t\t\t\r\n\tbce.go:36\t0x401149\t488b4c2418\t\tMOVQ 0x18(SP), CX\t\t\t\r\n\tbce.go:36\t0x40114e\t48890424\t\tMOVQ AX, 0(SP)\t\t\t\t\r\n\tbce.go:36\t0x401152\t48894c2408\t\tMOVQ CX, 0x8(SP)\t\t\t\r\n\tbce.go:36\t0x401157\te8a4fd0100\t\tCALL runtime.gopanic(SB)\t\t\r\n\tbce.go:36\t0x40115c\t0f0b\t\t\tUD2\t\t\t\t\t\r\n\tbce.go:9\t0x40115e\te89d600400\t\tCALL runtime.morestack_noctxt(SB)\t\r\n\tbce.go:9\t0x401163\te998feffff\t\tJMP main.blah(SB)\t\t\t\r\n```\r\n\r\n\r\nI *think* the chain of panicindex calls should be removed, since both the:\r\n```\r\n if l - i \u003c 4 {\r\n    goto fail\r\n  }\r\n```\r\nand  `_ = buf[i+3]`  calls should make it clear that the subsequent accesses cannot possibly go out of bounds.  Sorry if this is noise and it's WAI.",
	"user": {
		"login": "carl-mastrangelo",
		"id": 8943572,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "Performance"
		}
	],
	"comments": 4,
	"created_at": "2016-10-06T22:32:21Z",
	"updated_at": "2016-10-19T20:18:38Z",
	"milestone": {
		"id": 1055141,
		"number": 6,
		"title": "Unplanned"
	}
}
