{
	"id": 51281473,
	"number": 3989,
	"state": "closed",
	"title": "ssh: panic during high concurrency",
	"body": "\u003cpre\u003eWhat steps will reproduce the problem?\n\nGOMAXPROCS=81\n\nlucky(~/src/code.google.com/p/go.crypto/ssh) % go test \nwarning: building out-of-date packages:\n        code.google.com/p/go.crypto/ssh/terminal\ninstalling these packages with 'go test -i' will speed future tests.\n\npanic: runtime error: makeslice: len out of range\n\ngoroutine 114 [running]:\ncode.google.com/p/go.crypto/ssh.(*reader).readOnePacket(0xf8401a3870, 0xf8401380e8,\n0x900000009, 0xf8416d6000)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/transport.go:98 +0x5b3\ncode.google.com/p/go.crypto/ssh.(*transport).readPacket(0xf8401a3870, 0xf8416d6000,\n0x1f00000000, 0xf840169210)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/transport.go:119 +0x25\ncode.google.com/p/go.crypto/ssh.(*ServerConn).Accept(0xf8400cb300, 0xf8400cb200,\n0xf840169210, 0xf840169210)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/server.go:530 +0x8b\ncode.google.com/p/go.crypto/ssh.func路018(0xf840138130, 0xf840138128, 0xf840138120, 0x0,\n0x0, ...)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/session_test.go:46 +0x288\ncreated by code.google.com/p/go.crypto/ssh.dial\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/session_test.go:66 +0x235\n\ngoroutine 1 [chan receive]:\ntesting.RunTests(0x400c00, 0x7e2970, 0x2300000023, 0x7ce301, 0x200000002, ...)\n        /home/dfc/go/src/pkg/testing/testing.go:374 +0x7f5\ntesting.Main(0x400c00, 0x7e2970, 0x2300000023, 0x7e0288, 0x400000004, ...)\n        /home/dfc/go/src/pkg/testing/testing.go:309 +0x80\nmain.main()\n        code.google.com/p/go.crypto/ssh/_test/_testmain.go:119 +0x91\n\ngoroutine 2 [syscall]:\ncreated by runtime.main\n        /home/dfc/go/src/pkg/runtime/proc.c:220\n\ngoroutine 34 [chan receive]:\nnet.(*pollServer).WaitRead(0xf84016b7b0, 0xf840179ab0, 0xf84016b780, 0xb, 0xf84016b701,\n...)\n        /home/dfc/go/src/pkg/net/fd.go:244 +0x73\nnet.(*netFD).accept(0xf840179ab0, 0x4e2040, 0x0, 0xf84009c2d0, 0xf8400a1058, ...)\n        /home/dfc/go/src/pkg/net/fd.go:598 +0x21f\nnet.(*TCPListener).AcceptTCP(0xf840192050, 0x0, 0x0, 0x0, 0x7f4ab4507fa8, ...)\n        /home/dfc/go/src/pkg/net/tcpsock_posix.go:248 +0x71\nnet.(*TCPListener).Accept(0xf840192050, 0x0, 0x0, 0x0, 0x0, ...)\n        /home/dfc/go/src/pkg/net/tcpsock_posix.go:258 +0x49\ncode.google.com/p/go.crypto/ssh.(*Listener).Accept(0xf84013a460, 0xf84017bf00, 0x0, 0x0)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/server.go:680 +0x43\ncode.google.com/p/go.crypto/ssh.func路015(0xf840192008, 0xf840138828, 0x0, 0x0)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/server_test.go:132 +0x4b\ncreated by code.google.com/p/go.crypto/ssh.startSSHServer\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/server_test.go:143 +0x3b3\n\ngoroutine 8 [syscall]:\nsyscall.Syscall6()\n        /home/dfc/go/src/pkg/syscall/asm_linux_amd64.s:40 +0x5\nsyscall.EpollWait(0xf800000006, 0xf8401712d0, 0xa0000000a, 0xf8ffffffff, 0x7f4ab74e0f08,\n...)\n        /home/dfc/go/src/pkg/syscall/zerrors_linux_amd64.go:1846 +0x9c\nnet.(*pollster).WaitFD(0xf8401712c0, 0xf84016b7b0, 0x0, 0x0, 0x0, ...)\n        /home/dfc/go/src/pkg/net/fd_linux.go:146 +0xff\nnet.(*pollServer).Run(0xf84016b7b0, 0x0)\n        /home/dfc/go/src/pkg/net/fd.go:212 +0xec\ncreated by net.newPollServer\n        /home/dfc/go/src/pkg/net/newpollserver.go:33 +0x344\n\ngoroutine 21 [finalizer wait]:\ncreated by runtime.gc\n        /home/dfc/go/src/pkg/runtime/mgc0.c:849\n\ngoroutine 35 [chan receive]:\nnet.(*pollServer).WaitRead(0xf84016b7b0, --- FAIL:\nTestClientStdinRespectsMaxPacketSize-81 (0.13 seconds)\nsession_test.go:358:    failed to write: 65518, use of closed network connection\n0xf840179bd0, 0xf84016b780, 0xb, 0xf84016b701, ...)\n        /home/dfc/go/src/pkg/net/fd.go:244 +0x73\nnet.(*netFD).Read(0xf840179bd0, 0xf84013c000, 0x100000001000, 0xffffffff, 0xf84009c2d0,\n...)\n        /home/dfc/go/src/pkg/net/fd.go:404 +0x1fe\nnet.(*conn).Read(0xf8401920c8, 0xf84013c000, 0x100000001000, 0xfcc00000000,\n0xd116cdf200000001, ...)\n        /home/dfc/go/src/pkg/net/net_posix.go:30 +0xc3\nbufio.(*Reader).fill(0xf840139200, 0x0)\n        /home/dfc/go/src/pkg/bufio/bufio.go:77 +0xfc\nbufio.(*Reader).Read(0xf840139200, 0xf841934a68, 0x500000005, 0x5, 0x0, ...)\n        /home/dfc/go/src/pkg/bufio/bufio.go:142 +0x1be\ncode.google.com/p/go.crypto/ssh.(*reader).Read(0xf84017dd20, 0xf841934a68, 0x500000005,\n0x4143c0, 0x0, ...)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/agent.go:0 +0x72\nio.ReadAtLeast(0xf84016b930, 0xf84017dd20, 0xf841934a68, 0x500000005, 0x7f4a00000005,\n...)\n        /home/dfc/go/src/pkg/io/io.go:266 +0xdf\nio.ReadFull(0xf84016b930, 0xf84017dd20, 0xf841934a68, 0x500000005, 0xf84016b930, ...)\n        /home/dfc/go/src/pkg/io/io.go:285 +0x69\ncode.google.com/p/go.crypto/ssh.(*reader).readOnePacket(0xf84017dd20, 0xf84016b630,\n0xf8401921d8, 0x407758)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/transport.go:72 +0xcc\ncode.google.com/p/go.crypto/ssh.(*transport).readPacket(0xf84017dd20, 0x57d680,\n0xf841934a60, 0xf8400a8f20)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/transport.go:119 +0x25\ncode.google.com/p/go.crypto/ssh.(*ServerConn).Accept(0xf84017bf00, 0xf8401758b0, 0x0,\n0x7373657300000007)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/server.go:530 +0x8b\ncode.google.com/p/go.crypto/ssh.connRun(0xf8400cb000, 0xf84017bf00, 0x0, 0x0)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/server_test.go:151 +0xb7\ncreated by code.google.com/p/go.crypto/ssh.func路015\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/server_test.go:141 +0x1b5\n\ngoroutine 36 [chan receive]:\nnet.(*pollServer).WaitRead(0xf84016b7b0, 0xf840179b40, 0xf84016b780, 0xb, 0xf84016b701,\n...)\n        /home/dfc/go/src/pkg/net/fd.go:244 +0x73\nnet.(*netFD).Read(0xf840179b40, 0xf8400be000, 0x100000001000, 0xffffffff, 0xf84009c2d0,\n...)\n        /home/dfc/go/src/pkg/net/fd.go:404 +0x1fe\nnet.(*conn).Read(0xf840192160, 0xf8400be000, 0x100000001000, 0x7a800000000, 0x1, ...)\n        /home/dfc/go/src/pkg/net/net_posix.go:30 +0xc3\nbufio.(*Reader).fill(0xf840139840, 0xa0)\n        /home/dfc/go/src/pkg/bufio/bufio.go:77 +0xfc\nbufio.(*Reader).Read(0xf840139840, 0xf841934b88, 0x500000005, 0x5, 0x0, ...)\n        /home/dfc/go/src/pkg/bufio/bufio.go:142 +0x1be\ncode.google.com/p/go.crypto/ssh.(*reader).Read(0xf8400fb4b0, 0xf841934b88, 0x500000005,\n0x4143c0, 0x0, ...)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/agent.go:0 +0x72\nio.ReadAtLeast(0xf84016b930, 0xf8400fb4b0, 0xf841934b88, 0x500000005, 0x7f4a00000005,\n...)\n        /home/dfc/go/src/pkg/io/io.go:266 +0xdf\nio.ReadFull(0xf84016b930, 0xf8400fb4b0, 0xf841934b88, 0x500000005, 0xf84016b930, ...)\n        /home/dfc/go/src/pkg/io/io.go:285 +0x69\ncode.google.com/p/go.crypto/ssh.(*reader).readOnePacket(0xf8400fb4b0, 0x7f4ab7634920,\n0x40040ef78, 0x40f050)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/transport.go:72 +0xcc\ncode.google.com/p/go.crypto/ssh.(*transport).readPacket(0xf8400fb4b0, 0x0, 0x0,\n0xf841934b01)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/transport.go:119 +0x25\ncode.google.com/p/go.crypto/ssh.(*ClientConn).mainLoop(0xf8400cfa00, 0x0)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/client.go:202 +0x55\ncreated by code.google.com/p/go.crypto/ssh.Client\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/client.go:47 +0x197\n\ngoroutine 120 [running]:\ncreated by testing.RunTests\n        /home/dfc/go/src/pkg/testing/testing.go:373 +0x7d2\n\ngoroutine 121 [chan receive]:\nnet.(*pollServer).WaitRead(0xf84016b7b0, 0xf8401792d0, 0xf84016b780, 0xb, 0xf84016b701,\n...)\n        /home/dfc/go/src/pkg/net/fd.go:244 +0x73\nnet.(*netFD).Read(0xf8401792d0, 0xf8416c9000, 0x100000001000, 0xf8ffffffff,\n0xf84009c2d0, ...)\n        /home/dfc/go/src/pkg/net/fd.go:404 +0x1fe\nnet.(*conn).Read(0xf8401386c8, 0xf8416c9000, 0x100000001000, 0xed000000000, 0x1, ...)\n        /home/dfc/go/src/pkg/net/net_posix.go:30 +0xc3\nbufio.(*Reader).fill(0xf84011d8c0, 0xf840179340)\n        /home/dfc/go/src/pkg/bufio/bufio.go:77 +0xfc\nbufio.(*Reader).Read(0xf84011d8c0, 0xf840138728, 0x500000005, 0x5, 0x0, ...)\n        /home/dfc/go/src/pkg/bufio/bufio.go:142 +0x1be\ncode.google.com/p/go.crypto/ssh.(*reader).Read(0xf840096780, 0xf840138728, 0x500000005,\n0x4143c0, 0x0, ...)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/agent.go:0 +0x72\nio.ReadAtLeast(0xf84016b930, 0xf840096780, 0xf840138728, 0x500000005, 0x7f4a00000005,\n...)\n        /home/dfc/go/src/pkg/io/io.go:266 +0xdf\nio.ReadFull(0xf84016b930, 0xf840096780, 0xf840138728, 0x500000005, 0xf84016b930, ...)\n        /home/dfc/go/src/pkg/io/io.go:285 +0x69\ncode.google.com/p/go.crypto/ssh.(*reader).readOnePacket(0xf840096780, 0xa2,\n0xf840170400, 0x20000000116)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/transport.go:72 +0xcc\ncode.google.com/p/go.crypto/ssh.(*transport).readPacket(0xf840096780, 0x192,\n0xf8400a6000, 0x588d28)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/transport.go:119 +0x25\ncode.google.com/p/go.crypto/ssh.(*ServerConn).kexDH(0xf840120280, 0xf840175430, 0x3,\n0x7f4ab44aabc8, 0xf840138700, ...)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/server.go:142 +0x97\ncode.google.com/p/go.crypto/ssh.(*ServerConn).clientInitHandshake(0xf840120280,\n0xf8401a6300, 0xf84015b000, 0x12b0000011b, 0x0, ...)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/server.go:308 +0xdc7\ncode.google.com/p/go.crypto/ssh.(*ServerConn).Handshake(0xf840120280, 0x0, 0x0, 0x0)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/server.go:228 +0x1c1\ncode.google.com/p/go.crypto/ssh.func路018(0xf8401385d0, 0xf8401385b8, 0xf8401385b0, 0x0,\n0x0, ...)\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/session_test.go:41 +0x1a0\ncreated by code.google.com/p/go.crypto/ssh.dial\n        /home/dfc/src/code.google.com/p/go.crypto/ssh/session_test.go:66 +0x235\nexit status 2\nFAIL    code.google.com/p/go.crypto/ssh 3.940s\n\nWhat is the expected output? What do you see instead?\n\nPASS\n\nPlease use labels and text to provide additional information.\n\nThe 5 byte length and padding value received by the server is corrupt.\n\n* The tests should verify the data is correct (checksum, or a known value)\n* transport.go +98 should protect against a packet length larger than 2^31-1.\u003c/pre\u003e",
	"user": {
		"login": "davecheney",
		"id": 7171,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 1,
	"closed_at": "2014-12-08T10:21:08Z",
	"created_at": "2012-08-22T10:51:18Z",
	"updated_at": "2016-06-24T22:23:31Z"
}
