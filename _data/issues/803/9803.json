{
	"id": 56914974,
	"number": 9803,
	"state": "closed",
	"title": "runtime: cannot allocate memory on Plan 9",
	"body": "The runtime/pprof trace_parser_test.go and trace_test.go\r\ntest files were added in CL 2039.\r\n\r\nThese new tests were failing and emphasized an issue\r\nin the memory allocator on Plan 9 that could lead\r\nto a corruption (issue #9712).\r\n\r\nDmitry Vyukov (@dvyukov) kindly fixed the memory allocator\r\non Plan 9 in CL 3602.\r\n\r\nHowever, the TestTrace test is still randomly failing.\r\n\r\nFor example:\r\n\r\nhttp://build.golang.org/log/f3be10946ca4bd08b55b6fb0e4169f10058a059c\r\n\r\n```\r\nfatal error: runtime: cannot allocate memory\r\n\r\nruntime stack:\r\nruntime.throw(0x1a68a8, 0x1f)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/panic.go:511 +0x71\r\nruntime.persistentalloc(0x4000, 0x8, 0x276f98, 0x19eaa)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/malloc.go:634 +0x1ec\r\nruntime.fixAlloc_Alloc(0x267d40, 0x0)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mfixalloc.go:39 +0xc8\r\nruntime.mHeap_AllocSpanLocked(0x260e40, 0x1, 0x303c085c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mheap.go:308 +0x155\r\nruntime.mHeap_Alloc_m(0x260e40, 0x1, 0x6, 0xb400, 0x303c085c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mheap.go:193 +0x125\r\nruntime.func·034()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mheap.go:233 +0x51\r\nruntime.systemstack(0xdfffec5c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/asm_386.s:270 +0x7f\r\nruntime.mHeap_Alloc(0x260e40, 0x1, 0x6, 0x100, 0xb267)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mheap.go:234 +0x5f\r\nruntime.mCentral_Grow(0x264f80, 0x303c085c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mcentral.go:179 +0x89\r\nruntime.mCentral_CacheSpan(0x264f80, 0x303c085c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mcentral.go:75 +0x2e4\r\nruntime.mCache_Refill(0x30384000, 0x6, 0x303c085c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mcache.go:70 +0xa6\r\nruntime.func·003()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/malloc.go:161 +0x39\r\nruntime.systemstack(0x1039c000)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/asm_386.s:254 +0x56\r\nruntime.mstart()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/proc1.go:671\r\n\r\ngoroutine 50 [running]:\r\nruntime.systemstack_switch()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/asm_386.s:209 fp=0x1039fc98 sp=0x1039fc94\r\nruntime.mallocgc(0x50, 0x16e6c0, 0x0, 0x1787df90)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/malloc.go:162 +0x45c fp=0x1039fcf4 sp=0x1039fc98\r\nruntime.newobject(0x16e6c0, 0x1787df90)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/malloc.go:259 +0x47 fp=0x1039fd08 sp=0x1039fcf4\r\nruntime/pprof_test.parseEvents(0x18d5e000, 0x52b7b, 0x58ccc, 0x177e4000, 0x186da, 0x1e000, 0x0, 0x0)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/pprof/trace_parser_test.go:212 +0xa6d fp=0x1039fe98 sp=0x1039fd08\r\nruntime/pprof_test.parseTrace(0x303a6f20, 0x103f5e60, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/pprof/trace_parser_test.go:63 +0xb8 fp=0x1039fedc sp=0x1039fe98\r\nruntime/pprof_test.TestTraceStress(0x103f5e00)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/pprof/trace_test.go:201 +0xb24 fp=0x1039ffb4 sp=0x1039fedc\r\ntesting.tRunner(0x103f5e00, 0x25a338)\r\n\t/tmp/buildlet-scatch183758248/go/src/testing/testing.go:448 +0xb4 fp=0x1039ffe8 sp=0x1039ffb4\r\nruntime.goexit()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/asm_386.s:2414 +0x1 fp=0x1039ffec sp=0x1039ffe8\r\ncreated by testing.RunTests\r\n\t/tmp/buildlet-scatch183758248/go/src/testing/testing.go:556 +0x833\r\n\r\ngoroutine 1 [chan receive]:\r\ntesting.RunTests(0x1d12d8, 0x25a2c0, 0xc, 0xc, 0x1)\r\n\t/tmp/buildlet-scatch183758248/go/src/testing/testing.go:557 +0x86b\r\ntesting.(*M).Run(0x103d4060, 0x270060)\r\n\t/tmp/buildlet-scatch183758248/go/src/testing/testing.go:486 +0x5d\r\nmain.main()\r\n\truntime/pprof/_test/_testmain.go:76 +0x176\r\n\r\ngoroutine 82 [select (no cases)]:\r\nruntime/pprof_test.func·025()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/pprof/trace_test.go:189 +0x22\r\ncreated by runtime/pprof_test.TestTraceStress\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/pprof/trace_test.go:190 +0xa13\r\nfatal error: malloc deadlock\r\npanic during panic\r\n\r\nruntime stack:\r\nruntime.startpanic_m()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/panic1.go:66 +0x11b\r\nruntime.systemstack(0x1d14ec)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/asm_386.s:270 +0x7f\r\nruntime.startpanic()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/panic.go:489 +0x10\r\nruntime.throw(0x18fd18, 0xf)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/panic.go:510 +0x65\r\nruntime.mallocgc(0x8, 0x0, 0x3, 0xbe)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/malloc.go:69 +0x8d\r\nruntime.rawbyteslice(0x1, 0x0, 0x0, 0x0)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/string.go:274 +0x77\r\nruntime.stringtoslicebyte(0xdfffeb16, 0x1, 0x0, 0x0, 0x0)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/string.go:133 +0x3f\r\nruntime.exit(0x2)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/os1_plan9.go:185 +0x109\r\nruntime.dopanic_m(0x10382e60, 0x1ffb1, 0xdfffebb0)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/panic1.go:121 +0x21b\r\nruntime.func·043()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/panic.go:498 +0x3e\r\nruntime.systemstack(0xdfffeb9c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/asm_386.s:270 +0x7f\r\nruntime.dopanic(0x0)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/panic.go:499 +0x56\r\nruntime.throw(0x1a68a8, 0x1f)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/panic.go:511 +0x71\r\nruntime.persistentalloc(0x4000, 0x8, 0x276f98, 0x19eaa)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/malloc.go:634 +0x1ec\r\nruntime.fixAlloc_Alloc(0x267d40, 0x0)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mfixalloc.go:39 +0xc8\r\nruntime.mHeap_AllocSpanLocked(0x260e40, 0x1, 0x303c085c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mheap.go:308 +0x155\r\nruntime.mHeap_Alloc_m(0x260e40, 0x1, 0x6, 0xb400, 0x303c085c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mheap.go:193 +0x125\r\nruntime.func·034()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mheap.go:233 +0x51\r\nruntime.systemstack(0xdfffec5c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/asm_386.s:270 +0x7f\r\nruntime.mHeap_Alloc(0x260e40, 0x1, 0x6, 0x100, 0xb267)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mheap.go:234 +0x5f\r\nruntime.mCentral_Grow(0x264f80, 0x303c085c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mcentral.go:179 +0x89\r\nruntime.mCentral_CacheSpan(0x264f80, 0x303c085c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mcentral.go:75 +0x2e4\r\nruntime.mCache_Refill(0x30384000, 0x6, 0x303c085c)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/mcache.go:70 +0xa6\r\nruntime.func·003()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/malloc.go:161 +0x39\r\nruntime.systemstack(0x1039c000)\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/asm_386.s:254 +0x56\r\nruntime.mstart()\r\n\t/tmp/buildlet-scatch183758248/go/src/runtime/proc1.go:671\r\nfatal error: unexpected signal during runtime execution\r\nstack trace unavailable\r\nfatal error: malloc deadlock\r\n[...]\r\nfatal error: malloc deadlock\r\npprof.test 2266: suicide: sys: breakpoint pc=0x00040567\r\n*** Test killed: ran too long (5m0s).\r\nFAIL\truntime/pprof\t300.052s\r\n```",
	"user": {
		"login": "0intro",
		"id": 6043744,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"assignee": {
		"login": "0intro",
		"id": 6043744,
		"type": "User",
		"site_admin": false
	},
	"comments": 1,
	"closed_at": "2015-02-26T21:48:18Z",
	"created_at": "2015-02-07T15:38:20Z",
	"updated_at": "2016-06-25T02:00:17Z"
}
