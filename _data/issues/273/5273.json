{
	"id": 51283386,
	"number": 5273,
	"state": "closed",
	"title": "cmd/ld: Link to a shared library fails on windows",
	"body": "\u003cpre\u003eWhat steps will reproduce the problem?\n\n1. Compile the attached c code as a dll\n2. Compile the attached go code using the dll produced during previous step\n\n(see build.bat in the attached zip file)\n\nWhat is the expected output?\nExecutable file\n\nWhat do you see instead?\nC:\\Users\\Simon\\AppData\\Local\\Temp\\go-build373913279\\_\\C_\\GoEcho.a(_all.o): malformed pe\nfile: unexpected flags for PE section .idata$7\n\nWhich compiler are you using (5g, 6g, 8g, gccgo)?\n8g\n\nWhich operating system are you using?\nWindows 8 / x64\n\nWhich version are you using?  (run 'go version')\ngo version devel +b3017cc3e17b Wed Apr 10 21:41:54 2013 -0700 windows/386\n\nThe same steps produces the expected result when using go1.0.3\n\nPlease provide any additional information below.\n\n\u0026gt;\u0026gt; go env\nset GOARCH=386\nset GOBIN=\nset GOCHAR=8\nset GOEXE=.exe\nset GOHOSTARCH=386\nset GOHOSTOS=windows\nset GOOS=windows\nset GOPATH=C:\\Users\\Simon\\Go\nset GORACE=\nset GOROOT=C:\\go\nset GOTOOLDIR=C:\\go\\pkg\\tool\\windows_386\nset CC=gcc\nset GOGCCFLAGS=-g -O2 -m32 -mthreads\nset CGO_ENABLED=1\n\n\u0026gt;\u0026gt;gcc -v\nUtilisation des specs internes.\nCOLLECT_GCC=gcc\nCOLLECT_LTO_WRAPPER=c:/mingw/bin/../libexec/gcc/mingw32/4.7.2/lto-wrapper.exe\nTarget: mingw32\nConfiguré avec: ../gcc-4.7.2/configure --enable-languages=c,c++,ada,fortran,objc\n,obj-c++ --disable-sjlj-exceptions --with-dwarf2 --enable-shared --enable-libgom\np --disable-win32-registry --enable-libstdcxx-debug --disable-build-poststage1-w\nith-cxx --enable-version-specific-runtime-libs --build=mingw32 --prefix=/mingw\nModèle de thread: win32\ngcc version 4.7.2 (GCC)\n\n\u0026gt;\u0026gt; go build -x\nWORK=C:\\Users\\Simon\\AppData\\Local\\Temp\\go-build019044383\nmkdir -p $WORK\\_\\C_\\GoEcho\\_obj\\\ncd C:\\GoEcho\nC:\\go\\pkg\\tool\\windows_386\\cgo.exe -objdir $WORK\\_\\C_\\GoEcho\\_obj\\ -- -I. -I $WO\nRK\\_\\C_\\GoEcho\\_obj\\ main.go\nC:\\go\\pkg\\tool\\windows_386\\8c.exe -F -V -w -I $WORK\\_\\C_\\GoEcho\\_obj\\ -I C:\\go\\p\nkg\\windows_386 -o $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_defun.8 -D GOOS_windows -D GOARCH_\n386 $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_defun.c\ngcc -I . -g -O2 -m32 -mthreads -print-libgcc-file-name\ngcc -I . -g -O2 -m32 -mthreads -I. -I $WORK\\_\\C_\\GoEcho\\_obj\\ -o $WORK\\_\\C_\\GoEc\nho\\_obj\\_cgo_main.o -c $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_main.c\ngcc -I . -g -O2 -m32 -mthreads -I. -I $WORK\\_\\C_\\GoEcho\\_obj\\ -o $WORK\\_\\C_\\GoEc\nho\\_obj\\_cgo_export.o -c $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_export.c\ngcc -I . -g -O2 -m32 -mthreads -I. -I $WORK\\_\\C_\\GoEcho\\_obj\\ -o $WORK\\_\\C_\\GoEc\nho\\_obj\\main.cgo2.o -c $WORK\\_\\C_\\GoEcho\\_obj\\main.cgo2.c\ngcc -I . -g -O2 -m32 -mthreads -o $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_.o $WORK\\_\\C_\\GoEc\nho\\_obj\\_cgo_main.o $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_export.o $WORK\\_\\C_\\GoEcho\\_obj\\\nmain.cgo2.o libecho_dll.a\nC:\\go\\pkg\\tool\\windows_386\\cgo.exe -objdir $WORK\\_\\C_\\GoEcho\\_obj\\ -dynimport $W\nORK\\_\\C_\\GoEcho\\_obj\\_cgo_.o -dynout $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_import.c\nC:\\go\\pkg\\tool\\windows_386\\8c.exe -F -V -w -I $WORK\\_\\C_\\GoEcho\\_obj\\ -I C:\\go\\p\nkg\\windows_386 -o $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_import.8 -D GOOS_windows -D GOARCH\n_386 $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_import.c\ngcc -I . -g -O2 -m32 -mthreads -o $WORK\\_\\C_\\GoEcho\\_obj\\_all.o $WORK\\_\\C_\\GoEch\no\\_obj\\_cgo_export.o $WORK\\_\\C_\\GoEcho\\_obj\\main.cgo2.o libecho_dll.a -Wl,-r -no\nstdlib -lmingwex -lmingw32 c:/mingw/bin/../lib/gcc/mingw32/4.7.2/libgcc.a\nC:\\go\\pkg\\tool\\windows_386\\8g.exe -o $WORK\\_\\C_\\GoEcho\\_obj\\_go_.8 -p _/C_/GoEch\no -D _/C_/GoEcho -I $WORK $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_gotypes.go $WORK\\_\\C_\\GoEc\nho\\_obj\\main.cgo1.go\nC:\\go\\pkg\\tool\\windows_386\\pack.exe grcP $WORK $WORK\\_\\C_\\GoEcho.a $WORK\\_\\C_\\Go\nEcho\\_obj\\_go_.8 $WORK\\_\\C_\\GoEcho\\_obj\\_cgo_import.8 $WORK\\_\\C_\\GoEcho\\_obj\\_cg\no_defun.8 $WORK\\_\\C_\\GoEcho\\_obj\\_all.o\ncd .\nC:\\go\\pkg\\tool\\windows_386\\8l.exe -o GoEcho.exe -L $WORK $WORK\\_\\C_\\GoEcho.a\n# _/C_/GoEcho\nC:\\Users\\Simon\\AppData\\Local\\Temp\\go-build019044383\\_\\C_\\GoEcho.a(_all.o): malfo\nrmed pe file: unexpected flags for PE section .idata$7\n\n\nSteps used to create the dll, the c and the go executables:\ncd GccEcho\ngcc -c Echo.c -DECHO_EXPORTS\ngcc -shared -o echo_dll.dll Echo.o -Wl,--out-implib,libecho_dll.a\ngcc -c main.c\ngcc -o main_dll.exe main.o -L. -lecho_dll\ncd ..\\GoEcho\ncopy ..\\GccEcho\\Echo.h\ncopy ..\\GccEcho\\libecho_dll.a\ncopy ..\\GccEcho\\echo_dll.dll\ngo build\n\nThe C test program links against the .a file and executes without problem.\n\nI tried to reproduce the issue on linux x64 with a .so library, and the build succeeded.\nIt seems to be windows related.\n\nThis issue may be related to \u003ca href=\"https://golang.org/issue/5106\"\u003eissue #5106\u003c/a\u003e, but it seems to me that the build goes one step\nahead in my case.\n\nDo not hesitate if you want me to perform some other tests or give more detailed\ninformation.\n\nSimon\u003c/pre\u003e\n\n\n\n\n\nAttachments:\n\n1. \u003ca href=\"https://storage.googleapis.com/go-attachment/5273/0/GoIssue_src.zip\"\u003eGoIssue_src.zip\u003c/a\u003e (1700 bytes)",
	"user": {
		"login": "xeonx",
		"id": 1748632,
		"type": "User",
		"site_admin": false
	},
	"labels": [
		{
			"name": "FrozenDueToAge"
		}
	],
	"comments": 17,
	"closed_at": "2014-12-08T10:28:24Z",
	"created_at": "2013-04-11T19:01:22Z",
	"updated_at": "2016-06-24T22:37:56Z",
	"milestone": {
		"id": 1067199,
		"number": 11,
		"title": "Go1.1"
	}
}
