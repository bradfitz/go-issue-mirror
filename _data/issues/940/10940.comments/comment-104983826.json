{
	"id": 104983826,
	"body": "test code\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"bufio\"\r\n\t\"fmt\"\r\n\t\"net\"\r\n\t\"net/textproto\"\r\n\t\"sync\"\r\n\t\"testing\"\r\n\t\"time\"\r\n)\r\n\r\ntype Endpoint struct {\r\n\tl net.Listener\r\n\tc net.Conn\r\n\tw sync.WaitGroup\r\n\td chan string\r\n}\r\n\r\nfunc NewEndpoint(addr string) *Endpoint {\r\n\te := \u0026Endpoint{}\r\n\tl, err := net.Listen(\"tcp\", addr)\r\n\tif err != nil {\r\n\t\tpanic(err)\r\n\t}\r\n\te.l = l\r\n\te.d = make(chan string)\r\n\te.w.Add(1)\r\n\tgo func() {\r\n\t\tdefer e.w.Done()\r\n\t\tfor {\r\n\t\t\tc, err := l.Accept()\r\n\t\t\tif err != nil {\r\n\t\t\t\tfmt.Println(\"closed listener\")\r\n\t\t\t\tbreak\r\n\t\t\t}\r\n\t\t\tfmt.Println(\"accepted\", c)\r\n\t\t\te.c = c\r\n\t\t\tr := textproto.NewReader(bufio.NewReader(c))\r\n\t\t\tfor {\r\n\t\t\t\tl, err := r.ReadLine()\r\n\t\t\t\tif err != nil {\r\n\t\t\t\t\tfmt.Println(\"closed socket\")\r\n\t\t\t\t\tc.Close()\r\n\t\t\t\t\te.c = nil\r\n\t\t\t\t\tbreak\r\n\t\t\t\t}\r\n\t\t\t\te.d \u003c- l\r\n\t\t\t}\r\n\t\t}\r\n\t}()\r\n\treturn e\r\n}\r\n\r\nfunc (e *Endpoint) Stop() {\r\n\tfmt.Println(\"stop endpoint\")\r\n\te.l.Close()\r\n\tif e.c != nil {\r\n\t\te.c.Close()\r\n\t}\r\n\te.w.Wait()\r\n}\r\n\r\nfunc TestConn_Write_closed(t *testing.T) {\r\n\taddr := \"127.0.0.1:8888\"\r\n\te := NewEndpoint(addr)\r\n\r\n\tc, err := net.Dial(\"tcp\", addr)\r\n\tif err != nil {\r\n\t\tt.Log(\"failed to connect\")\r\n\t\tt.FailNow()\r\n\t}\r\n\tc.(*net.TCPConn).SetNoDelay(true)\r\n\r\n\t_, err = c.Write([]byte(\"hello\\n\"))\r\n\tif err != nil {\r\n\t\tt.Log(\"write failed\")\r\n\t\tt.Fail()\r\n\t}\r\n\tif \"hello\" != \u003c-e.d {\r\n\t\tt.Log(\"corrupted message\")\r\n\t\tt.Fail()\r\n\t}\r\n\r\n\te.Stop()\r\n\r\n\t// wait to make sure client receives FIN\r\n\ttime.Sleep(time.Second)\r\n\r\n\t_, err = c.Write([]byte(\"world\\n\"))\r\n\tif err == nil {\r\n\t\tt.Log(\"write to closed socket succeeded\")\r\n\t\tt.Fail()\r\n\t}\r\n}\r\n```\r\n\r\noutput on my machine:\r\n```\r\n=== RUN TestConn_Write_closed\r\naccepted \u0026{{0xc2080101c0}}\r\nstop endpoint\r\nclosed socket\r\nclosed listener\r\n--- FAIL: TestConn_Write_closed (1.01s)\r\n\tbug_test.go:92: write to closed socket succeeded\r\nFAIL\r\nexit status 1\r\nFAIL\taerofs.com/bug\t1.010s\r\n```\r\n\r\n![wireshark](https://cloud.githubusercontent.com/assets/7319881/7786940/86f74ff2-01bb-11e5-9959-1f8e120c75ef.png)\r\n",
	"user": {
		"login": "huguesb",
		"id": 7319881,
		"type": "User",
		"site_admin": false
	},
	"created_at": "2015-05-24T06:21:34Z",
	"updated_at": "2015-05-24T06:21:34Z"
}
